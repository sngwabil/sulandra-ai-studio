<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sulandra Creative Studio ¬∑ Enterprise</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

<style>
/* -------------------------------------------------------------------------- */
/* 1. DESIGN SYSTEM - ROYAL MIDNIGHT                                          */
/* -------------------------------------------------------------------------- */
:root {
    /* Core Backgrounds */
    --bg-app: #020410;       /* Deepest Midnight */
    --bg-panel: #05081a;     /* Sidebar/Header */
    --bg-card: #0a0e24;      /* Cards */
    --bg-element: #11152e;   /* Inputs */
    --bg-hover: #1a1f3d;     /* Hover States */
    --bg-active: #252b4d;     /* Active States */
    --bg-overlay: rgba(2, 4, 16, 0.85); /* Modal Backdrops */

    /* Borders */
    --border-light: #1f243d;
    --border-medium: #2d3455;
    --border-focus: #4f5b8c;

    /* Brand Accents */
    --accent-primary: #8b5cf6;    /* Violet */
    --accent-secondary: #3b82f6;  /* Royal Blue */
    --accent-tertiary: #ec4899;   /* Pink */
    --accent-success: #10b981;    /* Emerald */
    --accent-warning: #f59e0b;    /* Amber */
    --accent-error: #ef4444;      /* Red */

    /* Gradients */
    --gradient-brand: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
    --gradient-dark: linear-gradient(to bottom, #05081a, #020410);
    --gradient-glow: radial-gradient(circle at top, rgba(139, 92, 246, 0.15), transparent 70%);

    /* Typography */
    --text-main: #ffffff;
    --text-muted: #94a3b8;
    --text-dim: #64748b;

    /* Shadows */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.6);
    --shadow-glow: 0 0 20px rgba(139, 92, 246, 0.3);

    /* Dimensions */
    --header-height: 60px;
    --sidebar-width: 420px;
    --nav-rail-width: 72px;
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 16px;
    --radius-full: 9999px;

    /* Fonts - UPDATED based on image request */
    --font-ui: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-heading: 'Montserrat', sans-serif; /* Bold Heading Font */
    --font-mono: 'JetBrains Mono', monospace;
}

/* Reset & Base */
* { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-font-smoothing: antialiased; }

body {
    background-color: var(--bg-app);
    color: var(--text-main);
    font-family: var(--font-ui);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    font-size: 13px;
    line-height: 1.5;
}

/* Typography Updates */
h1, h2, h3, .font-heading { font-family: var(--font-heading); font-weight: 800; }

/* Placeholder Styling (Italicized examples) */
::placeholder {
    font-style: italic;
    color: var(--text-muted);
    opacity: 0.6;
    font-family: var(--font-ui);
    font-weight: 400;
}

a { color: inherit; text-decoration: none; }
button { font-family: inherit; }

/* Custom Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--border-focus); }

/* -------------------------------------------------------------------------- */
/* 2. UTILITY CLASSES & ANIMATIONS                                            */
/* -------------------------------------------------------------------------- */
.hidden { display: none !important; }
.flex { display: flex; }
.flex-col { flex-direction: column; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-2 { gap: 8px; }
.gap-4 { gap: 16px; }
.w-full { width: 100%; }
.h-full { height: 100%; }
.text-xs { font-size: 11px; }
.text-sm { font-size: 12px; }
.font-bold { font-weight: 700; }
.uppercase { text-transform: uppercase; letter-spacing: 0.05em; }
.cursor-pointer { cursor: pointer; }
.opacity-50 { opacity: 0.5; }

@keyframes spin { to { transform: rotate(360deg); } }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* -------------------------------------------------------------------------- */
/* 3. LAYOUT COMPONENTS                                                       */
/* -------------------------------------------------------------------------- */

/* Header */
header {
    height: var(--header-height);
    background: var(--bg-panel);
    border-bottom: 1px solid var(--border-light);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 24px; flex-shrink: 0; z-index: 50;
}
.brand { display: flex; align-items: center; gap: 12px; }
.brand-icon { 
    width: 32px; height: 32px; border-radius: 8px; 
    background: var(--gradient-brand); 
    display: flex; align-items: center; justify-content: center;
    font-weight: 800; color: white; font-size: 18px;
    box-shadow: var(--shadow-glow);
    font-family: var(--font-heading);
}
.brand-text { font-family: var(--font-heading); font-weight: 800; font-size: 18px; letter-spacing: -0.02em; }
.brand-badge { 
    font-size: 10px; background: var(--bg-element); border: 1px solid var(--border-light);
    padding: 2px 6px; border-radius: 4px; color: var(--text-muted); 
}

/* Navigation Links */
.nav-links { display: flex; gap: 4px; background: var(--bg-element); padding: 4px; border-radius: 8px; }
.nav-link {
    padding: 6px 16px; border-radius: 6px; color: var(--text-muted); font-weight: 600;
    transition: 0.2s; font-size: 12px; font-family: var(--font-heading);
}
.nav-link:hover { color: var(--text-main); background: var(--bg-hover); }
.nav-link.active { background: var(--bg-active); color: var(--text-main); box-shadow: var(--shadow-sm); }

/* User Profile */
.user-menu { display: flex; align-items: center; gap: 12px; }
.credits-pill {
    display: flex; align-items: center; gap: 6px; background: var(--bg-element);
    padding: 4px 10px; border-radius: 999px; border: 1px solid var(--border-light);
    font-size: 11px; color: var(--text-muted);
}
.credits-val { color: var(--accent-success); font-weight: 700; font-family: var(--font-heading); }
.avatar {
    width: 32px; height: 32px; border-radius: 50%; background: var(--gradient-brand);
    display: flex; align-items: center; justify-content: center; font-weight: 700;
    font-size: 12px; border: 2px solid var(--bg-panel); cursor: pointer;
}

/* Workspace */
.workspace { display: flex; height: calc(100vh - var(--header-height)); overflow: hidden; }

/* Nav Rail (Far Left) */
.nav-rail {
    width: var(--nav-rail-width); background: var(--bg-app);
    border-right: 1px solid var(--border-light);
    display: flex; flex-direction: column; align-items: center;
    padding: 20px 0; gap: 20px; flex-shrink: 0; z-index: 45;
}
.rail-btn {
    width: 44px; height: 44px; border-radius: 12px; display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 2px;
    color: var(--text-muted); cursor: pointer; transition: 0.2s;
}
.rail-btn:hover { background: var(--bg-hover); color: var(--text-main); }
.rail-btn.active {
    background: rgba(139, 92, 246, 0.1); color: var(--accent-primary);
    border: 1px solid rgba(139, 92, 246, 0.2);
}
.rail-icon svg { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2; }
.rail-label { font-size: 9px; font-weight: 700; font-family: var(--font-heading); }

/* Sidebar */
.sidebar {
    width: var(--sidebar-width); background: var(--bg-panel);
    border-right: 1px solid var(--border-light);
    display: flex; flex-direction: column; flex-shrink: 0;
    z-index: 40; transition: 0.3s;
}
.sidebar-header {
    padding: 16px 20px; border-bottom: 1px solid var(--border-light);
    display: flex; justify-content: space-between; align-items: center;
}
.sidebar-title { font-family: var(--font-heading); font-weight: 800; font-size: 14px; letter-spacing: 0.05em; color: var(--text-main); text-transform: uppercase; }
.status-dot { width: 6px; height: 6px; background: var(--accent-success); border-radius: 50%; box-shadow: 0 0 8px var(--accent-success); }

.sidebar-scroll {
    flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 24px;
}

/* Main Stage */
.stage {
    flex: 1; background: var(--bg-app); display: flex; flex-direction: column;
    position: relative; overflow: hidden;
}
.stage-toolbar {
    height: 48px; border-bottom: 1px solid var(--border-light);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 24px; background: rgba(5, 8, 26, 0.8); backdrop-filter: blur(10px);
}

/* -------------------------------------------------------------------------- */
/* 3. UI ELEMENTS                                                             */
/* -------------------------------------------------------------------------- */

/* Tabs */
.tabs { display: flex; background: var(--bg-element); padding: 3px; border-radius: 8px; border: 1px solid var(--border-light); }
.tab {
    flex: 1; text-align: center; padding: 8px; font-size: 12px; font-weight: 600;
    color: var(--text-muted); cursor: pointer; border-radius: 6px; transition: 0.2s;
    font-family: var(--font-heading);
}
.tab:hover { color: var(--text-main); }
.tab.active { background: var(--bg-active); color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }

/* Inputs & Labels */
.label {
    font-size: 11px; font-weight: 700; color: var(--text-muted); 
    text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;
    display: flex; justify-content: space-between; font-family: var(--font-heading);
}
/* Ask SIA Button Style */
.btn-sia {
    font-size: 10px; background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    -webkit-background-clip: text; color: transparent; font-weight: 800;
    cursor: pointer; border: none; padding: 0; background-color: transparent;
    transition: 0.2s;
}
.btn-sia:hover { transform: scale(1.05); filter: brightness(1.2); }

textarea, input[type="text"], input[type="number"], select {
    width: 100%; background: var(--bg-element); border: 1px solid var(--border-light);
    border-radius: var(--radius-md); color: white; padding: 10px;
    font-family: var(--font-ui); font-size: 13px; transition: 0.2s;
}
textarea:focus, input:focus, select:focus { border-color: var(--accent-primary); }

/* Upload Zone - PRIORITIZED */
.upload-zone {
    width: 100%; height: 140px; border: 2px dashed var(--border-medium);
    border-radius: var(--radius-md); background: rgba(255,255,255,0.02);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    cursor: pointer; position: relative; overflow: hidden; transition: 0.2s;
}
.upload-zone:hover { border-color: var(--accent-primary); background: rgba(139,92,246,0.05); }
.upload-zone.active { border-style: solid; border-color: var(--accent-primary); }
.preview-img { 
    position: absolute; inset: 0; width: 100%; height: 100%; 
    object-fit: contain; /* Full image visibility */
    background: #000; 
}

/* Generate Button */
.btn-gen {
    width: 100%; padding: 14px; border: none; border-radius: var(--radius-md);
    background: var(--gradient-brand); color: white; font-weight: 800; font-size: 14px;
    text-transform: uppercase; cursor: pointer; transition: 0.3s; box-shadow: var(--shadow-glow);
    letter-spacing: 0.5px; font-family: var(--font-heading);
}
.btn-gen:hover { transform: translateY(-2px); filter: brightness(1.1); }
.btn-gen:active { transform: translateY(0); }
.btn-gen:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

/* -------------------------------------------------------------------------- */
/* 4. SHORT FILM STORYBOARD                                                   */
/* -------------------------------------------------------------------------- */
.storyboard-container {
    background: var(--bg-element); border: 1px solid var(--border-light);
    border-radius: var(--radius-md); padding: 10px; height: 320px;
    display: flex; flex-direction: column; gap: 10px;
}
.storyboard-grid {
    flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(2, 1fr);
    gap: 8px; padding-right: 4px;
}
.scene-card {
    aspect-ratio: 16/9; background: var(--bg-card); border: 1px solid var(--border-light);
    border-radius: 6px; position: relative; overflow: hidden; cursor: grab;
    transition: 0.2s; display: flex; align-items: center; justify-content: center;
}
.scene-card:hover { border-color: var(--text-muted); }
.scene-card.active { border-color: var(--accent-secondary); box-shadow: 0 0 0 2px rgba(59,130,246,0.5); }
.scene-card.dragging { opacity: 0.5; border-style: dashed; }
.scene-card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }

.scene-badge {
    position: absolute; top: 4px; left: 4px; background: rgba(0,0,0,0.7);
    color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px;
    font-family: var(--font-mono);
}
.scene-delete {
    position: absolute; top: 4px; right: 4px; background: rgba(220, 38, 38, 0.9);
    width: 18px; height: 18px; border-radius: 4px; display: flex; align-items: center;
    justify-content: center; font-size: 10px; color: white; cursor: pointer;
    opacity: 0; transition: 0.2s;
}
.scene-card:hover .scene-delete { opacity: 1; }

.scene-editor {
    margin-top: 12px; padding: 12px; background: var(--bg-element);
    border: 1px solid var(--border-light); border-radius: var(--radius-md);
    display: none; /* Hidden by default */
}
.scene-editor.visible { display: block; animation: fadeIn 0.2s; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* -------------------------------------------------------------------------- */
/* 5. SIA AI CHAT MODAL (NEW)                                                 */
/* -------------------------------------------------------------------------- */
.sia-overlay {
    position: fixed; inset: 0; background: var(--bg-overlay); backdrop-filter: blur(8px);
    z-index: 200; display: none; align-items: center; justify-content: center;
}
.sia-overlay.visible { display: flex; animation: fadeIn 0.2s; }
.sia-window {
    width: 500px; height: 600px; background: var(--bg-panel);
    border: 1px solid var(--border-light); border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg); display: flex; flex-direction: column;
    overflow: hidden;
}
.sia-header {
    height: 50px; border-bottom: 1px solid var(--border-light);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 20px; background: var(--bg-element);
}
.sia-title { font-family: var(--font-heading); font-weight: 800; font-size: 14px; display: flex; align-items: center; gap: 8px; }
.sia-icon-lg { font-size: 18px; }
.sia-close { cursor: pointer; font-size: 18px; color: var(--text-muted); }
.sia-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
.chat-bubble { max-width: 80%; padding: 12px 16px; border-radius: 12px; font-size: 13px; line-height: 1.5; }
.chat-bubble.sia { background: var(--bg-element); align-self: flex-start; border: 1px solid var(--border-light); color: var(--text-muted); }
.chat-bubble.user { background: var(--accent-primary); align-self: flex-end; color: white; }
.sia-footer { padding: 16px; border-top: 1px solid var(--border-light); background: var(--bg-element); }
.sia-input-row { display: flex; gap: 10px; }
.sia-apply-btn { width: 100%; margin-top: 10px; background: var(--accent-success); border:none; color:white; padding:10px; border-radius:8px; cursor:pointer; font-weight:700; display:none; }

/* -------------------------------------------------------------------------- */
/* 6. AUDIO BROWSER & GALLERY                                                 */
/* -------------------------------------------------------------------------- */
.audio-panel {
    position: fixed; top: 0; right: -420px; width: 400px; height: 100%;
    background: var(--bg-panel); border-left: 1px solid var(--border-light);
    z-index: 100; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: -10px 0 50px rgba(0,0,0,0.5); display: flex; flex-direction: column;
}
.audio-panel.open { right: 0; }
.audio-list { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
.audio-item {
    display: flex; align-items: center; gap: 12px; padding: 12px;
    background: var(--bg-element); border: 1px solid var(--border-light);
    border-radius: 8px; cursor: pointer; transition: 0.2s;
}
.audio-item:hover { border-color: var(--accent-primary); background: var(--bg-hover); }
.audio-icon {
    width: 32px; height: 32px; background: rgba(139,92,246,0.1); color: var(--accent-primary);
    border-radius: 6px; display: flex; align-items: center; justify-content: center;
}

.gallery-grid { padding: 24px; display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; overflow-y: auto; flex: 1; }
.card { background: var(--bg-card); border: 1px solid var(--border-light); border-radius: var(--radius-md); overflow: hidden; position: relative; aspect-ratio: 1; transition: 0.2s; }
.card:hover { transform: translateY(-4px); border-color: var(--text-muted); }
.card img { width: 100%; height: 100%; object-fit: cover; }
.card-overlay {
    position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent 60%);
    opacity: 0; transition: 0.2s; display: flex; flex-direction: column; justify-content: flex-end; padding: 16px;
}
.card:hover .card-overlay { opacity: 1; }
.action-btn {
    background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2);
    color: white; padding: 6px 12px; border-radius: 6px; font-size: 11px;
    cursor: pointer; backdrop-filter: blur(4px);
}
.action-btn:hover { background: white; color: black; }
.empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 60vh; color: var(--text-dim); text-align: center; }
.empty-icon { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.3; }

/* Toast */
.toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 200; display: flex; flex-direction: column; gap: 10px; }
.toast {
    background: var(--bg-panel); border: 1px solid var(--border-light);
    border-left: 4px solid var(--accent-primary); padding: 16px 20px;
    border-radius: 8px; display: flex; align-items: center; gap: 12px;
    box-shadow: var(--shadow-lg); animation: slideUp 0.3s ease-out; min-width: 300px;
}
.toast.success { border-left-color: var(--accent-success); }
.toast.error { border-left-color: var(--accent-error); }

/* Ratio Grid */
.ratio-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
.ratio-card {
    background: var(--bg-element); border: 1px solid var(--border-light);
    border-radius: 6px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s;
}
.ratio-card:hover { border-color: var(--text-muted); }
.ratio-card.active { border-color: var(--text-main); background: var(--bg-active); }
.ratio-icon { width: 24px; height: 18px; border: 2px solid var(--text-muted); margin: 0 auto 4px; border-radius: 2px; opacity: 0.5; }
.ratio-card.active .ratio-icon { border-color: var(--text-main); opacity: 1; }
.ratio-label { font-size: 11px; color: var(--text-muted); font-weight: 600; font-family: var(--font-heading); }

</style>
</head>
<body>

<header>
    <div class="brand">
        <div class="brand-icon">S</div>
        <div>
            <div class="brand-text">Sulandra Studio</div>
            <div style="font-size:11px; color:var(--text-muted);">Enterprise Edition v2.5</div>
        </div>
    </div>
    <nav class="nav-links">
        <a href="index.html" class="nav-link">Dashboard</a>
        <a href="image.html" class="nav-link active">Creative Lab</a>
        <a href="studio.html" class="nav-link">Timeline</a>
    </nav>
    <div class="user-menu">
        <div class="credits-pill"><div class="credits-val">‚àû</div> credits</div>
        <div class="avatar">U</div>
    </div>
</header>

<div class="workspace">
    
    <div class="nav-rail">
        <div class="rail-btn active" onclick="switchLab('image')" title="Image Lab">
            <div class="rail-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div>
            <div class="rail-label">Image</div>
        </div>
        <div class="rail-btn" onclick="switchLab('video')" title="Video Lab">
            <div class="rail-icon"><svg viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg></div>
            <div class="rail-label">Video</div>
        </div>
        <div class="rail-btn" onclick="switchLab('film')" title="Short Film">
            <div class="rail-icon"><svg viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="20" rx="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/></svg></div>
            <div class="rail-label">Film</div>
        </div>
        <div class="rail-btn" onclick="window.location.href='music.html'" title="Music">
            <div class="rail-icon"><svg viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></div>
            <div class="rail-label">Music</div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-title" id="sidebar-title">Image Generation</span>
        </div>
        <div class="sidebar-scroll">
            
            <div id="ctrl-image">
                <div class="tabs mb-4">
                    <div class="tab active" onclick="setImageMode('txt2img', this)">Text to Image</div>
                    <div class="tab" onclick="setImageMode('img2img', this)">Image Reference</div>
                </div>

                <div id="upload-section-img" class="hidden">
                    <div class="label">Reference Image</div>
                    <input type="file" id="file-img" hidden accept="image/*" onchange="handleFile(this, 'img')">
                    <div class="upload-zone" id="drop-img" onclick="document.getElementById('file-img').click()">
                        <img id="preview-img" class="preview-img hidden">
                        <div style="text-align:center">
                            <div style="font-size:24px; color:var(--text-muted); margin-bottom:4px;">üìÇ</div>
                            <div class="text-xs text-muted">Click to Upload</div>
                        </div>
                    </div>
                    <div class="flex justify-between mt-2" style="margin-top:8px;">
                        <span class="text-xs text-muted">Influence</span>
                        <input type="range" id="strength" min="0.1" max="1.0" step="0.05" value="0.75" style="width:60%">
                    </div>
                </div>

                <div style="margin-top:16px;">
                    <div class="label">
                        <span>Prompt <span style="opacity:0.5; font-weight:400;">Required</span></span>
                        <button class="btn-sia" onclick="openSIA('prompt-img')">‚ú® Ask SIA</button>
                    </div>
                    <textarea id="prompt-img" placeholder="Describe your image... e.g. Cinematic shot of Lagos..." style="min-height:120px;"></textarea>
                </div>

                <div style="margin-top:16px;">
                    <div class="label">Aspect Ratio</div>
                    <div class="ratio-grid">
                        <div class="ratio-card active" onclick="setRatio(1024, 1024, this)"><div class="ratio-icon" style="width:18px;height:18px;"></div><div class="ratio-label">1:1</div></div>
                        <div class="ratio-card" onclick="setRatio(1280, 720, this)"><div class="ratio-icon" style="width:24px;height:14px;"></div><div class="ratio-label">16:9</div></div>
                        <div class="ratio-card" onclick="setRatio(720, 1280, this)"><div class="ratio-icon" style="width:14px;height:24px;"></div><div class="ratio-label">9:16</div></div>
                    </div>
                </div>
                <button class="btn-gen" onclick="generate('image')" style="margin-top:32px;">Generate Image</button>
            </div>

            <div id="ctrl-video" class="hidden">
                <div class="tabs mb-4">
                    <div class="tab active" onclick="setVideoMode('text', this)">Text to Video</div>
                    <div class="tab" onclick="setVideoMode('image', this)">Image to Video</div>
                </div>
                <div id="upload-group-vid" class="hidden">
                    <div class="label">Source Image</div>
                    <input type="file" id="file-vid" hidden accept="image/*" onchange="handleFile(this, 'vid')">
                    <div class="upload-zone" id="drop-vid" onclick="document.getElementById('file-vid').click()">
                        <img id="preview-vid" class="preview-img hidden">
                        <div style="text-align:center"><div style="font-size:24px; color:var(--text-muted); margin-bottom:4px;">üé¨</div><div class="text-xs text-muted">Upload Frame</div></div>
                    </div>
                </div>
                <div style="margin-top:16px;">
                    <div class="label">
                        <span>Prompt</span>
                        <button class="btn-sia" onclick="openSIA('prompt-vid')">‚ú® Ask SIA</button>
                    </div>
                    <textarea id="prompt-vid" class="text-input" placeholder="Describe motion... e.g. Camera pans slowly left" style="min-height:120px;"></textarea>
                </div>
                <button class="btn-gen" onclick="generate('video')" style="margin-top:32px;">Generate Video</button>
            </div>

            <div id="ctrl-film" class="hidden">
                <div class="label"><span>Scene Storyboard</span><span style="opacity:0.5">Max 20</span></div>
                <div class="storyboard-container">
                    <input type="file" id="file-scene" hidden multiple accept="image/*" onchange="handleSceneUpload(this)">
                    <div class="storyboard-grid" id="sb-grid">
                        <div class="scene-card" onclick="document.getElementById('file-scene').click()" style="display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.05);">
                            <span style="font-size:24px; color:var(--text-muted);">+</span>
                        </div>
                    </div>
                </div>
                <div id="scene-editor" class="scene-editor">
                    <div class="label" style="margin-bottom:4px;">
                        Selected Scene Prompt
                        <button class="btn-sia" onclick="openSIA('scene-prompt')">‚ú® Ask SIA</button>
                    </div>
                    <textarea id="scene-prompt" class="text-input" style="min-height:60px;" placeholder="Describe this specific shot..."></textarea>
                    <div class="flex justify-between mt-2" style="margin-top:8px;">
                        <button class="action-btn" onclick="saveScenePrompt()">Save</button>
                        <button class="action-btn" style="color:#ef4444; border-color:#ef4444;" onclick="deleteScene()">Delete</button>
                    </div>
                </div>
                <div style="margin-top:24px;">
                    <div class="label">
                        <span>Global Film Prompt</span>
                        <button class="btn-sia" onclick="openSIA('global-prompt')">‚ú® Ask SIA</button>
                    </div>
                    <textarea id="global-prompt" class="text-input" placeholder="Overall movie style and pacing..." style="min-height:80px;"></textarea>
                    
                    <div class="label" style="margin-top:16px;">
                        <span>Script / Screenplay</span>
                        <button class="btn-sia" onclick="openSIA('script-text')">‚ú® Ask SIA to Write</button>
                    </div>
                    <textarea id="script-text" class="text-input" placeholder="Paste your script here..." style="min-height:100px; margin-bottom:8px;"></textarea>
                    
                    <div class="upload-zone" style="height:60px; border-style:dotted;" onclick="alert('Upload PDF/Doc')">
                        <span class="text-xs text-muted">Drop PDF / Doc / Screenshot</span>
                    </div>
                    
                    <div class="label" style="margin-top:16px;">Audio Track</div>
                    <button class="btn-secondary w-full" style="padding:10px; border-radius:8px; background:var(--bg-element); color:var(--text-main); border:1px solid var(--border-light); cursor:pointer;" onclick="toggleAudioPanel()">üéµ Import from Music Lab</button>
                    <div id="audio-status" class="text-xs text-muted mt-2 hidden">Selected: <span id="audio-name" style="color:white"></span></div>
                </div>
                <button class="btn-gen" onclick="generate('film')" style="margin-top:32px;">Render Short Film</button>
            </div>
        </div>
    </div>

    <div class="stage">
        <div class="stage-toolbar">
            <div class="view-tabs">
                <div class="view-tab active" onclick="reloadGallery()">My Generations</div>
                <div class="view-tab">Community Feed</div>
            </div>
            <button class="action-btn" onclick="reloadGallery()">‚Üª</button>
        </div>
        <div class="stage-scroll">
            <div class="grid" id="gallery-grid">
                <div class="empty-state" id="empty-state">
                    <svg class="empty-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                    <h3>Ready to Create</h3><p>Select a tool on the left to begin.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="audio-panel" id="audio-panel">
    <div style="padding:20px; border-bottom:1px solid var(--border-light); display:flex; justify-content:space-between; align-items:center;">
        <span class="font-bold font-heading">Music Library</span>
        <button onclick="toggleAudioPanel()" style="background:none; border:none; color:white; cursor:pointer;">‚úï</button>
    </div>
    <div class="audio-list">
        <div class="audio-item" ondblclick="selectAudio('Afrobeat Chill', 'Summer Vibes')">
            <div class="audio-icon">üéµ</div>
            <div><div class="font-bold text-xs">Afrobeat Chill</div><div class="text-xs text-muted">Album: Summer Vibes</div></div>
        </div>
        <div class="audio-item" ondblclick="selectAudio('Cinematic Tension', 'Film Scores')">
            <div class="audio-icon">üéª</div>
            <div><div class="font-bold text-xs">Cinematic Tension</div><div class="text-xs text-muted">Album: Film Scores</div></div>
        </div>
    </div>
</div>

<div class="sia-overlay" id="sia-overlay">
    <div class="sia-window">
        <div class="sia-header">
            <div class="sia-title"><span class="sia-icon-lg">‚ú®</span> SIA Mentor</div>
            <div class="sia-close" onclick="closeSIA()">‚úï</div>
        </div>
        <div class="sia-body" id="sia-chat-body">
            <div class="chat-bubble sia">Hello! What can I help you with today? I can improve your prompts, write scripts, or suggest scene ideas.</div>
        </div>
        <div class="sia-footer">
            <div class="sia-input-row">
                <input type="text" id="sia-input" placeholder="Ask SIA anything..." onkeypress="handleSiaEnter(event)">
                <button class="btn-gen" style="width:auto; padding:8px 16px;" onclick="siaSendMessage()">Send</button>
            </div>
            <button id="sia-apply-btn" class="sia-apply-btn" onclick="siaApply()">Apply to Input</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toast-container"></div>

<script>
const API_URL = "https://pm37tp93i3bbci-9000.proxy.runpod.net";
let state = { lab:'image', imgMode:'txt2img', vidMode:'text', width:1024, height:1024, imageBase64:null, videoBase64:null, scenes:[], selectedSceneIdx:-1, audio:null };
let currentSiaTarget = null; // ID of input element SIA is helping with
let lastSiaResponse = "";

window.onload = () => { loadHistory(); switchLab('image'); };

function switchLab(lab) {
    state.lab = lab;
    document.querySelectorAll('.rail-btn').forEach(b => b.classList.remove('active'));
    if(lab === 'image') document.querySelectorAll('.rail-btn')[0].classList.add('active');
    if(lab === 'video') document.querySelectorAll('.rail-btn')[1].classList.add('active');
    if(lab === 'film') document.querySelectorAll('.rail-btn')[2].classList.add('active');
    ['ctrl-image', 'ctrl-video', 'ctrl-film'].forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById(`ctrl-${lab}`).classList.remove('hidden');
    document.getElementById('sidebar-title').innerText = lab === 'image' ? 'Image Generation' : lab === 'video' ? 'Video Generation' : 'Short Film Studio';
}

function setImageMode(mode, btn) {
    state.imgMode = mode;
    document.querySelectorAll('#ctrl-image .tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const upload = document.getElementById('upload-section-img');
    mode === 'img2img' ? upload.classList.remove('hidden') : upload.classList.add('hidden');
}

function setRatio(w, h, btn) {
    state.width = w; state.height = h;
    document.querySelectorAll('.ratio-card').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

function handleFile(input, type) {
    if(!input.files[0]) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const res = e.target.result;
        if(type === 'img') {
            state.imageBase64 = res;
            const img = document.getElementById('preview-img');
            img.src = res; img.classList.remove('hidden');
            document.getElementById('drop-img').classList.add('active');
            if(state.imgMode !== 'img2img') document.querySelectorAll('#ctrl-image .tab')[1].click();
        } else {
            state.videoBase64 = res;
            const img = document.getElementById('preview-vid');
            img.src = "https://via.placeholder.com/300x200?text=Video+File"; 
            img.classList.remove('hidden');
        }
    };
    reader.readAsDataURL(input.files[0]);
}

function setVideoMode(mode, btn) {
    state.vidMode = mode;
    document.querySelectorAll('#ctrl-video .tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const upload = document.getElementById('upload-group-vid');
    mode === 'image' ? upload.classList.remove('hidden') : upload.classList.add('hidden');
}

function handleSceneUpload(input) {
    if(!input.files) return;
    Array.from(input.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => { state.scenes.push({ src: e.target.result, prompt: "" }); renderStoryboard(); };
        reader.readAsDataURL(file);
    });
    input.value = "";
}

function renderStoryboard() {
    const grid = document.getElementById('sb-grid');
    const addBtn = grid.lastElementChild;
    grid.innerHTML = '';
    state.scenes.forEach((scene, idx) => {
        const div = document.createElement('div');
        div.className = `scene-card ${idx === state.selectedSceneIdx ? 'active' : ''}`;
        div.draggable = true;
        div.onclick = () => selectScene(idx);
        div.innerHTML = `<img src="${scene.src}"><div class="scene-badge">${idx + 1}</div><div class="scene-delete" onclick="event.stopPropagation(); deleteScene(${idx})">‚úï</div>`;
        div.ondragstart = (e) => { e.dataTransfer.setData("text/plain", idx); div.classList.add('dragging'); };
        div.ondragend = () => div.classList.remove('dragging');
        div.ondragover = (e) => e.preventDefault();
        div.ondrop = (e) => {
            e.preventDefault();
            const fromIdx = parseInt(e.dataTransfer.getData("text/plain"));
            const item = state.scenes.splice(fromIdx, 1)[0];
            state.scenes.splice(idx, 0, item);
            renderStoryboard();
        };
        grid.appendChild(div);
    });
    grid.appendChild(addBtn);
}

function selectScene(idx) {
    state.selectedSceneIdx = idx;
    document.getElementById('scene-editor').classList.add('visible');
    document.getElementById('scene-prompt').value = state.scenes[idx].prompt;
    renderStoryboard();
}

function saveScenePrompt() {
    if (state.selectedSceneIdx > -1) {
        state.scenes[state.selectedSceneIdx].prompt = document.getElementById('scene-prompt').value;
        showToast("Scene Prompt Saved", "success");
    }
}

function deleteScene(idx) {
    if(idx !== undefined) {
        state.scenes.splice(idx, 1);
        state.selectedSceneIdx = -1;
        document.getElementById('scene-editor').classList.remove('visible');
        renderStoryboard();
    }
}

function toggleAudioPanel() { document.getElementById('audio-panel').classList.toggle('open'); }
function selectAudio(name, album) {
    state.audio = name;
    document.getElementById('audio-name').innerText = name;
    document.getElementById('audio-status').classList.remove('hidden');
    toggleAudioPanel();
    showToast(`Attached: ${name}`, "success");
}

async function generate(type) {
    let prompt = "", payload = {}, endpoint = "/api/image/txt2img";
    if (type === 'image') {
        prompt = document.getElementById('prompt-img').value;
        payload = { prompt, width: state.width, height: state.height, steps: 25, guidance: 3.5 };
        if (state.imgMode === 'img2img' && state.imageBase64) {
            payload.image_base64 = state.imageBase64;
            payload.strength = parseFloat(document.getElementById('strength').value);
        }
    } else if (type === 'video') {
        prompt = document.getElementById('prompt-vid').value;
        showToast("Video API coming next...", "warning"); return;
    } else if (type === 'film') {
        if (state.scenes.length === 0) return showToast("Add scenes first!", "error");
        showToast(`Rendering ${state.scenes.length} scenes...`, "info"); return;
    }
    if (!prompt && type === 'image') return showToast("Enter a prompt", "error");

    const btn = document.querySelector('#ctrl-image .btn-gen');
    btn.innerText = "GENERATING..."; btn.disabled = true;
    showToast("Sending to H200...", "loading");

    try {
        const res = await fetch(API_URL + endpoint, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
        const data = await res.json();
        if (data.status === "success") {
            showToast("Success!", "success");
            addToGallery(API_URL + data.image_url, prompt);
            saveHistory(API_URL + data.image_url, prompt);
        } else { showToast("Error: " + data.message, "error"); }
    } catch (e) { console.error(e); showToast("Connection Failed", "error"); } 
    finally { btn.innerText = "GENERATE IMAGE"; btn.disabled = false; }
}

function addToGallery(url, prompt) {
    document.getElementById('empty-state').classList.add('hidden');
    const grid = document.getElementById('gallery-grid');
    const div = document.createElement('div');
    div.className = "card";
    div.innerHTML = `<img src="${url}" onclick="window.open('${url}')"><div class="card-overlay"><div class="text-xs text-white opacity-80 mb-2 line-clamp-2">${prompt.substring(0,30)}...</div><button class="action-btn" onclick="window.open('${url}')">‚¨á</button></div>`;
    grid.prepend(div);
}

function saveHistory(url, prompt) {
    const hist = JSON.parse(localStorage.getItem('sulandra_v2_hist') || '[]');
    hist.unshift({ url, prompt });
    localStorage.setItem('sulandra_v2_hist', JSON.stringify(hist));
}

function loadHistory() {
    const hist = JSON.parse(localStorage.getItem('sulandra_v2_hist') || '[]');
    hist.forEach(item => addToGallery(item.url, item.prompt));
}

function reloadGallery() {
    document.getElementById('gallery-grid').innerHTML = '';
    loadHistory();
}

function showToast(msg, type) {
    const con = document.getElementById('toast-container');
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    let icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'loading' ? '<div class="spinner"></div>' : '‚ÑπÔ∏è';
    el.innerHTML = `<span style="font-size:16px;">${icon}</span><span>${msg}</span>`;
    con.appendChild(el);
    setTimeout(() => el.remove(), 4000);
}

/* -------------------------------------------------------------------------- */
/* SIA CHAT LOGIC                                                             */
/* -------------------------------------------------------------------------- */
function openSIA(targetId) {
    currentSiaTarget = targetId;
    document.getElementById('sia-overlay').classList.add('visible');
    // Reset chat
    const body = document.getElementById('sia-chat-body');
    body.innerHTML = '<div class="chat-bubble sia">Hello! What can I help you with today? I can improve your prompts, write scripts, or suggest scene ideas.</div>';
    document.getElementById('sia-apply-btn').style.display = 'none';
}

function closeSIA() { document.getElementById('sia-overlay').classList.remove('visible'); }

function handleSiaEnter(e) { if(e.key === 'Enter') siaSendMessage(); }

function siaSendMessage() {
    const input = document.getElementById('sia-input');
    const msg = input.value.trim();
    if(!msg) return;
    
    const body = document.getElementById('sia-chat-body');
    body.innerHTML += `<div class="chat-bubble user">${msg}</div>`;
    input.value = "";
    body.scrollTop = body.scrollHeight;

    // Simulate AI Response
    setTimeout(() => {
        let reply = "I can help with that! Here is a refined version:";
        let result = msg + ", highly detailed, cinematic lighting, 8k resolution, photorealistic, trending on artstation";
        
        // Logic for Script vs Prompt
        if(currentSiaTarget === 'script-text') {
             reply = "Here is a dramatic scene draft based on your idea:";
             result = `SCENE 1. INT. SPACESHIP - DAY\n\nThe alarm BLARES. CAPTAIN JARA (30s) sprints down the corridor.\n\nJARA\nWe have to jump NOW!\n\nShe dives into the pilot seat. Stars streak past the window.`;
        }

        lastSiaResponse = result;
        body.innerHTML += `<div class="chat-bubble sia">${reply}<br><br><strong>${result}</strong></div>`;
        body.scrollTop = body.scrollHeight;
        document.getElementById('sia-apply-btn').style.display = 'block';
    }, 1000);
}

function siaApply() {
    if(currentSiaTarget && lastSiaResponse) {
        document.getElementById(currentSiaTarget).value = lastSiaResponse;
        showToast("SIA Suggestion Applied", "success");
        closeSIA();
    }
}
</script>
</body>
</html>
