<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sulandra AI Studio ‚Äì SOUND DAW (Ultimate)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* =========================================
       1. CORE VISUALS (ORIGINAL PRESERVED)
       ========================================= */
    :root {
      --bg-deep: #020419; --bg-surface: #050b2a; --bg-panel: #071134;
      --border-soft: rgba(129,166,255,0.25); --accent: #7cffc7; --accent2: #ff7cf1;
      --accent3: #ffd77c; --accent4: #7cbeff; --text-main: #f7fbff; --text-muted: #9cb3ff;
      --grid-line: rgba(167,194,255,0.18); --beat-width: 48px; --track-height: 40px;
    }
    * { box-sizing: border-box; }
    body { margin: 0; min-height: 100vh; font-family: system-ui, -apple-system, sans-serif; background: radial-gradient(circle at 0 0,#2744ff 0,transparent 45%), radial-gradient(circle at 100% 0,#ff3ccf 0,transparent 45%), #020419; color: var(--text-main); display: flex; flex-direction: column; overflow: hidden; user-select: none; }
    
    /* HEADER */
    header { background: linear-gradient(to bottom,rgba(10,20,70,0.98),rgba(4,8,35,0.98)); border-bottom: 1px solid rgba(0,0,0,0.9); z-index: 20; }
    .header-inner { max-width: 1440px; margin: 0 auto; padding: 4px 14px 6px; display: flex; align-items: center; justify-content: space-between; }
    .brand-left { display: flex; align-items: center; gap: 10px; }
    .brand-logo { width: 30px; height: 30px; border-radius: 10px; background: conic-gradient(from 120deg,#7cffc7,#7cbeff,#ff7cf1,#ffd77c,#7cffc7); display: flex; align-items: center; justify-content: center; color: #01030d; font-weight: 900; }
    .brand-text-main { font-size: 13px; text-transform: uppercase; letter-spacing: .16em; color: transparent; background: linear-gradient(to right,#7cffc7,#ffd77c,#ff7cf1,#7cbeff); -webkit-background-clip: text; }
    .brand-sound-pill { padding: 3px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.12); background: radial-gradient(circle at 0 0,#3f7cff,#050b2a); font-size: 10px; text-transform: uppercase; letter-spacing: .18em; color: var(--accent); box-shadow: 0 0 14px rgba(61,124,255,0.9); }
    .session-pill { padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(0,0,0,0.8); background: radial-gradient(circle at 0 0,#2135ff,#050b1a); display: flex; align-items: center; gap: 6px; font-size: 10px; }
    .session-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 8px rgba(124,255,199,0.9); }

    /* MAIN LAYOUT */
    main { flex: 1; max-width: 1440px; margin: 6px auto; padding: 0 10px 12px; display: flex; flex-direction: column; gap: 6px; width: 100%; }
    
    /* ICONS DOCK */
    .icon-dock { border-radius: 7px; border: 1px solid rgba(0,0,0,0.9); background: linear-gradient(to right,rgba(7,17,52,0.96),rgba(7,11,45,0.98)); padding: 4px 10px; display: flex; justify-content: space-between; font-size: 11px; }
    .dock-icon { width: 30px; height: 30px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; cursor: pointer; background: #071134; transition: 0.2s; }
    .dock-icon.active { border-color: #fff; box-shadow: 0 0 12px rgba(255,255,255,0.3); transform: translateY(-2px); }
    .dock-icon-labels { display: flex; gap: 10px; color: var(--text-muted); }

    /* GRID & PANELS */
    .main-grid { display: grid; grid-template-columns: 260px minmax(0,1fr) 220px; min-height: 450px; border-radius: 9px; border: 1px solid #000; background: #050821; overflow: hidden; }
    
    /* BROWSER */
    .left-browser { background: linear-gradient(to bottom,#050b2a,#020319); border-right: 1px solid #000; display: flex; flex-direction: column; }
    .panel-header { padding: 4px 8px; border-bottom: 1px solid #000; background: linear-gradient(to bottom,#091650,#050a28); display: flex; justify-content: space-between; font-size: 11px; }
    .browser-item { padding: 4px 8px; display: flex; justify-content: space-between; cursor: pointer; font-size: 11px; color: #9cb3ff; }
    .browser-item:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .browser-section-title { font-size: 9px; text-transform: uppercase; color: #7cbeff; margin: 8px 8px 2px; letter-spacing: 0.1em; }

    /* TIMELINE */
    .center-timeline-wrap { display: flex; flex-direction: column; border-right: 1px solid #000; position: relative; }
    .timeline-header { padding: 4px; background: #091650; border-bottom: 1px solid #000; }
    .timeline-screen { background: #02030f; padding: 4px; display: flex; justify-content: center; }
    .screen-grid { display: flex; gap: 6px; }
    .screen-box { background: #02041b; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 4px 8px; min-width: 100px; text-align: center; }
    .screen-label { font-size: 9px; color: #999; text-transform: uppercase; }
    .screen-value { font-family: monospace; color: #fff; font-size: 12px; letter-spacing: 1px; }
    
    .timeline-row-top { display: flex; justify-content: space-between; padding: 4px 8px; align-items: center; }
    .transport-btn { width: 24px; height: 24px; border-radius: 50%; border: 1px solid #333; background: #222; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .transport-btn.active { border-color: #7cffc7; box-shadow: 0 0 10px #7cffc7; background: #444; }
    .transport-btn.rec.active { border-color: #ff0000; box-shadow: 0 0 10px #ff0000; background: #550000; }

    /* MAIN TRACK AREA */
    .timeline-main { flex: 1; display: grid; grid-template-columns: 200px minmax(0,1fr) 14px; overflow: hidden; }
    
    .track-list { background: #050a28; border-right: 1px solid #000; overflow: hidden; position: relative; }
    .track-header { 
      height: 40px; display: flex; align-items: center; justify-content: space-between; 
      padding: 0 6px; border-bottom: 1px solid rgba(255,255,255,0.05); background: rgba(7,14,60,0.96);
    }
    .track-header:hover { background: rgba(20,30,80,1); }
    .track-rec-icon { width: 10px; height: 10px; border-radius: 50%; background: #330000; border: 1px solid #550000; cursor: pointer; margin-right: 6px; }
    .track-rec-icon.armed { background: #ff0000; box-shadow: 0 0 8px #ff0000; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { opacity:1; } 100% { opacity:0.5; } }
    .track-name { font-size: 11px; color: #fff; cursor: text; flex: 1; white-space: nowrap; overflow: hidden; }
    .track-menu-btn { font-size: 16px; color: #777; cursor: pointer; padding: 0 4px; }
    .track-menu-btn:hover { color: #fff; }

    .timeline-grid-wrap { overflow: auto; background: #050822; position: relative; }
    .grid-inner { position: relative; background-image: linear-gradient(to right, rgba(255,255,255,0.05) 1px, transparent 1px); background-size: var(--beat-width) 100%; height: 1000px; }
    .grid-track-row { height: 40px; border-bottom: 1px solid rgba(255,255,255,0.05); position: relative; }
    .playhead { position: absolute; top: 0; height: 100%; width: 1px; background: #ffd77c; z-index: 10; pointer-events: none; box-shadow: 0 0 5px #ffd77c; }
    
    .clip { 
      position: absolute; height: 32px; top: 4px; border-radius: 4px; 
      background: linear-gradient(135deg, #3d7cff, #7cbeff); 
      border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      overflow: hidden; cursor: move; font-size: 10px; color: #000; display: flex; align-items: center; padding-left: 4px;
    }

    /* BOTTOM DOCK (MIXER) - COMPLEX STYLING RESTORED */
    .bottom-dock { height: 240px; display: flex; flex-direction: column; border-top: 1px solid #000; background: #020419; display: none; }
    .bottom-panels { flex: 1; overflow: hidden; }
    .mixer-strips { display: flex; height: 100%; padding: 10px; gap: 6px; overflow-x: auto; background: #050815; }
    
    .mixer-strip { 
      width: 60px; flex-shrink: 0; background: #071425; border-radius: 4px; border: 1px solid #222;
      display: flex; flex-direction: column; align-items: center; padding: 4px;
    }
    .mixer-strip-title { font-size: 9px; color: #fff; margin-bottom: 4px; white-space: nowrap; overflow: hidden; width: 100%; text-align: center; }
    .mixer-fader-area { flex: 1; width: 100%; position: relative; display: flex; justify-content: center; background: #030612; border-radius: 10px; margin: 4px 0; }
    .mixer-fader-track { width: 2px; background: #333; height: 100%; }
    .mixer-fader-cap { 
      width: 30px; height: 15px; background: linear-gradient(#ccc, #666); 
      border-radius: 2px; position: absolute; bottom: 70%; left: 50%; transform: translateX(-50%); cursor: ns-resize; box-shadow: 0 2px 4px #000;
    }
    .mixer-meter { width: 6px; height: 100%; background: #111; position: absolute; right: 4px; border-radius: 3px; overflow: hidden; }
    .mixer-meter-val { width: 100%; background: linear-gradient(to top, #0f0, #ff0, #f00); height: 0%; position: absolute; bottom: 0; transition: height 0.05s; }

    /* CONTEXT MENUS & POPUPS */
    .ctx-menu { position: fixed; background: #0c101f; border: 1px solid #444; border-radius: 6px; padding: 4px 0; width: 160px; z-index: 9999; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
    .ctx-item { padding: 6px 12px; font-size: 11px; color: #ddd; cursor: pointer; display: flex; justify-content: space-between; position: relative; }
    .ctx-item:hover { background: #3d7cff; color: #fff; }
    .ctx-separator { height: 1px; background: #333; margin: 4px 0; }
    .ctx-submenu { position: absolute; left: 100%; top: -4px; width: 140px; background: #0c101f; border: 1px solid #444; display: none; border-radius: 6px; }
    .ctx-item:hover .ctx-submenu { display: block; }

    /* AI MODAL */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: none; align-items: center; justify-content: center; }
    .modal-box { width: 500px; background: #101526; border: 1px solid #333; border-radius: 12px; padding: 20px; color: #fff; box-shadow: 0 0 50px rgba(124,190,255,0.2); }
    .modal-input { width: 100%; background: #050712; border: 1px solid #333; color: #fff; padding: 10px; margin: 8px 0; border-radius: 6px; }
    .modal-btn { width: 100%; padding: 12px; background: linear-gradient(120deg, #ff5af1, #45f1ff); border: none; border-radius: 20px; font-weight: bold; margin-top: 12px; cursor: pointer; }
  </style>
</head>
<body>

<input type="file" id="file-import-input" accept="audio/*,.mid" hidden />

<div id="trackCtxMenu" class="ctx-menu">
  <div class="ctx-item" onclick="renameActiveTrack()">Rename Track</div>
  <div class="ctx-item">
    <span>Set Type</span> <span>‚ñ∂</span>
    <div class="ctx-submenu">
      <div class="ctx-item" onclick="setTrackType('Audio')">Audio</div>
      <div class="ctx-item" onclick="setTrackType('Instrument')">Instrument</div>
      <div class="ctx-item" onclick="setTrackType('FX')">FX Channel</div>
    </div>
  </div>
  <div class="ctx-separator"></div>
  <div class="ctx-item" onclick="uploadToActiveTrack()">Upload Here...</div>
  <div class="ctx-item">
    <span>Record Input</span> <span>‚ñ∂</span>
    <div class="ctx-submenu">
      <div class="ctx-item" onclick="armTrack('Mic')">Microphone</div>
      <div class="ctx-item" onclick="armTrack('MIDI')">MIDI</div>
      <div class="ctx-item" onclick="armTrack('None')">None</div>
    </div>
  </div>
  <div class="ctx-separator"></div>
  <div class="ctx-item" style="color:#ff5af1;" onclick="openAiModal()">‚ú® Create with AI</div>
</div>

<div id="aiModal" class="modal-overlay">
  <div class="modal-box">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
      <h2 style="margin:0; color:#ff5af1;">AI Music Lab</h2>
      <span style="cursor:pointer;" onclick="closeAiModal()">‚úï</span>
    </div>
    <p style="font-size:12px; color:#999;">Generate audio synced to your project (130 BPM).</p>
    
    <label style="font-size:11px; color:#9cb3ff;">PROMPT</label>
    <input type="text" id="aiPrompt" class="modal-input" placeholder="e.g. Lofi drums, Female vocal hook...">
    
    <div style="display:flex; gap:10px;">
        <div style="flex:1;">
            <label style="font-size:11px; color:#9cb3ff;">TYPE</label>
            <select id="aiType" class="modal-input">
                <option value="loop">Loop (4 Bars)</option>
                <option value="one-shot">One Shot</option>
                <option value="vocal">Vocal</option>
            </select>
        </div>
        <div style="flex:1;">
            <label style="font-size:11px; color:#9cb3ff;">MODEL</label>
            <select class="modal-input"><option>Sulandra V3</option></select>
        </div>
    </div>
    <button class="modal-btn" id="aiGenBtn" onclick="generateAiClip()">GENERATE & IMPORT</button>
  </div>
</div>

<header>
  <div class="header-inner">
    <div class="brand-left">
      <div class="brand-logo">S</div>
      <div class="brand-text-main">Sulandra Creative Studio</div>
      <div class="brand-sound-pill">Sound</div>
    </div>
    <div class="top-right">
      <div class="session-pill"><div class="session-dot"></div><span>Untitled Project</span></div>
    </div>
  </div>
</header>

<main>
  <section class="icon-dock">
    <div class="icon-row">
      <div class="dock-icon active" onclick="toggleBrowser()" title="File">F</div>
      <div class="dock-icon" onclick="toggleBottom('rack')" title="Rack">R</div>
      <div class="dock-icon" onclick="toggleBottom('mixer')" title="Mixer">M</div>
      <div class="dock-icon" onclick="toggleBottom('piano')" title="Piano">P</div>
      <div class="dock-icon active" title="Timeline">T</div>
    </div>
  </section>

  <section class="main-grid">
    <aside class="left-browser" id="browserPanel">
      <div class="panel-header"><div class="panel-title">Browser</div></div>
      <div class="browser-scroll">
        <div class="browser-section-title">Project</div>
        <div class="browser-item"><span>History</span></div>
        <div class="browser-section-title">Packs</div>
        <div class="browser-item"><span>Drums</span></div>
        <div class="browser-item"><span>Instruments</span></div>
        <div class="browser-section-title">User</div>
        <div class="browser-item" id="btn-upload-device">
            <span style="color:#7cffc7;">Upload from Device</span><span>üìÇ</span>
        </div>
      </div>
    </aside>

    <section class="center-timeline-wrap">
      <div class="timeline-header">
        <div class="timeline-screen">
          <div class="screen-grid">
            <div class="screen-box"><div class="screen-label">Time</div><div class="screen-value" id="screen-time">00:00</div></div>
            <div class="screen-box"><div class="screen-label">BPM</div><div class="screen-value">130.0</div></div>
          </div>
        </div>
        <div class="timeline-row-top">
            <div class="transport-buttons">
                <button class="transport-btn" onclick="togglePlay()" id="btn-play">‚ñ∂</button>
                <button class="transport-btn" onclick="stopPlay()">‚èπ</button>
                <button class="transport-btn rec">‚óè</button>
            </div>
            <div class="zoom-pill" style="display:flex; gap:5px; align-items:center; font-size:10px;">
                <span>Zoom</span><input type="range" id="zoom-range" min="20" max="100" value="48">
            </div>
        </div>
      </div>

      <div class="timeline-main">
        <div class="track-list" id="track-list">
            </div>
        <div class="timeline-grid-wrap" id="grid-wrap">
            <div class="grid-inner" id="grid-inner">
                <div class="playhead" id="playhead"></div>
                </div>
        </div>
      </div>
    </section>

    <aside class="right-placeholder" style="background:#050b2a; border-left:1px solid #000; padding:10px;">
      <h3 style="font-size:11px; color:#ff7cf1;">FX Slots</h3>
      <div style="font-size:10px; color:#777;">Select a track to view effects</div>
    </aside>
  </section>

  <section class="bottom-dock" id="bottom-dock">
    <div style="background:#091650; padding:4px; border-bottom:1px solid #000; font-size:11px;">Mixer</div>
    <div class="mixer-strips" id="mixer-strips">
        </div>
  </section>
</main>

<script>
/* ============================================================
   SULANDRA CORE ENGINE (PHASE 3 - ULTIMATE INTEGRATION)
   ============================================================ */

const ctx = new (window.AudioContext || window.webkitAudioContext)();
const STATE = {
    bpm: 130,
    zoom: 48,
    tracks: [],
    clips: [],
    nextTrackId: 1,
    nextClipId: 1,
    activeTrackId: null,
    isPlaying: false,
    startTime: 0,
    startBeat: 0
};

// DOM REFS
const dom = {
    trackList: document.getElementById('track-list'),
    gridInner: document.getElementById('grid-inner'),
    mixer: document.getElementById('mixer-strips'),
    ctxMenu: document.getElementById('trackCtxMenu'),
    fileInput: document.getElementById('file-import-input'),
    aiModal: document.getElementById('aiModal'),
    playhead: document.getElementById('playhead'),
    screenTime: document.getElementById('screen-time')
};

/* --- 1. INITIALIZATION --- */
function init() {
    // Create 5 Default Tracks
    for(let i=0; i<5; i++) addTrack(`Track ${i+1}`);
    
    // Grid visual
    updateGrid();
    
    // Global Click to close menus
    window.addEventListener('click', e => {
        if(!e.target.closest('.track-menu-btn') && !e.target.closest('.ctx-menu')) {
            dom.ctxMenu.style.display = 'none';
        }
    });

    // File Upload Listener
    dom.fileInput.addEventListener('change', handleFileUpload);
    
    // Global Upload Button
    document.getElementById('btn-upload-device').onclick = () => {
        alert("Please use the 3-dots menu on a specific track to upload content.");
    }
}

/* --- 2. TRACK & MIXER RENDERING (THE COMPLEX PART) --- */
function addTrack(name) {
    const track = {
        id: STATE.nextTrackId++,
        name: name,
        type: 'Audio',
        armed: false,
        color: getRandomColor(),
        vol: 0.8
    };
    STATE.tracks.push(track);
    renderTracks();
    renderMixer();
}

function renderTracks() {
    dom.trackList.innerHTML = '';
    STATE.tracks.forEach(t => {
        const div = document.createElement('div');
        div.className = 'track-header';
        div.innerHTML = `
            <div style="display:flex; align-items:center;">
                <div class="track-rec-icon ${t.armed?'armed':''}" onclick="toggleArm(${t.id})"></div>
                <div class="track-color-dot" style="background:${t.color}"></div>
                <div class="track-name" ondblclick="promptRename(${t.id})">${t.name}</div>
            </div>
            <div class="track-menu-btn" onclick="openTrackMenu(event, ${t.id})">‚ãÆ</div>
        `;
        dom.trackList.appendChild(div);
        
        // Ensure Grid Row Exists
        let row = document.querySelector(`.grid-track-row[data-id="${t.id}"]`);
        if(!row) {
            row = document.createElement('div');
            row.className = 'grid-track-row';
            row.dataset.id = t.id;
            dom.gridInner.appendChild(row);
        }
    });
    // Add "Add Track" button at bottom
    const btn = document.createElement('div');
    btn.innerHTML = '<button onclick="addTrack(\'New Track\')" style="width:100%; background:#222; color:#fff; border:none; padding:4px; cursor:pointer;">+ Add Track</button>';
    dom.trackList.appendChild(btn);
}

function renderMixer() {
    dom.mixer.innerHTML = '';
    STATE.tracks.forEach((t, i) => {
        const strip = document.createElement('div');
        strip.className = 'mixer-strip';
        // COMPLEX MIXER HTML STRUCTURE
        strip.innerHTML = `
            <div class="mixer-strip-title">${t.name}</div>
            <div style="font-size:8px; color:#666; margin-bottom:4px;">${t.type}</div>
            <div class="mixer-fader-area">
                <div class="mixer-meter"><div class="mixer-meter-val" id="meter-${t.id}"></div></div>
                <div class="mixer-fader-track"></div>
                <div class="mixer-fader-cap" id="fader-${t.id}" onmousedown="startFaderDrag(event, ${t.id})"></div>
            </div>
            <div style="font-size:9px; color:#fff; margin-top:4px;">Insert ${i+1}</div>
        `;
        dom.mixer.appendChild(strip);
    });
}

function getRandomColor() {
    const c = ['#7cffc7','#ff7cf1','#ffd77c','#7cbeff'];
    return c[Math.floor(Math.random()*c.length)];
}

/* --- 3. MENU LOGIC --- */
function openTrackMenu(e, id) {
    e.stopPropagation();
    STATE.activeTrackId = id;
    const m = dom.ctxMenu;
    m.style.display = 'block';
    m.style.top = e.clientY + 'px';
    m.style.left = (e.clientX + 10) + 'px';
}

function renameActiveTrack() {
    const t = STATE.tracks.find(x => x.id === STATE.activeTrackId);
    const n = prompt("Rename:", t.name);
    if(n) { t.name = n; renderTracks(); renderMixer(); }
    dom.ctxMenu.style.display = 'none';
}

function setTrackType(type) {
    const t = STATE.tracks.find(x => x.id === STATE.activeTrackId);
    t.type = type;
    renderTracks(); renderMixer();
    dom.ctxMenu.style.display = 'none';
}

function armTrack(source) {
    const t = STATE.tracks.find(x => x.id === STATE.activeTrackId);
    t.armed = (source !== 'None');
    renderTracks();
    dom.ctxMenu.style.display = 'none';
}

function toggleArm(id) {
    const t = STATE.tracks.find(x => x.id === id);
    t.armed = !t.armed;
    renderTracks();
}

/* --- 4. UPLOAD & CLIPS --- */
function uploadToActiveTrack() {
    dom.fileInput.click();
    dom.ctxMenu.style.display = 'none';
}

function handleFileUpload(e) {
    if(e.target.files.length > 0) {
        const file = e.target.files[0];
        // Mock MIDI
        if(file.name.endsWith('.mid')) {
            alert("Opening Piano Roll for MIDI...");
            return;
        }
        // Mock Audio Load
        const reader = new FileReader();
        reader.onload = (ev) => {
            ctx.decodeAudioData(ev.target.result).then(buff => {
                createClip(STATE.activeTrackId, buff, file.name);
            });
        };
        reader.readAsArrayBuffer(file);
    }
}

function createClip(trackId, buffer, name) {
    const t = STATE.tracks.find(x => x.id === trackId);
    const clip = {
        id: STATE.nextClipId++,
        trackId, name,
        start: 0,
        len: buffer.duration * (STATE.bpm/60) * STATE.zoom, // Approx width
        color: t.color
    };
    STATE.clips.push(clip);
    renderClips();
}

function renderClips() {
    document.querySelectorAll('.clip').forEach(e=>e.remove());
    STATE.clips.forEach(c => {
        const row = document.querySelector(`.grid-track-row[data-id="${c.trackId}"]`);
        if(row) {
            const el = document.createElement('div');
            el.className = 'clip';
            el.style.width = c.len + 'px';
            el.style.left = c.start + 'px';
            el.style.background = `linear-gradient(135deg, ${c.color}, #555)`;
            el.innerHTML = `<span>${c.name}</span>`;
            // Basic Drag (Simplified for brevity)
            el.onmousedown = (e) => {
                e.stopPropagation();
                const startX = e.clientX;
                const startLeft = parseInt(el.style.left||0);
                document.onmousemove = (ev) => {
                    el.style.left = (startLeft + ev.clientX - startX) + 'px';
                };
                document.onmouseup = () => document.onmousemove = null;
            };
            row.appendChild(el);
        }
    });
}

/* --- 5. AI MODAL --- */
function openAiModal() {
    dom.ctxMenu.style.display = 'none';
    dom.aiModal.style.display = 'flex';
}
function closeAiModal() { dom.aiModal.style.display = 'none'; }

function generateAiClip() {
    const btn = document.getElementById('aiGenBtn');
    btn.innerText = "Generating...";
    setTimeout(() => {
        const t = STATE.tracks.find(x => x.id === STATE.activeTrackId);
        // Create dummy buffer
        const b = ctx.createBuffer(2, 44100*5, 44100);
        createClip(STATE.activeTrackId, b, "AI Generated Loop");
        t.type = "AI";
        renderTracks();
        closeAiModal();
        btn.innerText = "GENERATE & IMPORT";
    }, 1000);
}

/* --- 6. PLAYBACK & HELPERS --- */
function togglePlay() {
    STATE.isPlaying = !STATE.isPlaying;
    if(STATE.isPlaying) {
        STATE.startTime = ctx.currentTime;
        requestAnimationFrame(loop);
        document.getElementById('btn-play').classList.add('active');
    } else {
        document.getElementById('btn-play').classList.remove('active');
    }
}
function stopPlay() { 
    STATE.isPlaying = false; 
    STATE.playhead.beat = 0; 
    dom.playhead.style.left = '0px';
    document.getElementById('btn-play').classList.remove('active');
}

function loop() {
    if(!STATE.isPlaying) return;
    const elapsed = ctx.currentTime - STATE.startTime;
    const beatPx = elapsed * (STATE.bpm/60) * STATE.zoom;
    dom.playhead.style.left = beatPx + 'px';
    
    // Update Timer
    const m = Math.floor(elapsed/60).toString().padStart(2,'0');
    const s = Math.floor(elapsed%60).toString().padStart(2,'0');
    dom.screenTime.innerText = `${m}:${s}`;
    
    // Simple Meter Animation
    document.querySelectorAll('.mixer-meter-val').forEach(m => {
        m.style.height = (Math.random()*80) + '%';
    });
    
    requestAnimationFrame(loop);
}

function updateGrid() {
    dom.gridInner.style.backgroundSize = STATE.zoom + 'px 100%';
}

document.getElementById('zoom-range').oninput = (e) => {
    STATE.zoom = parseInt(e.target.value);
    updateGrid();
};

// UI Toggles
function toggleBrowser() {
    const b = document.getElementById('browserPanel');
    b.style.display = b.style.display === 'none' ? 'flex' : 'none';
}
function toggleBottom() {
    const b = document.getElementById('bottom-dock');
    b.style.display = b.style.display === 'none' ? 'flex' : 'none';
}

init();
</script>
</body>
</html>
