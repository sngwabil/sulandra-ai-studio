<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sulandra Sound Lab ‚Äì Tracks & SL Assistant</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #141414;
      color: #ddd;
      overflow: hidden;
    }

    /* === Toolbar === */
    #toolbar {
      height: 44px;
      background: #1f1f1f;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      padding: 0 12px;
      gap: 12px;
    }

    .toolbar-title {
      font-weight: 600;
      font-size: 14px;
      color: #f0f0f0;
      margin-right: 12px;
    }

    .toolbar-spacer {
      flex: 1;
    }

    .btn {
      background: #2b2b2b;
      border: 1px solid #3b3b3b;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 12px;
      color: #eee;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover {
      background: #3a3a3a;
    }

    .btn-icon {
      font-size: 14px;
    }

    /* Dropdown menus */
    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      min-width: 220px;
      background: #252525;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 6px 0;
      margin-top: 4px;
      z-index: 999;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      display: none;
    }

    .dropdown.open .dropdown-menu {
      display: block;
    }

    .dropdown-item {
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dropdown-item:hover {
      background: #333;
    }

    .dropdown-item span.label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .dropdown-item .shortcut {
      opacity: 0.6;
      font-size: 11px;
    }

    .dropdown-separator {
      height: 1px;
      background: #333;
      margin: 4px 0;
    }

    .submenu-arrow {
      font-size: 10px;
      opacity: 0.7;
    }

    /* Submenu */
    .submenu {
      position: absolute;
      top: 0;
      left: 100%;
      margin-left: 4px;
      min-width: 200px;
      background: #252525;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 6px 0;
      display: none;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    }

    .dropdown-item.has-submenu:hover .submenu {
      display: block;
    }

    /* === Main Layout === */
    #main {
      display: flex;
      height: calc(100vh - 44px);
    }

    /* Simple left sidebar placeholder (mixer, browser, etc.) */
    #left-pane {
      width: 220px;
      background: #171717;
      border-right: 1px solid #333;
      padding: 8px;
      box-sizing: border-box;
      font-size: 12px;
    }

    #left-pane h3 {
      margin: 6px 0 8px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #888;
    }

    /* Timeline area */
    #timeline-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #timeline-header {
      height: 30px;
      background: #202020;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      font-size: 11px;
      color: #aaa;
      padding: 0 10px;
      box-sizing: border-box;
    }

    #timeline-header .time-ruler {
      flex: 1;
      background: linear-gradient(to right, #252525 1px, transparent 1px);
      background-size: 40px 100%;
      height: 100%;
      margin-left: 10px;
      opacity: 0.6;
    }

    #tracks-area {
      flex: 1;
      position: relative;
      overflow: auto;
      background: #1a1a1a;
    }

    .track {
      display: grid;
      grid-template-columns: 220px 1fr;
      height: 70px;
      border-bottom: 1px solid #252525;
    }

    .track-header {
      background: #222;
      border-right: 1px solid #333;
      padding: 6px 8px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: default;
      position: relative;
      user-select: none;
    }

    .track-header-main {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .track-color-strip {
      width: 4px;
      align-self: stretch;
      border-radius: 2px;
    }

    .track-icon {
      font-size: 14px;
    }

    .track-name {
      font-weight: 500;
    }

    .track-header-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 10px;
      margin-top: 4px;
    }

    .track-type-tag {
      padding: 2px 6px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.06);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .track-record-btn {
      border-radius: 999px;
      border: 1px solid #444;
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 10px;
      background: #2a2a2a;
      color: #f55;
    }

    .track-record-btn.armed {
      background: #d22;
      border-color: #f88;
      color: #fff;
      box-shadow: 0 0 0 2px rgba(255, 64, 64, 0.3);
    }

    .track-content {
      position: relative;
      overflow: hidden;
    }

    .clip {
      position: absolute;
      top: 14px;
      height: 42px;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 11px;
      box-sizing: border-box;
      color: #111;
      background: #9cf;
      display: flex;
      align-items: center;
      justify-content: space-between;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .clip-label {
      font-weight: 500;
    }

    .clip-meta {
      font-size: 10px;
      opacity: 0.7;
      margin-left: 10px;
    }

    /* Scrollbar styling */
    #tracks-area::-webkit-scrollbar {
      width: 10px;
    }
    #tracks-area::-webkit-scrollbar-track {
      background: #141414;
    }
    #tracks-area::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 5px;
    }

    /* === Modals === */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(2px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: #222;
      border-radius: 10px;
      border: 1px solid #444;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.7);
      padding: 16px 18px;
      box-sizing: border-box;
      min-width: 380px;
      max-width: 520px;
      color: #eee;
      font-size: 13px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .modal-title {
      font-size: 14px;
      font-weight: 600;
    }

    .modal-close {
      cursor: pointer;
      font-size: 16px;
      opacity: 0.7;
    }

    .modal-close:hover {
      opacity: 1;
    }

    .modal-body {
      max-height: 380px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .modal-footer {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .field-group {
      margin-bottom: 10px;
    }

    .field-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.8;
      margin-bottom: 3px;
    }

    .field-input, .field-select, .field-textarea {
      width: 100%;
      background: #181818;
      border-radius: 4px;
      border: 1px solid #444;
      color: #eee;
      padding: 6px 8px;
      font-size: 12px;
      box-sizing: border-box;
    }

    .field-textarea {
      min-height: 70px;
      resize: vertical;
    }

    .inline-row {
      display: flex;
      gap: 8px;
    }

    .inline-row > * {
      flex: 1;
    }

    .pill-toggle-group {
      display: inline-flex;
      background: #181818;
      border-radius: 999px;
      border: 1px solid #444;
      padding: 2px;
      gap: 2px;
    }

    .pill-toggle {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      cursor: pointer;
      opacity: 0.8;
    }

    .pill-toggle.active {
      background: linear-gradient(135deg, #ff6dcf, #46d6ff);
      color: #111;
      opacity: 1;
      font-weight: 600;
    }

    .color-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .color-swatches {
      display: flex;
      gap: 4px;
    }

    .color-swatch {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid #0009;
    }

    .btn-primary {
      background: #4c8dff;
      border-color: #4c8dff;
    }

    .btn-primary:hover {
      background: #5a9aff;
    }

    .btn-ghost {
      background: transparent;
      border-color: #444;
    }

    /* SL Assistant special styling */
    #sl-assistant-modal .modal {
      background: radial-gradient(circle at top left, #ff6dcf 0, #222 40%, #181818 100%);
      border-color: #ff9adc;
    }

    #sl-assistant-modal .modal-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #sl-assistant-modal .modal-title span.logo {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      background: conic-gradient(from 0deg, #ff6dcf, #ffe66d, #46d6ff, #9dff6d, #ff6dcf);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.3);
      color: #ffddee;
    }

    .preset-row {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 11px;
    }

    .preset-list {
      flex: 1;
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <div class="toolbar-title">Sulandra Sound Lab</div>

    <div class="dropdown" id="addTrackDropdown">
      <button class="btn" id="addTrackBtn">
        <span class="btn-icon">‚ûï</span>
        <span>Add Track</span>
      </button>
      <div class="dropdown-menu">
        <div class="dropdown-item has-submenu" data-menu="instrument">
          <span class="label"><span>üéπ</span> <span>Instrument</span></span>
          <span class="submenu-arrow">‚ñ∂</span>
          <div class="submenu">
            <!-- Instrument types -->
            <div class="dropdown-item" data-instrument="Piano">üéπ <span>Piano</span></div>
            <div class="dropdown-item" data-instrument="Guitar">üé∏ <span>Guitar</span></div>
            <div class="dropdown-item" data-instrument="Bass">üéµ <span>Bass</span></div>
            <div class="dropdown-item" data-instrument="Drums">ü•Å <span>Drums</span></div>
            <div class="dropdown-item" data-instrument="Strings">üéª <span>Strings</span></div>
            <div class="dropdown-item" data-instrument="Synth">üéõÔ∏è <span>Synth</span></div>
            <div class="dropdown-item" data-instrument="Pad">‚òÅÔ∏è <span>Pad</span></div>
            <div class="dropdown-item" data-instrument="Brass">üé∫ <span>Brass</span></div>
            <div class="dropdown-item" data-instrument="FX">‚ú® <span>FX</span></div>
          </div>
        </div>

        <div class="dropdown-item has-submenu" data-menu="vocals">
          <span class="label"><span>üé§</span> <span>Vocals</span></span>
          <span class="submenu-arrow">‚ñ∂</span>
          <div class="submenu">
            <div class="dropdown-item" data-vocal="Lead Vocals">üé§ Lead</div>
            <div class="dropdown-item" data-vocal="Backing Vocals">üé∂ Backing</div>
            <div class="dropdown-item" data-vocal="Choir">üë• Choir</div>
          </div>
        </div>

        <div class="dropdown-item has-submenu" data-menu="import">
          <span class="label"><span>üì•</span> <span>Import</span></span>
          <span class="submenu-arrow">‚ñ∂</span>
          <div class="submenu">
            <div class="dropdown-item" id="importFromDevice">üíª Upload from device‚Ä¶</div>
            <div class="dropdown-item" id="importFromAudio">üéµ Import from Audio (My Creations)</div>
          </div>
        </div>

        <div class="dropdown-separator"></div>

        <div class="dropdown-item" id="createWithSL">
          <span class="label">
            <span>üåà</span>
            <span>Create with SL Assistant</span>
          </span>
          <span class="shortcut">Ctrl+Shift+A</span>
        </div>
      </div>
    </div>

    <div class="toolbar-spacer"></div>

    <!-- Simple transport buttons placeholder -->
    <button class="btn"><span class="btn-icon">‚èÆ</span>Prev</button>
    <button class="btn"><span class="btn-icon">‚ñ∂</span>Play</button>
    <button class="btn"><span class="btn-icon">‚èπ</span>Stop</button>
    <button class="btn"><span class="btn-icon">‚óè</span>Record</button>
  </div>

  <div id="main">
    <div id="left-pane">
      <h3>Browser</h3>
      <p style="font-size:11px; opacity:0.8;">
        Drag loops, samples, vocals, and SL creations here and drop them onto tracks.
      </p>
    </div>

    <div id="timeline-container">
      <div id="timeline-header">
        <span>Timeline</span>
        <div class="time-ruler"></div>
      </div>

      <div id="tracks-area">
        <!-- Tracks injected here -->
      </div>
    </div>
  </div>

  <!-- Hidden file input for Import from Device -->
  <input type="file" id="fileInput" accept="audio/*" style="display:none;" />

  <!-- Track Settings Modal -->
  <div class="modal-backdrop" id="trackSettingsModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Track Settings</div>
        <div class="modal-close" data-close>&times;</div>
      </div>
      <div class="modal-body">
        <div class="field-group">
          <div class="field-label">Track Name</div>
          <input type="text" id="trackNameInput" class="field-input">
        </div>

        <div class="field-group">
          <div class="field-label">Track Icon</div>
          <div class="inline-row">
            <input type="text" id="trackIconInput" class="field-input" placeholder="e.g. üéπ, üé§, ü•Å">
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">Track Color</div>
          <div class="color-row">
            <input type="color" id="trackColorPicker" value="#4c8dff">
            <div class="color-swatches">
              <div class="color-swatch" data-color="#4c8dff" style="background:#4c8dff;"></div>
              <div class="color-swatch" data-color="#ff6d6d" style="background:#ff6d6d;"></div>
              <div class="color-swatch" data-color="#ffb347" style="background:#ffb347;"></div>
              <div class="color-swatch" data-color="#7adf82" style="background:#7adf82;"></div>
              <div class="color-swatch" data-color="#9a7bff" style="background:#9a7bff;"></div>
            </div>
          </div>
        </div>

        <div style="font-size:11px; opacity:0.75; margin-top:6px;">
          Any loop or pattern on this track will automatically use this color.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" data-close>Cancel</button>
        <button class="btn btn-primary" id="trackSettingsSave">Save</button>
      </div>
    </div>
  </div>

  <!-- Record Routing Modal -->
  <div class="modal-backdrop" id="recordRoutingModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Record Settings</div>
        <div class="modal-close" data-close>&times;</div>
      </div>
      <div class="modal-body">
        <div class="field-group">
          <div class="field-label">Input Device</div>
          <select id="inputDeviceSelect" class="field-select">
            <!-- Filled by JS -->
          </select>
        </div>

        <div class="field-group">
          <div class="field-label">Input Channel / Source</div>
          <select id="inputChannelSelect" class="field-select">
            <option>Mono In 1</option>
            <option>Mono In 2</option>
            <option>Stereo In 1-2</option>
          </select>
        </div>

        <div class="field-group">
          <div class="field-label">Output</div>
          <select id="outputDeviceSelect" class="field-select">
            <option value="master">Project Output (Master Bus)</option>
            <option value="phones">Headphones</option>
            <option value="interface12">Audio Interface Out 1-2</option>
            <option value="custom">Custom Routing</option>
          </select>
        </div>

        <div class="field-group">
          <div class="field-label">Preset</div>
          <div class="preset-row">
            <select id="presetSelect" class="field-select preset-list">
              <option value="">None</option>
            </select>
            <input type="text" id="presetNameInput" class="field-input" placeholder="Save as preset‚Ä¶">
          </div>
        </div>

        <div style="font-size:11px; opacity:0.75; margin-top:8px;">
          You can arm multiple tracks and record from different inputs at the same time.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" data-close>Cancel</button>
        <button class="btn" id="recordSavePresetBtn">Save Preset</button>
        <button class="btn btn-primary" id="recordApplyBtn">Apply & Arm</button>
      </div>
    </div>
  </div>

  <!-- SL Assistant Modal -->
  <div class="modal-backdrop" id="sl-assistant-modal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">
          <span class="logo"></span>
          <span>SL Assistant</span>
        </div>
        <div class="modal-close" data-close>&times;</div>
      </div>
      <div class="modal-body">
        <div class="field-group">
          <div class="field-label">Creation Type</div>
          <div class="pill-toggle-group" id="slTypeToggle">
            <div class="pill-toggle active" data-type="instrument">Instrument / Loop</div>
            <div class="pill-toggle" data-type="vocal">Vocal</div>
          </div>
          <span class="badge" style="margin-left:8px;">AI ¬∑ Sync to Project</span>
        </div>

        <div class="field-group">
          <div class="field-label">Prompt</div>
          <textarea id="slPromptInput" class="field-textarea"
            placeholder="Describe the sound you want (e.g. warm afrobeat piano loop, 8 bars, 100 BPM, soulful)."></textarea>
        </div>

        <div class="field-group" id="slLyricsGroup" style="display:none;">
          <div class="field-label">Lyrics (for Vocal)</div>
          <textarea id="slLyricsInput" class="field-textarea"
            placeholder="Paste or type your lyrics here. SL Assistant will generate vocals that match your project tempo and key."></textarea>
        </div>

        <div class="inline-row">
          <div class="field-group">
            <div class="field-label">Target Track</div>
            <select id="slTargetTrackSelect" class="field-select">
              <!-- filled by JS -->
            </select>
          </div>
          <div class="field-group">
            <div class="field-label">Length (bars)</div>
            <input type="number" id="slBarsInput" class="field-input" min="1" value="8">
          </div>
        </div>

        <div style="font-size:11px; opacity:0.85; margin-top:8px;">
          SL Assistant will sync loops, instruments, and vocals to the current project tempo
          and insert them directly into the selected track in the timeline.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" data-close>Cancel</button>
        <button class="btn btn-primary" id="slGenerateBtn">Generate & Add to Timeline</button>
      </div>
    </div>
  </div>

  <script>
    // ===== STATE =====
    const tracksArea = document.getElementById('tracks-area');
    let tracks = [];
    let currentTrackIdForSettings = null;
    let currentTrackIdForRecord = null;

    // fake device lists (replace with real device detection later)
    const inputDevices = [
      'Built-in Microphone',
      'USB Podcast Mic',
      'Focusrite Scarlett 2i2',
      'Studio Interface 8x8'
    ];

    const recordPresets = []; // {name, inputDevice, inputChannel, outputDevice}

    // ===== UTILITIES =====
    function createTrack({ name, type, icon, color }) {
      const id = 'track-' + Date.now() + '-' + Math.floor(Math.random() * 9999);
      const trackData = {
        id,
        name,
        type,
        icon,
        color,
        armed: false
      };
      tracks.push(trackData);
      renderTrack(trackData);
      refreshSLTrackList();
    }

    function renderTrack(track) {
      const trackEl = document.createElement('div');
      trackEl.className = 'track';
      trackEl.dataset.trackId = track.id;

      // header
      const header = document.createElement('div');
      header.className = 'track-header';
      header.addEventListener('dblclick', () => openTrackSettings(track.id));

      const headerMain = document.createElement('div');
      headerMain.className = 'track-header-main';

      const colorStrip = document.createElement('div');
      colorStrip.className = 'track-color-strip';
      colorStrip.style.background = track.color || '#4c8dff';
      colorStrip.dataset.role = 'colorStrip';

      const iconSpan = document.createElement('div');
      iconSpan.className = 'track-icon';
      iconSpan.textContent = track.icon || 'üéµ';
      iconSpan.dataset.role = 'icon';

      const nameSpan = document.createElement('div');
      nameSpan.className = 'track-name';
      nameSpan.textContent = track.name;
      nameSpan.dataset.role = 'name';

      headerMain.appendChild(colorStrip);
      headerMain.appendChild(iconSpan);
      headerMain.appendChild(nameSpan);

      const headerBottom = document.createElement('div');
      headerBottom.className = 'track-header-bottom';

      const typeTag = document.createElement('div');
      typeTag.className = 'track-type-tag';
      typeTag.textContent = track.type;
      headerBottom.appendChild(typeTag);

      const recordBtn = document.createElement('div');
      recordBtn.className = 'track-record-btn';
      recordBtn.innerHTML = '‚óè';
      if (track.armed) recordBtn.classList.add('armed');
      recordBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        openRecordRouting(track.id);
      });
      headerBottom.appendChild(recordBtn);

      header.appendChild(headerMain);
      header.appendChild(headerBottom);

      // content
      const content = document.createElement('div');
      content.className = 'track-content';

      trackEl.appendChild(header);
      trackEl.appendChild(content);

      tracksArea.appendChild(trackEl);
    }

    function updateTrackVisual(trackId) {
      const track = tracks.find(t => t.id === trackId);
      if (!track) return;

      const trackEl = tracksArea.querySelector(`.track[data-track-id="${trackId}"]`);
      if (!trackEl) return;

      const nameEl = trackEl.querySelector('[data-role="name"]');
      const iconEl = trackEl.querySelector('[data-role="icon"]');
      const colorStrip = trackEl.querySelector('[data-role="colorStrip"]');
      const recordBtn = trackEl.querySelector('.track-record-btn');
      const clips = trackEl.querySelectorAll('.clip');

      if (nameEl) nameEl.textContent = track.name;
      if (iconEl) iconEl.textContent = track.icon;
      if (colorStrip) colorStrip.style.background = track.color;
      recordBtn.classList.toggle('armed', track.armed);

      clips.forEach(clip => {
        clip.style.background = track.color;
      });
    }

    function addClipToTrack(trackId, label, bars) {
      const trackEl = tracksArea.querySelector(`.track[data-track-id="${trackId}"]`);
      const track = tracks.find(t => t.id === trackId);
      if (!trackEl || !track) return;

      const content = trackEl.querySelector('.track-content');
      const clip = document.createElement('div');
      clip.className = 'clip';
      clip.style.left = '40px';  // placeholder position
      clip.style.width = (bars * 40) + 'px'; // 40px per bar as example
      clip.style.background = track.color;

      const labelSpan = document.createElement('span');
      labelSpan.className = 'clip-label';
      labelSpan.textContent = label;

      const metaSpan = document.createElement('span');
      metaSpan.className = 'clip-meta';
      metaSpan.textContent = bars + ' bars';

      clip.appendChild(labelSpan);
      clip.appendChild(metaSpan);

      content.appendChild(clip);
    }

    function refreshSLTrackList() {
      const select = document.getElementById('slTargetTrackSelect');
      if (!select) return;
      select.innerHTML = '';
      if (tracks.length === 0) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No tracks yet ‚Äî add one first';
        select.appendChild(opt);
      } else {
        tracks.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.id;
          opt.textContent = t.name + ' (' + t.type + ')';
          select.appendChild(opt);
        });
      }
    }

    // ===== DROPDOWN LOGIC =====
    const addTrackDropdown = document.getElementById('addTrackDropdown');
    const addTrackBtn = document.getElementById('addTrackBtn');

    addTrackBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      addTrackDropdown.classList.toggle('open');
    });

    document.addEventListener('click', () => {
      addTrackDropdown.classList.remove('open');
    });

    addTrackDropdown.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    // Instrument submenu
    addTrackDropdown.querySelectorAll('[data-instrument]').forEach(item => {
      item.addEventListener('click', () => {
        const instrument = item.getAttribute('data-instrument');
        const defaults = getInstrumentDefaults(instrument);
        createTrack(defaults);
        addTrackDropdown.classList.remove('open');
      });
    });

    function getInstrumentDefaults(name) {
      const map = {
        'Piano':   { icon: 'üéπ', color: '#4c8dff' },
        'Guitar':  { icon: 'üé∏', color: '#ff9b4c' },
        'Bass':    { icon: 'üéµ', color: '#7adf82' },
        'Drums':   { icon: 'ü•Å', color: '#ff6d6d' },
        'Strings': { icon: 'üéª', color: '#9a7bff' },
        'Synth':   { icon: 'üéõÔ∏è', color: '#46d6ff' },
        'Pad':     { icon: '‚òÅÔ∏è', color: '#ffb3ff' },
        'Brass':   { icon: 'üé∫', color: '#ffd66b' },
        'FX':      { icon: '‚ú®', color: '#f2f2f2' }
      };
      const d = map[name] || { icon: 'üéµ', color: '#4c8dff' };
      return {
        name,
        type: 'Instrument',
        icon: d.icon,
        color: d.color
      };
    }

    // Vocals submenu
    addTrackDropdown.querySelectorAll('[data-vocal]').forEach(item => {
      item.addEventListener('click', () => {
        const vocalType = item.getAttribute('data-vocal');
        const defaults = getVocalDefaults(vocalType);
        createTrack(defaults);
        addTrackDropdown.classList.remove('open');
      });
    });

    function getVocalDefaults(name) {
      if (name === 'Lead Vocals') {
        return {
          name: 'Lead Vocals',
          type: 'Vocal',
          icon: 'üé§',
          color: '#ff6d9b'
        };
      } else if (name === 'Backing Vocals') {
        return {
          name: 'Backing Vocals',
          type: 'Vocal',
          icon: 'üé∂',
          color: '#46d6ff'
        };
      } else {
        return {
          name: 'Choir',
          type: 'Vocal',
          icon: 'üë•',
          color: '#ffd66b'
        };
      }
    }

    // Import submenu
    const fileInput = document.getElementById('fileInput');
    const importFromDevice = document.getElementById('importFromDevice');
    const importFromAudio = document.getElementById('importFromAudio');

    importFromDevice.addEventListener('click', () => {
      fileInput.click();
      addTrackDropdown.classList.remove('open');
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const trackName = file.name.replace(/\.[^/.]+$/, '');
      // auto create an "Audio" track for this file
      const trackDefaults = {
        name: trackName,
        type: 'Audio Import',
        icon: 'üì¶',
        color: '#9a7bff'
      };
      createTrack(trackDefaults);
      // put one clip as placeholder
      const lastTrack = tracks[tracks.length - 1];
      addClipToTrack(lastTrack.id, trackName, 8);
      e.target.value = '';
    });

    importFromAudio.addEventListener('click', () => {
      // This is where you link to music.html creations
      // For now, just create a generic track and dummy clip
      const trackDefaults = {
        name: 'SL Audio (My Creations)',
        type: 'Audio Import',
        icon: 'üéº',
        color: '#7adf82'
      };
      createTrack(trackDefaults);
      const lastTrack = tracks[tracks.length - 1];
      addClipToTrack(lastTrack.id, 'Imported from Audio Library', 8);
      addTrackDropdown.classList.remove('open');
    });

    // ===== TRACK SETTINGS MODAL =====
    const trackSettingsModal = document.getElementById('trackSettingsModal');
    const trackNameInput = document.getElementById('trackNameInput');
    const trackIconInput = document.getElementById('trackIconInput');
    const trackColorPicker = document.getElementById('trackColorPicker');
    const trackSettingsSave = document.getElementById('trackSettingsSave');

    function openTrackSettings(trackId) {
      currentTrackIdForSettings = trackId;
      const track = tracks.find(t => t.id === trackId);
      if (!track) return;
      trackNameInput.value = track.name;
      trackIconInput.value = track.icon;
      trackColorPicker.value = track.color;
      trackSettingsModal.style.display = 'flex';
    }

    trackSettingsSave.addEventListener('click', () => {
      const track = tracks.find(t => t.id === currentTrackIdForSettings);
      if (!track) return;
      track.name = trackNameInput.value || track.name;
      track.icon = trackIconInput.value || track.icon;
      track.color = trackColorPicker.value || track.color;
      updateTrackVisual(track.id);
      refreshSLTrackList();
      trackSettingsModal.style.display = 'none';
    });

    // color swatches in track settings
    document.querySelectorAll('#trackSettingsModal .color-swatch').forEach(swatch => {
      swatch.addEventListener('click', () => {
        const color = swatch.getAttribute('data-color');
        trackColorPicker.value = color;
      });
    });

    // ===== RECORD ROUTING MODAL =====
    const recordRoutingModal = document.getElementById('recordRoutingModal');
    const inputDeviceSelect = document.getElementById('inputDeviceSelect');
    const inputChannelSelect = document.getElementById('inputChannelSelect');
    const outputDeviceSelect = document.getElementById('outputDeviceSelect');
    const presetSelect = document.getElementById('presetSelect');
    const presetNameInput = document.getElementById('presetNameInput');
    const recordSavePresetBtn = document.getElementById('recordSavePresetBtn');
    const recordApplyBtn = document.getElementById('recordApplyBtn');

    // populate input devices
    inputDevices.forEach(dev => {
      const opt = document.createElement('option');
      opt.textContent = dev;
      opt.value = dev;
      inputDeviceSelect.appendChild(opt);
    });

    function openRecordRouting(trackId) {
      currentTrackIdForRecord = trackId;
      refreshPresetList();
      recordRoutingModal.style.display = 'flex';
    }

    function refreshPresetList() {
      presetSelect.innerHTML = '';
      const optNone = document.createElement('option');
      optNone.value = '';
      optNone.textContent = 'None';
      presetSelect.appendChild(optNone);

      recordPresets.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = p.name;
        presetSelect.appendChild(opt);
      });
    }

    presetSelect.addEventListener('change', () => {
      const name = presetSelect.value;
      if (!name) return;
      const preset = recordPresets.find(p => p.name === name);
      if (!preset) return;
      inputDeviceSelect.value = preset.inputDevice;
      inputChannelSelect.value = preset.inputChannel;
      outputDeviceSelect.value = preset.outputDevice;
    });

    recordSavePresetBtn.addEventListener('click', () => {
      const name = presetNameInput.value.trim();
      if (!name) return;
      const existing = recordPresets.find(p => p.name === name);
      const presetData = {
        name,
        inputDevice: inputDeviceSelect.value,
        inputChannel: inputChannelSelect.value,
        outputDevice: outputDeviceSelect.value
      };
      if (existing) {
        Object.assign(existing, presetData);
      } else {
        recordPresets.push(presetData);
      }
      presetNameInput.value = '';
      refreshPresetList();
    });

    recordApplyBtn.addEventListener('click', () => {
      const track = tracks.find(t => t.id === currentTrackIdForRecord);
      if (!track) return;
      track.armed = true;
      updateTrackVisual(track.id);
      // Here you would arm the track in your actual audio engine and
      // route inputDevice/inputChannel to outputDevice.
      //
      // When global Record is started, you would begin recording and
      // write clips directly into the timeline in real time.
      recordRoutingModal.style.display = 'none';
    });

    // ===== SL ASSISTANT MODAL =====
    const slAssistantModal = document.getElementById('sl-assistant-modal');
    const createWithSLBtn = document.getElementById('createWithSL');
    const slTypeToggle = document.getElementById('slTypeToggle');
    const slPromptInput = document.getElementById('slPromptInput');
    const slLyricsGroup = document.getElementById('slLyricsGroup');
    const slLyricsInput = document.getElementById('slLyricsInput');
    const slTargetTrackSelect = document.getElementById('slTargetTrackSelect');
    const slBarsInput = document.getElementById('slBarsInput');
    const slGenerateBtn = document.getElementById('slGenerateBtn');

    createWithSLBtn.addEventListener('click', () => {
      slAssistantModal.style.display = 'flex';
      refreshSLTrackList();
    });

    // toggle type (instrument / vocal)
    slTypeToggle.querySelectorAll('.pill-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        slTypeToggle.querySelectorAll('.pill-toggle').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const type = btn.getAttribute('data-type');
        if (type === 'vocal') {
          slLyricsGroup.style.display = 'block';
        } else {
          slLyricsGroup.style.display = 'none';
        }
      });
    });

    slGenerateBtn.addEventListener('click', () => {
      const typeBtn = slTypeToggle.querySelector('.pill-toggle.active');
      const type = typeBtn.getAttribute('data-type'); // 'instrument' or 'vocal'
      const prompt = slPromptInput.value.trim();
      const lyrics = slLyricsInput.value.trim();
      const bars = parseInt(slBarsInput.value) || 8;
      const targetTrackId = slTargetTrackSelect.value || (tracks[0]?.id);

      if (!targetTrackId) {
        alert('Please create a track first.');
        return;
      }

      const label = type === 'vocal'
        ? 'SL Vocal: ' + (lyrics ? lyrics.split('\n')[0].slice(0, 20) + '‚Ä¶' : 'New Vocal')
        : 'SL Loop: ' + (prompt ? prompt.slice(0, 20) + '‚Ä¶' : 'New Loop');

      addClipToTrack(targetTrackId, label, bars);

      // Here you would call your backend / SL Assistant to actually
      // generate the audio and insert the rendered file into this clip.

      slAssistantModal.style.display = 'none';
      slPromptInput.value = '';
      slLyricsInput.value = '';
    });

    // ===== MODAL CLOSE HANDLING =====
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
      backdrop.addEventListener('click', (e) => {
        if (e.target === backdrop) {
          backdrop.style.display = 'none';
        }
      });
      backdrop.querySelectorAll('[data-close]').forEach(btn => {
        btn.addEventListener('click', () => {
          backdrop.style.display = 'none';
        });
      });
    });

    // ===== INIT: add one starter track =====
    window.addEventListener('load', () => {
      createTrack({
        name: 'Piano',
        type: 'Instrument',
        icon: 'üéπ',
        color: '#4c8dff'
      });
      addClipToTrack(tracks[0].id, 'Piano Loop (Demo)', 8);
    });
  </script>
</body>
</html>
