<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <title>Sulandra AI Studio â€“ Sound DAW</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <style>
Â  Â  :root {
Â  Â  Â  --bg: #050709;
Â  Â  Â  --bg-deep: #020305;
Â  Â  Â  --panel: #101820;
Â  Â  Â  --panel-dark: #0a1219;
Â  Â  Â  --panel-soft: #141e28;
Â  Â  Â  --accent: #70ff63;
Â  Â  Â  --accent-soft: rgba(112,255,99,0.2);
Â  Â  Â  --accent-strong: #9aff8f;
Â  Â  Â  --text-main: #f2f9ff;
Â  Â  Â  --text-muted: #9eaab6;
Â  Â  Â  --border-soft: rgba(255,255,255,0.06);
Â  Â  Â  --border-strong: rgba(112,255,99,0.7);
Â  Â  Â  --radius-sm: 6px;
Â  Â  Â  --shadow-soft: 0 0 32px rgba(0,0,0,0.85);
Â  Â  Â  --grid-line: rgba(255,255,255,0.06);
Â  Â  }

Â  Â  * { box-sizing: border-box; }

Â  Â  body {
Â  Â  Â  margin: 0;
Â  Â  Â  min-height: 100vh;
Â  Â  Â  font-family: system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Inter",sans-serif;
Â  Â  Â  background: radial-gradient(circle at top left,#1b2635 0,#020305 55%,#000 100%);
Â  Â  Â  color: var(--text-main);
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  }

Â  Â  a { color: inherit; text-decoration: none; }

Â  Â  header {
Â  Â  Â  background: linear-gradient(to bottom,#141f2c,#0c141d);
Â  Â  Â  border-bottom: 1px solid var(--border-soft);
Â  Â  Â  box-shadow: 0 0 14px rgba(0,0,0,0.9);
Â  Â  Â  z-index: 20;
Â  Â  }
Â  Â  .app-header-inner {
Â  Â  Â  max-width: 1400px;
Â  Â  Â  margin: 0 auto;
Â  Â  Â  padding: 4px 14px 6px;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  gap: 10px;
Â  Â  }
Â  Â  .brand-wrap {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 8px;
Â  Â  }
Â  Â  .brand-icon {
Â  Â  Â  width: 26px;
Â  Â  Â  height: 26px;
Â  Â  Â  border-radius: 7px;
Â  Â  Â  background: radial-gradient(circle at 20% 0%,#7dff64,#28b88e);
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  color: #02110b;
Â  Â  Â  font-weight: 900;
Â  Â  Â  font-size: 15px;
Â  Â  Â  box-shadow: 0 0 15px rgba(112,255,99,0.8);
Â  Â  }
Â  Â  .brand-title-main {
Â  Â  Â  font-size: 13px;
Â  Â  Â  text-transform: uppercase;
Â  Â  Â  letter-spacing: .12em;
Â  Â  }
Â  Â  .brand-title-sub {
Â  Â  Â  font-size: 10px;
Â  Â  Â  color: var(--text-muted);
Â  Â  Â  text-transform: uppercase;
Â  Â  Â  letter-spacing: .18em;
Â  Â  }

Â  Â  .top-nav-links {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 6px;
Â  Â  Â  align-items: center;
Â  Â  Â  font-size: 11px;
Â  Â  Â  flex-wrap: wrap;
Â  Â  }
Â  Â  .top-nav-links a {
Â  Â  Â  padding: 4px 8px;
Â  Â  Â  border-radius: 999px;
Â  Â  Â  border: 1px solid transparent;
Â  Â  Â  color: var(--text-muted);
Â  Â  }
Â  Â  .top-nav-links a:hover {
Â  Â  Â  border-color: var(--border-soft);
Â  Â  Â  background: rgba(255,255,255,0.04);
Â  Â  Â  color: var(--text-main);
Â  Â  }
Â  Â  .top-nav-links a.active {
Â  Â  Â  border-color: var(--border-strong);
Â  Â  Â  color: #02110b;
Â  Â  Â  background: linear-gradient(120deg,#70ff63,#2fdcaa);
Â  Â  Â  box-shadow: 0 0 14px rgba(112,255,99,0.8);
Â  Â  Â  font-weight: 600;
Â  Â  }

Â  Â  .profile-pill {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 8px;
Â  Â  Â  font-size: 10px;
Â  Â  Â  padding: 4px 8px;
Â  Â  Â  border-radius: 999px;
Â  Â  Â  border: 1px solid var(--border-soft);
Â  Â  Â  background: rgba(2,5,8,0.9);
Â  Â  }
Â  Â  .profile-pill span { color: var(--text-muted); }
Â  Â  .profile-dot {
Â  Â  Â  width: 8px;
Â  Â  Â  height: 8px;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  background: var(--accent);
Â  Â  Â  box-shadow: 0 0 8px rgba(112,255,99,0.8);
Â  Â  }

Â  Â  main {
Â  Â  Â  flex: 1;
Â  Â  Â  max-width: 1400px;
Â  Â  Â  margin: 6px auto 10px;
Â  Â  Â  padding: 0 10px 8px;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 6px;
Â  Â  }

Â  Â  /* MENU / TRANSPORT */
Â  Â  .menu-transport {
Â  Â  Â  background: #141f2c;
Â  Â  Â  border-radius: 7px;
Â  Â  Â  border: 1px solid var(--border-soft);
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  box-shadow: var(--shadow-soft);
Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â  .menu-row {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 10px;
Â  Â  Â  padding: 4px 8px;
Â  Â  Â  font-size: 11px;
Â  Â  Â  border-bottom: 1px solid rgba(0,0,0,0.4);
Â  Â  Â  background: linear-gradient(to bottom,#1a2836,#121d27);
Â  Â  }
Â  Â  .menu-item {
Â  Â  Â  padding: 2px 6px;
Â  Â  Â  border-radius: 3px;
Â  Â  Â  cursor: default;
Â  Â  Â  color: var(--text-muted);
Â  Â  }
Â  Â  .menu-item:hover {
Â  Â  Â  background: rgba(255,255,255,0.06);
Â  Â  Â  color: var(--text-main);
Â  Â  }

Â  Â  .transport-row {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: minmax(0,1.6fr) minmax(0,2.2fr) minmax(0,1.4fr);
Â  Â  Â  gap: 4px;
Â  Â  Â  padding: 4px 8px 6px;
Â  Â  Â  background: linear-gradient(to bottom,#111a23,#060b10);
Â  Â  Â  font-size: 11px;
Â  Â  Â  color: var(--text-muted);
Â  Â  }
Â  Â  @media (max-width: 900px) {
Â  Â  Â  .transport-row { grid-template-columns: minmax(0,1fr); }
Â  Â  }
Â  Â  .transport-left,
Â  Â  .transport-center,
Â  Â  .transport-right {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 6px;
Â  Â  Â  flex-wrap: wrap;
Â  Â  }

Â  Â  .btn-transport {
Â  Â  Â  width: 24px;
Â  Â  Â  height: 24px;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  border: 1px solid var(--border-soft);
Â  Â  Â  background: #071016;
Â  Â  Â  color: var(--text-main);
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  cursor: pointer;
Â  Â  Â  box-shadow: inset 0 0 5px rgba(0,0,0,0.7);
Â  Â  Â  font-size: 11px;
Â  Â  Â  transition: all 0.1s ease;
Â  Â  }
Â  Â  .btn-transport:hover {
Â  Â  Â  transform: scale(1.05);
Â  Â  Â  box-shadow: inset 0 0 5px rgba(0,0,0,0.7), 0 0 5px rgba(255,255,255,0.2);
Â  Â  }
Â  Â  .btn-transport.green {
Â  Â  Â  background: radial-gradient(circle at 20% 0%,#70ff63,#27b87e);
Â  Â  Â  color: #02110b;
Â  Â  Â  border-color: var(--border-strong);
Â  Â  Â  box-shadow: 0 0 12px rgba(112,255,99,0.9);
Â  Â  }
Â  Â  .btn-transport.record {
Â  Â  Â  background: radial-gradient(circle at 20% 0%,#ff5757,#b02020);
Â  Â  Â  border-color: rgba(255,110,110,0.9);
Â  Â  Â  color: #000;
Â  Â  Â  box-shadow: 0 0 12px rgba(255,120,120,0.9);
Â  Â  }
Â  Â  .btn-transport.active-outline {
Â  Â  Â  box-shadow: 0 0 10px rgba(112,255,99,0.9), inset 0 0 5px rgba(0,0,0,0.7);
Â  Â  }

Â  Â  .tempo-block,
Â  Â  .snap-block {
Â  Â  Â  padding: 2px 6px;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  border: 1px solid rgba(0,0,0,0.65);
Â  Â  Â  background: #050b0f;
Â  Â  Â  display: inline-flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 4px;
Â  Â  Â  color: var(--accent-strong);
Â  Â  Â  box-shadow: inset 0 0 6px rgba(0,0,0,0.9);
Â  Â  }
Â  Â  .tempo-value { font-weight: 600; }
Â  Â  .display-field {
Â  Â  Â  padding: 2px 6px;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  border: 1px solid rgba(0,0,0,0.7);
Â  Â  Â  background: #040a10;
Â  Â  Â  min-width: 90px;
Â  Â  Â  text-align: center;
Â  Â  Â  color: #9ff792;
Â  Â  Â  box-shadow: inset 0 0 6px rgba(0,0,0,0.9);
Â  Â  }

Â  Â  /* DAW SHELL */
Â  Â  .daw-shell {
Â  Â  Â  margin-top: 4px;
Â  Â  Â  background: #020609;
Â  Â  Â  border-radius: 9px;
Â  Â  Â  border: 1px solid rgba(0,0,0,0.9);
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: 280px minmax(0,1fr);
Â  Â  Â  overflow: hidden;
Â  Â  Â  box-shadow: var(--shadow-soft);
Â  Â  Â  min-height: 520px;
Â  Â  Â  flex-grow: 1; /* Make sure DAW shell takes up vertical space */
Â  Â  }
Â  Â  @media (max-width: 900px) {
Â  Â  Â  .daw-shell { grid-template-columns: minmax(0,1fr); }
Â  Â  }

Â  Â  /* BROWSER LEFT */
Â  Â  .browser {
Â  Â  Â  background: radial-gradient(circle at top,#18242f 0,#04070c 60%);
Â  Â  Â  border-right: 1px solid #000;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  min-height: 0;
Â  Â  }
Â  Â  .browser-header {
Â  Â  Â  padding: 5px 7px;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 6px;
Â  Â  Â  border-bottom: 1px solid rgba(0,0,0,0.9);
Â  Â  Â  background: linear-gradient(to bottom,#1a2836,#091017);
Â  Â  Â  font-size: 11px;
Â  Â  }
Â  Â  .browser-title {
Â  Â  Â  font-weight: 600;
Â  Â  Â  color: var(--accent-strong);
Â  Â  Â  text-transform: uppercase;
Â  Â  Â  letter-spacing: .12em;
Â  Â  }
Â  Â  .browser-search {
Â  Â  Â  margin-left: auto;
Â  Â  Â  flex: 1;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 4px;
Â  Â  }
Â  Â  .browser-search input {
Â  Â  Â  width: 100%;
Â  Â  Â  border-radius: 999px;
Â  Â  Â  border: 1px solid rgba(0,0,0,0.8);
Â  Â  Â  background: #050c12;
Â  Â  Â  color: var(--text-main);
Â  Â  Â  font-size: 10px;
Â  Â  Â  padding: 3px 7px;
Â  Â  }
Â  Â  .browser-search input::placeholder {
Â  Â  Â  color: rgba(158,170,182,0.6);
Â  Â  }

Â  Â  .browser-tabs {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 2px;
Â  Â  Â  padding: 4px 4px 3px;
Â  Â  Â  border-bottom: 1px solid rgba(0,0,0,0.9);
Â  Â  Â  background: #091019;
Â  Â  Â  font-size: 10px;
Â  Â  }
Â  Â  .browser-tab {
Â  Â  Â  padding: 3px 6px;
Â  Â  Â  border-radius: 4px 4px 0 0;
Â  Â  Â  cursor: pointer;
Â  Â  Â  color: var(--text-muted);
Â  Â  }
Â  Â  .browser-tab.active {
Â  Â  Â  background: #151f2b;
Â  Â  Â  color: var(--accent-strong);
Â  Â  }

Â  Â  .browser-body {
Â  Â  Â  flex: 1;
Â  Â  Â  min-height: 0;
Â  Â  Â  overflow: hidden;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  }

Â  Â  .browser-scroll {
Â  Â  Â  flex: 1;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  padding: 4px 6px 8px;
Â  Â  Â  font-size: 11px;
Â  Â  Â  scrollbar-width: thin;
Â  Â  }
Â  Â  .browser-section { margin-bottom: 6px; }
Â  Â  .browser-section-title {
Â  Â  Â  text-transform: uppercase;
Â  Â  Â  letter-spacing: .12em;
Â  Â  Â  font-size: 9px;
Â  Â  Â  color: var(--text-muted);
Â  Â  Â  margin-bottom: 2px;
Â  Â  }
Â  Â  .browser-item {
Â  Â  Â  padding: 3px 4px;
Â  Â  Â  border-radius: 3px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  color: #c9d3dd;
Â  Â  }
Â  Â  .browser-item:hover {
Â  Â  Â  background: rgba(255,255,255,0.05);
Â  Â  }

Â  Â  .browser-tree {
Â  Â  Â  margin-left: 6px;
Â  Â  Â  border-left: 1px solid rgba(255,255,255,0.05);
Â  Â  Â  padding-left: 4px;
Â  Â  Â  margin-top: 2px;
Â  Â  }
Â  Â  .tree-group { margin-bottom: 4px; }
Â  Â  .tree-title {
Â  Â  Â  color: var(--accent-strong);
Â  Â  Â  cursor: pointer;
Â  Â  Â  padding: 2px 2px;
Â  Â  Â  border-radius: 3px;
Â  Â  Â  display: inline-flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 3px;
Â  Â  }
Â  Â  .tree-title::before {
Â  Â  Â  content: "â–¾";
Â  Â  Â  font-size: 8px;
Â  Â  }
Â  Â  .tree-title.collapsed::before { content: "â–¸"; }
Â  Â  .tree-content {
Â  Â  Â  margin-top: 3px;
Â  Â  Â  padding-left: 8px;
Â  Â  Â  border-left: 1px dashed rgba(255,255,255,0.08);
Â  Â  }
Â  Â  .tree-content.collapsed { display: none; }
Â  Â  .tree-content ul { margin: 0; padding: 0; list-style: none; }
Â  Â  .tree-content li { padding: 2px 0; color: #cbd6e3; }

Â  Â  /* PLAYLIST SIDE */
Â  Â  .playlist-wrap {
Â  Â  Â  background: radial-gradient(circle at top,#1c2734 0,#05070b 55%,#000 100%);
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  min-height: 0;
Â  Â  Â  flex-grow: 1; /* Make sure playlist takes up vertical space */
Â  Â  }
Â  Â  .playlist-header {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  padding: 4px 8px;
Â  Â  Â  border-bottom: 1px solid rgba(0,0,0,0.9);
Â  Â  Â  background: linear-gradient(to bottom,#182533,#0a1017);
Â  Â  Â  font-size: 11px;
Â  Â  Â  color: var(--text-muted);
Â  Â  }
Â  Â  .playlist-title {
Â  Â  Â  color: var(--accent-strong);
Â  Â  Â  font-weight: 600;
Â  Â  }
Â  Â  .playlist-toolbar {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 6px;
Â  Â  Â  font-size: 10px;
Â  Â  }
Â  Â  .small-pill {
Â  Â  Â  padding: 2px 5px;
Â  Â  Â  border-radius: 999px;
Â  Â  Â  border: 1px solid rgba(0,0,0,0.7);
Â  Â  Â  background: #071015;
Â  Â  Â  color: var(--text-muted);
Â  Â  Â  cursor: default;
Â  Â  }
Â  Â  .small-pill.active {
Â  Â  Â  border-color: var(--border-strong);
Â  Â  Â  color: var(--accent-strong);
Â  Â  }

Â  Â  .playlist-main {
Â  Â  Â  flex: 1;
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: 170px minmax(0,1fr);
Â  Â  Â  min-height: 0;
Â  Â  }

Â  Â  /* TRACK HEADERS */
Â  Â  .track-names {
Â  Â  Â  background: #04080d;
Â  Â  Â  border-right: 1px solid #000;
Â  Â  Â  font-size: 11px;
Â  Â  Â  color: var(--text-muted);
Â  Â  Â  position: relative;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  scrollbar-width: none; /* Hide scrollbar in track headers */
Â  Â  }
Â  Â  .track-row {
Â  Â  Â  position: relative;
Â  Â  }
Â  Â  .track-name-row {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  padding: 2px 6px;
Â  Â  Â  border-bottom: 1px solid rgba(255,255,255,0.03);
Â  Â  Â  background: linear-gradient(to bottom,rgba(9,16,23,0.9),rgba(4,7,11,0.9));
Â  Â  Â  height: 32px;
Â  Â  Â  gap: 4px;
Â  Â  Â  transition: height 0.1s ease;
Â  Â  }
Â  Â  .track-name-row:nth-child(odd) {
Â  Â  Â  background: linear-gradient(to bottom,rgba(11,19,27,0.9),rgba(5,9,13,0.9));
Â  Â  }
Â  Â  .track-dot {
Â  Â  Â  width: 9px;
Â  Â  Â  height: 9px;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  background: var(--accent-soft);
Â  Â  Â  box-shadow: 0 0 7px rgba(112,255,99,0.7);
Â  Â  }
Â  Â  .track-label-text {
Â  Â  Â  color: #d3dfe7;
Â  Â  Â  flex: 1;
Â  Â  Â  padding: 1px 3px;
Â  Â  Â  border-radius: 3px;
Â  Â  Â  cursor: text;
Â  Â  }
Â  Â  .track-label-text[contenteditable="true"] {
Â  Â  Â  outline: 1px solid var(--accent-soft);
Â  Â  Â  background: #050b10;
Â  Â  }
Â  Â  .track-label-text:focus {
Â  Â  Â  outline: none;
Â  Â  }

Â  Â  .track-controls {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 3px;
Â  Â  Â  font-size: 9px;
Â  Â  }
Â  Â  .track-btn {
Â  Â  Â  width: 18px;
Â  Â  Â  height: 18px;
Â  Â  Â  border-radius: 3px;
Â  Â  Â  border: 1px solid rgba(0,0,0,0.8);
Â  Â  Â  background: #070d12;
Â  Â  Â  color: var(--text-muted);
Â  Â  Â  cursor: pointer;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  transition: all 0.1s ease;
Â  Â  Â  user-select: none;
Â  Â  }
Â  Â  .track-btn:hover {
Â  Â  Â  background: #0c151e;
Â  Â  }
Â  Â  .track-btn.active {
Â  Â  Â  background: var(--accent);
Â  Â  Â  color: #02110b;
Â  Â  Â  border-color: var(--border-strong);
Â  Â  Â  box-shadow: 0 0 8px rgba(112,255,99,0.9);
Â  Â  Â  font-weight: 600;
Â  Â  }
Â  Â  .track-btn.solo.active {
Â  Â  Â  background: #fdf56f;
Â  Â  Â  color: #02110b;
Â  Â  Â  border-color: #ffd000;
Â  Â  Â  box-shadow: 0 0 8px rgba(255,215,0,0.9);
Â  Â  }
Â  Â  .track-btn.mute.active {
Â  Â  Â  background: #606060;
Â  Â  Â  color: #111;
Â  Â  Â  border-color: #333;
Â  Â  Â  box-shadow: none;
Â  Â  }

Â  Â  .track-volume {
Â  Â  Â  width: 40px;
Â  Â  Â  height: 3px;
Â  Â  Â  background: #1a2836;
Â  Â  Â  -webkit-appearance: none;
Â  Â  Â  appearance: none;
Â  Â  Â  border-radius: 999px;
Â  Â  Â  cursor: pointer;
Â  Â  }
Â  Â  .track-volume::-webkit-slider-thumb {
Â  Â  Â  -webkit-appearance: none;
Â  Â  Â  appearance: none;
Â  Â  Â  width: 8px;
Â  Â  Â  height: 8px;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  background: var(--accent);
Â  Â  Â  cursor: pointer;
Â  Â  Â  border: 1px solid #fff;
Â  Â  Â  box-shadow: 0 0 5px var(--accent);
Â  Â  }

Â  Â  .track-menu-wrap {
Â  Â  Â  position: relative;
Â  Â  }
Â  Â  .track-menu {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 22px;
Â  Â  Â  right: 0;
Â  Â  Â  min-width: 130px;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  border: 1px solid rgba(0,0,0,0.8);
Â  Â  Â  background: #0c151e;
Â  Â  Â  box-shadow: 0 10px 20px rgba(0,0,0,0.9);
Â  Â  Â  font-size: 10px;
Â  Â  Â  padding: 4px 0;
Â  Â  Â  display: none;
Â  Â  Â  z-index: 20;
Â  Â  }
Â  Â  .track-menu.open { display: block; }
Â  Â  .track-menu-item {
Â  Â  Â  padding: 4px 8px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  color: var(--text-main);
Â  Â  }
Â  Â  .track-menu-item:hover {
Â  Â  Â  background: rgba(255,255,255,0.07);
Â  Â  }

Â  Â  .track-resize-handle {
Â  Â  Â  height: 4px;
Â  Â  Â  cursor: row-resize;
Â  Â  Â  background: linear-gradient(to right,transparent,var(--grid-line),transparent);
Â  Â  }

Â  Â  /* GRID */
Â  Â  .playlist-grid {
Â  Â  Â  position: relative;
Â  Â  Â  background: #0d1823;
Â  Â  Â  overflow: auto;
Â  Â  }
Â  Â  .timeline-ruler {
Â  Â  Â  position: sticky;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  right: 0;
Â  Â  Â  height: 22px;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: flex-end;
Â  Â  Â  font-size: 9px;
Â  Â  Â  background: #071019;
Â  Â  Â  border-bottom: 1px solid rgba(0,0,0,0.9);
Â  Â  Â  box-shadow: 0 4px 6px rgba(0,0,0,0.8);
Â  Â  Â  z-index: 2;
Â  Â  }
Â  Â  .timeline-ruler-inner {
Â  Â  Â  display: flex;
Â  Â  Â  /* We set min-width to match the grid */
Â  Â  Â  min-width: 1300px;
Â  Â  Â  padding: 3px 6px;
Â  Â  Â  white-space: nowrap;
Â  Â  Â  color: var(--text-muted);
Â  Â  }
Â  Â  .timeline-ruler-inner span {
Â  Â  Â  width: 48px; /* BEAT_PIXELS */
Â  Â  Â  text-align: left;
Â  Â  }

Â  Â  .grid-inner {
Â  Â  Â  position: relative;
Â  Â  Â  min-width: 1300px;
Â  Â  Â  padding: 0 6px 6px;
Â  Â  Â  background-image:
Â  Â  Â  Â  linear-gradient(to right,var(--grid-line) 1px,transparent 1px),
Â  Â  Â  Â  linear-gradient(to bottom,var(--grid-line) 1px,transparent 1px);
Â  Â  Â  background-size: 48px 32px, 1px 32px; /* 48px wide lines (beats), 32px high rows */
Â  Â  }

Â  Â  .grid-track-row {
Â  Â  Â  height: 32px;
Â  Â  Â  border-bottom: 1px solid rgba(255,255,255,0.04);
Â  Â  Â  position: relative;
Â  Â  Â  transition: height 0.1s ease;
Â  Â  }
Â  Â  .grid-track-row:nth-child(even) {
Â  Â  Â  background-color: rgba(0,0,0,0.05);
Â  Â  }

Â  Â  .pattern-block {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 4px;
Â  Â  Â  height: 24px;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  background: linear-gradient(120deg,rgba(112,255,99,0.7),rgba(39,181,130,0.8));
Â  Â  Â  box-shadow: 0 0 12px rgba(112,255,99,0.9);
Â  Â  Â  color: #02110b;
Â  Â  Â  font-size: 10px;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  padding: 0 6px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  white-space: nowrap;
Â  Â  Â  overflow: hidden;
Â  Â  Â  text-overflow: ellipsis;
Â  Â  Â  user-select: none;
Â  Â  Â  transition: box-shadow 0.1s ease;
Â  Â  }
Â  Â  .pattern-block.selected {
Â  Â  Â  box-shadow: 0 0 16px rgba(255,255,255,0.9), inset 0 0 5px rgba(0,0,0,0.8);
Â  Â  Â  border: 1px solid #fff;
Â  Â  }

Â  Â  .playhead {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  bottom: 0;
Â  Â  Â  width: 2px;
Â  Â  Â  background: var(--accent);
Â  Â  Â  box-shadow: 0 0 8px rgba(112,255,99,0.9);
Â  Â  Â  left: 80px;
Â  Â  Â  pointer-events: none;
Â  Â  Â  z-index: 10;
Â  Â  }

Â  Â  .hint-bar {
Â  Â  Â  margin-top: 4px;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  border: 1px solid rgba(0,0,0,0.85);
Â  Â  Â  background: linear-gradient(to right,#121a22,#06090d);
Â  Â  Â  font-size: 10px;
Â  Â  Â  padding: 3px 6px;
Â  Â  Â  color: var(--text-muted);
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  gap: 4px;
Â  Â  }
Â  Â  .hint-bar span.key { color: var(--accent-strong); }

Â  Â  /* STEP SEQUENCER */
Â  Â  .step-sequencer {
Â  Â  Â  margin-top: 6px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  border: 1px solid rgba(0,0,0,0.9);
Â  Â  Â  background: linear-gradient(to bottom,#101821,#05070b);
Â  Â  Â  box-shadow: var(--shadow-soft);
Â  Â  Â  padding: 6px 8px 8px;
Â  Â  Â  font-size: 11px;
Â  Â  }
Â  Â  .step-header {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  margin-bottom: 6px;
Â  Â  }
Â  Â  .step-header-left {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 8px;
Â  Â  }
Â  Â  .step-title {
Â  Â  Â  text-transform: uppercase;
Â  Â  Â  letter-spacing: .12em;
Â  Â  Â  color: var(--accent-strong);
Â  Â  Â  font-size: 10px;
Â  Â  }
Â  Â  .step-current-pattern {
Â  Â  Â  font-size: 10px;
Â  Â  Â  color: var(--text-main);
Â  Â  Â  font-weight: 600;
Â  Â  }
Â  Â  .step-hint {
Â  Â  Â  color: var(--text-muted);
Â  Â  Â  font-size: 10px;
Â  Â  }
Â  Â  .step-grid {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 4px;
Â  Â  Â  margin-top: 2px;
Â  Â  Â  overflow-x: auto;
Â  Â  Â  padding-bottom: 4px;
Â  Â  }
Â  Â  .step-row {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 6px;
Â  Â  Â  white-space: nowrap;
Â  Â  }
Â  Â  .step-label {
Â  Â  Â  width: 40px;
Â  Â  Â  text-align: right;
Â  Â  Â  color: var(--text-muted);
Â  Â  Â  font-size: 10px;
Â  Â  Â  text-transform: capitalize;
Â  Â  }
Â  Â  .step-cells {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 2px;
Â  Â  }
Â  Â  .step-cell {
Â  Â  Â  width: 18px;
Â  Â  Â  height: 18px;
Â  Â  Â  border-radius: 3px;
Â  Â  Â  border: 1px solid rgba(0,0,0,0.7);
Â  Â  Â  background: #050b10;
Â  Â  Â  cursor: pointer;
Â  Â  Â  box-shadow: inset 0 0 4px rgba(0,0,0,0.9);
Â  Â  Â  transition: all 0.1s ease;
Â  Â  }
Â  Â  .step-cell:hover {
Â  Â  Â  background: #0c151e;
Â  Â  }
Â  Â  .step-cell.on {
Â  Â  Â  background: var(--accent);
Â  Â  Â  box-shadow: 0 0 8px rgba(112,255,99,0.9);
Â  Â  Â  border-color: var(--border-strong);
Â  Â  Â  transform: scale(1.05);
Â  Â  }
Â  Â  .step-cell.beat {
Â  Â  Â  border-top: 1px solid rgba(255,255,255,0.3);
Â  Â  }
Â  Â  .step-cell.subbeat {
Â  Â  Â  opacity: 0.85;
Â  Â  }
Â  Â  .step-cell.active-step {
Â  Â  Â  outline: 2px solid #fff;
Â  Â  Â  outline-offset: 1px;
Â  Â  Â  box-shadow: 0 0 10px rgba(255,255,255,0.7);
Â  Â  }
Â  </style>
</head>
<body>
<header>
Â  <div class="app-header-inner">
Â  Â  <div class="brand-wrap">
Â  Â  Â  <div class="brand-icon">S</div>
Â  Â  Â  <div>
Â  Â  Â  Â  <div class="brand-title-main">Sulandra AI Studio</div>
Â  Â  Â  Â  <div class="brand-title-sub">Sound Â· Daw View</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <nav class="top-nav-links">
Â  Â  Â  <a href="index.html">Home</a>
Â  Â  Â  <a href="image.html">Image Lab</a>
Â  Â  Â  <a href="video.html">Video Lab</a>
Â  Â  Â  <a href="music.html">Music Lab</a>
Â  Â  Â  <a href="film.html">Film Lab</a>
Â  Â  Â  <a href="studio.html">Studio</a>
Â  Â  Â  <a href="sound.html" class="active">Sound DAW</a>
Â  Â  </nav>
Â  Â  <div class="profile-pill">
Â  Â  Â  <div class="profile-dot"></div>
Â  Â  Â  <span>Project: <strong>We Need A Miracle</strong></span>
Â  Â  </div>
Â  </div>
</header>

<main>
Â  <!-- MENU / TRANSPORT -->
Â  <section class="menu-transport">
Â  Â  <div class="menu-row">
Â  Â  Â  <div class="menu-item">File</div>
Â  Â  Â  <div class="menu-item">Edit</div>
Â  Â  Â  <div class="menu-item">Add</div>
Â  Â  Â  <div class="menu-item">Patterns</div>
Â  Â  Â  <div class="menu-item">View</div>
Â  Â  Â  <div class="menu-item">Options</div>
Â  Â  Â  <div class="menu-item">Tools</div>
Â  Â  Â  <div class="menu-item">Help</div>
Â  Â  </div>
Â  Â  <div class="transport-row">
Â  Â  Â  <div class="transport-left">
Â  Â  Â  Â  <button class="btn-transport" id="btn-back">â®</button>
Â  Â  Â  Â  <button class="btn-transport" id="btn-play">â–¶</button>
Â  Â  Â  Â  <button class="btn-transport green" id="btn-stop">â¹</button>
Â  Â  Â  Â  <button class="btn-transport" id="btn-forward">â­</button>
Â  Â  Â  Â  <button class="btn-transport" id="btn-loop">ğŸ”„</button>
Â  Â  Â  Â  <div class="snap-block">
Â  Â  Â  Â  Â  <span>Mode:</span><span id="mode-label">Song</span>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="transport-center">
Â  Â  Â  Â  <div class="tempo-block">
Â  Â  Â  Â  Â  <span>Tempo</span>
Â  Â  Â  Â  Â  <span class="tempo-value" id="tempo-value">130.000</span>
Â  Â  Â  Â  Â  <span>BPM</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="display-field" id="time-display">0:00:00</div>
Â  Â  Â  Â  <div class="snap-block">
Â  Â  Â  Â  Â  <span>Snap:</span>
Â  Â  Â  Â  Â  <span>Line</span>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="transport-right">
Â  Â  Â  Â  <button class="btn-transport record" id="btn-record">â—</button>
Â  Â  Â  Â  <span id="status-label">Ready</span>
Â  Â  Â  </div>
Â  Â  </div>
Â  </section>

Â  <!-- DAW SHELL -->
Â  <section class="daw-shell">
Â  Â  <!-- BROWSER -->
Â  Â  <aside class="browser">
Â  Â  Â  <div class="browser-header">
Â  Â  Â  Â  <span class="browser-title">Browser</span>
Â  Â  Â  Â  <div class="browser-search">
Â  Â  Â  Â  Â  <input type="text" placeholder="Searchâ€¦" />
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="browser-tabs">
Â  Â  Â  Â  <div class="browser-tab active" data-tab="project">Project</div>
Â  Â  Â  Â  <div class="browser-tab" data-tab="manual">Manual</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="browser-body">
Â  Â  Â  Â  <!-- PROJECT TAB -->
Â  Â  Â  Â  <div class="browser-scroll" id="tab-project">
Â  Â  Â  Â  Â  <div class="browser-section">
Â  Â  Â  Â  Â  Â  <div class="browser-section-title">PROJECT</div>
Â  Â  Â  Â  Â  Â  <div class="browser-item">Current project</div>
Â  Â  Â  Â  Â  Â  <div class="browser-item">Recent files</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="browser-section">
Â  Â  Â  Â  Â  Â  <div class="browser-section-title">BROWSERS</div>
Â  Â  Â  Â  Â  Â  <div class="browser-item">Plugin database</div>
Â  Â  Â  Â  Â  Â  <div class="browser-item">Channel presets</div>
Â  Â  Â  Â  Â  Â  <div class="browser-item">Mixer presets</div>
Â  Â  Â  Â  Â  Â  <div class="browser-item">Scores</div>
Â  Â  Â  Â  Â  Â  <div class="browser-item">Packs</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- MANUAL TAB (condensed tree) -->
Â  Â  Â  Â  <div class="browser-scroll" id="tab-manual" style="display:none;">
Â  Â  Â  Â  Â  <div class="browser-section">
Â  Â  Â  Â  Â  Â  <div class="browser-section-title">FL STUDIO REFERENCE MANUAL</div>
Â  Â  Â  Â  Â  Â  <div class="browser-tree">
Â  Â  Â  Â  Â  Â  Â  <div class="tree-group">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="tree-title">Overview & Getting Started</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="tree-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>What is FL Studio?</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>What's New in FL Studio?</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>The user interface</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Making music (Tutorial)</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="tree-group">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="tree-title">Setting Up & Options</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="tree-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Audio Setup & ASIO</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>MIDI Settings</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>File & Theme Settings</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Project Settings</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="tree-group">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="tree-title">Playlist / Mixer / Plugins</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="tree-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Playlist â€“ Patterns, Audio, Automation</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Mixer Functions & Effects</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Generator Plugins</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Effect Plugins</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="tree-group">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="tree-title">Files & Troubleshooting</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="tree-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Project & Export Formats</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Optimizing CPU Performance</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Reset Settings</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Glossary</li>
Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div> <!-- browser body -->
Â  Â  </aside>

Â  Â  <!-- PLAYLIST -->
Â  Â  <section class="playlist-wrap">
Â  Â  Â  <div class="playlist-header">
Â  Â  Â  Â  <div class="playlist-title">Playlist â€“ Arrangement (none)</div>
Â  Â  Â  Â  <div class="playlist-toolbar">
Â  Â  Â  Â  Â  <div class="small-pill active">Track mode</div>
Â  Â  Â  Â  Â  <div class="small-pill">Draw</div>
Â  Â  Â  Â  Â  <div class="small-pill">Paint</div>
Â  Â  Â  Â  Â  <div class="small-pill">Slice</div>
Â  Â  Â  Â  Â  <div class="small-pill">Zoom</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button class="track-btn" onclick="addTrack()"><small>+ Track</small></button>
Â  Â  Â  </div>

Â  Â  Â  <div class="playlist-main">
Â  Â  Â  Â  <!-- TRACK HEADERS -->
Â  Â  Â  Â  <div class="track-names" id="track-headers">
Â  Â  Â  Â  Â  <!-- tracks generated by JS -->
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- GRID -->
Â  Â  Â  Â  <div class="playlist-grid" id="playlist-grid">
Â  Â  Â  Â  Â  <div class="timeline-ruler">
Â  Â  Â  Â  Â  Â  <div class="timeline-ruler-inner" id="timeline-labels">
Â  Â  Â  Â  Â  Â  Â  <!-- labels filled by JS -->
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="grid-inner" id="grid-inner" style="width: 1536px;"> <!-- 32 beats * 48px/beat -->
Â  Â  Â  Â  Â  Â  <div class="playhead" id="playhead"></div>
Â  Â  Â  Â  Â  Â  <!-- track rows + patterns filled by JS -->
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </section>
Â  </section>

Â  <!-- STEP SEQUENCER -->
Â  <section class="step-sequencer" id="step-sequencer">
Â  Â  <div class="step-header">
Â  Â  Â  <div class="step-header-left">
Â  Â  Â  Â  <div class="step-title">Pattern Step Sequencer</div>
Â  Â  Â  Â  <div class="step-current-pattern" id="step-current-pattern">No pattern selected</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="step-hint">
Â  Â  Â  Â  Click a pattern in the playlist to edit â€¢ 16 steps = 4 beats (Kick / Snare / Hat)
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="step-grid" id="step-grid">
Â  Â  Â  <!-- Rows will be filled by JS -->
Â  Â  </div>
Â  </section>

Â  <!-- HINTS -->
Â  <section class="hint-bar">
Â  Â  <span>Double-click track name to rename â€¢ Use M/S for mute / solo â€¢ Track menu â†’ Upload / Record / Create pattern.</span>
Â  Â  <span>Play = metronome + active patterns (Kick / Snare / Hat) at 130 BPM â€“ all in the browser.</span>
Â  </section>
</main>

<input type="file" id="hidden-file-input" style="display:none" accept="audio/*" />

<script>
Â  // === BASIC STATE ===
Â  let trackCounter = 0;
Â  let patternCounter = 0;
Â  const GRID_BEATS = 32;Â  Â  Â  Â  Â // number of beats across the grid
Â  const BEAT_PIXELS = 48;Â  Â  Â  Â  // pixels per beat
Â  const GRID_WIDTH = GRID_BEATS * BEAT_PIXELS;
Â  const TRACK_HEIGHT = 32; // Fixed height for simplicity

Â  const tracks = [];
Â  let patterns = [];Â  Â  Â  Â  Â  Â  Â // {id, trackIndex, startBeat, lengthBeats, label, steps}
Â  let selectedPatternId = null;

Â  let isPlaying = false;
Â  let playStartTime = 0; // The time the clock started (or resumed)
Â  let playheadTime = 0;Â  // The current position in seconds
Â  let tempo = 130.000;
Â  let loopEnabled = false;

Â  let lastGlobalStep = -1;Â  Â  Â  Â // for metronome + sequencer
Â  const STEPS_PER_BEAT = 4;Â  Â  Â  // 16th notes
Â  const STEPS_PER_BAR = 16;Â  Â  Â  // 4 beats * 4
Â  const SEQ_ROWS = ['kick','snare','hat'];
Â  const PATTERN_LENGTH_BEATS = 4; // Default pattern length in beats

Â  // DOM references
Â  const playBtn = document.getElementById('btn-play');
Â  const stopBtn = document.getElementById('btn-stop');
Â  const loopBtn = document.getElementById('btn-loop');
Â  const backBtn = document.getElementById('btn-back');
Â  const fwdBtn = document.getElementById('btn-forward');
Â  const recordBtn = document.getElementById('btn-record');
Â  const timeDisplay = document.getElementById('time-display');
Â  const tempoDisplay = document.getElementById('tempo-value');
Â  const statusLabel = document.getElementById('status-label');
Â  const playlistGridEl = document.getElementById('playlist-grid');
Â  const playheadEl = document.getElementById('playhead');
Â  const gridInner = document.getElementById('grid-inner');
Â  const trackHeaders = document.getElementById('track-headers');
Â  const timelineLabels = document.getElementById('timeline-labels');
Â  const hiddenFileInput = document.getElementById('hidden-file-input');
Â  const stepGridEl = document.getElementById('step-grid');
Â  const stepCurrentPattern = document.getElementById('step-current-pattern');

Â  // Global Animation Frame ID
Â  let animationFrameId = null;


Â  // === WEB AUDIO ===
Â  let audioCtx = null;
Â  let noiseBuffer = null;

Â  function ensureAudioContext() {
Â  Â  if (!audioCtx) {
Â  Â  Â  const AC = window.AudioContext || window.webkitAudioContext;
Â  Â  Â  audioCtx = new AC();
Â  Â  Â  createNoiseBuffer();
Â  Â  }
Â  Â  if (audioCtx.state === 'suspended') {
Â  Â  Â  audioCtx.resume();
Â  Â  }
Â  }

Â  function createNoiseBuffer() {
Â  Â  if (!audioCtx || noiseBuffer) return;
Â  Â  const length = audioCtx.sampleRate * 0.5; // 0.5 seconds of noise
Â  Â  const buffer = audioCtx.createBuffer(1, length, audioCtx.sampleRate);
Â  Â  const data = buffer.getChannelData(0);
Â  Â  for (let i = 0; i < length; i++) {
Â  Â  Â  data[i] = Math.random() * 2 - 1;
Â  Â  }
Â  Â  noiseBuffer = buffer;
Â  }

Â  // Simplified audio functions (Metronome, Kick, Snare, Hat) for demo
Â  function playMetronome(accent) {
Â  Â  if (!audioCtx) return;
Â  Â  const now = audioCtx.currentTime;
Â  Â  const osc = audioCtx.createOscillator();
Â  Â  const gain = audioCtx.createGain();

Â  Â  osc.type = 'square';
Â  Â  const freq = accent ? 3000 : 2000;
Â  Â  osc.frequency.setValueAtTime(freq, now);

Â  Â  gain.gain.setValueAtTime(accent ? 0.3 : 0.15, now);
Â  Â  gain.gain.exponentialRampToValueAtTime(0.001, now + 0.08);

Â  Â  osc.connect(gain).connect(audioCtx.destination);
Â  Â  osc.start(now);
Â  Â  osc.stop(now + 0.1);
Â  }

Â  function playKick() {
Â  Â  if (!audioCtx || tracks[0].muted || tracks[0].solo) return;
Â  Â  const now = audioCtx.currentTime;
Â  Â  const osc = audioCtx.createOscillator();
Â  Â  const gain = audioCtx.createGain();

Â  Â  osc.type = 'sine';
Â  Â  osc.frequency.setValueAtTime(150, now);
Â  Â  osc.frequency.exponentialRampToValueAtTime(50, now + 0.15);

Â  Â  gain.gain.setValueAtTime(0.9 * tracks[0].volume, now);
Â  Â  gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);

Â  Â  osc.connect(gain).connect(audioCtx.destination);
Â  Â  osc.start(now);
Â  Â  osc.stop(now + 0.2);
Â  }

Â  function playSnare() {
Â  Â  if (!audioCtx || !noiseBuffer || tracks[1].muted || tracks[1].solo) return;
Â  Â  const now = audioCtx.currentTime;
Â  Â  const noise = audioCtx.createBufferSource();
Â  Â  noise.buffer = noiseBuffer;

Â  Â  const filter = audioCtx.createBiquadFilter();
Â  Â  filter.type = 'bandpass';
Â  Â  filter.frequency.value = 1800;
Â  Â  filter.Q.value = 1;

Â  Â  const gain = audioCtx.createGain();
Â  Â  gain.gain.setValueAtTime(0.4 * tracks[1].volume, now);
Â  Â  gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);

Â  Â  noise.connect(filter).connect(gain).connect(audioCtx.destination);
Â  Â  noise.start(now);
Â  Â  noise.stop(now + 0.2);
Â  }

Â  function playHat() {
Â  Â  if (!audioCtx || !noiseBuffer || tracks[2].muted || tracks[2].solo) return;
Â  Â  const now = audioCtx.currentTime;
Â  Â  const noise = audioCtx.createBufferSource();
Â  Â  noise.buffer = noiseBuffer;

Â  Â  const filter = audioCtx.createBiquadFilter();
Â  Â  filter.type = 'highpass';
Â  Â  filter.frequency.value = 7000;

Â  Â  const gain = audioCtx.createGain();
Â  Â  gain.gain.setValueAtTime(0.15 * tracks[2].volume, now);
Â  Â  gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);

Â  Â  noise.connect(filter).connect(gain).connect(audioCtx.destination);
Â  Â  noise.start(now);
Â  Â  noise.stop(now + 0.1);
Â  }

Â  const instrumentMap = {
Â  Â  'kick': playKick,
Â  Â  'snare': playSnare,
Â  Â  'hat': playHat
Â  };

Â  // === INIT TIMELINE LABELS ===
Â  function initTimelineLabels() {
Â  Â  timelineLabels.innerHTML = '';
Â  Â  for (let i = 1; i <= GRID_BEATS; i++) {
Â  Â  Â  const span = document.createElement('span');
Â  Â  Â  span.textContent = i;
Â  Â  Â  timelineLabels.appendChild(span);
Â  Â  }
Â  Â  gridInner.style.minWidth = GRID_WIDTH + 'px';
Â  Â  // Ensure ruler width matches grid width
Â  Â  timelineLabels.style.minWidth = GRID_WIDTH + 'px';
Â  }


Â  // === TRACKS / UI RENDERING ===

Â  function createTrack(index, initialName) {
Â  Â  const track = {
Â  Â  Â  index: index,
Â  Â  Â  name: initialName || `Track ${index + 1}`,
Â  Â  Â  height: TRACK_HEIGHT,
Â  Â  Â  muted: false,
Â  Â  Â  solo: false,
Â  Â  Â  volume: 0.8
Â  Â  };
Â  Â  tracks.push(track);
Â  }

Â  function addTrack() {
Â  Â  const newIndex = tracks.length;
Â  Â  createTrack(newIndex);
Â  Â  renderTracks();
Â  Â  renderGrid();
Â  }


Â  // Set up initial tracks (Kick, Snare, Hat as first three)
Â  createTrack(0, 'Kick');
Â  createTrack(1, 'Snare');
Â  createTrack(2, 'Hat');
Â  for (let i = 3; i < 9; i++) createTrack(i);


Â  function toggleMute(index) {
Â  Â  const track = tracks[index];
Â  Â  track.muted = !track.muted;
Â  Â  if (track.muted && track.solo) track.solo = false;
Â  Â  renderTracks();
Â  }

Â  function toggleSolo(index) {
Â  Â  const track = tracks[index];
Â  Â  track.solo = !track.solo;

Â  Â  // Mute button is automatically toggled off if solo is turned on
Â  Â  if (track.solo && track.muted) track.muted = false;

Â  Â  // If any track is soloed, all non-soloed tracks are effectively muted
Â  Â  // We don't need to change the 'muted' state of other tracks, just rerender
Â  Â  renderTracks();
Â  }

Â  function updateVolume(index, value) {
Â  Â  tracks[index].volume = parseFloat(value);
Â  }

Â  function renderTracks() {
Â  Â  trackHeaders.innerHTML = '';

Â  Â  tracks.forEach(track => {
Â  Â  Â  const headerRow = document.createElement('div');
Â  Â  Â  headerRow.className = 'track-name-row';
Â  Â  Â  headerRow.dataset.trackIndex = track.index;
Â  Â  Â  headerRow.style.height = TRACK_HEIGHT + 'px';

Â  Â  Â  const dot = document.createElement('div');
Â  Â  Â  dot.className = 'track-dot';

Â  Â  Â  const label = document.createElement('div');
Â  Â  Â  label.className = 'track-label-text';
Â  Â  Â  label.textContent = track.name;
Â  Â  Â  label.dataset.trackIndex = track.index;

Â  Â  Â  // Track Renaming Logic
Â  Â  Â  label.addEventListener('dblclick', () => {
Â  Â  Â  Â  label.contentEditable = 'true';
Â  Â  Â  Â  label.focus();
Â  Â  Â  Â  // Select all text for easy replacement
Â  Â  Â  Â  document.execCommand('selectAll', false, null);
Â  Â  Â  });
Â  Â  Â  label.addEventListener('blur', () => {
Â  Â  Â  Â  label.contentEditable = 'false';
Â  Â  Â  Â  track.name = label.textContent || `Track ${track.index + 1}`;
Â  Â  Â  Â  label.textContent = track.name;
Â  Â  Â  Â  // If this is a drum track, update the pattern labels
Â  Â  Â  Â  renderPatterns();
Â  Â  Â  });
Â  Â  Â  label.addEventListener('keydown', (e) => {
Â  Â  Â  Â  if (e.key === 'Enter') {
Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  label.blur();
Â  Â  Â  Â  }
Â  Â  Â  });


Â  Â  Â  const controls = document.createElement('div');
Â  Â  Â  controls.className = 'track-controls';

Â  Â  Â  // Mute Button
Â  Â  Â  const muteBtn = document.createElement('div');
Â  Â  Â  muteBtn.className = `track-btn mute ${track.muted ? 'active' : ''}`;
Â  Â  Â  muteBtn.textContent = 'M';
Â  Â  Â  muteBtn.title = 'Mute';
Â  Â  Â  muteBtn.addEventListener('click', () => toggleMute(track.index));

Â  Â  Â  // Solo Button
Â  Â  Â  const soloBtn = document.createElement('div');
Â  Â  Â  soloBtn.className = `track-btn solo ${track.solo ? 'active' : ''}`;
Â  Â  Â  soloBtn.textContent = 'S';
Â  Â  Â  soloBtn.title = 'Solo';
Â  Â  Â  soloBtn.addEventListener('click', () => toggleSolo(track.index));

Â  Â  Â  // Volume Slider
Â  Â  Â  const volumeSlider = document.createElement('input');
Â  Â  Â  volumeSlider.type = 'range';
Â  Â  Â  volumeSlider.min = '0';
Â  Â  Â  volumeSlider.max = '1';
Â  Â  Â  volumeSlider.step = '0.05';
Â  Â  Â  volumeSlider.value = track.volume;
Â  Â  Â  volumeSlider.className = 'track-volume';
Â  Â  Â  volumeSlider.title = `Volume: ${Math.round(track.volume * 100)}%`;
Â  Â  Â  volumeSlider.addEventListener('input', (e) => {
Â  Â  Â  Â  updateVolume(track.index, e.target.value);
Â  Â  Â  Â  volumeSlider.title = `Volume: ${Math.round(track.volume * 100)}%`;
Â  Â  Â  });

Â  Â  Â  // Track Menu Button (3 dots)
Â  Â  Â  const menuWrap = document.createElement('div');
Â  Â  Â  menuWrap.className = 'track-menu-wrap';

Â  Â  Â  const menuBtn = document.createElement('div');
Â  Â  Â  menuBtn.className = 'track-btn';
Â  Â  Â  menuBtn.innerHTML = 'â‹®';
Â  Â  Â  menuBtn.addEventListener('click', (e) => {
Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  toggleTrackMenu(menuWrap, track.index);
Â  Â  Â  });

Â  Â  Â  // Track Menu
Â  Â  Â  const menu = document.createElement('div');
Â  Â  Â  menu.className = 'track-menu';
Â  Â  Â  menu.innerHTML = `
Â  Â  Â  Â  <div class="track-menu-item" onclick="createNewPattern(${track.index})">â• Create Pattern</div>
Â  Â  Â  Â  <div class="track-menu-item" onclick="alert('TODO: Open Plugin for ${track.name}')">ğŸš Open Plugin</div>
Â  Â  Â  Â  <div class="track-menu-item" onclick="alert('TODO: Upload Sample to ${track.name}')">ğŸ“¤ Upload Sample</div>
Â  Â  Â  Â  <div class="track-menu-item" onclick="removeTrack(${track.index})" style="color:#f99">âŒ Delete Track</div>
Â  Â  Â  `;
Â  Â  Â  menuWrap.appendChild(menuBtn);
Â  Â  Â  menuWrap.appendChild(menu);

Â  Â  Â  controls.appendChild(muteBtn);
Â  Â  Â  controls.appendChild(soloBtn);
Â  Â  Â  controls.appendChild(volumeSlider);
Â  Â  Â  controls.appendChild(menuWrap);

Â  Â  Â  headerRow.appendChild(dot);
Â  Â  Â  headerRow.appendChild(label);
Â  Â  Â  headerRow.appendChild(controls);

Â  Â  Â  trackHeaders.appendChild(headerRow);
Â  Â  });
Â  }

Â  function toggleTrackMenu(menuWrap, trackIndex) {
Â  Â  // Close all other menus
Â  Â  document.querySelectorAll('.track-menu.open').forEach(m => {
Â  Â  Â  if (m.parentElement !== menuWrap) m.classList.remove('open');
Â  Â  });
Â  Â  menuWrap.querySelector('.track-menu').classList.toggle('open');
Â  }

Â  // Global click handler to close menus
Â  document.addEventListener('click', (e) => {
Â  Â  if (!e.target.closest('.track-menu-wrap')) {
Â  Â  Â  document.querySelectorAll('.track-menu.open').forEach(m => m.classList.remove('open'));
Â  Â  }
Â  });

Â  window.removeTrack = function(index) {
Â  Â  if (tracks.length === 1) return alert('Cannot delete the last track.');
Â  Â  tracks.splice(index, 1);
Â  Â  // Re-index remaining tracks
Â  Â  tracks.forEach((t, i) => t.index = i);
Â  Â  // Update patterns
Â  Â  patterns = patterns.filter(p => p.trackIndex !== index);
Â  Â  patterns.forEach(p => {
Â  Â  Â  if (p.trackIndex > index) p.trackIndex--;
Â  Â  });
Â  Â  selectedPatternId = null;
Â  Â  renderTracks();
Â  Â  renderGrid();
Â  Â  renderStepSequencer();
Â  };

Â  // === PATTERN LOGIC ===
Â  function defaultSteps() {
Â  Â  // simple 4-on-the-floor kick, snare on 5 & 13, hats every 2nd step
Â  Â  const steps = {
Â  Â  Â  kick: Array(STEPS_PER_BAR).fill(false),
Â  Â  Â  snare: Array(STEPS_PER_BAR).fill(false),
Â  Â  Â  hat: Array(STEPS_PER_BAR).fill(false)
Â  Â  };
Â  Â  for (let s = 0; s < STEPS_PER_BAR; s += 4) {
Â  Â  Â  steps.kick[s] = true; // beats 1,2,3,4
Â  Â  }
Â  Â  steps.snare[4] = true;Â  // beat 2
Â  Â  steps.snare[12] = true; // beat 4
Â  Â  for (let s = 0; s < STEPS_PER_BAR; s += 2) {
Â  Â  Â  steps.hat[s] = true;
Â  Â  }
Â  Â  return steps;
Â  }

Â  function createNewPattern(trackIndex) {
Â  Â  patternCounter++;
Â  Â  const newPattern = {
Â  Â  Â  id: patternCounter,
Â  Â  Â  trackIndex: trackIndex,
Â  Â  Â  startBeat: 1, // Start at beat 1 (index 0)
Â  Â  Â  lengthBeats: PATTERN_LENGTH_BEATS,
Â  Â  Â  label: `Pattern ${patternCounter}`,
Â  Â  Â  steps: defaultSteps()
Â  Â  };
Â  Â  patterns.push(newPattern);
Â  Â  selectPattern(newPattern.id);
Â  Â  renderGrid();
Â  }

Â  function findPatternById(id) {
Â  Â  return patterns.find(p => p.id === id) || null;
Â  }

Â  function selectPattern(id) {
Â  Â  selectedPatternId = id;
Â  Â  renderPatterns(); // Update selection visual
Â  Â  renderStepSequencer();
Â  }

Â  function renderPatterns() {
Â  Â  // Remove old patterns
Â  Â  document.querySelectorAll('.pattern-block').forEach(el => el.remove());

Â  Â  patterns.forEach(p => {
Â  Â  Â  const patternEl = document.createElement('div');
Â  Â  Â  patternEl.className = `pattern-block ${p.id === selectedPatternId ? 'selected' : ''}`;
Â  Â  Â  patternEl.dataset.patternId = p.id;

Â  Â  Â  // Calculate position and width
Â  Â  Â  const startPx = (p.startBeat - 1) * BEAT_PIXELS;
Â  Â  Â  const widthPx = p.lengthBeats * BEAT_PIXELS;
Â  Â  Â  const trackRowEl = gridInner.querySelector(`.grid-track-row[data-track-index="${p.trackIndex}"]`);

Â  Â  Â  if (trackRowEl) {
Â  Â  Â  Â  patternEl.style.left = `${startPx}px`;
Â  Â  Â  Â  patternEl.style.width = `${widthPx}px`;
Â  Â  Â  Â  patternEl.textContent = `${tracks[p.trackIndex].name}: ${p.label}`;
Â  Â  Â  Â  
Â  Â  Â  Â  patternEl.addEventListener('click', () => selectPattern(p.id));
Â  Â  Â  Â  
Â  Â  Â  Â  // Simple Dragging (Horizontal only)
Â  Â  Â  Â  let isDragging = false;
Â  Â  Â  Â  let startX;
Â  Â  Â  Â  let startBeat;
Â  Â  Â  Â  
Â  Â  Â  Â  patternEl.addEventListener('mousedown', (e) => {
Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  selectPattern(p.id);
Â  Â  Â  Â  Â  isDragging = true;
Â  Â  Â  Â  Â  startX = e.clientX;
Â  Â  Â  Â  Â  startBeat = p.startBeat;
Â  Â  Â  Â  Â  patternEl.style.cursor = 'grabbing';
Â  Â  Â  Â  });

Â  Â  Â  Â  document.addEventListener('mousemove', (e) => {
Â  Â  Â  Â  Â  if (!isDragging) return;
Â  Â  Â  Â  Â  const deltaX = e.clientX - startX;
Â  Â  Â  Â  Â  const deltaBeats = Math.round(deltaX / BEAT_PIXELS);
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  let newStartBeat = startBeat + deltaBeats;
Â  Â  Â  Â  Â  // Keep pattern within bounds (1 to GRID_BEATS - lengthBeats + 1)
Â  Â  Â  Â  Â  newStartBeat = Math.max(1, newStartBeat);
Â  Â  Â  Â  Â  newStartBeat = Math.min(GRID_BEATS - p.lengthBeats + 1, newStartBeat);

Â  Â  Â  Â  Â  p.startBeat = newStartBeat;
Â  Â  Â  Â  Â  patternEl.style.left = `${(p.startBeat - 1) * BEAT_PIXELS}px`;
Â  Â  Â  Â  });

Â  Â  Â  Â  document.addEventListener('mouseup', () => {
Â  Â  Â  Â  Â  if (isDragging) {
Â  Â  Â  Â  Â  Â  isDragging = false;
Â  Â  Â  Â  Â  Â  patternEl.style.cursor = 'pointer';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  trackRowEl.appendChild(patternEl);
Â  Â  Â  }
Â  Â  });
Â  }

Â  function renderGrid() {
Â  Â  // Clear existing rows
Â  Â  gridInner.querySelectorAll('.grid-track-row').forEach(el => el.remove());

Â  Â  // Create track rows in the grid
Â  Â  tracks.forEach(track => {
Â  Â  Â  const gridRow = document.createElement('div');
Â  Â  Â  gridRow.className = 'grid-track-row';
Â  Â  Â  gridRow.dataset.trackIndex = track.index;
Â  Â  Â  gridRow.style.height = TRACK_HEIGHT + 'px';
Â  Â  Â  gridInner.appendChild(gridRow);
Â  Â  });

Â  Â  renderPatterns();
Â  Â  
Â  Â  // Sync scrolling
Â  Â  trackHeaders.addEventListener('scroll', () => {
Â  Â  Â  playlistGridEl.scrollTop = trackHeaders.scrollTop;
Â  Â  });
Â  Â  playlistGridEl.addEventListener('scroll', () => {
Â  Â  Â  trackHeaders.scrollTop = playlistGridEl.scrollTop;
Â  Â  });
Â  }

Â  // === STEP SEQUENCER ===
Â  function toggleStep(patternId, instrumentKey, stepIndex) {
Â  Â  const pattern = findPatternById(patternId);
Â  Â  if (!pattern) return;

Â  Â  pattern.steps[instrumentKey][stepIndex] = !pattern.steps[instrumentKey][stepIndex];
Â  Â  renderStepSequencer(); // Re-render to update the visual state
Â  }

Â  function renderStepSequencer() {
Â  Â  stepGridEl.innerHTML = '';
Â  Â  const pattern = findPatternById(selectedPatternId);

Â  Â  if (!pattern) {
Â  Â  Â  stepCurrentPattern.textContent = 'No pattern selected';
Â  Â  Â  return;
Â  Â  }

Â  Â  stepCurrentPattern.textContent = `Editing: ${pattern.label} (Track ${pattern.trackIndex + 1}: ${tracks[pattern.trackIndex].name})`;

Â  Â  SEQ_ROWS.forEach(key => {
Â  Â  Â  const trackRow = tracks.find(t => t.index === SEQ_ROWS.indexOf(key)); // Assume Kick, Snare, Hat are tracks 0, 1, 2
Â  Â  Â  if (!trackRow) return;

Â  Â  Â  const rowEl = document.createElement('div');
Â  Â  Â  rowEl.className = 'step-row';

Â  Â  Â  const label = document.createElement('div');
Â  Â  Â  label.className = 'step-label';
Â  Â  Â  label.textContent = trackRow.name;
Â  Â  Â  rowEl.appendChild(label);

Â  Â  Â  const cellsEl = document.createElement('div');
Â  Â  Â  cellsEl.className = 'step-cells';

Â  Â  Â  for (let i = 0; i < STEPS_PER_BAR; i++) {
Â  Â  Â  Â  const cell = document.createElement('div');
Â  Â  Â  Â  cell.className = 'step-cell';
Â  Â  Â  Â  if (pattern.steps[key][i]) cell.classList.add('on');
Â  Â  Â  Â  if (i % STEPS_PER_BEAT === 0) cell.classList.add('beat'); // Major beats
Â  Â  Â  Â  else if (i % 2 === 0) cell.classList.add('subbeat'); // Off beats (8th notes)
Â  Â  Â  Â  
Â  Â  Â  Â  cell.dataset.stepIndex = i;
Â  Â  Â  Â  cell.dataset.instrument = key;
Â  Â  Â  Â  
Â  Â  Â  Â  cell.addEventListener('click', () => toggleStep(pattern.id, key, i));
Â  Â  Â  Â  cellsEl.appendChild(cell);
Â  Â  Â  }
Â  Â  Â  rowEl.appendChild(cellsEl);
Â  Â  Â  stepGridEl.appendChild(rowEl);
Â  Â  });
Â  Â  
Â  Â  // Update active step indicator
Â  Â  updateSequencerStepHighlight(lastGlobalStep);
Â  }
Â  
Â  function updateSequencerStepHighlight(globalStep) {
Â  Â  // Remove all existing highlights
Â  Â  document.querySelectorAll('.step-cell.active-step').forEach(el => el.classList.remove('active-step'));

Â  Â  if (globalStep === -1 || !selectedPatternId) return;

Â  Â  const currentStep = globalStep % STEPS_PER_BAR;

Â  Â  // Find all cells corresponding to the current step index
Â  Â  document.querySelectorAll(`.step-cell[data-step-index="${currentStep}"]`).forEach(el => {
Â  Â  Â  el.classList.add('active-step');
Â  Â  });
Â  }


Â  // === TIME / TRANSPORT LOGIC ===

Â  // Time calculations
Â  const secondsPerBeat = () => 60 / tempo;
Â  const secondsPerStep = () => secondsPerBeat() / STEPS_PER_BEAT;

Â  function updatePlayhead(timestamp) {
Â  Â  if (!isPlaying) {
Â  Â  Â  cancelAnimationFrame(animationFrameId);
Â  Â  Â  return;
Â  Â  }

Â  Â  // Calculate elapsed time since play started
Â  Â  const elapsedTime = (timestamp - playStartTime) / 1000;
Â  Â  
Â  Â  playheadTime = elapsedTime;

Â  Â  // Convert time to beats
Â  Â  const currentBeat = elapsedTime / secondsPerBeat();
Â  Â  const currentStep = Math.floor(currentBeat * STEPS_PER_BEAT); // Global step count

Â  Â  // Calculate position in pixels
Â  Â  const playheadX = currentBeat * BEAT_PIXELS;

Â  Â  // Check for loop
Â  Â  if (loopEnabled && currentBeat >= GRID_BEATS) {
Â  Â  Â  // Reset position if loop is enabled and we hit the end
Â  Â  Â  playheadTime = 0;
Â  Â  Â  playStartTime = timestamp;
Â  Â  } else if (currentBeat >= GRID_BEATS) {
Â  Â  Â  // Stop if not looping and we hit the end
Â  Â  Â  togglePlayStop();
Â  Â  Â  return;
Â  Â  }

Â  Â  // Update Playhead Position (UI)
Â  Â  playheadEl.style.transform = `translateX(${playheadX}px)`;

Â  Â  // Keep playhead centered (scroll the grid)
Â  Â  const scrollOffset = playheadX - (playlistGridEl.clientWidth / 2);
Â  Â  playlistGridEl.scrollLeft = scrollOffset;

Â  Â  // Update Time Display (UI)
Â  Â  updateTimeDisplay(playheadTime);

Â  Â  // Audio scheduling (Metronome/Sequencer)
Â  Â  metronomeSequencerScheduler(currentStep);
Â  Â  updateSequencerStepHighlight(currentStep);

Â  Â  // Request next frame
Â  Â  animationFrameId = requestAnimationFrame(updatePlayhead);
Â  }
Â  
Â  // Advanced Audio Scheduling (Lookahead)
Â  let nextStepTime = 0;

Â  function metronomeSequencerScheduler(currentGlobalStep) {
Â  Â  if (!audioCtx) return;

Â  Â  const lookahead = 0.1; // seconds
Â  Â  const scheduleAheadTime = 0.2; // seconds

Â  Â  while (nextStepTime < audioCtx.currentTime + scheduleAheadTime) {
Â  Â  Â  const stepNumber = Math.floor((nextStepTime / secondsPerBeat()) * STEPS_PER_BEAT);

Â  Â  Â  // 1. Metronome Tick
Â  Â  Â  if (stepNumber % STEPS_PER_BEAT === 0) {
Â  Â  Â  Â  const isFirstBeat = (stepNumber / STEPS_PER_BEAT) % 4 === 0; // Every 4 beats is bar 1
Â  Â  Â  Â  playMetronome(isFirstBeat);
Â  Â  Â  }

Â  Â  Â  // 2. Sequencer Playback
Â  Â  Â  const stepInBar = stepNumber % STEPS_PER_BAR;
Â  Â  Â  const beatInGlobalGrid = Math.floor(stepNumber / STEPS_PER_STEP) + 1;
Â  Â  Â  
Â  Â  Â  // Check all patterns currently covering this beat
Â  Â  Â  patterns.forEach(p => {
Â  Â  Â  Â  // Check if pattern is active on this beat
Â  Â  Â  Â  if (beatInGlobalGrid >= p.startBeat && beatInGlobalGrid < p.startBeat + p.lengthBeats) {
Â  Â  Â  Â  Â  // Calculate the step index within the pattern (which is always 16 steps long in our case)
Â  Â  Â  Â  Â  const patternStepIndex = stepInBar; // Since all patterns are 4 beats/16 steps long

Â  Â  Â  Â  Â  // Check the three sequencer rows (Kick, Snare, Hat) for this track
Â  Â  Â  Â  Â  if (p.trackIndex >= 0 && p.trackIndex < SEQ_ROWS.length) {
Â  Â  Â  Â  Â  Â  const instrument = SEQ_ROWS[p.trackIndex];
Â  Â  Â  Â  Â  Â  if (p.steps[instrument] && p.steps[instrument][patternStepIndex]) {
Â  Â  Â  Â  Â  Â  Â  // Only play if no track is soloed OR this track is soloed
Â  Â  Â  Â  Â  Â  Â  const isSoloed = tracks.some(t => t.solo);
Â  Â  Â  Â  Â  Â  Â  const track = tracks[p.trackIndex];

Â  Â  Â  Â  Â  Â  Â  if (!track.muted && (!isSoloed || track.solo)) {
Â  Â  Â  Â  Â  Â  Â  Â  instrumentMap[instrument]();
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // Advance to the next step time
Â  Â  Â  nextStepTime += secondsPerStep();
Â  Â  }
Â  }


Â  function updateTimeDisplay(seconds) {
Â  Â  const totalSeconds = Math.floor(seconds);
Â  Â  const mins = Math.floor(totalSeconds / 60);
Â  Â  const secs = totalSeconds % 60;
Â  Â  const ms = Math.floor((seconds - totalSeconds) * 100); // Hundredths of a second

Â  Â  const timeStr = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}:${ms.toString().padStart(2, '0')}`;
Â  Â  
Â  Â  // Also display beat/bar (just the first bar/beat/step of the current position)
Â  Â  const currentBeat = (seconds / secondsPerBeat());
Â  Â  const bar = Math.floor(currentBeat / 4) + 1;
Â  Â  const beat = Math.floor(currentBeat % 4) + 1;
Â  Â  const step = Math.floor(currentBeat * STEPS_PER_BEAT) % STEPS_PER_BEAT + 1;
Â  Â  
Â  Â  timeDisplay.textContent = `${bar.toString().padStart(3, '0')}:${beat.toString().padStart(2, '0')}:${step.toString().padStart(2, '0')}`;
Â  }

Â  function togglePlayStop() {
Â  Â  ensureAudioContext();
Â  Â  
Â  Â  isPlaying = !isPlaying;

Â  Â  if (isPlaying) {
Â  Â  Â  // Start playback
Â  Â  Â  statusLabel.textContent = 'Playing...';
Â  Â  Â  playBtn.classList.add('green');
Â  Â  Â  stopBtn.classList.remove('green');
Â  Â  Â  
Â  Â  Â  // Set initial playhead time for audio scheduling
Â  Â  Â  nextStepTime = audioCtx.currentTime + 0.05; // Schedule 50ms ahead

Â  Â  Â  // Start the animation loop
Â  Â  Â  playStartTime = performance.now() - (playheadTime * 1000);
Â  Â  Â  animationFrameId = requestAnimationFrame(updatePlayhead);
Â  Â  } else {
Â  Â  Â  // Stop playback (but keep current position)
Â  Â  Â  statusLabel.textContent = 'Paused';
Â  Â  Â  playBtn.classList.remove('green');
Â  Â  Â  stopBtn.classList.add('green');
Â  Â  Â  
Â  Â  Â  // Cancel the animation loop
Â  Â  Â  cancelAnimationFrame(animationFrameId);
Â  Â  }
Â  }

Â  function stopAndReset() {
Â  Â  isPlaying = false;
Â  Â  playheadTime = 0;
Â  Â  nextStepTime = 0;
Â  Â  lastGlobalStep = -1;
Â  Â  cancelAnimationFrame(animationFrameId);
Â  Â  
Â  Â  playheadEl.style.transform = `translateX(0px)`;
Â  Â  playlistGridEl.scrollLeft = 0;
Â  Â  updateTimeDisplay(0);
Â  Â  updateSequencerStepHighlight(-1);
Â  Â  
Â  Â  statusLabel.textContent = 'Ready';
Â  Â  playBtn.classList.remove('green');
Â  Â  stopBtn.classList.add('green');
Â  }

Â  function toggleLoop() {
Â  Â  loopEnabled = !loopEnabled;
Â  Â  loopBtn.classList.toggle('active-outline', loopEnabled);
Â  }
Â  
Â  function backToStart() {
Â  Â  if(isPlaying) {
Â  Â  Â  playStartTime = performance.now();
Â  Â  Â  playheadTime = 0;
Â  Â  } else {
Â  Â  Â  stopAndReset();
Â  Â  }
Â  }

Â  // === INIT AND LISTENERS ===

Â  window.onload = function() {
Â  Â  initTimelineLabels();
Â  Â  renderTracks();
Â  Â  renderGrid();
Â  Â  renderStepSequencer();
Â  Â  
Â  Â  // Initial dummy pattern for testing (Kick/Snare/Hat tracks)
Â  Â  createNewPattern(0); 
Â  Â  createNewPattern(1);
Â  Â  createNewPattern(2);
Â  Â  // Move pattern 3 to beat 5
Â  Â  patterns[2].startBeat = 5;
Â  Â  // Create a simple audio track pattern
Â  Â  patternCounter++;
Â  Â  patterns.push({
Â  Â  Â  id: patternCounter,
Â  Â  Â  trackIndex: 3,
Â  Â  Â  startBeat: 9,
Â  Â  Â  lengthBeats: 8,
Â  Â  Â  label: 'Acoustic Guitar Loop',
Â  Â  Â  steps: {}
Â  Â  });
Â  Â  renderPatterns();
Â  Â  
Â  Â  // Transport Listeners
Â  Â  playBtn.addEventListener('click', togglePlayStop);
Â  Â  stopBtn.addEventListener('click', stopAndReset);
Â  Â  loopBtn.addEventListener('click', toggleLoop);
Â  Â  backBtn.addEventListener('click', backToStart);
Â  Â  // Forward/Record buttons are just visual indicators for now
Â  Â  fwdBtn.addEventListener('click', () => fwdBtn.classList.toggle('active-outline'));
Â  Â  recordBtn.addEventListener('click', () => recordBtn.classList.toggle('active-outline'));
Â  };
</script>
</body>
</html>
