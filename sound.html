<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sulandra Sound Lab ‚Äì Timeline</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background-color: #121212;
            color: #e0e0e0;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #toolbar {
            height: 48px;
            background: #1e1e1e;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 12px;
            gap: 12px;
        }

        #appTitle {
            font-size: 14px;
            font-weight: 600;
            color: #f5f5f5;
            margin-right: 24px;
        }

        button,
        .toolbar-button {
            background: #2b2b2b;
            color: #f0f0f0;
            border: 1px solid #444;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        button:hover,
        .toolbar-button:hover {
            background: #3a3a3a;
        }

        button:active,
        .toolbar-button:active {
            background: #444;
        }

        .toolbar-spacer {
            flex: 1;
        }

        /* Transport controls */
        #transport {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .transport-button {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            justify-content: center;
            padding: 0;
        }

        .transport-button.record {
            border-color: #e53935;
            color: #ff5252;
        }

        /* Layout */
        #main {
            position: absolute;
            top: 48px;
            bottom: 0;
            left: 0;
            right: 0;
            display: grid;
            grid-template-columns: 260px 1fr;
        }

        #trackList {
            background: #181818;
            border-right: 1px solid #333;
            overflow-y: auto;
        }

        #timeline {
            background: #151515;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #timelineHeader {
            height: 28px;
            border-bottom: 1px solid #333;
            background: linear-gradient(to right, #202020, #252525);
            display: flex;
            align-items: center;
            font-size: 11px;
            color: #b0b0b0;
            padding-left: 8px;
        }

        #timelineGrid {
            flex: 1;
            overflow: auto;
            position: relative;
            background-image: linear-gradient(#1f1f1f 1px, transparent 1px),
                              linear-gradient(90deg, #1f1f1f 1px, transparent 1px);
            background-size: 24px 48px;
            background-position: 40px 0;
        }

        .timeline-row {
            position: relative;
            height: 48px;
            border-bottom: 1px solid #242424;
            margin-left: 40px;
        }

        .clip {
            position: absolute;
            top: 8px;
            height: 32px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.5);
            background: #4caf50;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 11px;
            color: #111;
            overflow: hidden;
            white-space: nowrap;
        }

        /* Track list */
        .track-row {
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid #242424;
        }

        .track-header {
            display: grid;
            grid-template-columns: 4px 28px 1fr auto;
            align-items: center;
            height: 48px;
            cursor: default;
        }

        .track-color-strip {
            width: 4px;
            height: 100%;
            background: #4caf50;
        }

        .track-icon {
            text-align: center;
            font-size: 18px;
        }

        .track-name {
            font-size: 13px;
            padding: 0 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .track-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            padding-right: 6px;
        }

        .track-control-btn {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            font-size: 11px;
            padding: 0;
            justify-content: center;
        }

        .track-control-btn.record-arm.on {
            background: #b71c1c;
            border-color: #ff5252;
            color: #ffebee;
        }

        .track-row:hover {
            background: #1f1f1f;
        }

        /* Dropdown menu */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 260px;
            background: #222;
            border-radius: 6px;
            border: 1px solid #444;
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
            padding: 6px 0;
            margin-top: 4px;
            z-index: 50;
            display: none;
        }

        .dropdown-menu.open {
            display: block;
        }

        .menu-section {
            padding: 4px 0 6px 0;
            border-top: 1px solid #333;
        }

        .menu-section:first-child {
            border-top: none;
        }

        .menu-title {
            font-size: 11px;
            text-transform: uppercase;
            color: #888;
            padding: 2px 10px;
        }

        .menu-item {
            width: 100%;
            text-align: left;
            padding: 4px 10px;
            font-size: 12px;
            background: transparent;
            border: none;
            color: #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-item span {
            pointer-events: none;
        }

        .menu-item:hover {
            background: #333;
        }

        .shortcut {
            font-size: 10px;
            color: #777;
        }

        /* Modals */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .modal-backdrop.open {
            display: flex;
        }

        .modal {
            background: #1a1a1a;
            border-radius: 10px;
            border: 1px solid #444;
            padding: 14px 16px 16px 16px;
            width: 460px;
            max-width: 96vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 12px 30px rgba(0,0,0,0.75);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .modal-title {
            font-size: 14px;
            font-weight: 600;
        }

        .modal-close {
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 12px;
            padding: 0;
            justify-content: center;
        }

        .form-row {
            margin-bottom: 10px;
            display: flex;
            gap: 8px;
        }

        .form-row label {
            font-size: 12px;
            color: #bbb;
            min-width: 100px;
        }

        .form-row input[type="text"],
        .form-row select,
        .form-row textarea,
        .form-row input[type="color"] {
            flex: 1;
            background: #121212;
            border: 1px solid #444;
            border-radius: 4px;
            color: #eee;
            font-size: 12px;
            padding: 4px 6px;
        }

        .form-row textarea {
            min-height: 70px;
            resize: vertical;
        }

        .modal-footer {
            margin-top: 12px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .checkbox-row {
            font-size: 12px;
            color: #ccc;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        /* SL Assistant modal ‚Äì extra colorful */
        .sl-assistant-modal {
            background: radial-gradient(circle at top left, #ff9a9e 0, #fad0c4 22%, #fbc2eb 40%, #a18cd1 58%, #5ee7df 76%, #b2fefa 100%);
            border: none;
            color: #111;
        }

        .sl-assistant-modal .modal-header,
        .sl-assistant-modal .modal-footer {
            color: #111;
        }

        .sl-assistant-modal .modal-title {
            color: #111;
            text-shadow: 0 1px 4px rgba(255,255,255,0.6);
        }

        .sl-assistant-modal .badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(0,0,0,0.1);
            margin-left: 6px;
        }

        .sl-assistant-modal .form-row label {
            color: #222;
            font-weight: 600;
        }

        .sl-assistant-modal .form-row input[type="text"],
        .sl-assistant-modal .form-row textarea,
        .sl-assistant-modal .form-row select {
            background: rgba(255,255,255,0.85);
            border: none;
            color: #111;
        }

        .sl-assistant-modal .helper-text {
            font-size: 11px;
            color: #222;
            margin-top: -6px;
            margin-bottom: 6px;
        }

        .pill-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 6px;
        }

        .pill {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(0,0,0,0.15);
            cursor: pointer;
        }

        .pill.active {
            background: rgba(0,0,0,0.35);
        }

        .sl-assistant-logo {
            font-size: 11px;
            letter-spacing: 0.06em;
            text-transform: uppercase;
        }

        .sl-assistant-logo span {
            font-weight: 700;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-track {
            background: #111;
        }
    </style>
</head>
<body>
<div id="toolbar">
    <div id="appTitle">üéß Sulandra Sound Lab ‚Äì Timeline</div>

    <!-- Add Track dropdown -->
    <div class="dropdown">
        <button class="toolbar-button" id="addTrackBtn">
            + Add Track ‚ñæ
        </button>
        <div class="dropdown-menu" id="addTrackMenu">
            <div class="menu-section">
                <div class="menu-title">Instruments</div>
                <button class="menu-item" data-category="instrument" data-type="Piano">
                    <span>üéπ Piano</span><span class="shortcut">Ctrl+1</span>
                </button>
                <button class="menu-item" data-category="instrument" data-type="Guitar">
                    <span>üé∏ Guitar</span><span class="shortcut">Ctrl+2</span>
                </button>
                <button class="menu-item" data-category="instrument" data-type="Bass">
                    <span>üé∏ Bass</span><span class="shortcut">Ctrl+3</span>
                </button>
                <button class="menu-item" data-category="instrument" data-type="Drums">
                    <span>ü•Å Drums</span><span class="shortcut">Ctrl+4</span>
                </button>
                <button class="menu-item" data-category="instrument" data-type="Strings">
                    <span>üéª Strings</span>
                </button>
                <button class="menu-item" data-category="instrument" data-type="Synth">
                    <span>üéõÔ∏è Synth</span>
                </button>
            </div>

            <div class="menu-section">
                <div class="menu-title">Vocals</div>
                <button class="menu-item" data-category="vocal" data-type="Lead Vocal">
                    <span>üé§ Lead Vocal</span>
                </button>
                <button class="menu-item" data-category="vocal" data-type="Backing Vocals">
                    <span>üë• Backing Vocals</span>
                </button>
                <button class="menu-item" data-category="vocal" data-type="Choir">
                    <span>üé∂ Choir</span>
                </button>
            </div>

            <div class="menu-section">
                <div class="menu-title">Import</div>
                <button class="menu-item" data-action="import-device">
                    <span>üìÇ Import from device‚Ä¶</span>
                </button>
                <button class="menu-item" data-action="import-library">
                    <span>üéº Import from audio library‚Ä¶</span>
                </button>
            </div>

            <div class="menu-section">
                <div class="menu-title">Create</div>
                <button class="menu-item" data-action="open-sl-assistant">
                    <span>‚ú® Create with SL Assistant‚Ä¶</span>
                </button>
            </div>
        </div>
    </div>

    <div class="toolbar-spacer"></div>

    <!-- Transport controls -->
    <div id="transport">
        <button class="transport-button toolbar-button" id="btnStop" title="Stop">
            ‚èπ
        </button>
        <button class="transport-button toolbar-button" id="btnPlay" title="Play / Pause">
            ‚ñ∂
        </button>
        <button class="transport-button toolbar-button record" id="btnRecord" title="Record">
            ‚óè
        </button>
    </div>
</div>

<div id="main">
    <div id="trackList">
        <!-- Tracks appear here -->
    </div>
    <div id="timeline">
        <div id="timelineHeader">
            <span>Bars / Beats</span>
        </div>
        <div id="timelineGrid">
            <!-- Timeline rows appear here -->
        </div>
    </div>
</div>

<!-- Hidden file input for import-from-device -->
<input type="file" id="audioFileInput" accept="audio/*" multiple class="hidden"/>

<!-- Track Settings Modal -->
<div class="modal-backdrop" id="trackSettingsBackdrop">
    <div class="modal" id="trackSettingsModal">
        <div class="modal-header">
            <div class="modal-title">Track Settings</div>
            <button class="modal-close" data-close-track-settings>‚úï</button>
        </div>
        <div class="form-row">
            <label for="trackNameInput">Track name</label>
            <input type="text" id="trackNameInput">
        </div>
        <div class="form-row">
            <label for="trackIconSelect">Track icon</label>
            <select id="trackIconSelect">
                <option value="üéπ">üéπ Piano</option>
                <option value="üé∏">üé∏ Guitar/Bass</option>
                <option value="ü•Å">ü•Å Drums</option>
                <option value="üéª">üéª Strings</option>
                <option value="üéõÔ∏è">üéõÔ∏è Synth</option>
                <option value="üé§">üé§ Lead Vocal</option>
                <option value="üë•">üë• Backing Vocals</option>
                <option value="üé∂">üé∂ Choir</option>
                <option value="üéß">üéß FX/Bus</option>
            </select>
        </div>
        <div class="form-row">
            <label for="trackColorInput">Track color</label>
            <input type="color" id="trackColorInput">
        </div>
        <div class="modal-footer">
            <button id="trackSettingsCancelBtn">Cancel</button>
            <button id="trackSettingsSaveBtn">Save</button>
        </div>
    </div>
</div>

<!-- Record Settings Modal -->
<div class="modal-backdrop" id="recordSettingsBackdrop">
    <div class="modal" id="recordSettingsModal">
        <div class="modal-header">
            <div class="modal-title">Record Settings</div>
            <button class="modal-close" data-close-record-settings>‚úï</button>
        </div>

        <div class="form-row">
            <label for="recordPresetSelect">Preset</label>
            <select id="recordPresetSelect">
                <option value="none">None (manual)</option>
            </select>
        </div>

        <div class="form-row">
            <label for="inputSourceSelect">Input source</label>
            <select id="inputSourceSelect">
                <option>Built-in Microphone</option>
                <option>USB Interface ‚Äì Input 1</option>
                <option>USB Interface ‚Äì Input 2</option>
                <option>USB Interface ‚Äì Stereo 1‚Äì2</option>
                <option>Virtual Loopback</option>
            </select>
        </div>
        <div class="form-row">
            <label for="outputDestinationSelect">Output</label>
            <select id="outputDestinationSelect">
                <option>Project Output (Main Out)</option>
                <option>Headphones ‚Äì 1</option>
                <option>Headphones ‚Äì 2</option>
                <option>USB Interface ‚Äì Monitor Out</option>
            </select>
        </div>

        <div class="checkbox-row">
            <input type="checkbox" id="saveAsPresetCheckbox">
            <label for="saveAsPresetCheckbox">Save these settings as a new preset</label>
        </div>

        <div class="form-row" id="presetNameRow">
            <label for="presetNameInput">Preset name</label>
            <input type="text" id="presetNameInput" placeholder="e.g., Lead Vocal ‚Äì SM7B">
        </div>

        <div class="checkbox-row">
            <input type="checkbox" id="setAsDefaultCheckbox">
            <label for="setAsDefaultCheckbox">Set this preset as default for this track</label>
        </div>

        <div class="modal-footer">
            <button id="recordSettingsCancelBtn">Cancel</button>
            <button id="recordSettingsApplyBtn">Apply & Arm Track</button>
        </div>
    </div>
</div>

<!-- SL Assistant Modal -->
<div class="modal-backdrop" id="slAssistantBackdrop">
    <div class="modal sl-assistant-modal" id="slAssistantModal">
        <div class="modal-header">
            <div>
                <div class="sl-assistant-logo">
                    <span>SL</span> Assistant ¬∑ Creative Engine
                </div>
                <div class="modal-title">
                    Create with SL Assistant
                    <span class="badge">Auto-syncs with project tempo</span>
                </div>
            </div>
            <button class="modal-close" data-close-sl-assistant>‚úï</button>
        </div>

        <div class="form-row">
            <label for="slTrackTypeSelect">Track type</label>
            <select id="slTrackTypeSelect">
                <option value="instrument">Instrument</option>
                <option value="vocal-lead">Lead Vocal</option>
                <option value="vocal-backing">Backing Vocals</option>
                <option value="vocal-choir">Choir</option>
            </select>
        </div>

        <div class="form-row">
            <label for="slPromptInput">Creative prompt</label>
            <textarea id="slPromptInput" placeholder="Describe the loop, texture, or idea you want..."></textarea>
        </div>
        <div class="helper-text">
            Example: ‚ÄúWarm Afrobeat guitar loop, syncopated, bright top-end, fits 4 bars at 100 BPM‚Äù
        </div>

        <div class="form-row" id="slLyricsRow">
            <label for="slLyricsInput">Lyrics</label>
            <textarea id="slLyricsInput" placeholder="Paste or write your lyrics here for SL Assistant to shape the vocal..."></textarea>
        </div>

        <div class="helper-text" id="slLyricsHelper">
            For vocal tracks, SL Assistant will align phrasing to your lyrics and the project grid.
        </div>

        <div class="form-row">
            <label>Style & mood</label>
            <div style="flex: 1;">
                <div class="pill-row" id="stylePills">
                    <div class="pill" data-style="afrobeat">Afrobeat Groovy</div>
                    <div class="pill" data-style="trap">Trap / 808</div>
                    <div class="pill" data-style="gospel">Gospel / Worship</div>
                    <div class="pill" data-style="cinematic">Cinematic</div>
                    <div class="pill" data-style="aerial">Ambient / Aerial</div>
                </div>
                <div class="pill-row" id="intensityPills">
                    <div class="pill" data-intensity="soft">Soft</div>
                    <div class="pill" data-intensity="medium">Medium Energy</div>
                    <div class="pill" data-intensity="high">High Energy</div>
                </div>
            </div>
        </div>

        <div class="helper-text">
            SL Assistant will return loops, vocals, and layers that you can drop directly into the timeline lanes for this project.
        </div>

        <div class="modal-footer">
            <button id="slAssistantCancelBtn">Cancel</button>
            <button id="slAssistantCreateBtn">
                Generate & Drop into Timeline
            </button>
        </div>
    </div>
</div>

<script>
    (function () {
        // ------- Data / State -------

        const TRACK_TEMPLATES = {
            instrument: {
                "Piano":  { icon: "üéπ", color: "#4caf50" },
                "Guitar": { icon: "üé∏", color: "#ff9800" },
                "Bass":   { icon: "üé∏", color: "#3f51b5" },
                "Drums":  { icon: "ü•Å", color: "#e91e63" },
                "Strings":{ icon: "üéª", color: "#9c27b0" },
                "Synth":  { icon: "üéõÔ∏è", color: "#00bcd4" }
            },
            vocal: {
                "Lead Vocal":      { icon: "üé§", color: "#f44336" },
                "Backing Vocals":  { icon: "üë•", color: "#ff9800" },
                "Choir":           { icon: "üé∂", color: "#8bc34a" }
            }
        };

        let trackCounter = 0;
        const tracks = new Map(); // id -> { id, name, color, icon, category, type, defaultRecordPresetId }

        // Presets: id -> { id, name, input, output }
        let recordPresetCounter = 0;
        const recordPresets = new Map();

        let currentTrackForSettings = null;
        let currentTrackForRecord = null;

        // ------- Helper Functions -------

        function createTrack(category, type) {
            const id = "track-" + (++trackCounter);
            const templateGroup = category === "vocal" ? TRACK_TEMPLATES.vocal : TRACK_TEMPLATES.instrument;
            const template = templateGroup[type] || { icon: "üéß", color: "#607d8b" };

            const trackData = {
                id,
                name: type,
                color: template.color,
                icon: template.icon,
                category,
                type,
                defaultRecordPresetId: null
            };
            tracks.set(id, trackData);

            // Track list row
            const trackList = document.getElementById("trackList");
            const row = document.createElement("div");
            row.className = "track-row";
            row.dataset.trackId = id;

            const header = document.createElement("div");
            header.className = "track-header";

            const colorStrip = document.createElement("div");
            colorStrip.className = "track-color-strip";
            colorStrip.style.backgroundColor = trackData.color;

            const iconCell = document.createElement("div");
            iconCell.className = "track-icon";
            iconCell.textContent = trackData.icon;

            const nameCell = document.createElement("div");
            nameCell.className = "track-name";
            nameCell.textContent = trackData.name;

            const controlsCell = document.createElement("div");
            controlsCell.className = "track-controls";

            const recordBtn = document.createElement("button");
            recordBtn.className = "track-control-btn record-arm";
            recordBtn.textContent = "‚óè";
            recordBtn.title = "Record settings / arm track";
            recordBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                openRecordSettingsModal(id);
            });

            controlsCell.appendChild(recordBtn);

            header.appendChild(colorStrip);
            header.appendChild(iconCell);
            header.appendChild(nameCell);
            header.appendChild(controlsCell);
            row.appendChild(header);
            trackList.appendChild(row);

            // Double click to open track settings
            header.addEventListener("dblclick", () => {
                openTrackSettingsModal(id);
            });

            // Timeline row
            const timelineGrid = document.getElementById("timelineGrid");
            const tRow = document.createElement("div");
            tRow.className = "timeline-row";
            tRow.dataset.trackId = id;
            timelineGrid.appendChild(tRow);

            // Example: we could add empty clip placeholders later
        }

        function getTrackRowElements(trackId) {
            const row = document.querySelector('.track-row[data-track-id="' + trackId + '"]');
            if (!row) return null;
            return {
                row,
                header: row.querySelector(".track-header"),
                colorStrip: row.querySelector(".track-color-strip"),
                iconCell: row.querySelector(".track-icon"),
                nameCell: row.querySelector(".track-name"),
                recordBtn: row.querySelector(".record-arm")
            };
        }

        function applyTrackVisuals(trackId) {
            const trackData = tracks.get(trackId);
            if (!trackData) return;
            const els = getTrackRowElements(trackId);
            if (!els) return;
            els.colorStrip.style.backgroundColor = trackData.color;
            els.iconCell.textContent = trackData.icon;
            els.nameCell.textContent = trackData.name;

            // Update any clips on this track
            const clips = document.querySelectorAll(
                '.timeline-row[data-track-id="' + trackId + '"] .clip'
            );
            clips.forEach(c => {
                c.style.backgroundColor = trackData.color;
            });
        }

        function openDropdown() {
            document.getElementById("addTrackMenu").classList.add("open");
        }

        function closeDropdown() {
            document.getElementById("addTrackMenu").classList.remove("open");
        }

        function toggleDropdown() {
            const menu = document.getElementById("addTrackMenu");
            if (menu.classList.contains("open")) closeDropdown();
            else openDropdown();
        }

        function openTrackSettingsModal(trackId) {
            const trackData = tracks.get(trackId);
            if (!trackData) return;
            currentTrackForSettings = trackId;

            document.getElementById("trackNameInput").value = trackData.name;
            document.getElementById("trackIconSelect").value = trackData.icon;
            document.getElementById("trackColorInput").value = trackData.color;

            document.getElementById("trackSettingsBackdrop").classList.add("open");
        }

        function closeTrackSettingsModal() {
            currentTrackForSettings = null;
            document.getElementById("trackSettingsBackdrop").classList.remove("open");
        }

        function openRecordSettingsModal(trackId) {
            currentTrackForRecord = trackId;

            // Reset checkboxes
            document.getElementById("saveAsPresetCheckbox").checked = false;
            document.getElementById("setAsDefaultCheckbox").checked = false;
            document.getElementById("presetNameInput").value = "";

            const presetSelect = document.getElementById("recordPresetSelect");
            presetSelect.innerHTML = "";
            const noneOption = document.createElement("option");
            noneOption.value = "none";
            noneOption.textContent = "None (manual)";
            presetSelect.appendChild(noneOption);

            // Fill presets
            recordPresets.forEach(preset => {
                const opt = document.createElement("option");
                opt.value = preset.id;
                opt.textContent = preset.name;
                presetSelect.appendChild(opt);
            });

            // If track has default preset, preselect it
            const trackData = tracks.get(trackId);
            if (trackData && trackData.defaultRecordPresetId) {
                presetSelect.value = trackData.defaultRecordPresetId;
                const defaultPreset = recordPresets.get(trackData.defaultRecordPresetId);
                if (defaultPreset) {
                    document.getElementById("inputSourceSelect").value = defaultPreset.input;
                    document.getElementById("outputDestinationSelect").value = defaultPreset.output;
                }
            }

            document.getElementById("recordSettingsBackdrop").classList.add("open");
        }

        function closeRecordSettingsModal() {
            currentTrackForRecord = null;
            document.getElementById("recordSettingsBackdrop").classList.remove("open");
        }

        function openSlAssistantModal(defaultVocalTypeIfAny = null) {
            const trackTypeSelect = document.getElementById("slTrackTypeSelect");
            if (defaultVocalTypeIfAny) {
                trackTypeSelect.value = defaultVocalTypeIfAny;
            } else {
                trackTypeSelect.value = "instrument";
            }
            updateSlAssistantLyricsVisibility();
            document.getElementById("slAssistantBackdrop").classList.add("open");
        }

        function closeSlAssistantModal() {
            document.getElementById("slAssistantBackdrop").classList.remove("open");
        }

        function updateSlAssistantLyricsVisibility() {
            const value = document.getElementById("slTrackTypeSelect").value;
            const isVocal = value.startsWith("vocal-");
            document.getElementById("slLyricsRow").style.display = isVocal ? "flex" : "none";
            document.getElementById("slLyricsHelper").style.display = isVocal ? "block" : "none";
        }

        // ------- Event Wiring -------

        document.addEventListener("DOMContentLoaded", () => {
            const addTrackBtn = document.getElementById("addTrackBtn");
            const addTrackMenu = document.getElementById("addTrackMenu");

            addTrackBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                toggleDropdown();
            });

            // Click outside to close dropdown
            document.addEventListener("click", (e) => {
                if (!addTrackMenu.contains(e.target) && e.target !== addTrackBtn) {
                    closeDropdown();
                }
            });

            // Menu actions
            addTrackMenu.querySelectorAll(".menu-item").forEach(item => {
                item.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const category = item.dataset.category;
                    const type = item.dataset.type;
                    const action = item.dataset.action;

                    closeDropdown();

                    if (category && type) {
                        createTrack(category, type);
                        return;
                    }

                    if (action === "import-device") {
                        const input = document.getElementById("audioFileInput");
                        input.click();
                    } else if (action === "import-library") {
                        alert("This will open your Sulandra creations from music.html and let you drop audio into the timeline.");
                    } else if (action === "open-sl-assistant") {
                        openSlAssistantModal();
                    }
                });
            });

            // File input change
            document.getElementById("audioFileInput").addEventListener("change", (e) => {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;
                alert("Imported " + files.length + " file(s) from device.\n(Here you will sync them to the project tempo and place them on a selected track.)");
                // You can hook this into the backend / audio engine later
            });

            // Track settings modal events
            document.querySelectorAll("[data-close-track-settings]").forEach(btn => {
                btn.addEventListener("click", closeTrackSettingsModal);
            });
            document.getElementById("trackSettingsCancelBtn").addEventListener("click", closeTrackSettingsModal);

            document.getElementById("trackSettingsSaveBtn").addEventListener("click", () => {
                if (!currentTrackForSettings) return;
                const trackData = tracks.get(currentTrackForSettings);
                if (!trackData) return;

                trackData.name = document.getElementById("trackNameInput").value || trackData.name;
                trackData.icon = document.getElementById("trackIconSelect").value || trackData.icon;
                trackData.color = document.getElementById("trackColorInput").value || trackData.color;

                tracks.set(currentTrackForSettings, trackData);
                applyTrackVisuals(currentTrackForSettings);
                closeTrackSettingsModal();
            });

            // Record settings modal events
            document.querySelectorAll("[data-close-record-settings]").forEach(btn => {
                btn.addEventListener("click", closeRecordSettingsModal);
            });
            document.getElementById("recordSettingsCancelBtn").addEventListener("click", closeRecordSettingsModal);

            document.getElementById("recordPresetSelect").addEventListener("change", (e) => {
                const value = e.target.value;
                if (value === "none") return;
                const preset = recordPresets.get(value);
                if (!preset) return;
                document.getElementById("inputSourceSelect").value = preset.input;
                document.getElementById("outputDestinationSelect").value = preset.output;
            });

            document.getElementById("saveAsPresetCheckbox").addEventListener("change", (e) => {
                document.getElementById("presetNameRow").style.display = e.target.checked ? "flex" : "none";
            });

            document.getElementById("recordSettingsApplyBtn").addEventListener("click", () => {
                if (!currentTrackForRecord) return;
                const trackData = tracks.get(currentTrackForRecord);
                if (!trackData) return;

                const input = document.getElementById("inputSourceSelect").value;
                const output = document.getElementById("outputDestinationSelect").value;
                const savePreset = document.getElementById("saveAsPresetCheckbox").checked;
                const presetName = document.getElementById("presetNameInput").value.trim();
                const setAsDefault = document.getElementById("setAsDefaultCheckbox").checked;

                let newPresetId = null;

                if (savePreset && presetName) {
                    newPresetId = "preset-" + (++recordPresetCounter);
                    const preset = {
                        id: newPresetId,
                        name: presetName,
                        input,
                        output
                    };
                    recordPresets.set(newPresetId, preset);
                }

                if (setAsDefault && (newPresetId || trackData.defaultRecordPresetId)) {
                    trackData.defaultRecordPresetId = newPresetId || trackData.defaultRecordPresetId;
                    tracks.set(currentTrackForRecord, trackData);
                }

                // Mark track as armed
                const rowEls = getTrackRowElements(currentTrackForRecord);
                if (rowEls && rowEls.recordBtn) {
                    rowEls.recordBtn.classList.add("on");
                }

                closeRecordSettingsModal();
            });

            // SL Assistant events
            document.querySelectorAll("[data-close-sl-assistant]").forEach(btn => {
                btn.addEventListener("click", closeSlAssistantModal);
            });
            document.getElementById("slAssistantCancelBtn").addEventListener("click", closeSlAssistantModal);

            document.getElementById("slTrackTypeSelect").addEventListener("change", updateSlAssistantLyricsVisibility);

            // Style pills
            const stylePills = document.getElementById("stylePills");
            stylePills.querySelectorAll(".pill").forEach(pill => {
                pill.addEventListener("click", () => {
                    stylePills.querySelectorAll(".pill").forEach(p => p.classList.remove("active"));
                    pill.classList.add("active");
                });
            });

            const intensityPills = document.getElementById("intensityPills");
            intensityPills.querySelectorAll(".pill").forEach(pill => {
                pill.addEventListener("click", () => {
                    intensityPills.querySelectorAll(".pill").forEach(p => p.classList.remove("active"));
                    pill.classList.add("active");
                });
            });

            document.getElementById("slAssistantCreateBtn").addEventListener("click", () => {
                const type = document.getElementById("slTrackTypeSelect").value;
                const prompt = document.getElementById("slPromptInput").value.trim();
                const lyrics = document.getElementById("slLyricsInput").value.trim();

                alert("SL Assistant would now generate content with:\n\n" +
                    "- Track type: " + type + "\n" +
                    "- Prompt: " + (prompt || "(none)") + "\n" +
                    (type.startsWith("vocal-") ? "- Lyrics: " + (lyrics || "(none)") + "\n" : "") +
                    "\nThen it will drop the generated loop/vocals directly into the chosen track lane.");

                closeSlAssistantModal();
            });

            // Transport stubs (visual only)
            document.getElementById("btnPlay").addEventListener("click", () => {
                alert("Play / Pause project (transport wiring will connect to the audio engine).");
            });
            document.getElementById("btnStop").addEventListener("click", () => {
                alert("Stop project and return playhead to start.");
            });
            document.getElementById("btnRecord").addEventListener("click", () => {
                alert("Global record: all armed tracks will record into the timeline in real-time.");
            });

            // Initialize preset name row hidden
            document.getElementById("presetNameRow").style.display = "none";
            updateSlAssistantLyricsVisibility();
        });
    })();
</script>
</body>
</html>
