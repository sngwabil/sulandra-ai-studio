<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sulandra AI Studio ‚Äì SOUND DAW (Enhanced)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      /* DEFAULT THEME VARIABLES */
      --bg-deep: #020419;
      --bg-surface: #050b2a;
      --bg-panel: #071134;
      --accent: #7cffc7;
      --accent2: #ff7cf1;
      --accent3: #ffd77c;
      --accent4: #7cbeff;
      --text-main: #f7fbff;
      --text-muted: #9cb3ff;
      --grid-line: rgba(167,194,255,0.18);
      --beat-width: 48px;
      --track-height: 40px;
      
      /* Gradients */
      --header-bg: linear-gradient(to bottom,rgba(10,20,70,0.98),rgba(4,8,35,0.98));
      --timeline-bg: radial-gradient(circle at 0 0,#253bff,#050a23 45%,#020419 100%);
      --menu-bg: #050b24;
      --modal-bg: radial-gradient(circle at top left, #1a2142, #020410);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg-deep);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* --- UTILS --- */
    button { cursor: pointer; border: none; outline: none; }
    a { color: inherit; text-decoration: none; }
    
    /* --- HEADER --- */
    header {
      background: var(--header-bg);
      border-bottom: 1px solid rgba(0,0,0,0.9);
      height: 42px; flex-shrink: 0; display: flex; align-items: center;
      padding: 0 10px; justify-content: space-between;
      z-index: 20;
    }
    .brand-logo { font-weight: 900; color: var(--accent); margin-right: 10px; }

    /* --- LAYOUT --- */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 6px 10px;
      overflow: hidden;
    }

    .main-grid {
      flex: 1;
      display: grid;
      grid-template-columns: 220px minmax(0,1fr);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      background: #010208;
      overflow: hidden;
    }

    /* --- TIMELINE & TRACKS --- */
    .center-timeline-wrap {
      display: flex; flex-direction: column; min-height: 0;
      background: var(--timeline-bg);
      position: relative;
    }

    .timeline-header {
      height: 70px;
      background: rgba(0,0,0,0.3);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 5px;
    }

    .timeline-main {
      flex: 1; display: flex; min-height: 0;
      position: relative;
    }

    .track-list {
      width: 220px;
      background: #05081a;
      border-right: 1px solid rgba(255,255,255,0.1);
      overflow-y: auto; overflow-x: hidden;
      display: flex; flex-direction: column;
    }

    .track-header {
      height: 40px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      background: rgba(255,255,255,0.02);
      display: flex; align-items: center;
      padding: 0 4px; gap: 6px;
      user-select: none;
      position: relative;
    }
    .track-header:hover { background: rgba(255,255,255,0.05); }
    .track-header.armed {
      background: rgba(255, 0, 60, 0.15);
      border-left: 2px solid #ff003c;
    }

    .track-icon { width: 20px; text-align: center; font-size: 14px; }
    .track-color-strip { width: 4px; height: 70%; border-radius: 2px; background: #555; }
    .track-name { 
      flex: 1; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
      cursor: text; color: #ddd;
    }
    .track-controls { display: flex; gap: 2px; }
    
    .t-btn {
      width: 18px; height: 18px; border-radius: 3px; 
      background: #111; color: #777; font-size: 9px;
      display: flex; align-items: center; justify-content: center;
    }
    .t-btn:hover { color: #fff; }
    .t-btn.rec { color: #555; }
    .t-btn.rec.active { background: #ff003c; color: #fff; box-shadow: 0 0 5px #ff003c; }
    .t-btn.menu-btn { font-size: 12px; font-weight: bold; padding-bottom: 4px;}

    .add-track-btn {
      width: 100%; padding: 8px; background: transparent;
      color: var(--text-muted); font-size: 11px; text-transform: uppercase;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .add-track-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }

    /* GRID */
    .timeline-grid-wrap { flex: 1; overflow: auto; position: relative; background: #000; }
    .timeline-ruler { height: 20px; background: #0b1021; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #333; }
    .grid-inner { 
      background-image: 
        linear-gradient(to right, rgba(255,255,255,0.05) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,0.05) 1px, transparent 1px);
      background-size: var(--beat-width) 40px;
    }
    .grid-row { height: 40px; border-bottom: 1px solid rgba(255,255,255,0.05); position: relative; }
    
    .clip {
      position: absolute; top: 2px; bottom: 2px;
      border-radius: 4px; border: 1px solid rgba(255,255,255,0.4);
      background: rgba(61, 124, 255, 0.5);
      color: #fff; font-size: 10px; padding: 2px 5px;
      overflow: hidden; white-space: nowrap;
      cursor: move;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    .playhead {
      position: absolute; top: 0; bottom: 0; width: 1px; background: #ffd77c;
      z-index: 5; box-shadow: 0 0 10px #ffd77c; pointer-events: none;
    }

    /* --- DROPDOWN MENUS --- */
    .dropdown-menu {
      position: fixed; z-index: 1000;
      background: var(--menu-bg);
      border: 1px solid #334;
      box-shadow: 0 5px 20px rgba(0,0,0,0.8);
      border-radius: 6px;
      width: 180px;
      padding: 4px 0;
      display: none;
      font-size: 11px;
    }
    .menu-item {
      padding: 6px 12px;
      color: #ccc;
      cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
      position: relative;
    }
    .menu-item:hover { background: var(--accent4); color: #000; }
    .menu-item .arrow { font-size: 9px; }

    /* SUBMENUS */
    .submenu {
      position: absolute; left: 100%; top: -4px;
      background: var(--menu-bg);
      border: 1px solid #334;
      border-radius: 6px;
      width: 160px;
      display: none;
      box-shadow: 0 5px 20px rgba(0,0,0,0.9);
    }
    .menu-item:hover > .submenu { display: block; }

    /* --- MODALS --- */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7);
      display: none; justify-content: center; align-items: center; z-index: 2000;
      backdrop-filter: blur(3px);
    }
    .modal-window {
      background: var(--modal-bg);
      border: 1px solid rgba(124,190,255,0.3);
      border-radius: 10px;
      padding: 20px;
      width: 400px;
      color: #fff;
      box-shadow: 0 0 30px rgba(0,0,0,0.8);
    }
    .modal-header { font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); margin-bottom: 15px; font-weight: bold; }
    
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-size: 10px; color: #88aaff; margin-bottom: 4px; text-transform: uppercase; }
    .form-control {
      width: 100%; background: rgba(0,0,0,0.4); border: 1px solid #445; color: #fff;
      padding: 6px; border-radius: 4px; font-size: 12px;
    }
    .form-control:focus { border-color: var(--accent); outline: none; }
    
    .color-spectrum {
      width: 100%; height: 30px; border: none; padding: 0; background: none; cursor: pointer;
    }
    
    .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .btn {
      padding: 6px 14px; border-radius: 4px; font-size: 11px; text-transform: uppercase; font-weight: bold;
    }
    .btn-cancel { background: transparent; border: 1px solid #555; color: #aaa; }
    .btn-primary { background: var(--accent); color: #000; border: 1px solid var(--accent); }
    .btn-sl { background: linear-gradient(135deg, #ff00cc, #333399); color: #fff; border: none; box-shadow: 0 0 15px #ff00cc; }

    /* SL ASSISTANT SPECIFIC */
    .sl-window { width: 500px; border: 1px solid #ff00cc; }
    .sl-title { 
      background: linear-gradient(to right, #ff00cc, #333399); 
      -webkit-background-clip: text; color: transparent; 
      font-size: 18px; margin-bottom: 10px;
    }
    .sl-desc { font-size: 11px; color: #ccc; margin-bottom: 15px; line-height: 1.4; }

  </style>
</head>
<body>

<header>
  <div style="display:flex; align-items:center;">
    <div class="brand-logo">SULANDRA</div>
    <div style="font-size:11px; color:#888;">Studio / Sound DAW</div>
  </div>
  <button class="btn btn-primary" id="play-btn">‚ñ∂ Play</button>
</header>

<main>
  <div class="main-grid">
    <div class="track-list" id="track-list">
      <button class="add-track-btn" id="btn-add-generic">+ Add Empty Track</button>
    </div>

    <div class="center-timeline-wrap">
      <div class="timeline-header">
        <div style="color:#777; font-size:10px; margin-bottom:4px;">Current Session</div>
        <div style="font-size:24px; font-family:monospace; color:#fff;">00:00:00</div>
      </div>
      <div class="timeline-main">
        <div class="timeline-grid-wrap" id="timeline-scroll">
          <div class="timeline-ruler"></div>
          <div class="grid-inner" id="grid-inner">
            <div class="playhead" id="playhead"></div>
            </div>
        </div>
      </div>
    </div>
  </div>
</main>

<div class="dropdown-menu" id="track-ctx-menu">
  <div class="menu-item">
    <span>Instruments</span><span class="arrow">‚ñ∂</span>
    <div class="submenu">
      <div class="menu-item" onclick="applyTrackPreset('Piano', 'üéπ', '#ffd77c')">Piano</div>
      <div class="menu-item" onclick="applyTrackPreset('Synthesizer', 'üéπ', '#ff7cf1')">Synthesizer</div>
      <div class="menu-item" onclick="applyTrackPreset('Acoustic Guitar', 'üé∏', '#d4a058')">Acoustic Guitar</div>
      <div class="menu-item" onclick="applyTrackPreset('Electric Guitar', 'üé∏', '#ff3d3d')">Electric Guitar</div>
      <div class="menu-item" onclick="applyTrackPreset('Bass', 'üé∏', '#4aa8ff')">Bass</div>
      <div class="menu-item" onclick="applyTrackPreset('Drums', 'ü•Å', '#7cffc7')">Drum Kit</div>
      <div class="menu-item" onclick="applyTrackPreset('Strings', 'üéª', '#ba8aff')">Strings Section</div>
      <div class="menu-item" onclick="applyTrackPreset('Brass', 'üé∫', '#e8b923')">Brass / Horns</div>
    </div>
  </div>
  <div class="menu-item">
    <span>Vocals</span><span class="arrow">‚ñ∂</span>
    <div class="submenu">
      <div class="menu-item" onclick="applyTrackPreset('Lead Vocal', 'üé§', '#ff6ca4')">Lead Vocal</div>
      <div class="menu-item" onclick="applyTrackPreset('Backing Vocal', 'üé§', '#ff9ec6')">Backing Vocal</div>
      <div class="menu-item" onclick="applyTrackPreset('Choir', '‚õ™', '#d9b3ff')">Choir / Ad-libs</div>
      <div class="menu-item" onclick="applyTrackPreset('Rap', 'üé§', '#ff4444')">Rap / MC</div>
    </div>
  </div>
  <div class="menu-item">
    <span>Import</span><span class="arrow">‚ñ∂</span>
    <div class="submenu">
      <div class="menu-item" onclick="triggerImport('device')">From Device...</div>
      <div class="menu-item" onclick="triggerImport('audio')">From My Audio (Cloud)</div>
    </div>
  </div>
  <div class="menu-item" style="color: var(--accent2); font-weight:bold;" onclick="openSLAssistant()">
    ‚ú® Create with SL Assistant
  </div>
  <hr style="border:0; border-top:1px solid #333; margin:2px 0;">
  <div class="menu-item" onclick="deleteActiveTrack()">Delete Track</div>
</div>

<div class="modal-overlay" id="modal-track-settings">
  <div class="modal-window">
    <div class="modal-header">Track Customization</div>
    <div class="form-group">
      <label>Track Name</label>
      <input type="text" class="form-control" id="setting-name">
    </div>
    <div class="form-group">
      <label>Icon</label>
      <select class="form-control" id="setting-icon">
        <option value="üéµ">üéµ Generic</option>
        <option value="üéπ">üéπ Keys</option>
        <option value="üé∏">üé∏ Guitar/Bass</option>
        <option value="ü•Å">ü•Å Drums</option>
        <option value="üé§">üé§ Vocal</option>
        <option value="üéª">üéª Strings</option>
        <option value="üéß">üéß FX/Audio</option>
      </select>
    </div>
    <div class="form-group">
      <label>Track Color (Applied to Clips)</label>
      <div style="display:flex; gap:10px; align-items:center;">
        <input type="color" class="color-spectrum" id="setting-color">
        <span style="font-size:10px; color:#777;">Select from full spectrum</span>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-cancel" onclick="closeModals()">Cancel</button>
      <button class="btn btn-primary" onclick="saveTrackSettings()">Apply Changes</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-recording">
  <div class="modal-window">
    <div class="modal-header">üî¥ Recording Setup</div>
    <div style="margin-bottom:15px; font-size:11px; color:#aaa;">
      Configure input/output for <span id="rec-track-name" style="color:#fff; font-weight:bold;">Track</span>.
    </div>
    
    <div class="form-group">
      <label>Input Source</label>
      <select class="form-control" id="rec-input">
        <option value="default">System Default Input</option>
        <option value="mic1">Microphone (Realtek Audio)</option>
        <option value="usb1">USB Interface (Focusrite Scarlett) - Ch 1</option>
        <option value="usb2">USB Interface (Focusrite Scarlett) - Ch 2</option>
        <option value="midi">MIDI Keyboard Controller</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>Output Routing</label>
      <select class="form-control" id="rec-output">
        <option value="master">Master Bus (Default)</option>
        <option value="phones">Headphones Out</option>
        <option value="bus1">Send to Bus A (Reverb)</option>
      </select>
    </div>

    <div style="display:flex; align-items:center; gap:8px; margin-top:10px; font-size:11px;">
      <input type="checkbox" id="rec-save-preset">
      <label for="rec-save-preset" style="margin:0; cursor:pointer;">Save as Default Preset</label>
    </div>

    <div class="modal-footer">
      <button class="btn btn-cancel" onclick="closeModals()">Cancel</button>
      <button class="btn btn-primary" style="background:#ff003c; border-color:#ff003c; color:#fff;" onclick="armTrackConfirmed()">üî• Arm Track</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-sl-assistant">
  <div class="modal-window sl-window">
    <div class="sl-title">Create with SL Assistant</div>
    <div class="sl-desc">
      Describe what you want. The AI will generate loops, melodies, or vocals and drop them directly into your timeline, fully synced.
    </div>
    
    <div class="form-group">
      <label>Type</label>
      <select class="form-control" id="sl-type" onchange="toggleLyricsBox()">
        <option value="instrument">Instrument / Loop</option>
        <option value="vocal">Vocal / Acapella</option>
      </select>
    </div>

    <div class="form-group">
      <label>Prompt</label>
      <textarea class="form-control" rows="2" placeholder="E.g., A dark cinematic bassline in F minor..."></textarea>
    </div>

    <div class="form-group" id="sl-lyrics-group" style="display:none;">
      <label>Lyrics (for Vocals)</label>
      <textarea class="form-control" rows="3" placeholder="Enter lyrics here..."></textarea>
    </div>

    <div class="modal-footer">
      <button class="btn btn-cancel" onclick="closeModals()">Cancel</button>
      <button class="btn btn-sl" onclick="generateSLContent()">‚ú® Generate & Insert</button>
    </div>
  </div>
</div>

<input type="file" id="file-input" style="display:none;" />

<script>
  /* ================= DATA & STATE ================= */
  let tracks = [
    { id: 1, name: "Drums", color: "#7cffc7", icon: "ü•Å", armed: false },
    { id: 2, name: "Keys", color: "#7cbeff", icon: "üéπ", armed: false },
    { id: 3, name: "Vocals", color: "#ff7cf1", icon: "üé§", armed: false }
  ];
  
  // Dummy Clips
  let clips = [
    { id: 101, trackId: 1, start: 0, len: 4, name: "Beat A" },
    { id: 102, trackId: 2, start: 0, len: 8, name: "Chords Main" }
  ];

  let activeTrackId = null; // For context menu
  let editingTrackId = null; // For Settings Modal
  let armingTrackId = null; // For Recording Modal

  /* ================= INITIALIZATION ================= */
  const trackListEl = document.getElementById('track-list');
  const gridInnerEl = document.getElementById('grid-inner');
  const ctxMenu = document.getElementById('track-ctx-menu');

  function render() {
    // Clear
    trackListEl.innerHTML = '';
    gridInnerEl.innerHTML = '<div class="playhead" id="playhead"></div>';
    
    // Render Tracks & Grid Rows
    tracks.forEach(t => {
      // 1. Track Header
      const div = document.createElement('div');
      div.className = `track-header ${t.armed ? 'armed' : ''}`;
      div.innerHTML = `
        <div class="track-icon">${t.icon}</div>
        <div class="track-color-strip" style="background:${t.color}"></div>
        <div class="track-name" title="Double Click to Settings">${t.name}</div>
        <div class="track-controls">
          <button class="t-btn rec ${t.armed ? 'active' : ''}" onclick="openRecModal(${t.id})" title="Arm for Recording">‚óè</button>
          <button class="t-btn menu-btn" onclick="openMenu(event, ${t.id})">‚ãØ</button>
        </div>
      `;
      
      // Double click to edit settings
      div.addEventListener('dblclick', (e) => {
        if(!e.target.closest('button')) openSettingsModal(t.id);
      });
      trackListEl.appendChild(div);

      // 2. Grid Row
      const row = document.createElement('div');
      row.className = 'grid-row';
      row.id = `row-${t.id}`;
      gridInnerEl.appendChild(row);
    });

    // Add Track Button at bottom
    const addBtn = document.createElement('button');
    addBtn.className = 'add-track-btn';
    addBtn.textContent = '+ Add Empty Track';
    addBtn.onclick = () => addNewTrack();
    trackListEl.appendChild(addBtn);

    // Render Clips
    renderClips();
  }

  function renderClips() {
    document.querySelectorAll('.clip').forEach(c => c.remove());
    clips.forEach(c => {
      const t = tracks.find(tr => tr.id === c.trackId);
      if(!t) return;
      
      const row = document.getElementById(`row-${c.trackId}`);
      const clipEl = document.createElement('div');
      clipEl.className = 'clip';
      clipEl.style.left = (c.start * 48) + 'px';
      clipEl.style.width = (c.len * 48) + 'px';
      clipEl.style.background = t.color; // Apply track color to clip
      // Darken text if color is bright, lighten if dark (simple logic)
      clipEl.style.color = '#000'; 
      clipEl.style.fontWeight = 'bold';
      clipEl.textContent = c.name;
      
      // Add simple gradient overlay for visual pop
      clipEl.style.backgroundImage = 'linear-gradient(to bottom, rgba(255,255,255,0.3), rgba(0,0,0,0.1))';
      
      row.appendChild(clipEl);
    });
  }

  /* ================= TRACK ACTIONS ================= */

  function addNewTrack() {
    const newId = tracks.length > 0 ? Math.max(...tracks.map(t=>t.id)) + 1 : 1;
    tracks.push({ id: newId, name: `Track ${newId}`, color: "#888888", icon: "üéµ", armed: false });
    render();
  }

  function deleteActiveTrack() {
    if(activeTrackId) {
      tracks = tracks.filter(t => t.id !== activeTrackId);
      clips = clips.filter(c => c.trackId !== activeTrackId);
      render();
      closeMenu();
    }
  }

  // --- CONTEXT MENU LOGIC ---
  function openMenu(e, id) {
    e.stopPropagation();
    activeTrackId = id;
    ctxMenu.style.display = 'block';
    ctxMenu.style.left = e.clientX + 'px';
    ctxMenu.style.top = e.clientY + 'px';
    
    // Boundary check
    const rect = ctxMenu.getBoundingClientRect();
    if(rect.right > window.innerWidth) ctxMenu.style.left = (window.innerWidth - rect.width - 10) + 'px';
    if(rect.bottom > window.innerHeight) ctxMenu.style.top = (window.innerHeight - rect.height - 10) + 'px';
  }

  function closeMenu() {
    ctxMenu.style.display = 'none';
    activeTrackId = null;
  }
  
  // Apply Preset (From Menu)
  function applyTrackPreset(name, icon, color) {
    if(activeTrackId) {
      const t = tracks.find(tr => tr.id === activeTrackId);
      if(t) {
        t.name = name;
        t.icon = icon;
        t.color = color;
        render();
      }
    }
    closeMenu();
  }

  // --- IMPORT LOGIC ---
  function triggerImport(type) {
    closeMenu();
    if(type === 'device') {
      document.getElementById('file-input').click();
    } else {
      alert("Accessing 'My Audio' cloud storage from music.html...\n\n(Simulation: File imported successfully)");
      if(activeTrackId) {
         const t = tracks.find(tr => tr.id === activeTrackId);
         t.name = "Imported Audio";
         t.color = "#ffffff";
         render();
      }
    }
  }

  // File input listener
  document.getElementById('file-input').addEventListener('change', (e) => {
    if(e.target.files && e.target.files[0]) {
      const fileName = e.target.files[0].name;
      if(activeTrackId) {
        const t = tracks.find(tr => tr.id === activeTrackId);
        t.name = fileName;
        render();
      }
    }
  });


  /* ================= MODALS LOGIC ================= */

  function closeModals() {
    document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
    editingTrackId = null;
    armingTrackId = null;
  }

  // 1. SETTINGS MODAL (Rename/Color/Icon)
  function openSettingsModal(id) {
    editingTrackId = id;
    const t = tracks.find(tr => tr.id === id);
    document.getElementById('setting-name').value = t.name;
    document.getElementById('setting-icon').value = t.icon;
    document.getElementById('setting-color').value = t.color;
    document.getElementById('modal-track-settings').style.display = 'flex';
  }

  function saveTrackSettings() {
    if(editingTrackId) {
      const t = tracks.find(tr => tr.id === editingTrackId);
      t.name = document.getElementById('setting-name').value;
      t.icon = document.getElementById('setting-icon').value;
      t.color = document.getElementById('setting-color').value;
      render();
    }
    closeModals();
  }

  // 2. SL ASSISTANT
  function openSLAssistant() {
    closeMenu();
    document.getElementById('modal-sl-assistant').style.display = 'flex';
  }

  function toggleLyricsBox() {
    const type = document.getElementById('sl-type').value;
    const box = document.getElementById('sl-lyrics-group');
    box.style.display = type === 'vocal' ? 'block' : 'none';
  }

  function generateSLContent() {
    // Simulation of AI generation
    const type = document.getElementById('sl-type').value;
    const newId = Math.floor(Math.random() * 1000);
    
    // Find a track or create one
    let targetTrackId = activeTrackId;
    if(!targetTrackId) {
      addNewTrack();
      targetTrackId = tracks[tracks.length-1].id;
    }

    const t = tracks.find(tr => tr.id === targetTrackId);
    if(type === 'vocal') {
        t.name = "SL Vocal Gen";
        t.color = "#ff00cc";
        t.icon = "ü§ñ";
    } else {
        t.name = "SL Instrument";
        t.color = "#333399";
        t.icon = "‚ú®";
    }

    // Add a clip
    clips.push({
      id: newId,
      trackId: targetTrackId,
      start: 4, // arbitrary placement
      len: 8,
      name: type === 'vocal' ? "AI Vocals" : "AI Loop"
    });

    render();
    closeModals();
    alert("SL Assistant: Content generated and synced to timeline!");
  }

  // 3. RECORDING MODAL
  function openRecModal(id) {
    const t = tracks.find(tr => tr.id === id);
    
    // If already armed, just unarm immediately
    if(t.armed) {
      t.armed = false;
      render();
      return;
    }

    armingTrackId = id;
    document.getElementById('rec-track-name').innerText = t.name;
    document.getElementById('modal-recording').style.display = 'flex';
  }

  function armTrackConfirmed() {
    if(armingTrackId) {
      const t = tracks.find(tr => tr.id === armingTrackId);
      const input = document.getElementById('rec-input').value;
      const savePreset = document.getElementById('rec-save-preset').checked;

      t.armed = true;
      
      if(savePreset) {
        // Simulation of saving to localStorage
        localStorage.setItem('sl_rec_preset', JSON.stringify({ input: input }));
        console.log("Preset saved");
      }

      render(); // Updates the UI to show red glow/borders
    }
    closeModals();
  }

  /* ================= EVENT LISTENERS ================= */
  
  // Close menu on click outside
  window.addEventListener('click', () => {
    closeMenu();
  });

  // Close modals on click outside
  document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', (e) => {
      if(e.target === overlay) closeModals();
    });
  });

  // Basic Playhead Animation (Simulated)
  let playing = false;
  let playX = 0;
  document.getElementById('play-btn').addEventListener('click', () => {
    playing = !playing;
    document.getElementById('play-btn').textContent = playing ? "‚è∏ Pause" : "‚ñ∂ Play";
    if(playing) animate();
  });

  function animate() {
    if(!playing) return;
    playX += 2;
    const playhead = document.getElementById('playhead');
    if(playhead) playhead.style.left = playX + 'px';
    
    // Loop simulation
    if(playX > 800) playX = 0;
    
    requestAnimationFrame(animate);
  }

  // Init
  render();

</script>
</body>
</html>
