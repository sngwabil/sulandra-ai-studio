<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sulandra AI Studio ‚Äì SOUND DAW</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      /* DEFAULT (SULANDRA NEON) THEME VARIABLES */
      --bg-deep: #020419;
      --bg-surface: #050b2a;
      --bg-panel: #071134;
      --bg-panel-soft: #091746;
      --border-soft: rgba(129,166,255,0.25);
      --border-strong: rgba(129,166,255,0.9);
      --accent: #7cbeff;
      --accent2: #ffd77c;
      --accent3: #ff6ca4;
      --accent4: #7cbeff;
      --text-main: #f7fbff;
      --text-muted: #9cb3ff;
      --grid-line: rgba(167,194,255,0.18);
      --clip-blue: #3d7cff;
      --clip-purple: #a96cff;
      --clip-pink: #ff6ca4;
      --clip-green: #4dffbb;
      --radius: 7px;
      --shadow-soft: 0 0 32px rgba(0,0,0,0.85);
      --beat-width: 48px;
      --track-height: 64px;
      --beats-per-bar: 4;

      /* Timeline-specific base colors (overridden by themes + custom designer) */
      --timeline-bg: radial-gradient(circle at 0 0,#253bff,#050a23 45%,#020419 100%);
      --timeline-grid-bg: #050822;
      --timeline-header-bg: linear-gradient(to bottom,#091650,#050a24);
      --timeline-ruler-bg: linear-gradient(to bottom,#091650,#050a24);

      /* Mixer theme */
      --mixer-bg: radial-gradient(circle at 0 0,#152264,#030617 55%,#000212 100%);
      --mixer-strip-bg: linear-gradient(to bottom,#050a26,#020316);
      --mixer-strip-border: rgba(129,166,255,0.4);
      --mixer-meter-bg: #05091c;
      --mixer-meter-fill: linear-gradient(to top,#4dffbb,#ffd77c);
      --mixer-text: #f7fbff;

      /* Pattern editor theme */
      --pattern-bg: radial-gradient(circle at 0 0,#1b2a70,#020419 55%,#000214 100%);
      --pattern-grid-bg: rgba(4,9,35,0.96);
      --pattern-step-on: #ffd77c;
      --pattern-step-off: rgba(34,49,104,0.95);
      --pattern-step-border: rgba(148,178,255,0.45);
      --pattern-accent: #7cbeff;

      /* Theme designer palette */
      --designer-bg: radial-gradient(circle at 0 0,#2836a4,#050927 55%,#000212 100%);
      --designer-surface: rgba(5,11,40,0.98);
      --designer-chip-border: rgba(149,178,255,0.4);
      --designer-chip-selected: rgba(124,190,255,0.32);
      --designer-label: #c0d3ff;
      --designer-muted: #7e92d0;
    }

    * {
      box-sizing: border-box;
      user-select: none;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: radial-gradient(circle at 0 0,#2434a6,#050a23 45%,#020419 100%);
      color: var(--text-main);
    }

    body {
      display: flex;
      flex-direction: column;
    }

    /* ===== TOP NAV / TOOLBAR ===== */
    header {
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      background: linear-gradient(to right,#040822,#050b2b 40%,#050b2b 60%,#040822 100%);
      border-bottom: 1px solid rgba(129,166,255,0.35);
      box-shadow: 0 0 18px rgba(0,0,0,0.75);
      position: relative;
      z-index: 10;
    }
    .app-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      letter-spacing: 0.04em;
      font-size: 13px;
      text-transform: uppercase;
      color: #e6f0ff;
    }
    .app-badge {
      padding: 2px 6px;
      border-radius: 99px;
      font-size: 9px;
      text-transform: uppercase;
      background: radial-gradient(circle at 0 0,#ffd77c,#ff6ca4);
      color: #020419;
      box-shadow: 0 0 8px rgba(255,215,124,0.65);
    }
    .app-title span {
      opacity: 0.8;
    }

    .transport {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .transport button {
      border-radius: 999px;
      border: 1px solid rgba(129,166,255,0.7);
      background: radial-gradient(circle at 0 0,#3d7cff,#050a23);
      color: #f7fbff;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      box-shadow: 0 0 14px rgba(0,0,0,0.85);
    }
    .transport button.secondary {
      background: radial-gradient(circle at 0 0,#050b2a,#050b2a);
      border-color: rgba(129,166,255,0.5);
      font-size: 11px;
    }
    .transport button:active {
      transform: translateY(1px);
      box-shadow: 0 0 8px rgba(0,0,0,0.85);
    }

    .tempo-display {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: radial-gradient(circle at 0 0,#050c2e,#02041a 70%);
      border: 1px solid rgba(129,166,255,0.6);
      font-size: 11px;
      color: #d3e2ff;
    }
    .tempo-display span.label {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 9px;
      color: #9cb3ff;
    }
    .tempo-display span.value {
      font-variant-numeric: tabular-nums;
    }

    .top-right-tools {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .chip-button {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(129,166,255,0.6);
      background: radial-gradient(circle at 0 0,#060e3a,#040726 70%);
      color: #d5e4ff;
      cursor: pointer;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .chip-button span.hotkey {
      opacity: 0.7;
      font-size: 9px;
      margin-left: 4px;
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      grid-template-rows: 1fr;
      gap: 8px;
      padding: 8px;
      background: radial-gradient(circle at 0 0,#121f5e,#020219 55%,#000211 100%);
    }

    /* LEFT: TIMELINE PANEL */
    .timeline-panel {
      position: relative;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      background: radial-gradient(circle at 0 0,#202f7c,#02041a 60%,#01010b 100%);
      border-radius: var(--radius);
      border: 1px solid rgba(129,166,255,0.5);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .timeline-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      background: var(--timeline-header-bg);
      border-bottom: 1px solid rgba(129,166,255,0.4);
    }

    .timeline-toolbar-left,
    .timeline-toolbar-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .toolbar-label {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #9cb3ff;
      opacity: 0.9;
    }

    .toolbar-toggle {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(129,166,255,0.4);
      background: radial-gradient(circle at 0 0,#040826,#050b2a 70%);
      color: #d6e3ff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .toolbar-toggle.secondary {
      border-style: dashed;
      opacity: 0.85;
    }

    .toolbar-toggle span.icon {
      font-size: 11px;
    }

    .timeline-header-row {
      display: grid;
      grid-template-columns: 180px 1fr;
      background: var(--timeline-header-bg);
      border-bottom: 1px solid rgba(129,166,255,0.4);
      font-size: 11px;
      color: #c6d4ff;
    }
    .timeline-header-row .tracks-label {
      padding: 4px 8px;
      border-right: 1px solid rgba(129,166,255,0.4);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 9px;
      display: flex;
      align-items: center;
      gap: 4px;
      color: #9cb3ff;
    }
    .timeline-header-row .tracks-label span.icon {
      font-size: 13px;
    }

    .timeline-ruler {
      height: 22px;
      background: var(--timeline-ruler-bg);
      border-bottom: 1px solid rgba(129,166,255,0.3);
      position: relative;
      overflow: hidden;
      font-size: 10px;
    }

    .ruler-inner {
      position: absolute;
      inset: 0;
      white-space: nowrap;
      display: flex;
      align-items: flex-end;
      padding: 0 4px;
      color: #c2d3ff;
    }

    .ruler-bar {
      height: 14px;
      display: inline-flex;
      align-items: flex-end;
      justify-content: flex-start;
      position: relative;
      border-right: 1px solid rgba(129,166,255,0.35);
      padding-right: 4px;
    }
    .ruler-bar span {
      font-variant-numeric: tabular-nums;
      opacity: 0.9;
    }

    .timeline-body {
      position: relative;
      display: grid;
      grid-template-columns: 180px 1fr;
      height: 100%;
    }

    .track-list {
      position: relative;
      background: radial-gradient(circle at 0 0,#08123a,#02041a 60%,#01010b 100%);
      border-right: 1px solid rgba(129,166,255,0.45);
      overflow-y: auto;
      overflow-x: hidden;
    }

    .track-header {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 4px 4px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      background: rgba(7,14,60,0.96);
      min-height: 48px;
      gap: 2px;
      cursor: grab;
    }
    .track-header-main {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .track-icon {
      width: 14px;
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      margin-right: 1px;
      flex-shrink: 0;
    }
    .track-header:nth-child(odd) { background: rgba(8,16,70,0.96); }
    .track-header.dragging {
      opacity: 0.7;
    }
    .track-color-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: linear-gradient(135deg,#4aa8ff,#ffd77c);
      box-shadow: 0 0 8px rgba(124,190,255,0.9);
      cursor: pointer;
      flex-shrink: 0;
    }
    .track-name {
      flex: 1;
      padding: 2px 4px;
      border-radius: 4px;
      color: #f7fbff;
      font-size: 11px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      background: rgba(2,5,27,0.8);
      border: 1px solid rgba(129,166,255,0.3);
    }
    .track-name[contenteditable="true"] {
      outline: 1px solid var(--accent);
      background: #02041b;
    }
    .track-controls {
      display: flex;
      align-items: center;
      gap: 2px;
      flex-shrink: 0;
    }
    .track-btn {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 1px solid rgba(0,0,0,0.9);
      background: #050a27;
      color: var(--text-muted);
      font-size: 9px;
      cursor: pointer;
      padding: 0;
    }
    .track-btn.active {
      background: radial-gradient(circle at 0 0,#ffd77c,#ff6ca4);
      color: #02041a;
    }
    .track-options-btn {
      width: 20px;
      height: 18px;
      border-radius: 4px;
      border: 1px solid rgba(0,0,0,0.9);
      background: #050a27;
      color: var(--text-muted);
      font-size: 11px;
      cursor: pointer;
      padding: 0;
    }
    .track-resize-handle {
      height: 4px;
      cursor: row-resize;
      background: linear-gradient(to right,rgba(129,166,255,0.15),rgba(129,166,255,0.02),rgba(129,166,255,0.15));
    }
    .add-track-bar {
      padding: 6px;
      text-align: center;
      border-top: 1px solid rgba(129,166,255,0.35);
      background: radial-gradient(circle at 0 0,#091653,#02041a 60%);
      position: sticky;
      bottom: 0;
    }
    .add-track-btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(129,166,255,0.7);
      background: radial-gradient(circle at 0 0,#3d7cff,#050a23 60%);
      color: #f7fbff;
      font-size: 11px;
      cursor: pointer;
    }

    .grid-viewport {
      position: relative;
      overflow: auto;
      background: var(--timeline-grid-bg);
    }

    .grid-inner {
      position: relative;
      min-width: calc(64 * var(--beat-width));
      background-image: linear-gradient(to right,rgba(129,166,255,0.12) 1px,transparent 1px),
                        linear-gradient(to right,rgba(129,166,255,0.06) 1px,transparent 1px);
      background-size: calc(var(--beat-width)) 100%, calc(var(--beat-width) * var(--beats-per-bar)) 100%;
    }

    .grid-track-row {
      position: relative;
      border-bottom: 1px solid rgba(129,166,255,0.12);
    }

    .clip {
      position: absolute;
      top: 3px;
      height: calc(var(--track-height) - 8px);
      border-radius: 4px;
      font-size: 10px;
      color: #020414;
      padding: 2px 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0,0,0,0.85);
    }

    /* colors for clips assigned later */

    .playhead {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 1px;
      background: rgba(255,255,255,0.9);
      pointer-events: none;
      z-index: 5;
    }
    .playhead-handle {
      position: absolute;
      top: 0;
      transform: translate(-6px,0);
      width: 12px;
      height: 10px;
      background: radial-gradient(circle at 0 0,#ffd77c,#ff6ca4);
      border-radius: 0 0 8px 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.85);
    }

    .loop-region {
      position: absolute;
      top: 0;
      bottom: 0;
      background: rgba(124,190,255,0.12);
      border-left: 1px solid rgba(124,190,255,0.7);
      border-right: 1px solid rgba(124,190,255,0.7);
      pointer-events: none;
      z-index: 3;
    }

    .vertical-scrollbar {
      position: absolute;
      top: 0;
      right: 0;
      width: 10px;
      height: 100%;
      background: linear-gradient(to bottom,rgba(5,10,40,0.8),rgba(2,3,15,0.95));
      border-left: 1px solid rgba(129,166,255,0.6);
    }
    .vertical-thumb {
      position: absolute;
      left: 1px;
      right: 1px;
      height: 40px;
      background: radial-gradient(circle at 0 0,#4aa8ff,#091246);
      border-radius: 999px;
      box-shadow: 0 0 10px rgba(0,0,0,0.85);
      cursor: pointer;
    }

    .horizontal-scrollbar {
      position: absolute;
      left: 0;
      right: 10px;
      bottom: 0;
      height: 12px;
      background: linear-gradient(to right,rgba(5,10,40,0.8),rgba(2,3,15,0.95));
      border-top: 1px solid rgba(129,166,255,0.6);
    }
    .horizontal-thumb {
      position: absolute;
      top: 1px;
      bottom: 1px;
      width: 120px;
      background: radial-gradient(circle at 0 0,#4aa8ff,#091246);
      border-radius: 999px;
      box-shadow: 0 0 10px rgba(0,0,0,0.85);
      cursor: pointer;
    }

    /* ===== PATTERN + MIXER PANEL ===== */
    .right-panel {
      display: grid;
      grid-template-rows: 1.1fr 0.9fr;
      gap: 8px;
    }

    .pattern-panel, .mixer-panel {
      position: relative;
      border-radius: var(--radius);
      border: 1px solid rgba(129,166,255,0.5);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      background: radial-gradient(circle at 0 0,#182570,#02041a 60%,#000112 100%);
    }

    .panel-header {
      padding: 6px 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(to right,#080f3e,#050a26);
      border-bottom: 1px solid rgba(129,166,255,0.45);
      color: #c6d4ff;
    }
    .panel-header span.icon {
      margin-right: 6px;
      font-size: 13px;
    }
    .panel-header-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
    }

    .pattern-body {
      position: relative;
      background: var(--pattern-bg);
      padding: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .pattern-toolbar {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      color: #d9e4ff;
    }

    select, input[type="number"], input[type="text"] {
      background: #02041a;
      border-radius: 4px;
      border: 1px solid rgba(129,166,255,0.5);
      color: #f7fbff;
      font-size: 11px;
      padding: 2px 4px;
    }

    .pattern-grid {
      flex: 1;
      border-radius: 7px;
      background: var(--pattern-grid-bg);
      border: 1px solid rgba(129,166,255,0.45);
      overflow: hidden;
      display: grid;
      grid-template-rows: repeat(8,1fr);
      grid-auto-flow: row;
      margin-top: 4px;
    }

    .pattern-row {
      display: grid;
      grid-template-columns: repeat(16,1fr);
      border-bottom: 1px solid rgba(33,52,109,0.95);
    }

    .pattern-step {
      border-right: 1px solid rgba(33,52,109,0.95);
      background: var(--pattern-step-off);
      cursor: pointer;
    }
    .pattern-step.on {
      background: var(--pattern-step-on);
      box-shadow: 0 0 10px rgba(255,215,124,0.8);
    }

    .mixer-body {
      position: relative;
      background: var(--mixer-bg);
      padding: 6px 6px 10px 6px;
      display: flex;
      align-items: flex-end;
      gap: 6px;
      overflow-x: auto;
      overflow-y: hidden;
    }

    .mixer-strip {
      width: 64px;
      border-radius: 8px;
      background: var(--mixer-strip-bg);
      border: 1px solid var(--mixer-strip-border);
      padding: 6px 4px 6px 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 0 20px rgba(0,0,0,0.9);
      flex-shrink: 0;
    }
    .mixer-strip-header {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--mixer-text);
      opacity: 0.8;
      margin-bottom: 4px;
      text-align: center;
    }
    .mixer-strip-num {
      font-variant-numeric: tabular-nums;
    }
    .mixer-strip-label {
      font-size: 9px;
      opacity: 0.95;
      margin-top: 2px;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .mixer-meter {
      width: 20px;
      height: 90px;
      border-radius: 999px;
      background: var(--mixer-meter-bg);
      border: 1px solid rgba(129,166,255,0.5);
      margin-bottom: 6px;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }
    .mixer-meter-fill {
      width: 100%;
      border-radius: 999px;
      background: var(--mixer-meter-fill);
      box-shadow: 0 0 12px rgba(77,255,187,0.9);
    }

    .mixer-fader {
      width: 6px;
      height: 50px;
      border-radius: 999px;
      background: linear-gradient(to bottom,#e6f0ff,#8797ff);
      position: relative;
      overflow: visible;
      margin-bottom: 6px;
    }

    .mixer-fader-knob {
      position: absolute;
      left: -4px;
      width: 14px;
      height: 12px;
      border-radius: 999px;
      background: radial-gradient(circle at 0 0,#ffd77c,#ff6ca4);
      border: 1px solid rgba(0,0,0,0.7);
      box-shadow: 0 0 10px rgba(0,0,0,0.85);
      cursor: pointer;
    }

    .mixer-strip-footer {
      font-size: 9px;
      color: var(--mixer-text);
      opacity: 0.8;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .mixer-btn {
      font-size: 9px;
      padding: 2px 4px;
      border-radius: 999px;
      border: 1px solid rgba(129,166,255,0.5);
      background: rgba(5,10,40,0.9);
      color: var(--mixer-text);
      cursor: pointer;
    }

    .mixer-pan {
      width: 38px;
    }

    /* TRACK TYPE MENU */
    .track-type-menu {
      position: fixed;
      z-index: 1000;
      min-width: 140px;
      background: #050b24;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 0 18px rgba(0,0,0,0.95);
      padding: 4px 0;
      font-size: 11px;
      color: var(--text-main);
      display: none;
    }
    .track-type-menu-group + .track-type-menu-group {
      border-top: 1px solid rgba(255,255,255,0.08);
      margin-top: 4px;
      padding-top: 4px;
    }
    .track-type-menu-title {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
      padding: 2px 10px;
      margin-bottom: 2px;
    }
    .track-type-menu-item {
      padding: 4px 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }
    .track-type-menu-item:hover {
      background: rgba(124,190,255,0.18);
    }
    .track-type-menu-item span:last-child {
      font-size: 9px;
      color: var(--text-muted);
    }

    /* ===== HINT BAR ===== */
    .hint-bar {
      margin-top: 4px;
      border-radius: 7px;
      background: rgba(2,5,20,0.95);
      border: 1px dashed rgba(129,166,255,0.5);
      padding: 4px 8px;
      font-size: 10px;
      color: #bdccff;
    }
    .hint-bar strong {
      color: #ffd77c;
      font-weight: 600;
    }

    /* ===== THEME DESIGNER OVERLAY ===== */
    .overlay-backdrop {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 0 0,rgba(23,42,110,0.9),rgba(0,0,5,0.96));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .overlay-panel {
      width: 720px;
      max-width: calc(100% - 32px);
      max-height: calc(100% - 32px);
      border-radius: 12px;
      background: var(--designer-bg);
      border: 1px solid rgba(129,166,255,0.7);
      box-shadow: 0 0 32px rgba(0,0,0,0.95);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .overlay-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--designer-label);
      border-bottom: 1px solid rgba(129,166,255,0.4);
      padding-bottom: 6px;
    }
    .overlay-panel-body {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 8px;
      font-size: 11px;
      color: var(--designer-label);
      flex: 1;
      min-height: 0;
    }
    .overlay-column {
      background: var(--designer-surface);
      border-radius: 9px;
      border: 1px solid rgba(129,166,255,0.4);
      padding: 8px;
      overflow: auto;
    }
    .overlay-section-title {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--designer-muted);
      margin-bottom: 6px;
    }
    .color-chip-grid {
      display: grid;
      grid-template-columns: repeat(4,1fr);
      gap: 6px;
    }
    .color-chip {
      border-radius: 7px;
      border: 1px solid var(--designer-chip-border);
      height: 40px;
      position: relative;
      cursor: pointer;
      overflow: hidden;
    }
    .color-chip-inner {
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg,rgba(124,190,255,0.1),rgba(255,215,124,0.05));
    }
    .color-chip-label {
      position: absolute;
      bottom: 4px;
      left: 6px;
      right: 6px;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #d7e3ff;
    }
    .color-chip.selected {
      border-color: rgba(255,215,124,0.8);
      box-shadow: 0 0 16px rgba(0,0,0,0.9);
      background: var(--designer-chip-selected);
    }

    .preset-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid rgba(129,166,255,0.15);
      font-size: 11px;
    }
    .preset-row:last-child {
      border-bottom: none;
    }
    .preset-apply-btn {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(129,166,255,0.6);
      background: rgba(5,10,40,0.9);
      color: #e4edff;
      cursor: pointer;
    }

    .overlay-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 10px;
      padding-top: 6px;
      border-top: 1px solid rgba(129,166,255,0.4);
      color: var(--designer-muted);
    }
    .overlay-close-btn {
      font-size: 10px;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(129,166,255,0.6);
      background: radial-gradient(circle at 0 0,#09144a,#05092a 70%);
      color: #e6efff;
      cursor: pointer;
    }

    /* PLUGIN WINDOW OVERLAY */
    .plugin-overlay-backdrop {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 0 0,rgba(24,37,94,0.9),rgba(0,0,5,0.96));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2100;
    }
    .plugin-window {
      width: 520px;
      max-width: calc(100% - 32px);
      max-height: calc(100% - 32px);
      border-radius: 12px;
      background: radial-gradient(circle at 0 0,#1a286a,#020418 60%);
      border: 1px solid rgba(129,166,255,0.65);
      box-shadow: 0 0 32px rgba(0,0,0,0.95);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: #dfe8ff;
      font-size: 11px;
    }
    .plugin-window-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(129,166,255,0.5);
      padding-bottom: 4px;
    }
    .plugin-window-title {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 10px;
      color: #c9d8ff;
    }
    .plugin-window-close {
      border-radius: 999px;
      border: 1px solid rgba(129,166,255,0.7);
      background: rgba(5,10,40,0.9);
      color: #eaf0ff;
      font-size: 10px;
      padding: 2px 8px;
      cursor: pointer;
    }
    .plugin-window-body {
      flex: 1;
      overflow: auto;
      padding-top: 4px;
      font-size: 11px;
    }
    .plugin-window-body p {
      margin: 4px 0;
    }

    /* PANELS FOOTER / STATUS */
    .status-bar {
      height: 20px;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 8px;
      background: radial-gradient(circle at 0 0,#060e3a,#020214 65%);
      border-top: 1px solid rgba(129,166,255,0.5);
      color: #9cb3ff;
    }
    .status-left, .status-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

  </style>
</head>
<body>
<header>
  <div class="app-title">
    <span>üéß Sulandra AI Studio</span>
    <span class="app-badge">SOUND LAB</span>
  </div>
  <div class="transport">
    <button id="btn-stop">‚ñ†</button>
    <button id="btn-play">‚ñ∂</button>
    <button class="secondary" id="btn-loop">‚ü≥</button>
    <div class="tempo-display">
      <span class="label">BPM</span>
      <span class="value" id="tempo-value">120</span>
    </div>
  </div>
  <div class="top-right-tools">
    <button class="chip-button" id="theme-designer-btn">Theme Designer<span class="hotkey">ALT+T</span></button>
    <button class="chip-button" id="open-mixer-btn">Mixer<span class="hotkey">F9</span></button>
  </div>
</header>

<main>
  <!-- LEFT: TIMELINE -->
  <section class="timeline-panel">
    <div class="timeline-toolbar">
      <div class="timeline-toolbar-left">
        <span class="toolbar-label">Timeline</span>
        <button class="toolbar-toggle" id="pattern-mode-toggle">
          <span class="icon">üéõÔ∏è</span> Pattern Mode
        </button>
        <button class="toolbar-toggle secondary" id="snap-toggle">
          <span class="icon">üìê</span> Snap
        </button>
      </div>
      <div class="timeline-toolbar-right">
        <button class="toolbar-toggle secondary" id="zoom-out">‚àí</button>
        <button class="toolbar-toggle secondary" id="zoom-in">+</button>
      </div>
    </div>

    <div class="timeline-header-row">
      <div class="tracks-label">
        <span class="icon">üéöÔ∏è</span>
        <span>Tracks</span>
      </div>
      <div class="timeline-ruler">
        <div class="ruler-inner" id="ruler-inner"></div>
      </div>
    </div>

    <div class="timeline-body">
      <div class="track-list" id="track-list">
        <div class="add-track-bar">
          <button class="add-track-btn" id="add-track-btn">+ Add Track</button>
        </div>
      </div>
      <div class="grid-viewport" id="grid-viewport">
        <div class="grid-inner" id="grid-inner">
          <div class="playhead" id="playhead">
            <div class="playhead-handle"></div>
          </div>
          <div class="loop-region" id="loop-region"></div>
        </div>
        <div class="vertical-scrollbar" id="vertical-scrollbar">
          <div class="vertical-thumb" id="vertical-thumb"></div>
        </div>
        <div class="horizontal-scrollbar" id="horizontal-scrollbar">
          <div class="horizontal-thumb" id="horizontal-thumb"></div>
        </div>
      </div>
    </div>

    <div class="status-bar">
      <div class="status-left">
        <span>Now: <span id="status-position">Bar 1 ‚Ä¢ Beat 1 ‚Ä¢ 00:00</span></span>
      </div>
      <div class="status-right">
        <span>Pattern: <span id="status-pattern">None</span></span>
        <span>Theme: Neon Midnight</span>
      </div>
    </div>
  </section>

  <!-- RIGHT: PATTERN + MIXER -->
  <section class="right-panel">
    <section class="pattern-panel">
      <div class="panel-header">
        <div><span class="icon">üéõÔ∏è</span>Pattern Editor</div>
        <div class="panel-header-controls">
          <span>Active: <span id="pattern-name-display">None</span></span>
        </div>
      </div>
      <div class="pattern-body">
        <div class="pattern-toolbar">
          <label>Pattern:
            <select id="pattern-select"></select>
          </label>
          <button class="chip-button" id="new-pattern-btn">New</button>
          <button class="chip-button" id="duplicate-pattern-btn">Duplicate</button>
        </div>
        <div class="pattern-grid" id="pattern-grid"></div>
        <div class="hint-bar">
          <strong>Hint:</strong> Turn on steps to program drums / instruments. In Pattern Mode, clips trigger the selected pattern instead of raw audio.
        </div>
      </div>
    </section>

    <section class="mixer-panel">
      <div class="panel-header">
        <div><span class="icon">üéöÔ∏è</span>Mixer</div>
        <div class="panel-header-controls">
          <span>Strips follow tracks</span>
        </div>
      </div>
      <div class="mixer-body" id="mixer-strips"></div>
    </section>
  </section>
</main>

<!-- TRACK TYPE POPUP -->
<div class="track-type-menu" id="track-type-menu">
  <!-- INSTRUMENTS -->
  <div class="track-type-menu-group">
    <div class="track-type-menu-title">Instruments</div>

    <div class="track-type-menu-item"
         data-action="preset"
         data-kind="instrument"
         data-preset="piano"
         data-label="Piano"
         data-color="#7cbeff"
         data-icon="üéπ"
         data-mixertype="Piano">
      Piano
    </div>

    <div class="track-type-menu-item"
         data-action="preset"
         data-kind="instrument"
         data-preset="guitar"
         data-label="Guitar"
         data-color="#ffd77c"
         data-icon="üé∏"
         data-mixertype="Guitar">
      Guitar
    </div>

    <div class="track-type-menu-item"
         data-action="preset"
         data-kind="instrument"
         data-preset="bass"
         data-label="Bass"
         data-color="#7cffc7"
         data-icon="üéµ"
         data-mixertype="Bass">
      Bass
    </div>

    <div class="track-type-menu-item"
         data-action="preset"
         data-kind="instrument"
         data-preset="drums"
         data-label="Drums"
         data-color="#ff8a6a"
         data-icon="ü•Å"
         data-mixertype="Drums">
      Drums
    </div>

    <div class="track-type-menu-item"
         data-action="preset"
         data-kind="instrument"
         data-preset="synth"
         data-label="Synth"
         data-color="#ffb4ff"
         data-icon="üéõÔ∏è"
         data-mixertype="Synth">
      Synth
    </div>

    <div class="track-type-menu-item"
         data-action="preset"
         data-kind="instrument"
         data-preset="strings"
         data-label="Strings"
         data-color="#9fc5ff"
         data-icon="üéª"
         data-mixertype="Strings">
      Strings
    </div>
  </div>

  <!-- VOCALS -->
  <div class="track-type-menu-group">
    <div class="track-type-menu-title">Vocals</div>

    <div class="track-type-menu-item"
         data-action="preset"
         data-kind="vocal"
         data-preset="lead"
         data-label="Lead Vocal"
         data-color="#ffb4ff"
         data-icon="üéôÔ∏è"
         data-mixertype="Lead">
      Lead Vocal
    </div>

    <div class="track-type-menu-item"
         data-action="preset"
         data-kind="vocal"
         data-preset="backing"
         data-label="Backing Vocals"
         data-color="#7cffc7"
         data-icon="üé§"
         data-mixertype="Back">
      Backing Vocals
    </div>

    <div class="track-type-menu-item"
         data-action="preset"
         data-kind="vocal"
         data-preset="choir"
         data-label="Choir"
         data-color="#ffd77c"
         data-icon="üéº"
         data-mixertype="Choir">
      Choir
    </div>
  </div>

  <!-- IMPORT -->
  <div class="track-type-menu-group">
    <div class="track-type-menu-title">Import</div>

    <div class="track-type-menu-item"
         data-action="import-device">
      Upload from device‚Ä¶
    </div>

    <div class="track-type-menu-item"
         data-action="import-audio">
      Import from Audio (music.html)
    </div>
  </div>

  <!-- SL ASSISTANT -->
  <div class="track-type-menu-group">
    <div class="track-type-menu-title">Assistant</div>
    <div class="track-type-menu-item"
         data-action="sl-assistant">
      Create with SL Assistant
    </div>
  </div>
</div>

<input type="file" id="track-file-input" accept="audio/*" style="display:none">

<!-- PLUGIN / THEME OVERLAYS -->
<div class="overlay-backdrop" id="theme-overlay">
  <div class="overlay-panel">
    <div class="overlay-panel-header">
      <span>Theme Designer</span>
      <button class="overlay-close-btn" id="theme-close-btn">Close</button>
    </div>
    <div class="overlay-panel-body">
      <div class="overlay-column">
        <div class="overlay-section-title">Base Palettes</div>
        <div class="color-chip-grid" id="theme-presets"></div>
      </div>
      <div class="overlay-column">
        <div class="overlay-section-title">Description</div>
        <div id="theme-description">
          Select a palette to instantly recolor the Sound Lab. All gradients, clip colors, and mixer accents will follow.
        </div>
      </div>
    </div>
    <div class="overlay-footer">
      <span>TIP: Save your favorite colorways as snapshots in the future designer version.</span>
    </div>
  </div>
</div>

<div class="plugin-overlay-backdrop" id="plugin-overlay">
  <div class="plugin-window">
    <div class="plugin-window-header">
      <div class="plugin-window-title" id="plugin-title">Plugin</div>
      <button class="plugin-window-close" id="plugin-close-btn">Close</button>
    </div>
    <div class="plugin-window-body" id="plugin-body"></div>
  </div>
</div>

<script>
  /* ========= STATE ========= */
  const gridViewport = document.getElementById('grid-viewport');
  const gridInner = document.getElementById('grid-inner');
  const playheadEl = document.getElementById('playhead');
  const loopRegionEl = document.getElementById('loop-region');
  const verticalScrollbar = document.getElementById('vertical-scrollbar');
  const verticalThumb = document.getElementById('vertical-thumb');
  const horizontalScrollbar = document.getElementById('horizontal-scrollbar');
  const horizontalThumb = document.getElementById('horizontal-thumb');
  const trackListEl = document.getElementById('track-list');
  const addTrackBtn = document.getElementById('add-track-btn');
  const tempoValueEl = document.getElementById('tempo-value');
  const statusPositionEl = document.getElementById('status-position');
  const statusPatternEl = document.getElementById('status-pattern');
  const patternSelect = document.getElementById('pattern-select');
  const patternGrid = document.getElementById('pattern-grid');
  const patternNameDisplay = document.getElementById('pattern-name-display');
  const patternModeToggle = document.getElementById('pattern-mode-toggle');
  const btnPlay = document.getElementById('btn-play');
  const btnStop = document.getElementById('btn-stop');
  const btnLoop = document.getElementById('btn-loop');
  const themeDesignerBtn = document.getElementById('theme-designer-btn');
  const themeOverlay = document.getElementById('theme-overlay');
  const themeCloseBtn = document.getElementById('theme-close-btn');
  const themePresetsEl = document.getElementById('theme-presets');
  const themeDescriptionEl = document.getElementById('theme-description');
  const pluginOverlay = document.getElementById('plugin-overlay');
  const pluginTitleEl = document.getElementById('plugin-title');
  const pluginBodyEl = document.getElementById('plugin-body');
  const pluginCloseBtn = document.getElementById('plugin-close-btn');
  const mixerStripsEl = document.getElementById('mixer-strips');
  const trackTypeMenu = document.getElementById('track-type-menu');
  const trackFileInput = document.getElementById('track-file-input');
  let activeTypeTrackId = null;

  let tempo = 120;
  let isPlaying = false;
  let isLooping = false;
  let playheadBeat = 0;
  let loopStartBeat = 0;
  let loopEndBeat = 16;
  let patternMode = false;
  let nextTrackId = 1;
  let nextClipId = 1;
  let nextPatternId = 1;

  const tracks = [];
  const clips = [];
  const patterns = [];
  let currentPatternId = null;

  let playTimer = null;
  let verticalThumbDragging = false;
  let horizontalThumbDragging = false;
  let trackDragInfo = null;

  /* ========= BASIC HELPERS ========= */
  function beatsToPx(beats) {
    return beats * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--beat-width'));
  }
  function pxToBeats(px) {
    return px / parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--beat-width'));
  }

  /* ========= RULER ========= */
  function buildRuler() {
    const inner = document.getElementById('ruler-inner');
    inner.innerHTML = '';
    for (let bar = 1; bar <= 64; bar++) {
      const barEl = document.createElement('div');
      barEl.className = 'ruler-bar';
      barEl.style.width = (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--beat-width')) * 4) + 'px';
      const label = document.createElement('span');
      label.textContent = bar;
      barEl.appendChild(label);
      inner.appendChild(barEl);
    }
  }

  /* ========= TRACKS ========= */
  function addTrack(name) {
    const id = nextTrackId++;
    tracks.push({
      id,
      name: name || `Track ${id}`,
      height: 64,
      type: 'Audio',   // mixer label
      kind: 'audio',   // audio / instrument / vocal
      preset: null,    // piano, lead, etc.
      color: null,     // custom color for dot
      icon: ''         // emoji icon
    });
    renderTracks();
    return id;
  }

  function moveTrack(id, dir) {
    const idx = tracks.findIndex(t => t.id === id);
    if (idx < 0) return;
    const newIndex = idx + dir;
    if (newIndex < 0 || newIndex >= tracks.length) return;
    const [t] = tracks.splice(idx, 1);
    tracks.splice(newIndex, 0, t);
    renderTracks();
  }

  function renderTracks() {
    const headers = Array.from(trackListEl.querySelectorAll('.track-header,.track-resize-handle'));
    headers.forEach(h => h.remove());

    const rows = Array.from(gridInner.querySelectorAll('.grid-track-row'));
    rows.forEach(r => r.remove());

    tracks.forEach((t, idx) => {
      const header = document.createElement('div');
      header.className = 'track-header';
      header.style.height = t.height + 'px';
      header.dataset.trackId = t.id;

      // top row: color + icon + name
      const topRow = document.createElement('div');
      topRow.className = 'track-header-main';

      const dot = document.createElement('div');
      dot.className = 'track-color-dot';
      if (t.color) {
        dot.style.background = t.color;
        dot.style.boxShadow = '0 0 8px ' + t.color;
      }
      dot.addEventListener('dblclick', () => {
        openPluginWindow(
          `Track Plugin ‚Äì ${t.name}`,
          `<p>Future plugin window for <b>${t.name}</b>.</p>
           <p>Later you can load a track plugin UI here (EQ, compressor, reverb, sends).</p>
           <p>Ideas:</p>
           <ul>
             <li>AI-assisted EQ suggestions per track</li>
             <li>Preset browser tied to genre &amp; tempo</li>
           </ul>`
        );
      });

      const iconEl = document.createElement('div');
      iconEl.className = 'track-icon';
      iconEl.textContent = t.icon || '';

      const nameEl = document.createElement('div');
      nameEl.className = 'track-name';
      nameEl.textContent = t.name;
      nameEl.title = t.name;
      nameEl.addEventListener('dblclick', (e) => {
        e.stopPropagation();
        nameEl.contentEditable = 'true';
        nameEl.focus();
        document.execCommand('selectAll', false, null);
      });
      nameEl.addEventListener('blur', () => {
        nameEl.contentEditable = 'false';
        t.name = nameEl.textContent.trim() || t.name;
        nameEl.textContent = t.name;
        nameEl.title = t.name;
        renderMixer();
      });
      nameEl.addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); nameEl.blur(); }
      });

      topRow.appendChild(dot);
      topRow.appendChild(iconEl);
      topRow.appendChild(nameEl);

      // bottom row: controls
      const controls = document.createElement('div');
      controls.className = 'track-controls';

      const mBtn = document.createElement('button');
      mBtn.className = 'track-btn';
      mBtn.textContent = 'M';
      mBtn.title = 'Mute';
      mBtn.addEventListener('click', () => {
        mBtn.classList.toggle('active');
      });

      const sBtn = document.createElement('button');
      sBtn.className = 'track-btn';
      sBtn.textContent = 'S';
      sBtn.title = 'Solo';
      sBtn.addEventListener('click', () => {
        sBtn.classList.toggle('active');
      });

      const upBtn = document.createElement('button');
      upBtn.className = 'track-btn';
      upBtn.textContent = '‚ñ≤';
      upBtn.title = 'Move up';
      upBtn.addEventListener('click', () => moveTrack(t.id, -1));

      const downBtn = document.createElement('button');
      downBtn.className = 'track-btn';
      downBtn.textContent = '‚ñº';
      downBtn.title = 'Move down';
      downBtn.addEventListener('click', () => moveTrack(t.id, +1));

      const optionsBtn = document.createElement('button');
      optionsBtn.className = 'track-options-btn';
      optionsBtn.textContent = '‚ãØ';
      optionsBtn.title = 'Track type / options';
      optionsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        activeTypeTrackId = t.id;
        showTrackTypeMenu(e.clientX, e.clientY);
      });

      controls.appendChild(mBtn);
      controls.appendChild(sBtn);
      controls.appendChild(upBtn);
      controls.appendChild(downBtn);
      controls.appendChild(optionsBtn);

      header.appendChild(topRow);
      header.appendChild(controls);

      // double-click anywhere on empty header area opens type menu
      header.addEventListener('dblclick', (e) => {
        if (e.target.closest('.track-btn') || e.target.closest('.track-name') || e.target.classList.contains('track-color-dot')) return;
        activeTypeTrackId = t.id;
        showTrackTypeMenu(e.clientX, e.clientY);
      });

      const resize = document.createElement('div');
      resize.className = 'track-resize-handle';
      resize.dataset.trackId = t.id;

      trackListEl.insertBefore(resize, trackListAddBar);
      trackListEl.insertBefore(header, resize);

      header.addEventListener('mousedown', (e) => {
        if (e.target.closest('.track-btn') || e.target.closest('.track-options-btn') || e.target.classList.contains('track-color-dot')) return;
        if (e.button !== 0) return;
        trackDragInfo = { id: t.id };
        header.classList.add('dragging');
      });

      const gridRow = document.createElement('div');
      gridRow.className = 'grid-track-row';
      gridRow.dataset.trackId = t.id;
      gridRow.style.height = t.height + 'px';

      // double-click in the timeline row opens the same track menu
      gridRow.addEventListener('dblclick', (e) => {
        activeTypeTrackId = t.id;
        showTrackTypeMenu(e.clientX, e.clientY);
      });

      gridInner.appendChild(gridRow);
    });

    gridInner.style.setProperty('--track-height', '64px');
    renderClips();
    renderMixer();
    updatePlayheadPosition(false);
    updateLoopRegion();
    updateVerticalThumb();
    updateHorizontalThumb();
  }

  const trackListAddBar = trackListEl.querySelector('.add-track-bar');

  function createClip(trackId, startBeat, lengthBeats, label, color, patternId=null) {
    const id = nextClipId++;
    clips.push({ id, trackId, startBeat, lengthBeats, label, color, patternId });
    renderClips();
  }

  function renderClips() {
    Array.from(gridInner.querySelectorAll('.clip')).forEach(c => c.remove());
    clips.forEach(c => {
      const row = gridInner.querySelector(`.grid-track-row[data-track-id="${c.trackId}"]`);
      if (!row) return;
      const el = document.createElement('div');
      el.className = 'clip';
      el.dataset.clipId = c.id;
      el.textContent = c.label;
      el.style.left = beatsToPx(c.startBeat) + 'px';
      el.style.width = beatsToPx(c.lengthBeats) + 'px';
      el.style.background = c.color || 'var(--clip-blue)';
      row.appendChild(el);
    });
  }

  /* ========= TRACK TYPE MENU ========= */
  function showTrackTypeMenu(clientX, clientY) {
    if (!trackTypeMenu) return;
    const menu = trackTypeMenu;
    menu.style.display = 'block';
    const rect = menu.getBoundingClientRect();
    let x = clientX + 4;
    let y = clientY + 4;
    if (x + rect.width > window.innerWidth) x = window.innerWidth - rect.width - 6;
    if (y + rect.height > window.innerHeight) y = window.innerHeight - rect.height - 6;
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';
  }

  function hideTrackTypeMenu() {
    if (!trackTypeMenu) return;
    trackTypeMenu.style.display = 'none';
    activeTypeTrackId = null;
  }

  function applyTrackPresetToActive(item) {
    if (!activeTypeTrackId) return;
    const t = tracks.find(tr => tr.id === activeTypeTrackId);
    if (!t) return;

    const kind      = item.dataset.kind || 'audio';
    const preset    = item.dataset.preset || null;
    const label     = item.dataset.label || t.name;
    const mixertype = item.dataset.mixertype || kind;
    const color     = item.dataset.color || null;
    const icon      = item.dataset.icon || '';

    t.kind   = kind;
    t.preset = preset;
    t.type   = mixertype;
    t.name   = label;
    t.color  = color;
    t.icon   = icon;

    hideTrackTypeMenu();
    renderTracks();
    renderMixer();
  }

  // handle clicks on menu items (presets, import, assistant)
  trackTypeMenu.querySelectorAll('.track-type-menu-item').forEach(item => {
    item.addEventListener('click', () => {
      const action = item.dataset.action || 'preset';

      if (action === 'preset') {
        applyTrackPresetToActive(item);

      } else if (action === 'import-device') {
        hideTrackTypeMenu();
        if (!trackFileInput || !activeTypeTrackId) return;
        trackFileInput.dataset.trackId = String(activeTypeTrackId);
        trackFileInput.click();

      } else if (action === 'import-audio') {
        hideTrackTypeMenu();
        window.location.href = 'music.html#creations';

      } else if (action === 'sl-assistant') {
        hideTrackTypeMenu();
        const t = tracks.find(tr => tr.id === activeTypeTrackId);
        const title = t ? `SL Assistant ‚Äì ${t.name}` : 'SL Assistant';
        const bodyHtml = `
          <p>Use SL Assistant to create or refine audio for
             <b>${t ? t.name : 'this track'}</b>.</p>
          <p>Later you can connect this to Sulandra AI Studio‚Äôs
             generation pipeline.</p>
        `;
        openPluginWindow(title, bodyHtml);
      }
    });
  });

  // close menu when clicking outside
  window.addEventListener('click', (e) => {
    if (!trackTypeMenu) return;
    if (!trackTypeMenu.contains(e.target) && !e.target.classList.contains('track-options-btn')) {
      hideTrackTypeMenu();
    }
  });

  // handle file uploads from "Upload from device‚Ä¶"
  if (trackFileInput) {
    trackFileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      const trackId = parseInt(trackFileInput.dataset.trackId || '', 10);
      const t = tracks.find(tr => tr.id === trackId);
      if (t) {
        // store filenames on the track; later you can hook real audio import
        t.importedFiles = files.map(f => f.name);
        renderMixer();
      }

      trackFileInput.value = '';
      trackFileInput.dataset.trackId = '';
    });
  }

  /* ========= MIXER ========= */
  function renderMixer() {
    if (!mixerStripsEl) return;
    mixerStripsEl.innerHTML = '';
    tracks.forEach((t, index) => {
      const strip = document.createElement('div');
      strip.className = 'mixer-strip';

      const header = document.createElement('div');
      header.className = 'mixer-strip-header';
      const num = document.createElement('div');
      num.className = 'mixer-strip-num';
      num.textContent = index + 1;
      const label = document.createElement('div');
      label.className = 'mixer-strip-label';
      label.textContent = t.type || 'Audio';
      header.appendChild(num);
      header.appendChild(label);

      const meter = document.createElement('div');
      meter.className = 'mixer-meter';
      const fill = document.createElement('div');
      fill.className = 'mixer-meter-fill';
      fill.style.height = '30%';
      meter.appendChild(fill);

      const fader = document.createElement('div');
      fader.className = 'mixer-fader';
      const knob = document.createElement('div');
      knob.className = 'mixer-fader-knob';
      knob.style.bottom = '20px';
      fader.appendChild(knob);

      const footer = document.createElement('div');
      footer.className = 'mixer-strip-footer';
      const panLabel = document.createElement('div');
      panLabel.textContent = 'PAN';
      const volumeLabel = document.createElement('div');
      volumeLabel.textContent = 'VOL';

      const panBtn = document.createElement('button');
      panBtn.className = 'mixer-btn mixer-pan';
      panBtn.textContent = 'C';

      const volBtn = document.createElement('button');
      volBtn.className = 'mixer-btn';
      volBtn.textContent = '0.0 dB';

      footer.appendChild(panLabel);
      footer.appendChild(panBtn);
      footer.appendChild(volumeLabel);
      footer.appendChild(volBtn);

      strip.appendChild(header);
      strip.appendChild(meter);
      strip.appendChild(fader);
      strip.appendChild(footer);

      mixerStripsEl.appendChild(strip);
    });
  }

  /* ========= PATTERNS ========= */
  function addPattern(name, color) {
    const id = nextPatternId++;
    patterns.push({ id, name, color, steps: Array(8).fill(0).map(() => Array(16).fill(false)) });
    return id;
  }

  function renderPatterns() {
    patternSelect.innerHTML = '';
    patterns.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.name;
      patternSelect.appendChild(opt);
    });
    if (currentPatternId) {
      patternSelect.value = currentPatternId;
    }
    renderPatternGrid();
  }

  function renderPatternGrid() {
    patternGrid.innerHTML = '';
    const p = patterns.find(x => x.id === currentPatternId);
    if (!p) return;
    patternNameDisplay.textContent = p.name;
    p.steps.forEach((row, rowIndex) => {
      const rowEl = document.createElement('div');
      rowEl.className = 'pattern-row';
      row.forEach((on, colIndex) => {
        const stepEl = document.createElement('div');
        stepEl.className = 'pattern-step';
        if (on) stepEl.classList.add('on');
        stepEl.addEventListener('click', () => {
          p.steps[rowIndex][colIndex] = !p.steps[rowIndex][colIndex];
          stepEl.classList.toggle('on');
        });
        rowEl.appendChild(stepEl);
      });
      patternGrid.appendChild(rowEl);
    });
  }

  /* ========= PLAYBACK ========= */
  function updateStatusPosition() {
    const seconds = (playheadBeat * 60) / tempo;
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    const bar = Math.floor(playheadBeat / 4) + 1;
    const beat = Math.floor(playheadBeat % 4) + 1;
    statusPositionEl.textContent = `Bar ${bar} ‚Ä¢ Beat ${beat} ‚Ä¢ ${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
  }

  function updatePlayheadPosition(scrollIntoView=true) {
    const x = beatsToPx(playheadBeat);
    playheadEl.style.left = x + 'px';
    if (scrollIntoView) {
      const viewLeft = gridViewport.scrollLeft;
      const viewRight = viewLeft + gridViewport.clientWidth;
      if (x < viewLeft || x > viewRight) {
        gridViewport.scrollLeft = x - gridViewport.clientWidth / 2;
      }
    }
    updateStatusPosition();
  }

  function updateLoopRegion() {
    loopRegionEl.style.left = beatsToPx(loopStartBeat) + 'px';
    loopRegionEl.style.width = beatsToPx(loopEndBeat - loopStartBeat) + 'px';
  }

  function startPlayback() {
    if (isPlaying) return;
    isPlaying = true;
    btnPlay.textContent = '‚è∏';
    const stepMs = (60 / tempo) * 250; // quarter-beat-ish
    playTimer = setInterval(() => {
      playheadBeat += 0.25;
      if (isLooping && playheadBeat >= loopEndBeat) {
        playheadBeat = loopStartBeat;
      }
      updatePlayheadPosition();
    }, stepMs);
  }

  function stopPlayback() {
    isPlaying = false;
    btnPlay.textContent = '‚ñ∂';
    if (playTimer) clearInterval(playTimer);
    playTimer = null;
  }

  /* ========= SCROLLBARS ========= */
  function updateVerticalThumb() {
    const contentHeight = tracks.reduce((sum,t) => sum + t.height, 0) || 1;
    const viewHeight = gridViewport.clientHeight || 1;
    const ratio = viewHeight / contentHeight;
    const thumbHeight = Math.max(24, ratio * verticalScrollbar.clientHeight);
    verticalThumb.style.height = thumbHeight + 'px';
    const scrollRatio = gridViewport.scrollTop / (contentHeight - viewHeight || 1);
    const maxOffset = verticalScrollbar.clientHeight - thumbHeight;
    verticalThumb.style.top = (scrollRatio * maxOffset) + 'px';
  }

  function updateHorizontalThumb() {
    const contentWidth = gridInner.scrollWidth || 1;
    const viewWidth = gridViewport.clientWidth || 1;
    const ratio = viewWidth / contentWidth;
    const thumbWidth = Math.max(40, ratio * horizontalScrollbar.clientWidth);
    horizontalThumb.style.width = thumbWidth + 'px';
    const scrollRatio = gridViewport.scrollLeft / (contentWidth - viewWidth || 1);
    const maxOffset = horizontalScrollbar.clientWidth - thumbWidth;
    horizontalThumb.style.left = (scrollRatio * maxOffset) + 'px';
  }

  gridViewport.addEventListener('scroll', () => {
    updateVerticalThumb();
    updateHorizontalThumb();
  });

  verticalThumb.addEventListener('mousedown', (e) => {
    e.preventDefault();
    verticalThumbDragging = true;
  });
  horizontalThumb.addEventListener('mousedown', (e) => {
    e.preventDefault();
    horizontalThumbDragging = true;
  });
  window.addEventListener('mouseup', () => {
    verticalThumbDragging = false;
    horizontalThumbDragging = false;
  });
  window.addEventListener('mousemove', (e) => {
    if (verticalThumbDragging) {
      const rect = verticalScrollbar.getBoundingClientRect();
      const thumbHeight = verticalThumb.clientHeight;
      const maxOffset = rect.height - thumbHeight;
      let offset = e.clientY - rect.top - thumbHeight / 2;
      offset = Math.max(0, Math.min(maxOffset, offset));
      verticalThumb.style.top = offset + 'px';

      const contentHeight = tracks.reduce((sum,t) => sum + t.height, 0) || 1;
      const viewHeight = gridViewport.clientHeight || 1;
      const scrollRatio = offset / maxOffset;
      gridViewport.scrollTop = scrollRatio * (contentHeight - viewHeight);
    }
    if (horizontalThumbDragging) {
      const rect = horizontalScrollbar.getBoundingClientRect();
      const thumbWidth = horizontalThumb.clientWidth;
      const maxOffset = rect.width - thumbWidth;
      let offset = e.clientX - rect.left - thumbWidth / 2;
      offset = Math.max(0, Math.min(maxOffset, offset));
      horizontalThumb.style.left = offset + 'px';

      const contentWidth = gridInner.scrollWidth || 1;
      const viewWidth = gridViewport.clientWidth || 1;
      const scrollRatio = offset / maxOffset;
      gridViewport.scrollLeft = scrollRatio * (contentWidth - viewWidth);
    }
  });

  /* ========= THEME DESIGNER ========= */
  const themePresets = [
    {
      name: 'Neon Midnight',
      description: 'Deep navy base with neon blues, magenta highlights and warm gold accents ‚Äì the classic Sulandra Sound Lab look.',
      values: {
        '--bg-deep': '#020419',
        '--bg-surface': '#050b2a',
        '--bg-panel': '#071134',
        '--accent': '#7cbeff',
        '--accent2': '#ffd77c',
        '--accent3': '#ff6ca4',
        '--clip-blue': '#3d7cff',
        '--clip-purple': '#a96cff',
        '--clip-green': '#4dffbb'
      }
    },
    {
      name: 'Solar Amber',
      description: 'Sunset oranges and amber gradients, perfect for warm Afrobeat sessions and golden-hour inspiration.',
      values: {
        '--bg-deep': '#120908',
        '--bg-surface': '#1d0b09',
        '--bg-panel': '#2b130f',
        '--accent': '#ffb24d',
        '--accent2': '#ffd77c',
        '--accent3': '#ff6ca4',
        '--clip-blue': '#ff9e4d',
        '--clip-purple': '#ff6ca4',
        '--clip-green': '#ffd77c'
      }
    },
    {
      name: 'Aurora Cyan',
      description: 'Cool cyan and teal aurora-style gradients for late-night electronic and ambient projects.',
      values: {
        '--bg-deep': '#011418',
        '--bg-surface': '#021e26',
        '--bg-panel': '#032932',
        '--accent': '#4dffc7',
        '--accent2': '#7cbeff',
        '--accent3': '#a96cff',
        '--clip-blue': '#4dffc7',
        '--clip-purple': '#7cbeff',
        '--clip-green': '#a6ffea'
      }
    }
  ];

  function buildThemePresetUI() {
    themePresetsEl.innerHTML = '';
    themePresets.forEach((preset, index) => {
      const chip = document.createElement('div');
      chip.className = 'color-chip';
      chip.dataset.index = index;
      const inner = document.createElement('div');
      inner.className = 'color-chip-inner';
      inner.style.background = `linear-gradient(135deg,${preset.values['--accent']},${preset.values['--accent2'] || preset.values['--accent']})`;
      chip.appendChild(inner);
      const label = document.createElement('div');
      label.className = 'color-chip-label';
      label.textContent = preset.name;
      chip.appendChild(label);
      chip.addEventListener('click', () => {
        themePresetsEl.querySelectorAll('.color-chip').forEach(c => c.classList.remove('selected'));
        chip.classList.add('selected');
        applyThemePreset(preset);
      });
      themePresetsEl.appendChild(chip);
    });
    if (themePresetsEl.firstChild) {
      themePresetsEl.firstChild.classList.add('selected');
      applyThemePreset(themePresets[0]);
    }
  }

  function applyThemePreset(preset) {
    Object.entries(preset.values).forEach(([k,v]) => {
      document.documentElement.style.setProperty(k, v);
    });
    themeDescriptionEl.textContent = preset.description;
  }

  themeDesignerBtn.addEventListener('click', () => {
    themeOverlay.style.display = 'flex';
  });
  themeCloseBtn.addEventListener('click', () => {
    themeOverlay.style.display = 'none';
  });

  /* ========= PLUGIN WINDOW ========= */
  function openPluginWindow(title, bodyHtml) {
    pluginTitleEl.textContent = title;
    pluginBodyEl.innerHTML = bodyHtml;
    pluginOverlay.style.display = 'flex';
  }
  pluginCloseBtn.addEventListener('click', () => {
    pluginOverlay.style.display = 'none';
  });

  /* ========= CONTROLS ========= */
  btnPlay.addEventListener('click', () => {
    if (isPlaying) {
      stopPlayback();
    } else {
      startPlayback();
    }
  });
  btnStop.addEventListener('click', () => {
    stopPlayback();
    playheadBeat = 0;
    updatePlayheadPosition();
  });
  btnLoop.addEventListener('click', () => {
    isLooping = !isLooping;
    btnLoop.classList.toggle('active', isLooping);
  });

  patternModeToggle.addEventListener('click', () => {
    patternMode = !patternMode;
    patternModeToggle.classList.toggle('active', patternMode);
  });

  document.getElementById('zoom-in').addEventListener('click', () => {
    const current = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--beat-width'));
    const next = Math.min(96, current + 8);
    document.documentElement.style.setProperty('--beat-width', next + 'px');
    buildRuler();
    renderClips();
  });
  document.getElementById('zoom-out').addEventListener('click', () => {
    const current = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--beat-width'));
    const next = Math.max(24, current - 8);
    document.documentElement.style.setProperty('--beat-width', next + 'px');
    buildRuler();
    renderClips();
  });

  patternSelect.addEventListener('change', () => {
    currentPatternId = parseInt(patternSelect.value, 10);
    renderPatternGrid();
    const p = patterns.find(x => x.id === currentPatternId);
    statusPatternEl.textContent = p ? p.name : 'None';
  });

  document.getElementById('new-pattern-btn').addEventListener('click', () => {
    const name = `Pattern ${patterns.length + 1}`;
    const colors = ['blue','green','purple','pink'];
    const color = colors[patterns.length % colors.length];
    const pId = addPattern(name, color);
    currentPatternId = pId;
    patternSelect.value = pId;
    renderPatterns();
  });

  document.getElementById('duplicate-pattern-btn').addEventListener('click', () => {
    const p = patterns.find(x => x.id === currentPatternId);
    if (!p) return;
    const name = p.name + ' Copy';
    const newId = addPattern(name, p.color);
    const np = patterns.find(x => x.id === newId);
    np.steps = p.steps.map(row => row.slice());
    currentPatternId = newId;
    renderPatterns();
  });

  addTrackBtn.addEventListener('click', () => {
    const id = addTrack();
    if (clips.length === 0 && patterns.length > 0) {
      const p = patterns[0];
      createClip(id, 0, 4, p.name, p.color, p.id);
    }
  });

  /* ========= INIT ========= */
  buildRuler();
  buildThemePresetUI();
  addTrack('Drums');
  addTrack('Keys');
  addTrack('Bass');
  const pId = addPattern('Pattern 1', 'blue');
  currentPatternId = pId;
  renderPatterns();
  createClip(1, 0, 4, 'Beat A', '#3d7cff', pId);
  createClip(2, 4, 4, 'Chords', '#a96cff', pId);
  createClip(3, 8, 4, 'Bassline', '#4dffbb', pId);
  updatePlayheadPosition(false);
  updateLoopRegion();
  updateVerticalThumb();
  updateHorizontalThumb();
</script>
</body>
</html>
