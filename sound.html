<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SL Sound Lab ‚Äì JS DAW Engine</title>
  <style>
    :root {
      --sl-bg: #1e1f23;
      --sl-bg-alt: #25262b;
      --sl-panel: #2a2b31;
      --sl-panel-strong: #30323a;
      --sl-accent: #4da3ff;
      --sl-accent-soft: #3b7bd5;
      --sl-text-main: #e0e0e0;
      --sl-text-soft: #b0b0b5;
      --sl-border: #3d3f48;
      --sl-timeline-bg: #202126;
      --sl-grid-line: #333540;
      --sl-clip-border: #101118;
      --sl-danger: #ff4b6a;
      --sl-success: #62d26f;
      --sl-warning: #ffb74d;
    }

    * {
      box-sizing: border-box;
    }

    body {
      background-color: var(--sl-bg);
      color: var(--sl-text-main);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      overflow: hidden;
      user-select: none;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
    }

    /* Toolbar */

    #toolbar {
      height: 40px;
      background-color: var(--sl-panel);
      display: flex;
      align-items: center;
      padding: 0 12px;
      border-bottom: 1px solid var(--sl-border);
      gap: 8px;
    }

    .toolbar-section {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-right: 16px;
    }

    button {
      background-color: #3a3b42;
      color: var(--sl-text-main);
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    button:hover {
      background-color: #4a4b54;
    }

    button.active {
      background-color: var(--sl-accent);
      color: #fff;
    }

    .toolbar-icon-button img {
      width: 16px;
      height: 16px;
      object-fit: contain;
      display: block;
    }

    #titleLabel {
      font-size: 12px;
      font-weight: 600;
      color: var(--sl-text-soft);
      margin-right: 8px;
    }

    /* Add Track Dropdown */

    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      min-width: 200px;
      background-color: var(--sl-panel-strong);
      border-radius: 6px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.65);
      border: 1px solid var(--sl-border);
      padding: 4px 0;
      z-index: 1000;
      display: none;
    }

    .dropdown-menu.open {
      display: block;
    }

    .menu-item {
      padding: 6px 12px;
      font-size: 12px;
      color: var(--sl-text-main);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      white-space: nowrap;
    }

    .menu-item:hover {
      background-color: #3c3e48;
    }

    .menu-item-label {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .menu-item .shortcut {
      font-size: 11px;
      color: var(--sl-text-soft);
    }

    .menu-item.has-submenu {
      position: relative;
    }

    .submenu {
      position: absolute;
      top: 0;
      left: 100%;
      margin-left: 2px;
      min-width: 190px;
      background-color: var(--sl-panel-strong);
      border-radius: 6px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.65);
      border: 1px solid var(--sl-border);
      padding: 4px 0;
      display: none;
    }

    .menu-item.has-submenu:hover .submenu {
      display: block;
    }

    .menu-separator {
      border-top: 1px solid var(--sl-border);
      margin: 4px 0;
    }

    /* Main layout */

    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: var(--sl-bg-alt);
    }

    /* Timeline layout */

    #timelineWrapper {
      flex: 1;
      display: flex;
      background-color: var(--sl-timeline-bg);
    }

    #trackHeaders {
      width: 230px;
      border-right: 1px solid var(--sl-border);
      background-color: var(--sl-panel);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    #trackHeadersTitle {
      padding: 6px 8px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--sl-text-soft);
      border-bottom: 1px solid var(--sl-border);
    }

    #trackHeaderList {
      flex: 1;
      overflow-y: auto;
    }

    .track-header {
      display: flex;
      align-items: center;
      padding: 4px 6px;
      border-bottom: 1px solid #2f3037;
      cursor: pointer;
    }

    .track-header:hover {
      background-color: #343641;
    }

    .track-color-bar {
      width: 4px;
      height: 26px;
      border-radius: 2px;
      margin-right: 6px;
      flex-shrink: 0;
    }

    .track-icon {
      width: 20px;
      text-align: center;
      font-size: 14px;
      margin-right: 4px;
      flex-shrink: 0;
    }

    .track-name {
      flex: 1;
      font-size: 12px;
      color: var(--sl-text-main);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-right: 6px;
    }

    .track-type-badge {
      font-size: 10px;
      padding: 1px 4px;
      border-radius: 10px;
      background-color: #3c3d46;
      color: var(--sl-text-soft);
      margin-right: 6px;
      text-transform: uppercase;
    }

    .track-record-btn {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #4a232b;
      color: var(--sl-danger);
      flex-shrink: 0;
    }

    .track-record-btn.armed {
      background: radial-gradient(circle at 30% 30%, #ffb0c1, #ff3155);
      color: #fff;
      box-shadow: 0 0 6px rgba(255, 80, 120, 0.9);
    }

    #timelineViewport {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #timelineHeader {
      height: 26px;
      border-bottom: 1px solid var(--sl-border);
      background: linear-gradient(to bottom, #2a2c33, #24252b);
      display: flex;
      align-items: center;
      padding: 0 6px;
      font-size: 10px;
      color: var(--sl-text-soft);
    }

    #timelineHeader .marker {
      width: 60px;
      text-align: center;
      border-left: 1px solid #333540;
    }

    #timelineScroll {
      flex: 1;
      overflow: auto;
      position: relative;
    }

    .timeline-row {
      position: relative;
      height: 40px;
      border-bottom: 1px solid #262732;
      background-image: linear-gradient(
        to right,
        rgba(255, 255, 255, 0.02) 1px,
        transparent 1px
      );
      background-size: 60px 100%;
    }

    .timeline-row:nth-child(2n) {
      background-color: #24252e;
    }

    .timeline-row:nth-child(2n + 1) {
      background-color: #22232b;
    }

    .clip {
      position: absolute;
      top: 6px;
      height: 28px;
      border-radius: 4px;
      border: 1px solid var(--sl-clip-border);
      background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.15),
        rgba(0, 0, 0, 0.3)
      );
      padding: 2px 6px;
      font-size: 11px;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .clip-label {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }

    .clip-tag {
      font-size: 9px;
      padding: 0 4px;
      border-radius: 6px;
      background-color: rgba(0, 0, 0, 0.3);
    }

    /* Bottom transport bar */

    #transportBar {
      height: 42px;
      background-color: var(--sl-panel);
      border-top: 1px solid var(--sl-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      font-size: 12px;
    }

    .transport-section {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .transport-time {
      font-family: "Consolas", "Menlo", monospace;
      padding: 3px 8px;
      border-radius: 4px;
      background-color: #2e3038;
    }

    .tiny-label {
      font-size: 10px;
      color: var(--sl-text-soft);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    input[type="range"] {
      accent-color: var(--sl-accent);
    }

    /* Modals */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(0, 0, 0, 0.55), rgba(0, 0, 0, 0.9));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal-backdrop.open {
      display: flex;
    }

    .modal {
      background-color: #252733;
      border-radius: 10px;
      border: 1px solid var(--sl-border);
      padding: 14px 16px 12px;
      min-width: 360px;
      max-width: 620px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.8);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .modal-title {
      font-size: 14px;
      font-weight: 600;
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
    }

    .modal-close {
      cursor: pointer;
      font-size: 16px;
      color: var(--sl-text-soft);
    }

    .modal-close:hover {
      color: #fff;
    }

    .form-row {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .form-row-inline {
      display: flex;
      gap: 8px;
    }

    .form-row label {
      font-size: 11px;
      color: var(--sl-text-soft);
    }

    .form-row input[type="text"],
    .form-row input[type="number"],
    .form-row select,
    .form-row textarea {
      background-color: #2f313c;
      border-radius: 4px;
      border: 1px solid #424455;
      color: var(--sl-text-main);
      font-size: 12px;
      padding: 4px 6px;
      outline: none;
    }

    .form-row textarea {
      resize: vertical;
      min-height: 60px;
      max-height: 180px;
    }

    .form-row input[type="color"] {
      padding: 0;
      border-radius: 4px;
      border: 1px solid #424455;
      width: 36px;
      height: 22px;
      cursor: pointer;
    }

    .form-row small {
      font-size: 10px;
      color: var(--sl-text-soft);
    }

    /* Colorful SL Assistant modal */

    #slAssistantModal .modal {
      background: radial-gradient(circle at top left, #30345b, #1d1e29 55%, #18141f 100%);
      border: 1px solid rgba(119, 187, 255, 0.5);
      box-shadow:
        0 0 25px rgba(77, 163, 255, 0.45),
        0 30px 60px rgba(0, 0, 0, 0.9);
    }

    #slAssistantModal .modal-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #slAssistantModal .badge-pill {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      background-color: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.18);
      color: #d5e7ff;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    #slAssistantModal .gradient-chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 2px;
    }

    #slAssistantModal .gradient-chip {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      background: linear-gradient(135deg, #ff7ae0, #8f6bff);
      color: #fff;
      cursor: pointer;
      opacity: 0.85;
    }

    #slAssistantModal .gradient-chip:nth-child(2) {
      background: linear-gradient(135deg, #7df9ff, #4da3ff);
    }

    #slAssistantModal .gradient-chip:nth-child(3) {
      background: linear-gradient(135deg, #ffc857, #ff7a3c);
    }

    #slAssistantModal .gradient-chip:nth-child(4) {
      background: linear-gradient(135deg, #b0ff92, #45e28b);
    }

    #slAssistantModal .gradient-chip:hover {
      opacity: 1;
    }

    #slAssistantModal .form-row textarea {
      background: rgba(0, 0, 0, 0.35);
      border-color: rgba(159, 206, 255, 0.6);
    }

    #slAssistantModal .form-row select,
    #slAssistantModal .form-row input[type="text"] {
      background: rgba(0, 0, 0, 0.35);
      border-color: rgba(159, 206, 255, 0.6);
    }

    /* Hidden helper */

    .hidden {
      display: none !important;
    }

    /* Simple scrollbars */

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-thumb {
      background-color: #3a3b44;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-track {
      background-color: #22232a;
    }
  </style>
</head>
<body>
<div id="app">
  <!-- Top toolbar -->
  <div id="toolbar">
    <span id="titleLabel">SL Sound Lab</span>

    <div class="toolbar-section">
      <!-- Example real-ish icons ‚Äì replace src with your own PNG/SVG if desired -->
      <button id="timelineBtn" class="toolbar-icon-button active" title="Timeline">
        <img src="icons/timeline.png" alt="Timeline">
        Timeline
      </button>
      <button id="mixerBtn" class="toolbar-icon-button" title="Mixer (overlay)">
        <img src="icons/mixer.png" alt="Mixer">
        Mixer
      </button>
      <button id="patternsBtn" class="toolbar-icon-button" title="Pattern Rack (overlay)">
        <img src="icons/patterns.png" alt="Patterns">
        Patterns
      </button>
    </div>

    <div class="toolbar-section">
      <!-- Add Track dropdown -->
      <div class="dropdown" id="addTrackDropdown">
        <button id="addTrackButton">+ Track ‚ñæ</button>
        <div id="addTrackMenu" class="dropdown-menu">
          <div class="menu-item has-submenu">
            <span class="menu-item-label">
              <span>Instrument</span>
            </span>
            <span class="shortcut">‚ñ∂</span>
            <div class="submenu" id="instrumentSubmenu">
              <div class="menu-item" data-instrument="Aurora Keys" data-color="#4caf50" data-icon="üéπ">
                <span class="menu-item-label"><span>üéπ Aurora Keys</span></span>
                <span class="shortcut">Keys</span>
              </div>
              <div class="menu-item" data-instrument="Nebula Bass" data-color="#ff7043" data-icon="üåÄ">
                <span class="menu-item-label"><span>üåÄ Nebula Bass</span></span>
                <span class="shortcut">Bass</span>
              </div>
              <div class="menu-item" data-instrument="Photon Drums" data-color="#ffca28" data-icon="ü•Å">
                <span class="menu-item-label"><span>ü•Å Photon Drums</span></span>
                <span class="shortcut">Drums</span>
              </div>
              <div class="menu-item" data-instrument="Cosmic Pad" data-color="#7e57c2" data-icon="‚òÅÔ∏è">
                <span class="menu-item-label"><span>‚òÅÔ∏è Cosmic Pad</span></span>
                <span class="shortcut">Pad</span>
              </div>
              <div class="menu-item" data-instrument="Starlite Pluck" data-color="#26c6da" data-icon="‚ú®">
                <span class="menu-item-label"><span>‚ú® Starlite Pluck</span></span>
                <span class="shortcut">Pluck</span>
              </div>
            </div>
          </div>

          <div class="menu-item has-submenu">
            <span class="menu-item-label">
              <span>Vocals</span>
            </span>
            <span class="shortcut">‚ñ∂</span>
            <div class="submenu" id="vocalSubmenu">
              <div class="menu-item" data-vocal="Lead Vocals" data-color="#ec407a" data-icon="üéôÔ∏è">
                <span class="menu-item-label"><span>üéôÔ∏è Lead Vocals</span></span>
                <span class="shortcut">Lead</span>
              </div>
              <div class="menu-item" data-vocal="Backing Vocals" data-color="#ab47bc" data-icon="üé§">
                <span class="menu-item-label"><span>üé§ Backing Vocals</span></span>
                <span class="shortcut">BGV</span>
              </div>
              <div class="menu-item" data-vocal="Choir Stack" data-color="#42a5f5" data-icon="üë•">
                <span class="menu-item-label"><span>üë• Choir Stack</span></span>
                <span class="shortcut">Choir</span>
              </div>
            </div>
          </div>

          <div class="menu-item has-submenu">
            <span class="menu-item-label">
              <span>Import</span>
            </span>
            <span class="shortcut">‚ñ∂</span>
            <div class="submenu" id="importSubmenu">
              <div class="menu-item" data-import="device">
                <span class="menu-item-label"><span>Upload from device‚Ä¶</span></span>
              </div>
              <div class="menu-item" data-import="library">
                <span class="menu-item-label"><span>Import from Audio Library (music.html)‚Ä¶</span></span>
              </div>
            </div>
          </div>

          <div class="menu-separator"></div>

          <div class="menu-item" id="createWithSlAssistantMenuItem">
            <span class="menu-item-label">
              <span>‚ú® Create with SL Assistant‚Ä¶</span>
            </span>
            <span class="shortcut">Ctrl+Shift+A</span>
          </div>
        </div>
      </div>
    </div>

    <div class="toolbar-section" style="margin-left:auto;">
      <span class="tiny-label">Metronome</span>
      <button id="metronomeBtn">‚è±Ô∏è</button>
      <span class="tiny-label">Tempo</span>
      <input id="tempoInput" type="number" value="120" min="40" max="220"
             style="width:60px;background:#2e2f37;border:1px solid #444;border-radius:4px;color:var(--sl-text-main);font-size:11px;padding:2px 4px;">
    </div>
  </div>

  <!-- Main timeline + track area -->
  <div id="main">
    <div id="timelineWrapper">
      <!-- Track headers -->
      <div id="trackHeaders">
        <div id="trackHeadersTitle">Tracks</div>
        <div id="trackHeaderList"></div>
      </div>

      <!-- Timeline grid -->
      <div id="timelineViewport">
        <div id="timelineHeader"></div>
        <div id="timelineScroll"></div>
      </div>
    </div>

    <!-- Transport bar -->
    <div id="transportBar">
      <div class="transport-section">
        <button id="playBtn">‚ñ∂</button>
        <button id="stopBtn">‚ñ†</button>
        <button id="recordGlobalBtn">‚óè</button>
        <span class="transport-time" id="timeDisplay">000:01:01</span>
      </div>

      <div class="transport-section">
        <span class="tiny-label">Volume</span>
        <input id="masterVolume" type="range" min="0" max="100" value="85">
        <span class="tiny-label">Snap</span>
        <select id="snapSelect"
                style="background:#2e2f37;border:1px solid #444;border-radius:4px;color:var(--sl-text-main);font-size:11px;padding:2px 4px;">
          <option>Line</option>
          <option>Beat</option>
          <option>Bar</option>
          <option>None</option>
        </select>
      </div>
    </div>
  </div>
</div>

<!-- Hidden file input for import from device -->
<input type="file" id="audioUploadInput" accept="audio/*" class="hidden">

<!-- Modals -->

<!-- Track Settings Modal -->
<div id="trackSettingsModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Track Settings</div>
      <div class="modal-close" data-close="trackSettingsModal">√ó</div>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <label for="trackSettingsName">Track name</label>
        <input type="text" id="trackSettingsName">
      </div>
      <div class="form-row-inline">
        <div class="form-row" style="flex:1;">
          <label for="trackSettingsIcon">Track icon (emoji or 1‚Äì2 chars)</label>
          <input type="text" id="trackSettingsIcon" maxlength="4">
        </div>
        <div class="form-row" style="width:110px;">
          <label for="trackSettingsColor">Track color</label>
          <input type="color" id="trackSettingsColor">
        </div>
      </div>
      <div class="form-row">
        <label>Info</label>
        <small>Changing the track color will also recolor all clips on this track to keep things visually organized.</small>
      </div>
    </div>
    <div class="modal-footer">
      <button data-close="trackSettingsModal">Cancel</button>
      <button id="trackSettingsSaveBtn">Apply</button>
    </div>
  </div>
</div>

<!-- Record Settings Modal -->
<div id="recordSettingsModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Record Routing ‚Äì <span id="recordSettingsTrackName"></span></div>
      <div class="modal-close" data-close="recordSettingsModal">√ó</div>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <label for="recordPresetSelect">Preset</label>
        <select id="recordPresetSelect">
          <option value="">New route / custom</option>
        </select>
        <small>Select a saved routing preset or configure a new route below.</small>
      </div>

      <div class="form-row-inline">
        <div class="form-row" style="flex:1;">
          <label for="recordInputDevice">Input device (microphone / interface)</label>
          <select id="recordInputDevice"></select>
          <small>We‚Äôll list microphones and audio interfaces that the browser can see.</small>
        </div>
        <div class="form-row" style="flex:1;">
          <label for="recordOutputDevice">Output target</label>
          <select id="recordOutputDevice"></select>
          <small>Default is the main project output. You can route monitoring to an interface or headphones.</small>
        </div>
      </div>

      <div class="form-row-inline">
        <div class="form-row" style="flex:1;">
          <label for="recordPresetName">Save as preset (optional)</label>
          <input type="text" id="recordPresetName" placeholder="My vocal chain A">
        </div>
        <div class="form-row" style="width:150px;">
          <label>
            <input type="checkbox" id="recordPresetDefault" style="margin-right:4px;vertical-align:middle;">
            <span style="font-size:11px;color:var(--sl-text-soft);">Set as default</span>
          </label>
        </div>
      </div>

      <div class="form-row">
        <label>Behavior</label>
        <small>When you arm this track and start global recording, SL Sound Lab will record from the chosen input into this track in real time. You can arm multiple tracks at once for multi-input recording.</small>
      </div>
    </div>
    <div class="modal-footer">
      <button data-close="recordSettingsModal">Cancel</button>
      <button id="recordSettingsApplyBtn">Accept</button>
    </div>
  </div>
</div>

<!-- SL Assistant Modal -->
<div id="slAssistantModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">
        ‚ú® SL Assistant
        <span class="badge-pill">Loop ‚Ä¢ Vocal ‚Ä¢ FX</span>
      </div>
      <div class="modal-close" data-close="slAssistantModal">√ó</div>
    </div>
    <div class="modal-body">
      <div class="gradient-chip-row">
        <div class="gradient-chip" data-chip-prompt="Afrobeat drum loop, bouncy, warm, human feel">Afrobeat Groove</div>
        <div class="gradient-chip" data-chip-prompt="Soulful keys, atmospheric pads, gentle arps">Soul Keys</div>
        <div class="gradient-chip" data-chip-prompt="Punchy 808, trap bounce, modern pop energy">808 Bounce</div>
        <div class="gradient-chip" data-chip-prompt="Choir harmonies, lush reverb, emotional worship">Choir Stack</div>
      </div>

      <div class="form-row-inline">
        <div class="form-row" style="flex:1;">
          <label for="slAssistantTargetTrack">Target track</label>
          <select id="slAssistantTargetTrack">
            <option value="">Create new track automatically</option>
          </select>
        </div>
        <div class="form-row" style="flex:1;">
          <label for="slAssistantContentType">Content type</label>
          <select id="slAssistantContentType">
            <option value="instrument">Instrument Loop</option>
            <option value="drum">Drum Loop</option>
            <option value="vocal-lead">Vocal ‚Äì Lead</option>
            <option value="vocal-choir">Vocal ‚Äì Choir</option>
            <option value="fx">FX / Atmosphere</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <label for="slAssistantPrompt">Style / sound prompt</label>
        <textarea id="slAssistantPrompt" placeholder="Describe the loop, vocal, or FX you want SL Assistant to create‚Ä¶"></textarea>
      </div>

      <div class="form-row hidden" id="slAssistantLyricsRow">
        <label for="slAssistantLyrics">Lyrics (for vocals)</label>
        <textarea id="slAssistantLyrics" placeholder="Paste or type the lyrics here so SL Assistant can phrase the performance to match."></textarea>
      </div>

      <div class="form-row-inline">
        <div class="form-row" style="flex:1;">
          <label for="slAssistantLength">Loop length (bars)</label>
          <input type="number" id="slAssistantLength" value="4" min="1" max="64">
        </div>
        <div class="form-row" style="flex:1;">
          <label for="slAssistantEnergy">Energy</label>
          <select id="slAssistantEnergy">
            <option value="chill">Chill / background</option>
            <option value="medium" selected>Medium groove</option>
            <option value="high">High energy</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <label>Sync</label>
        <small>SL Assistant will lock the new loop to the current project tempo (<span id="slAssistantTempoLabel">120</span> BPM) and start it at the next full bar in the timeline.</small>
      </div>
    </div>
    <div class="modal-footer">
      <button data-close="slAssistantModal">Close</button>
      <button id="slAssistantGenerateBtn">Generate & Drop into Timeline</button>
    </div>
  </div>
</div>

<script>
  // Basic data structures
  const tracks = [];
  let trackIdCounter = 1;

  const recordPresets = []; // { name, inputId, inputLabel, outputId, outputLabel, isDefault }

  // Cached DOM
  const trackHeaderListEl = document.getElementById('trackHeaderList');
  const timelineHeaderEl = document.getElementById('timelineHeader');
  const timelineScrollEl = document.getElementById('timelineScroll');

  const addTrackDropdownEl = document.getElementById('addTrackDropdown');
  const addTrackButtonEl = document.getElementById('addTrackButton');
  const addTrackMenuEl = document.getElementById('addTrackMenu');

  const audioUploadInputEl = document.getElementById('audioUploadInput');

  // Modals
  const trackSettingsModalEl = document.getElementById('trackSettingsModal');
  const recordSettingsModalEl = document.getElementById('recordSettingsModal');
  const slAssistantModalEl = document.getElementById('slAssistantModal');

  // Track settings modal fields
  const trackSettingsNameEl = document.getElementById('trackSettingsName');
  const trackSettingsIconEl = document.getElementById('trackSettingsIcon');
  const trackSettingsColorEl = document.getElementById('trackSettingsColor');
  const trackSettingsSaveBtn = document.getElementById('trackSettingsSaveBtn');
  let trackSettingsEditingId = null;

  // Record settings modal fields
  const recordSettingsTrackNameEl = document.getElementById('recordSettingsTrackName');
  const recordPresetSelectEl = document.getElementById('recordPresetSelect');
  const recordInputDeviceEl = document.getElementById('recordInputDevice');
  const recordOutputDeviceEl = document.getElementById('recordOutputDevice');
  const recordPresetNameEl = document.getElementById('recordPresetName');
  const recordPresetDefaultEl = document.getElementById('recordPresetDefault');
  const recordSettingsApplyBtn = document.getElementById('recordSettingsApplyBtn');
  let recordSettingsTrackId = null;

  // SL Assistant fields
  const slAssistantTargetTrackEl = document.getElementById('slAssistantTargetTrack');
  const slAssistantContentTypeEl = document.getElementById('slAssistantContentType');
  const slAssistantPromptEl = document.getElementById('slAssistantPrompt');
  const slAssistantLyricsEl = document.getElementById('slAssistantLyrics');
  const slAssistantLyricsRowEl = document.getElementById('slAssistantLyricsRow');
  const slAssistantLengthEl = document.getElementById('slAssistantLength');
  const slAssistantEnergyEl = document.getElementById('slAssistantEnergy');
  const slAssistantTempoLabelEl = document.getElementById('slAssistantTempoLabel');
  const tempoInputEl = document.getElementById('tempoInput');
  const slAssistantGenerateBtn = document.getElementById('slAssistantGenerateBtn');

  const timeDisplayEl = document.getElementById('timeDisplay');

  /* Utility: modal handling */

  function openModal(modalEl) {
    modalEl.classList.add('open');
  }

  function closeModal(modalEl) {
    modalEl.classList.remove('open');
  }

  document.querySelectorAll('.modal-close').forEach(el => {
    el.addEventListener('click', () => {
      const id = el.getAttribute('data-close');
      if (id) {
        const modal = document.getElementById(id);
        if (modal) closeModal(modal);
      }
    });
  });

  document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
    backdrop.addEventListener('click', e => {
      if (e.target === backdrop) {
        backdrop.classList.remove('open');
      }
    });
  });

  document.querySelectorAll('[data-close]').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-close');
      const modal = document.getElementById(id);
      if (modal) closeModal(modal);
    });
  });

  /* Timeline header (beats / bars grid) */

  function renderTimelineHeader() {
    timelineHeaderEl.innerHTML = '';
    const totalMarkers = 32; // simple static
    for (let i = 0; i < totalMarkers; i++) {
      const marker = document.createElement('div');
      marker.className = 'marker';
      marker.textContent = i % 4 === 0 ? `Bar ${Math.floor(i / 4) + 1}` : '';
      timelineHeaderEl.appendChild(marker);
    }
  }

  /* Track + timeline rendering */

  function renderTracks() {
    // Render track headers
    trackHeaderListEl.innerHTML = '';
    tracks.forEach(track => {
      const header = document.createElement('div');
      header.className = 'track-header';
      header.dataset.trackId = track.id;

      const colorBar = document.createElement('div');
      colorBar.className = 'track-color-bar';
      colorBar.style.backgroundColor = track.color;
      header.appendChild(colorBar);

      const icon = document.createElement('div');
      icon.className = 'track-icon';
      icon.textContent = track.icon || 'üéõÔ∏è';
      header.appendChild(icon);

      const nameSpan = document.createElement('div');
      nameSpan.className = 'track-name';
      nameSpan.textContent = track.name;
      header.appendChild(nameSpan);

      const typeBadge = document.createElement('div');
      typeBadge.className = 'track-type-badge';
      typeBadge.textContent = track.type.toUpperCase();
      header.appendChild(typeBadge);

      const recBtn = document.createElement('button');
      recBtn.className = 'track-record-btn';
      if (track.armed) recBtn.classList.add('armed');
      recBtn.textContent = '‚óè';
      recBtn.title = 'Arm for recording';
      recBtn.addEventListener('click', e => {
        e.stopPropagation();
        toggleTrackRecordArm(track.id);
      });
      header.appendChild(recBtn);

      // Double-click for track settings
      header.addEventListener('dblclick', () => {
        openTrackSettings(track.id);
      });

      trackHeaderListEl.appendChild(header);
    });

    // Render timeline rows
    timelineScrollEl.innerHTML = '';
    tracks.forEach(track => {
      const row = document.createElement('div');
      row.className = 'timeline-row';
      row.dataset.trackId = track.id;

      // Render existing clips on this track
      (track.clips || []).forEach(clip => {
        const clipEl = document.createElement('div');
        clipEl.className = 'clip';
        clipEl.style.left = clip.left + 'px';
        clipEl.style.width = clip.width + 'px';
        clipEl.style.backgroundColor = track.color;
        clipEl.style.borderColor = 'rgba(0,0,0,0.6)';

        const labelEl = document.createElement('span');
        labelEl.className = 'clip-label';
        labelEl.textContent = clip.label || 'Clip';
        clipEl.appendChild(labelEl);

        const tagEl = document.createElement('span');
        tagEl.className = 'clip-tag';
        tagEl.textContent = clip.tag || track.type;
        clipEl.appendChild(tagEl);

        row.appendChild(clipEl);
      });

      timelineScrollEl.appendChild(row);
    });

    // Update SL Assistant track list
    refreshSlAssistantTrackList();
  }

  function createTrack({ name, type, color, icon }) {
    const track = {
      id: 'track-' + (trackIdCounter++),
      name: name || 'Track ' + trackIdCounter,
      type: type || 'generic',
      color: color || '#4da3ff',
      icon: icon || 'üéõÔ∏è',
      clips: [],
      armed: false,
      recordingRoute: null
    };
    tracks.push(track);
    renderTracks();
    return track;
  }

  function getTrackById(trackId) {
    return tracks.find(t => t.id === trackId) || null;
  }

  function recolorTrack(trackId, newColor) {
    const track = getTrackById(trackId);
    if (!track) return;
    track.color = newColor;
    // Re-apply color to all clips
    (track.clips || []).forEach(clip => {
      clip.color = newColor;
    });
    renderTracks();
  }

  // Adding some initial tracks so the timeline isn't empty
  function createDefaultTracksIfEmpty() {
    if (tracks.length > 0) return;
    createTrack({ name: 'Aurora Keys', type: 'instrument', color: '#4caf50', icon: 'üéπ' });
    createTrack({ name: 'Nebula Bass', type: 'instrument', color: '#ff7043', icon: 'üåÄ' });
    createTrack({ name: 'Lead Vocals', type: 'vocal', color: '#ec407a', icon: 'üéôÔ∏è' });
  }

  /* Track Settings */

  function openTrackSettings(trackId) {
    const track = getTrackById(trackId);
    if (!track) return;
    trackSettingsEditingId = trackId;
    trackSettingsNameEl.value = track.name;
    trackSettingsIconEl.value = track.icon || '';
    trackSettingsColorEl.value = track.color || '#4da3ff';
    openModal(trackSettingsModalEl);
  }

  trackSettingsSaveBtn.addEventListener('click', () => {
    if (!trackSettingsEditingId) return;
    const track = getTrackById(trackSettingsEditingId);
    if (!track) return;
    const newName = trackSettingsNameEl.value.trim();
    const newIcon = trackSettingsIconEl.value.trim();
    const newColor = trackSettingsColorEl.value || track.color;

    if (newName) track.name = newName;
    if (newIcon) track.icon = newIcon;
    track.color = newColor;

    // Recolor clips
    (track.clips || []).forEach(clip => {
      clip.color = newColor;
    });

    renderTracks();
    closeModal(trackSettingsModalEl);
  });

  /* Add Track dropdown events */

  addTrackButtonEl.addEventListener('click', () => {
    const isOpen = addTrackMenuEl.classList.contains('open');
    document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('open'));
    if (!isOpen) addTrackMenuEl.classList.add('open');
  });

  document.addEventListener('click', e => {
    if (!addTrackDropdownEl.contains(e.target)) {
      addTrackMenuEl.classList.remove('open');
    }
  });

  // Instrument submenu
  document.getElementById('instrumentSubmenu').addEventListener('click', e => {
    const item = e.target.closest('.menu-item[data-instrument]');
    if (!item) return;
    const instName = item.getAttribute('data-instrument');
    const color = item.getAttribute('data-color');
    const icon = item.getAttribute('data-icon');
    createTrack({
      name: instName,
      type: 'instrument',
      color,
      icon
    });
    addTrackMenuEl.classList.remove('open');
  });

  // Vocal submenu
  document.getElementById('vocalSubmenu').addEventListener('click', e => {
    const item = e.target.closest('.menu-item[data-vocal]');
    if (!item) return;
    const vocalName = item.getAttribute('data-vocal');
    const color = item.getAttribute('data-color');
    const icon = item.getAttribute('data-icon');
    createTrack({
      name: vocalName,
      type: 'vocal',
      color,
      icon
    });
    addTrackMenuEl.classList.remove('open');
  });

  // Import submenu
  document.getElementById('importSubmenu').addEventListener('click', e => {
    const item = e.target.closest('.menu-item[data-import]');
    if (!item) return;
    const mode = item.getAttribute('data-import');
    if (mode === 'device') {
      // open file input
      audioUploadInputEl.click();
    } else if (mode === 'library') {
      alert('Import from Audio Library: link this to your creations in music.html (placeholder hook).');
    }
    addTrackMenuEl.classList.remove('open');
  });

  audioUploadInputEl.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    // Placeholder: create a new "Audio Import" track and drop a clip
    const importTrack = createTrack({
      name: 'Audio Import ‚Äì ' + (file.name || 'File'),
      type: 'audio',
      color: '#26c6da',
      icon: 'üìÇ'
    });
    addClipToTrack(importTrack.id, {
      label: file.name || 'Imported Audio',
      tag: 'Audio',
      bars: 4
    });
  });

  // Create with SL Assistant
  document.getElementById('createWithSlAssistantMenuItem').addEventListener('click', () => {
    openSlAssistantModal();
    addTrackMenuEl.classList.remove('open');
  });

  /* Clips */

  function addClipToTrack(trackId, { label, tag, bars }) {
    const track = getTrackById(trackId);
    if (!track) return;
    const pxPerBar = 60; // matches background size
    const clipWidth = (bars || 4) * pxPerBar;

    // Position at first free spot: simple layout left to right
    let left = 10;
    const used = (track.clips || []).map(c => ({ left: c.left, right: c.left + c.width }));
    used.sort((a, b) => a.left - b.left);
    for (const seg of used) {
      if (left + clipWidth <= seg.left - 8) break;
      left = seg.right + 10;
    }

    const clip = {
      id: 'clip-' + Date.now() + '-' + Math.floor(Math.random() * 9999),
      label: label || 'Clip',
      tag: tag || track.type,
      left,
      width: clipWidth,
      color: track.color
    };
    track.clips.push(clip);
    renderTracks();
  }

  /* Record routing + arming */

  async function populateAudioDeviceDropdowns() {
    recordInputDeviceEl.innerHTML = '';
    recordOutputDeviceEl.innerHTML = '';

    let inputs = [];
    let outputs = [];

    try {
      if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
        const devices = await navigator.mediaDevices.enumerateDevices();
        inputs = devices.filter(d => d.kind === 'audioinput');
        outputs = devices.filter(d => d.kind === 'audiooutput');
      }
    } catch (err) {
      console.warn('Could not enumerate audio devices, using fallback list.', err);
    }

    if (inputs.length === 0) {
      inputs = [
        { deviceId: 'builtin-mic', label: 'Built-in Microphone' },
        { deviceId: 'usb-interface-1', label: 'USB Interface In 1‚Äì2' },
        { deviceId: 'stream-mic', label: 'Streaming Mic' }
      ];
    } else {
      inputs = inputs.map(d => ({ deviceId: d.deviceId, label: d.label || 'Mic ' + d.deviceId.slice(0, 6) }));
    }

    if (outputs.length === 0) {
      outputs = [
        { deviceId: 'project-out', label: 'Project Output (Default)' },
        { deviceId: 'headphones', label: 'Headphones / Monitor Out' },
        { deviceId: 'usb-out-1', label: 'USB Interface Out 1‚Äì2' }
      ];
    } else {
      outputs = outputs.map(d => ({ deviceId: d.deviceId, label: d.label || 'Out ' + d.deviceId.slice(0, 6) }));
    }

    inputs.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.deviceId;
      opt.textContent = d.label;
      recordInputDeviceEl.appendChild(opt);
    });

    outputs.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.deviceId;
      opt.textContent = d.label;
      recordOutputDeviceEl.appendChild(opt);
    });

    // Default selections
    recordInputDeviceEl.selectedIndex = 0;
    const projectOutOpt = Array.from(recordOutputDeviceEl.options).find(o => o.value === 'project-out') || recordOutputDeviceEl.options[0];
    if (projectOutOpt) projectOutOpt.selected = true;
  }

  function refreshRecordPresetSelect() {
    recordPresetSelectEl.innerHTML = '';
    const baseOpt = document.createElement('option');
    baseOpt.value = '';
    baseOpt.textContent = 'New route / custom';
    recordPresetSelectEl.appendChild(baseOpt);

    recordPresets.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.name;
      opt.textContent = p.name + (p.isDefault ? ' (default)' : '');
      recordPresetSelectEl.appendChild(opt);
    });
  }

  function applyPresetToUi(presetName) {
    const preset = recordPresets.find(p => p.name === presetName);
    if (!preset) return;
    setSelectValue(recordInputDeviceEl, preset.inputId);
    setSelectValue(recordOutputDeviceEl, preset.outputId);
  }

  function setSelectValue(selectEl, value) {
    const opt = Array.from(selectEl.options).find(o => o.value === value);
    if (opt) {
      selectEl.value = value;
    }
  }

  function openRecordSettings(trackId) {
    const track = getTrackById(trackId);
    if (!track) return;
    recordSettingsTrackId = trackId;
    recordSettingsTrackNameEl.textContent = track.name;
    recordPresetNameEl.value = '';
    recordPresetDefaultEl.checked = false;

    populateAudioDeviceDropdowns().then(() => {
      refreshRecordPresetSelect();

      // If track already has route, set UI to it
      if (track.recordingRoute) {
        const r = track.recordingRoute;
        if (r.presetName && recordPresets.some(p => p.name === r.presetName)) {
          recordPresetSelectEl.value = r.presetName;
          applyPresetToUi(r.presetName);
        } else {
          setSelectValue(recordInputDeviceEl, r.inputId);
          setSelectValue(recordOutputDeviceEl, r.outputId);
        }
      } else {
        // if a default preset exists, apply it
        const defaultPreset = recordPresets.find(p => p.isDefault);
        if (defaultPreset) {
          recordPresetSelectEl.value = defaultPreset.name;
          applyPresetToUi(defaultPreset.name);
        }
      }

      openModal(recordSettingsModalEl);
    });
  }

  recordPresetSelectEl.addEventListener('change', () => {
    const presetName = recordPresetSelectEl.value;
    if (!presetName) return;
    applyPresetToUi(presetName);
  });

  recordSettingsApplyBtn.addEventListener('click', () => {
    if (!recordSettingsTrackId) return;
    const track = getTrackById(recordSettingsTrackId);
    if (!track) return;

    const inputId = recordInputDeviceEl.value;
    const inputLabel = recordInputDeviceEl.selectedOptions[0]?.textContent || '';
    const outputId = recordOutputDeviceEl.value;
    const outputLabel = recordOutputDeviceEl.selectedOptions[0]?.textContent || 'Project Output';

    let presetName = recordPresetSelectEl.value;
    const customPresetName = recordPresetNameEl.value.trim();
    const markDefault = recordPresetDefaultEl.checked;

    // If user typed a new preset name, store it
    if (customPresetName) {
      presetName = customPresetName;
      // Remove old preset with same name
      const index = recordPresets.findIndex(p => p.name === presetName);
      if (index !== -1) recordPresets.splice(index, 1);
      recordPresets.push({
        name: presetName,
        inputId,
        inputLabel,
        outputId,
        outputLabel,
        isDefault: markDefault
      });
      if (markDefault) {
        recordPresets.forEach(p => {
          if (p.name !== presetName) p.isDefault = false;
        });
      }
    } else if (presetName && markDefault) {
      // Mark existing preset default
      recordPresets.forEach(p => {
        p.isDefault = (p.name === presetName);
      });
    }

    track.recordingRoute = {
      presetName: presetName || null,
      inputId,
      inputLabel,
      outputId,
      outputLabel
    };
    track.armed = true;

    renderTracks();
    closeModal(recordSettingsModalEl);
  });

  function toggleTrackRecordArm(trackId) {
    const track = getTrackById(trackId);
    if (!track) return;
    if (!track.armed) {
      // First time arm -> open routing
      openRecordSettings(trackId);
    } else {
      // Simple toggle off
      track.armed = false;
      renderTracks();
    }
  }

  /* SL Assistant */

  function refreshSlAssistantTrackList() {
    slAssistantTargetTrackEl.innerHTML = '';
    const noneOpt = document.createElement('option');
    noneOpt.value = '';
    noneOpt.textContent = 'Create new track automatically';
    slAssistantTargetTrackEl.appendChild(noneOpt);

    tracks.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = t.name;
      slAssistantTargetTrackEl.appendChild(opt);
    });
  }

  function openSlAssistantModal() {
    slAssistantTempoLabelEl.textContent = tempoInputEl.value || '120';
    slAssistantPromptEl.value = '';
    slAssistantLyricsEl.value = '';
    slAssistantLengthEl.value = 4;
    slAssistantEnergyEl.value = 'medium';
    refreshSlAssistantTrackList();
    updateSlAssistantLyricsVisibility();
    openModal(slAssistantModalEl);
  }

  slAssistantContentTypeEl.addEventListener('change', updateSlAssistantLyricsVisibility);

  function updateSlAssistantLyricsVisibility() {
    const val = slAssistantContentTypeEl.value;
    if (val.startsWith('vocal')) {
      slAssistantLyricsRowEl.classList.remove('hidden');
    } else {
      slAssistantLyricsRowEl.classList.add('hidden');
    }
  }

  // Quick chips
  document.querySelectorAll('#slAssistantModal .gradient-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      const prompt = chip.getAttribute('data-chip-prompt');
      if (prompt) {
        slAssistantPromptEl.value = prompt;
      }
    });
  });

  slAssistantGenerateBtn.addEventListener('click', () => {
    const targetTrackId = slAssistantTargetTrackEl.value;
    const contentType = slAssistantContentTypeEl.value;
    const prompt = slAssistantPromptEl.value.trim();
    const lyrics = slAssistantLyricsEl.value.trim(); // available for future engine
    const bars = Math.max(1, parseInt(slAssistantLengthEl.value || '4', 10));

    let track = null;
    if (targetTrackId) {
      track = getTrackById(targetTrackId);
    }

    if (!track) {
      // create automatically, based on type
      if (contentType === 'vocal-lead' || contentType === 'vocal-choir') {
        track = createTrack({
          name: contentType === 'vocal-lead' ? 'Lead Vocal (SL Assistant)' : 'Choir (SL Assistant)',
          type: 'vocal',
          color: contentType === 'vocal-lead' ? '#ec407a' : '#42a5f5',
          icon: contentType === 'vocal-lead' ? 'üéôÔ∏è' : 'üë•'
        });
      } else if (contentType === 'drum') {
        track = createTrack({
          name: 'Drums ‚Äì SL Assistant',
          type: 'instrument',
          color: '#ffca28',
          icon: 'ü•Å'
        });
      } else if (contentType === 'fx') {
        track = createTrack({
          name: 'FX ‚Äì SL Assistant',
          type: 'fx',
          color: '#7e57c2',
          icon: 'üåå'
        });
      } else {
        track = createTrack({
          name: 'Instrument ‚Äì SL Assistant',
          type: 'instrument',
          color: '#4caf50',
          icon: 'üéπ'
        });
      }
    }

    let label = 'SL Assistant Loop';
    let tag = 'Loop';

    if (contentType === 'vocal-lead') {
      label = 'SL Lead Vocal';
      tag = 'Vocal';
    } else if (contentType === 'vocal-choir') {
      label = 'SL Choir';
      tag = 'Vocal';
    } else if (contentType === 'drum') {
      label = 'SL Drum Loop';
      tag = 'Drum';
    } else if (contentType === 'fx') {
      label = 'SL FX';
      tag = 'FX';
    } else if (contentType === 'instrument') {
      label = 'SL Instrument Loop';
      tag = 'Instrument';
    }

    if (prompt) {
      label += ' ‚Äì ' + prompt.slice(0, 22);
    }

    addClipToTrack(track.id, { label, tag, bars });

    // For now we just visually add ‚Äì audio generation / engine hooks go here.
    closeModal(slAssistantModalEl);
  });

  /* Tempo label sync */

  tempoInputEl.addEventListener('input', () => {
    slAssistantTempoLabelEl.textContent = tempoInputEl.value || '120';
  });

  /* Very simple transport time mocked */

  let fakeTime = 0;
  let fakeTimer = null;

  function startFakePlay() {
    if (fakeTimer) return;
    fakeTimer = setInterval(() => {
      fakeTime += 0.05; // seconds
      const totalBeats = fakeTime * (parseInt(tempoInputEl.value || '120', 10) / 60);
      const bar = Math.floor(totalBeats / 4) + 1;
      const beat = Math.floor(totalBeats % 4) + 1;
      const step = Math.floor((totalBeats * 4) % 4) + 1;
      timeDisplayEl.textContent = String(bar).padStart(3, '0') + ':' +
        String(beat).padStart(2, '0') + ':' +
        String(step).padStart(2, '0');
    }, 50);
  }

  function stopFakePlay() {
    if (fakeTimer) {
      clearInterval(fakeTimer);
      fakeTimer = null;
    }
  }

  document.getElementById('playBtn').addEventListener('click', () => {
    startFakePlay();
  });

  document.getElementById('stopBtn').addEventListener('click', () => {
    stopFakePlay();
  });

  document.getElementById('recordGlobalBtn').addEventListener('click', () => {
    // Placeholder: here you would start recording engine and capture armed tracks.
    const armedTracks = tracks.filter(t => t.armed);
    if (armedTracks.length === 0) {
      alert('No tracks are armed for recording. Click the red circle on a track to configure and arm it.');
      return;
    }
    alert('Global record triggered.\n(Engine hook placeholder ‚Äì record from each armed track‚Äôs input.)');
  });

  /* Keyboard shortcut for SL Assistant */

  document.addEventListener('keydown', e => {
    if (e.ctrlKey && e.shiftKey && (e.key === 'A' || e.key === 'a')) {
      openSlAssistantModal();
      e.preventDefault();
    }
  });

  /* Init */

  function init() {
    renderTimelineHeader();
    createDefaultTracksIfEmpty();
    renderTracks();
  }

  init();
</script>
</body>
</html>
