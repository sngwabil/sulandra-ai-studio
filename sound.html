<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sulandra AI Studio ‚Äì Sound DAW</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050709;
      --bg-deep: #020305;
      --panel: #101820;
      --panel-dark: #0a1219;
      --panel-soft: #141e28;
      --accent: #70ff63;
      --accent-soft: rgba(112,255,99,0.2);
      --accent-strong: #9aff8f;
      --text-main: #f2f9ff;
      --text-muted: #9eaab6;
      --border-soft: rgba(255,255,255,0.06);
      --border-strong: rgba(112,255,99,0.7);
      --radius-sm: 6px;
      --shadow-soft: 0 0 32px rgba(0,0,0,0.85);
      --grid-line: rgba(255,255,255,0.06);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Inter",sans-serif;
      background: radial-gradient(circle at top left,#1b2635 0,#020305 55%,#000 100%);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
    }

    a { color: inherit; text-decoration: none; }

    header {
      background: linear-gradient(to bottom,#141f2c,#0c141d);
      border-bottom: 1px solid var(--border-soft);
      box-shadow: 0 0 14px rgba(0,0,0,0.9);
      z-index: 20;
    }
    .app-header-inner {
      max-width: 1400px;
      margin: 0 auto;
      padding: 4px 14px 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .brand-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .brand-icon {
      width: 26px;
      height: 26px;
      border-radius: 7px;
      background: radial-gradient(circle at 20% 0%,#7dff64,#28b88e);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #02110b;
      font-weight: 900;
      font-size: 15px;
      box-shadow: 0 0 15px rgba(112,255,99,0.8);
    }
    .brand-title-main {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .12em;
    }
    .brand-title-sub {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .18em;
    }

    .top-nav-links {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 11px;
      flex-wrap: wrap;
    }
    .top-nav-links a {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid transparent;
      color: var(--text-muted);
    }
    .top-nav-links a:hover {
      border-color: var(--border-soft);
      background: rgba(255,255,255,0.04);
      color: var(--text-main);
    }
    .top-nav-links a.active {
      border-color: var(--border-strong);
      color: #02110b;
      background: linear-gradient(120deg,#70ff63,#2fdcaa);
      box-shadow: 0 0 14px rgba(112,255,99,0.8);
      font-weight: 600;
    }

    .profile-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(2,5,8,0.9);
    }
    .profile-pill span { color: var(--text-muted); }
    .profile-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 8px rgba(112,255,99,0.8);
    }

    main {
      flex: 1;
      max-width: 1400px;
      margin: 6px auto 10px;
      padding: 0 10px 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    /* MENU / TRANSPORT */
    .menu-transport {
      background: #141f2c;
      border-radius: 7px;
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }
    .menu-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 4px 8px;
      font-size: 11px;
      border-bottom: 1px solid rgba(0,0,0,0.4);
      background: linear-gradient(to bottom,#1a2836,#121d27);
    }
    .menu-item {
      padding: 2px 6px;
      border-radius: 3px;
      cursor: default;
      color: var(--text-muted);
    }
    .menu-item:hover {
      background: rgba(255,255,255,0.06);
      color: var(--text-main);
    }

    .transport-row {
      display: grid;
      grid-template-columns: minmax(0,1.6fr) minmax(0,2.2fr) minmax(0,1.4fr);
      gap: 4px;
      padding: 4px 8px 6px;
      background: linear-gradient(to bottom,#111a23,#060b10);
      font-size: 11px;
      color: var(--text-muted);
    }
    @media (max-width: 900px) {
      .transport-row { grid-template-columns: minmax(0,1fr); }
    }
    .transport-left,
    .transport-center,
    .transport-right {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .btn-transport {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 1px solid var(--border-soft);
      background: #071016;
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.7);
      font-size: 11px;
    }
    .btn-transport.green {
      background: radial-gradient(circle at 20% 0%,#70ff63,#27b87e);
      color: #02110b;
      border-color: var(--border-strong);
      box-shadow: 0 0 12px rgba(112,255,99,0.9);
    }
    .btn-transport.record {
      background: radial-gradient(circle at 20% 0%,#ff5757,#b02020);
      border-color: rgba(255,110,110,0.9);
      color: #000;
      box-shadow: 0 0 12px rgba(255,120,120,0.9);
    }
    .btn-transport.active-outline {
      box-shadow: 0 0 10px rgba(112,255,99,0.9);
    }

    .tempo-block,
    .snap-block {
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid rgba(0,0,0,0.65);
      background: #050b0f;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--accent-strong);
      box-shadow: inset 0 0 6px rgba(0,0,0,0.9);
    }
    .tempo-value { font-weight: 600; }
    .tempo-btn {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      border: 1px solid rgba(0,0,0,0.8);
      background: #071016;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      cursor: pointer;
    }
    .display-field {
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid rgba(0,0,0,0.7);
      background: #040a10;
      min-width: 90px;
      text-align: center;
      color: #9ff792;
      box-shadow: inset 0 0 6px rgba(0,0,0,0.9);
    }

    /* DAW SHELL */
    .daw-shell {
      margin-top: 4px;
      background: #020609;
      border-radius: 9px;
      border: 1px solid rgba(0,0,0,0.9);
      display: grid;
      grid-template-columns: 280px minmax(0,1fr);
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      min-height: 520px;
    }
    @media (max-width: 900px) {
      .daw-shell { grid-template-columns: minmax(0,1fr); }
    }

    /* BROWSER LEFT */
    .browser {
      background: radial-gradient(circle at top,#18242f 0,#04070c 60%);
      border-right: 1px solid #000;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .browser-header {
      padding: 5px 7px;
      display: flex;
      align-items: center;
      gap: 6px;
      border-bottom: 1px solid rgba(0,0,0,0.9);
      background: linear-gradient(to bottom,#1a2836,#091017);
      font-size: 11px;
    }
    .browser-title {
      font-weight: 600;
      color: var(--accent-strong);
      text-transform: uppercase;
      letter-spacing: .12em;
    }
    .browser-search {
      margin-left: auto;
      flex: 1;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .browser-search input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.8);
      background: #050c12;
      color: var(--text-main);
      font-size: 10px;
      padding: 3px 7px;
    }
    .browser-search input::placeholder {
      color: rgba(158,170,182,0.6);
    }

    .browser-tabs {
      display: flex;
      gap: 2px;
      padding: 4px 4px 3px;
      border-bottom: 1px solid rgba(0,0,0,0.9);
      background: #091019;
      font-size: 10px;
    }
    .browser-tab {
      padding: 3px 6px;
      border-radius: 4px 4px 0 0;
      cursor: pointer;
      color: var(--text-muted);
    }
    .browser-tab.active {
      background: #151f2b;
      color: var(--accent-strong);
    }

    .browser-body {
      flex: 1;
      min-height: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .browser-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 4px 6px 8px;
      font-size: 11px;
      scrollbar-width: thin;
    }
    .browser-section { margin-bottom: 6px; }
    .browser-section-title {
      text-transform: uppercase;
      letter-spacing: .12em;
      font-size: 9px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    .browser-item {
      padding: 3px 4px;
      border-radius: 3px;
      cursor: pointer;
      color: #c9d3dd;
    }
    .browser-item:hover {
      background: rgba(255,255,255,0.05);
    }

    .browser-tree {
      margin-left: 6px;
      border-left: 1px solid rgba(255,255,255,0.05);
      padding-left: 4px;
      margin-top: 2px;
    }
    .tree-group { margin-bottom: 4px; }
    .tree-title {
      color: var(--accent-strong);
      cursor: pointer;
      padding: 2px 2px;
      border-radius: 3px;
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }
    .tree-title::before {
      content: "‚ñæ";
      font-size: 8px;
    }
    .tree-title.collapsed::before { content: "‚ñ∏"; }
    .tree-content {
      margin-top: 3px;
      padding-left: 8px;
      border-left: 1px dashed rgba(255,255,255,0.08);
    }
    .tree-content.collapsed { display: none; }
    .tree-content ul { margin: 0; padding: 0; list-style: none; }
    .tree-content li { padding: 2px 0; color: #cbd6e3; }

    /* PLAYLIST SIDE */
    .playlist-wrap {
      background: radial-gradient(circle at top,#1c2734 0,#05070b 55%,#000 100%);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .playlist-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 8px;
      border-bottom: 1px solid rgba(0,0,0,0.9);
      background: linear-gradient(to bottom,#182533,#0a1017);
      font-size: 11px;
      color: var(--text-muted);
    }
    .playlist-title {
      color: var(--accent-strong);
      font-weight: 600;
    }
    .playlist-toolbar {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
    }
    .small-pill {
      padding: 2px 5px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.7);
      background: #071015;
      color: var(--text-muted);
      cursor: default;
    }
    .small-pill.active {
      border-color: var(--border-strong);
      color: var(--accent-strong);
    }

    .playlist-main {
      flex: 1;
      display: grid;
      grid-template-columns: 170px minmax(0,1fr);
      min-height: 0;
    }

    /* TRACK HEADERS */
    .track-names {
      background: #04080d;
      border-right: 1px solid #000;
      font-size: 11px;
      color: var(--text-muted);
      position: relative;
      overflow-y: auto;
    }
    .track-row { position: relative; }
    .track-name-row {
      display: flex;
      align-items: center;
      padding: 2px 6px;
      border-bottom: 1px solid rgba(255,255,255,0.03);
      background: linear-gradient(to bottom,rgba(9,16,23,0.9),rgba(4,7,11,0.9));
      height: 32px;
      gap: 4px;
    }
    .track-name-row:nth-child(odd) {
      background: linear-gradient(to bottom,rgba(11,19,27,0.9),rgba(5,9,13,0.9));
    }
    .track-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--accent-soft);
      box-shadow: 0 0 7px rgba(112,255,99,0.7);
    }
    .track-label-text {
      color: #d3dfe7;
      flex: 1;
      padding: 1px 3px;
      border-radius: 3px;
    }
    .track-label-text[contenteditable="true"] {
      outline: 1px solid var(--accent-soft);
      background: #050b10;
    }

    .track-controls {
      display: flex;
      align-items: center;
      gap: 3px;
      font-size: 9px;
    }
    .track-btn {
      width: 18px;
      height: 18px;
      border-radius: 3px;
      border: 1px solid rgba(0,0,0,0.8);
      background: #070d12;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .track-btn.active {
      background: var(--accent);
      color: #02110b;
      border-color: var(--border-strong);
      box-shadow: 0 0 8px rgba(112,255,99,0.9);
    }
    .track-volume {
      width: 60px;
    }

    .track-menu-wrap { position: relative; }
    .track-menu {
      position: absolute;
      top: 22px;
      right: 0;
      min-width: 130px;
      border-radius: 6px;
      border: 1px solid rgba(0,0,0,0.8);
      background: #0c151e;
      box-shadow: 0 10px 20px rgba(0,0,0,0.9);
      font-size: 10px;
      padding: 4px 0;
      display: none;
      z-index: 20;
    }
    .track-menu.open { display: block; }
    .track-menu-item {
      padding: 4px 8px;
      cursor: pointer;
      color: var(--text-main);
    }
    .track-menu-item:hover {
      background: rgba(255,255,255,0.07);
    }

    .track-resize-handle {
      height: 4px;
      cursor: row-resize;
      background: linear-gradient(to right,transparent,var(--grid-line),transparent);
    }

    /* GRID */
    .playlist-grid {
      position: relative;
      background: #0d1823;
      overflow: auto;
    }
    .timeline-ruler {
      position: sticky;
      top: 0;
      left: 0;
      right: 0;
      height: 22px;
      display: flex;
      align-items: flex-end;
      font-size: 9px;
      background: #071019;
      border-bottom: 1px solid rgba(0,0,0,0.9);
      box-shadow: 0 4px 6px rgba(0,0,0,0.8);
      z-index: 2;
    }
    .timeline-ruler-inner {
      display: flex;
      gap: 48px;
      padding: 3px 6px;
      white-space: nowrap;
      color: var(--text-muted);
    }

    .grid-inner {
      position: relative;
      min-width: 1300px;
      padding: 0 6px 6px;
      background-image:
        linear-gradient(to right,var(--grid-line) 1px,transparent 1px),
        linear-gradient(to bottom,var(--grid-line) 1px,transparent 1px);
      background-size: 48px 1px, 1px 32px;
    }

    .grid-track-row {
      height: 32px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      position: relative;
    }

    .pattern-block {
      position: absolute;
      top: 4px;
      height: 24px;
      border-radius: 4px;
      background: linear-gradient(120deg,rgba(112,255,99,0.7),rgba(39,181,130,0.8));
      box-shadow: 0 0 12px rgba(112,255,99,0.9);
      color: #02110b;
      font-size: 10px;
      display: flex;
      align-items: center;
      padding: 0 6px;
      cursor: pointer;
      white-space: nowrap;
    }
    .pattern-block.selected {
      box-shadow: 0 0 16px rgba(255,255,255,0.9);
      border: 1px solid #fff;
    }

    .playhead {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--accent);
      box-shadow: 0 0 8px rgba(112,255,99,0.9);
      left: 80px;
      pointer-events: none;
    }

    .hint-bar {
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid rgba(0,0,0,0.85);
      background: linear-gradient(to right,#121a22,#06090d);
      font-size: 10px;
      padding: 3px 6px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 4px;
    }

    /* STEP SEQUENCER & CHANNEL RACK LAYOUT */
    .bottom-grid {
      margin-top: 6px;
      display: grid;
      grid-template-columns: minmax(0,1.3fr) minmax(0,1fr);
      gap: 6px;
    }
    @media (max-width: 900px) {
      .bottom-grid {
        grid-template-columns: minmax(0,1fr);
      }
    }

    .step-sequencer,
    .channel-rack {
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.9);
      background: linear-gradient(to bottom,#101821,#05070b);
      box-shadow: var(--shadow-soft);
      padding: 6px 8px 8px;
      font-size: 11px;
    }

    .step-header,
    .rack-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .step-header-left,
    .rack-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .step-title,
    .rack-title {
      text-transform: uppercase;
      letter-spacing: .12em;
      color: var(--accent-strong);
      font-size: 10px;
    }
    .step-current-pattern {
      font-size: 10px;
      color: var(--text-main);
    }
    .step-hint,
    .rack-hint {
      color: var(--text-muted);
      font-size: 10px;
    }
    .pattern-select {
      padding: 2px 4px;
      border-radius: 4px;
      border: 1px solid rgba(0,0,0,0.7);
      background: #050b10;
      color: var(--text-main);
      font-size: 10px;
    }

    .step-grid {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 2px;
      overflow-x: auto;
    }
    .step-row {
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .step-label {
      width: 40px;
      text-align: right;
      color: var(--text-muted);
      font-size: 10px;
    }
    .step-cells {
      display: flex;
      gap: 2px;
    }
    .step-cell {
      width: 18px;
      height: 18px;
      border-radius: 3px;
      border: 1px solid rgba(0,0,0,0.7);
      background: #050b10;
      cursor: pointer;
      box-shadow: inset 0 0 4px rgba(0,0,0,0.9);
    }
    .step-cell.on {
      background: var(--accent);
      box-shadow: 0 0 8px rgba(112,255,99,0.9);
      border-color: var(--border-strong);
    }
    .step-cell.beat { border-top: 1px solid rgba(255,255,255,0.3); }
    .step-cell.subbeat { opacity: 0.85; }
    .step-cell.active-step { outline: 1px solid #fff; }

    .rack-row {
      display: grid;
      grid-template-columns: 70px 26px 26px minmax(0,1fr) minmax(0,1fr) 40px;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      margin-bottom: 4px;
      padding: 3px 5px;
      border-radius: 4px;
      background: rgba(0,0,0,0.3);
    }
    .rack-name { color: #dde7f4; }
    .rack-btn {
      width: 22px;
      height: 18px;
      border-radius: 3px;
      border: 1px solid rgba(0,0,0,0.7);
      background: #070d12;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .rack-btn.active {
      background: var(--accent);
      color: #02110b;
      border-color: var(--border-strong);
      box-shadow: 0 0 6px rgba(112,255,99,0.8);
    }
    .rack-slider {
      width: 100%;
    }
    .rack-output {
      text-align: right;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
<header>
  <div class="app-header-inner">
    <div class="brand-wrap">
      <div class="brand-icon">S</div>
      <div>
        <div class="brand-title-main">Sulandra AI Studio</div>
        <div class="brand-title-sub">Sound ¬∑ Daw View</div>
      </div>
    </div>
    <nav class="top-nav-links">
      <a href="index.html">Home</a>
      <a href="image.html">Image Lab</a>
      <a href="video.html">Video Lab</a>
      <a href="music.html">Music Lab</a>
      <a href="film.html">Film Lab</a>
      <a href="studio.html">Studio</a>
      <a href="sound.html" class="active">Sound DAW</a>
    </nav>
    <div class="profile-pill">
      <div class="profile-dot"></div>
      <span>Project: <strong>We Need A Miracle</strong></span>
    </div>
  </div>
</header>

<main>
  <!-- MENU / TRANSPORT -->
  <section class="menu-transport">
    <div class="menu-row">
      <div class="menu-item">File</div>
      <div class="menu-item">Edit</div>
      <div class="menu-item">Add</div>
      <div class="menu-item">Patterns</div>
      <div class="menu-item">View</div>
      <div class="menu-item">Options</div>
      <div class="menu-item">Tools</div>
      <div class="menu-item">Help</div>
    </div>
    <div class="transport-row">
      <div class="transport-left">
        <button class="btn-transport" id="btn-back">‚èÆ</button>
        <button class="btn-transport green" id="btn-play">‚ñ∂</button>
        <button class="btn-transport" id="btn-stop">‚èπ</button>
        <button class="btn-transport" id="btn-forward">‚è≠</button>
        <button class="btn-transport" id="btn-loop">üîÑ</button>
        <div class="snap-block">
          <span>Mode:</span><span id="mode-label">Song</span>
        </div>
      </div>

      <div class="transport-center">
        <div class="tempo-block">
          <span>Tempo</span>
          <span class="tempo-value" id="tempo-value">130.000</span>
          <span>BPM</span>
          <button class="tempo-btn" id="tempo-dec">‚Äì</button>
          <button class="tempo-btn" id="tempo-inc">+</button>
        </div>
        <div class="display-field" id="time-display">0:00:00</div>
        <div class="snap-block">
          <span>Snap:</span>
          <span>Line</span>
        </div>
      </div>

      <div class="transport-right">
        <button class="btn-transport record" id="btn-record">‚óè</button>
        <span id="status-label">Ready</span>
      </div>
    </div>
  </section>

  <!-- DAW SHELL -->
  <section class="daw-shell">
    <!-- BROWSER -->
    <aside class="browser">
      <div class="browser-header">
        <span class="browser-title">Browser</span>
        <div class="browser-search">
          <input type="text" placeholder="Search‚Ä¶" />
        </div>
      </div>
      <div class="browser-tabs">
        <div class="browser-tab active" data-tab="project">Project</div>
        <div class="browser-tab" data-tab="manual">Manual</div>
      </div>
      <div class="browser-body">
        <!-- PROJECT TAB -->
        <div class="browser-scroll" id="tab-project">
          <div class="browser-section">
            <div class="browser-section-title">PROJECT</div>
            <div class="browser-item">Current project</div>
            <div class="browser-item">Recent files</div>
          </div>
          <div class="browser-section">
            <div class="browser-section-title">BROWSERS</div>
            <div class="browser-item">Plugin database</div>
            <div class="browser-item">Channel presets</div>
            <div class="browser-item">Mixer presets</div>
            <div class="browser-item">Scores</div>
            <div class="browser-item">Packs</div>
          </div>
        </div>

        <!-- MANUAL TAB (condensed tree) -->
        <div class="browser-scroll" id="tab-manual" style="display:none;">
          <div class="browser-section">
            <div class="browser-section-title">FL STUDIO REFERENCE MANUAL</div>
            <div class="browser-tree">
              <div class="tree-group">
                <div class="tree-title">Overview & Getting Started</div>
                <div class="tree-content">
                  <ul>
                    <li>What is FL Studio?</li>
                    <li>What's New in FL Studio?</li>
                    <li>The user interface</li>
                    <li>Making music (Tutorial)</li>
                  </ul>
                </div>
              </div>
              <div class="tree-group">
                <div class="tree-title">Setting Up & Options</div>
                <div class="tree-content">
                  <ul>
                    <li>Audio Setup & ASIO</li>
                    <li>MIDI Settings</li>
                    <li>File & Theme Settings</li>
                    <li>Project Settings</li>
                  </ul>
                </div>
              </div>
              <div class="tree-group">
                <div class="tree-title">Playlist / Mixer / Plugins</div>
                <div class="tree-content">
                  <ul>
                    <li>Playlist ‚Äì Patterns, Audio, Automation</li>
                    <li>Mixer Functions & Effects</li>
                    <li>Generator Plugins</li>
                    <li>Effect Plugins</li>
                  </ul>
                </div>
              </div>
              <div class="tree-group">
                <div class="tree-title">Files & Troubleshooting</div>
                <div class="tree-content">
                  <ul>
                    <li>Project & Export Formats</li>
                    <li>Optimizing CPU Performance</li>
                    <li>Reset Settings</li>
                    <li>Glossary</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- browser body -->
    </aside>

    <!-- PLAYLIST -->
    <section class="playlist-wrap">
      <div class="playlist-header">
        <div class="playlist-title">Playlist ‚Äì Arrangement (none)</div>
        <div class="playlist-toolbar">
          <div class="small-pill active">Track mode</div>
          <div class="small-pill">Draw</div>
          <div class="small-pill">Paint</div>
          <div class="small-pill">Slice</div>
          <div class="small-pill">Zoom</div>
        </div>
      </div>

      <div class="playlist-main">
        <!-- TRACK HEADERS -->
        <div class="track-names" id="track-headers">
          <!-- generated by JS -->
        </div>

        <!-- GRID -->
        <div class="playlist-grid" id="playlist-grid">
          <div class="timeline-ruler">
            <div class="timeline-ruler-inner" id="timeline-labels">
              <!-- labels by JS -->
            </div>
          </div>
          <div class="grid-inner" id="grid-inner">
            <div class="playhead" id="playhead"></div>
            <!-- track rows + patterns by JS -->
          </div>
        </div>
      </div>
    </section>
  </section>

  <!-- STEP SEQUENCER + CHANNEL RACK -->
  <section class="bottom-grid">
    <!-- STEP SEQ -->
    <section class="step-sequencer" id="step-sequencer">
      <div class="step-header">
        <div class="step-header-left">
          <div class="step-title">Pattern Step Sequencer</div>
          <div class="step-current-pattern" id="step-current-pattern">No pattern selected</div>
        </div>
        <div class="step-hint">
          Click a pattern or choose from the list ‚Ä¢ Kick / Snare / Hat ‚Äì 16 steps
        </div>
      </div>
      <div style="margin-bottom:4px; display:flex; align-items:center; gap:6px; font-size:10px;">
        <label>Pattern:</label>
        <select id="pattern-select" class="pattern-select"></select>
      </div>
      <div class="step-grid" id="step-grid"></div>
    </section>

    <!-- CHANNEL RACK -->
    <section class="channel-rack" id="channel-rack">
      <div class="rack-header">
        <div class="rack-header-left">
          <div class="rack-title">Channel Rack</div>
        </div>
        <div class="rack-hint">
          Adjust per-instrument volume & pan ‚Ä¢ Linked to sequencer
        </div>
      </div>
      <div id="rack-rows">
        <!-- rows from JS -->
      </div>
    </section>
  </section>

  <!-- HINTS -->
  <section class="hint-bar">
    <span>Double-click track name to rename ‚Ä¢ Track menu ‚Üí Upload / Record / Create pattern ‚Ä¢ Double-click empty grid row to drop a new pattern at that bar.</span>
    <span>Spacebar = Play/Pause ‚Ä¢ M/S and rack sliders affect drum volume in real time.</span>
  </section>
</main>

<input type="file" id="hidden-file-input" style="display:none" accept="audio/*" />

<script>
  // === BASIC STATE ===
  const NUM_TRACKS = 9;
  const GRID_BEATS = 32;
  const BEAT_PIXELS = 48;
  const TRACK_HEIGHT_MIN = 24;
  const TRACK_HEIGHT_MAX = 64;

  const STEPS_PER_BEAT = 4;
  const STEPS_PER_BAR = 16;
  const SEQ_ROWS = ['kick','snare','hat'];

  const tracks = [];
  let patterns = []; // {id, trackIndex, startBeat, lengthBeats, label, steps}
  let selectedPatternId = null;

  let isPlaying = false;
  let playStartTime = 0;
  let playheadStartX = 80;
  let tempo = 130;
  let loopEnabled = false;

  let lastGlobalStep = -1;

  const instrumentSettings = {
    kick: { gain: 1, pan: 0, muted: false },
    snare: { gain: 1, pan: 0, muted: false },
    hat: { gain: 0.8, pan: 0, muted: false }
  };

  // DOM
  const playBtn = document.getElementById('btn-play');
  const stopBtn = document.getElementById('btn-stop');
  const loopBtn = document.getElementById('btn-loop');
  const backBtn = document.getElementById('btn-back');
  const fwdBtn = document.getElementById('btn-forward');
  const recordBtn = document.getElementById('btn-record');
  const tempoDecBtn = document.getElementById('tempo-dec');
  const tempoIncBtn = document.getElementById('tempo-inc');
  const timeDisplay = document.getElementById('time-display');
  const tempoDisplay = document.getElementById('tempo-value');
  const statusLabel = document.getElementById('status-label');
  const playheadEl = document.getElementById('playhead');
  const gridInner = document.getElementById('grid-inner');
  const playlistGrid = document.getElementById('playlist-grid');
  const trackHeaders = document.getElementById('track-headers');
  const timelineLabels = document.getElementById('timeline-labels');
  const hiddenFileInput = document.getElementById('hidden-file-input');
  const stepGridEl = document.getElementById('step-grid');
  const stepCurrentPattern = document.getElementById('step-current-pattern');
  const patternSelect = document.getElementById('pattern-select');
  const rackRows = document.getElementById('rack-rows');

  // === WEB AUDIO ===
  let audioCtx = null;
  let noiseBuffer = null;

  function ensureAudioContext() {
    if (!audioCtx) {
      const AC = window.AudioContext || window.webkitAudioContext;
      audioCtx = new AC();
      createNoiseBuffer();
    }
    if (audioCtx.state === 'suspended') {
      audioCtx.resume();
    }
  }

  function createNoiseBuffer() {
    if (!audioCtx || noiseBuffer) return;
    const length = audioCtx.sampleRate * 0.5;
    const buffer = audioCtx.createBuffer(1, length, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < length; i++) data[i] = Math.random() * 2 - 1;
    noiseBuffer = buffer;
  }

  function createPannedGain(gainScale, pan) {
    const now = audioCtx.currentTime;
    const gain = audioCtx.createGain();
    const clampedGain = Math.max(0, Math.min(1, gainScale));
    gain.gain.setValueAtTime(clampedGain, now);
    let node = gain;

    if (audioCtx.createStereoPanner) {
      const panner = audioCtx.createStereoPanner();
      const clampedPan = Math.max(-1, Math.min(1, pan));
      panner.pan.setValueAtTime(clampedPan, now);
      gain.connect(panner);
      node = panner;
    }
    node.connect(audioCtx.destination);
    return { gain, node };
  }

  function playMetronome(accent) {
    if (!audioCtx) return;
    const now = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();

    osc.type = 'square';
    osc.frequency.setValueAtTime(accent ? 3000 : 2000, now);

    gainNode.gain.setValueAtTime(accent ? 0.3 : 0.15, now);
    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.08);

    osc.connect(gainNode).connect(audioCtx.destination);
    osc.start(now);
    osc.stop(now + 0.1);
  }

  function playKick(scale = 1, pan = 0) {
    if (!audioCtx) return;
    const now = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const { gain } = createPannedGain(0.9 * scale, pan);

    osc.type = 'sine';
    osc.frequency.setValueAtTime(150, now);
    osc.frequency.exponentialRampToValueAtTime(50, now + 0.15);

    osc.connect(gain);
    osc.start(now);
    osc.stop(now + 0.2);
  }

  function playSnare(scale = 1, pan = 0) {
    if (!audioCtx || !noiseBuffer) return;
    const now = audioCtx.currentTime;
    const noise = audioCtx.createBufferSource();
    noise.buffer = noiseBuffer;

    const filter = audioCtx.createBiquadFilter();
    filter.type = 'bandpass';
    filter.frequency.value = 1800;
    filter.Q.value = 1;

    const { gain } = createPannedGain(0.4 * scale, pan);
    noise.connect(filter).connect(gain);
    noise.start(now);
    noise.stop(now + 0.2);
  }

  function playHat(scale = 1, pan = 0) {
    if (!audioCtx || !noiseBuffer) return;
    const now = audioCtx.currentTime;
    const noise = audioCtx.createBufferSource();
    noise.buffer = noiseBuffer;

    const filter = audioCtx.createBiquadFilter();
    filter.type = 'highpass';
    filter.frequency.value = 7000;

    const { gain } = createPannedGain(0.15 * scale, pan);
    noise.connect(filter).connect(gain);
    noise.start(now);
    noise.stop(now + 0.1);
  }

  // === TIMELINE LABELS ===
  for (let i = 1; i <= GRID_BEATS; i++) {
    const span = document.createElement('span');
    span.textContent = i;
    timelineLabels.appendChild(span);
  }

  // === TRACKS ===
  function createTrack(index) {
    const track = {
      index,
      name: `Track ${index + 1}`,
      height: 32,
      muted: false,
      solo: false,
      volume: 0.8
    };
    tracks.push(track);
  }
  for (let i = 0; i < NUM_TRACKS; i++) createTrack(i);

  // === PATTERN / STEPS ===
  function defaultSteps() {
    const steps = {
      kick: Array(STEPS_PER_BAR).fill(false),
      snare: Array(STEPS_PER_BAR).fill(false),
      hat: Array(STEPS_PER_BAR).fill(false)
    };
    for (let s = 0; s < STEPS_PER_BAR; s += 4) steps.kick[s] = true;
    steps.snare[4] = true;
    steps.snare[12] = true;
    for (let s = 0; s < STEPS_PER_BAR; s += 2) steps.hat[s] = true;
    return steps;
  }

  function findPatternById(id) {
    return patterns.find(p => p.id === id) || null;
  }

  function anyTrackSolo() {
    return tracks.some(t => t.solo);
  }

  // === RENDER TRACKS & GRID ===
  function renderTracks() {
    trackHeaders.innerHTML = '';
    gridInner.querySelectorAll('.grid-track-row').forEach(el => el.remove());

    tracks.forEach(track => {
      const rowWrap = document.createElement('div');
      rowWrap.className = 'track-row';

      const headerRow = document.createElement('div');
      headerRow.className = 'track-name-row';
      headerRow.style.height = track.height + 'px';

      const dot = document.createElement('div');
      dot.className = 'track-dot';

      const label = document.createElement('div');
      label.className = 'track-label-text';
      label.textContent = track.name;
      label.dataset.trackIndex = track.index;

      label.addEventListener('dblclick', () => {
        label.contentEditable = 'true';
        label.focus();
        document.execCommand('selectAll', false, null);
      });
      label.addEventListener('blur', () => {
        label.contentEditable = 'false';
        track.name = label.textContent.trim() || `Track ${track.index + 1}`;
        label.textContent = track.name;
      });
      label.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          label.blur();
        }
      });

      const controls = document.createElement('div');
      controls.className = 'track-controls';

      const mBtn = document.createElement('button');
      mBtn.className = 'track-btn';
      mBtn.textContent = 'M';
      mBtn.title = 'Mute';
      mBtn.classList.toggle('active', track.muted);
      mBtn.addEventListener('click', () => {
        track.muted = !track.muted;
        mBtn.classList.toggle('active', track.muted);
      });

      const sBtn = document.createElement('button');
      sBtn.className = 'track-btn';
      sBtn.textContent = 'S';
      sBtn.title = 'Solo';
      sBtn.classList.toggle('active', track.solo);
      sBtn.addEventListener('click', () => {
        track.solo = !track.solo;
        sBtn.classList.toggle('active', track.solo);
      });

      const vol = document.createElement('input');
      vol.type = 'range';
      vol.min = 0;
      vol.max = 1;
      vol.step = 0.01;
      vol.value = track.volume;
      vol.className = 'track-volume';
      vol.title = 'Volume';
      vol.addEventListener('input', () => {
        track.volume = parseFloat(vol.value);
      });

      const menuWrap = document.createElement('div');
      menuWrap.className = 'track-menu-wrap';

      const menuBtn = document.createElement('button');
      menuBtn.className = 'track-btn';
      menuBtn.textContent = '‚ãÆ';
      menuBtn.title = 'Track options';

      const menu = document.createElement('div');
      menu.className = 'track-menu';

      const itemUpload = document.createElement('div');
      itemUpload.className = 'track-menu-item';
      itemUpload.textContent = 'Upload audio to this track';
      itemUpload.addEventListener('click', () => {
        statusLabel.textContent = `Upload audio to ${track.name}‚Ä¶`;
        hiddenFileInput.click();
        menu.classList.remove('open');
      });

      const itemRecord = document.createElement('div');
      itemRecord.className = 'track-menu-item';
      itemRecord.textContent = 'Record (mic) ‚Äì connect engine later';
      itemRecord.addEventListener('click', () => {
        alert('Here you can hook getUserMedia + Web Audio to record into ' + track.name);
        menu.classList.remove('open');
      });

      const itemPattern = document.createElement('div');
      itemPattern.className = 'track-menu-item';
      itemPattern.textContent = 'Create MIDI pattern at bar 1';
      itemPattern.addEventListener('click', () => {
        addPatternForTrack(track.index, 0);
        menu.classList.remove('open');
      });

      menu.appendChild(itemUpload);
      menu.appendChild(itemRecord);
      menu.appendChild(itemPattern);

      menuBtn.addEventListener('click', e => {
        e.stopPropagation();
        document.querySelectorAll('.track-menu').forEach(m => m.classList.remove('open'));
        menu.classList.toggle('open');
      });

      menuWrap.appendChild(menuBtn);
      menuWrap.appendChild(menu);

      controls.appendChild(mBtn);
      controls.appendChild(sBtn);
      controls.appendChild(vol);
      controls.appendChild(menuWrap);

      headerRow.appendChild(dot);
      headerRow.appendChild(label);
      headerRow.appendChild(controls);

      const resizeHandle = document.createElement('div');
      resizeHandle.className = 'track-resize-handle';
      resizeHandle.dataset.trackIndex = track.index;

      rowWrap.appendChild(headerRow);
      rowWrap.appendChild(resizeHandle);
      trackHeaders.appendChild(rowWrap);

      const gridRow = document.createElement('div');
      gridRow.className = 'grid-track-row';
      gridRow.style.height = track.height + 'px';
      gridRow.dataset.trackIndex = track.index;
      gridInner.appendChild(gridRow);
    });

    renderPatterns();
  }

  // === PATTERNS ===
  function addPatternForTrack(trackIndex, startBeatGuess) {
    const existing = patterns.filter(p => p.trackIndex === trackIndex);
    let startBeat = startBeatGuess;
    if (startBeat == null) startBeat = existing.length * 4;
    if (startBeat < 0) startBeat = 0;
    startBeat = Math.floor(startBeat / 4) * 4; // align to bar

    const pattern = {
      id: Date.now() + '_' + Math.random(),
      trackIndex,
      startBeat,
      lengthBeats: 4,
      label: 'Pattern ' + (existing.length + 1),
      steps: defaultSteps()
    };
    patterns.push(pattern);
    selectedPatternId = pattern.id;
    renderPatterns();
    updatePatternSelect();
    updateStepSequencerUI();
  }

  function renderPatterns() {
    gridInner.querySelectorAll('.pattern-block').forEach(el => el.remove());

    patterns.forEach(p => {
      const trackRow = gridInner.querySelector(`.grid-track-row[data-track-index="${p.trackIndex}"]`);
      if (!trackRow) return;
      const top = trackRow.offsetTop;

      const block = document.createElement('div');
      block.className = 'pattern-block';
      if (p.id === selectedPatternId) block.classList.add('selected');
      block.textContent = p.label;
      block.style.left = playheadStartX + p.startBeat * BEAT_PIXELS + 'px';
      block.style.top = top + 4 + 'px';
      block.style.width = (p.lengthBeats * BEAT_PIXELS - 6) + 'px';
      block.dataset.patternId = p.id;

      block.addEventListener('click', e => {
        e.stopPropagation();
        selectedPatternId = p.id;
        renderPatterns();
        updatePatternSelect();
        updateStepSequencerUI();
      });

      block.addEventListener('dblclick', e => {
        e.stopPropagation();
        const name = prompt('Rename pattern:', p.label);
        if (name && name.trim()) {
          p.label = name.trim();
          renderPatterns();
          updatePatternSelect();
          updateStepSequencerUI();
        }
      });

      gridInner.appendChild(block);
    });
  }

  function updatePatternSelect() {
    patternSelect.innerHTML = '';
    const optNone = document.createElement('option');
    optNone.value = '';
    optNone.textContent = '‚Äî Select pattern ‚Äî';
    patternSelect.appendChild(optNone);

    patterns.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = `${p.label} (Track ${p.trackIndex + 1})`;
      if (p.id === selectedPatternId) opt.selected = true;
      patternSelect.appendChild(opt);
    });
  }

  patternSelect.addEventListener('change', () => {
    if (!patternSelect.value) {
      selectedPatternId = null;
    } else {
      selectedPatternId = patternSelect.value;
    }
    renderPatterns();
    updateStepSequencerUI();
  });

  // === STEP SEQUENCER UI ===
  function buildStepGrid() {
    stepGridEl.innerHTML = '';
    for (const rowName of SEQ_ROWS) {
      const rowEl = document.createElement('div');
      rowEl.className = 'step-row';

      const labelEl = document.createElement('div');
      labelEl.className = 'step-label';
      labelEl.textContent = rowName[0].toUpperCase() + rowName.slice(1);
      rowEl.appendChild(labelEl);

      const cellsWrap = document.createElement('div');
      cellsWrap.className = 'step-cells';

      for (let i = 0; i < STEPS_PER_BAR; i++) {
        const cell = document.createElement('div');
        cell.className = 'step-cell';
        if (i % 4 === 0) cell.classList.add('beat');
        else if (i % 2 === 0) cell.classList.add('subbeat');
        cell.dataset.row = rowName;
        cell.dataset.step = i;
        cell.addEventListener('click', () => toggleStepCell(cell));
        cellsWrap.appendChild(cell);
      }

      rowEl.appendChild(cellsWrap);
      stepGridEl.appendChild(rowEl);
    }
  }

  function toggleStepCell(cell) {
    const pattern = findPatternById(selectedPatternId);
    if (!pattern) return;
    const row = cell.dataset.row;
    const step = parseInt(cell.dataset.step, 10);
    const current = !!pattern.steps[row][step];
    pattern.steps[row][step] = !current;
    cell.classList.toggle('on', !current);
  }

  function updateStepSequencerUI(activeGlobalStep = null) {
    const pattern = findPatternById(selectedPatternId);
    if (!pattern) {
      stepCurrentPattern.textContent = 'No pattern selected';
      document.querySelectorAll('.step-cell').forEach(c => {
        c.classList.remove('on','active-step');
      });
      return;
    }
    stepCurrentPattern.textContent = `${pattern.label} ‚Äì Track ${pattern.trackIndex + 1}`;

    // on/off
    document.querySelectorAll('.step-cell').forEach(cell => {
      const row = cell.dataset.row;
      const step = parseInt(cell.dataset.step, 10);
      cell.classList.toggle('on', !!pattern.steps[row][step]);
      cell.classList.remove('active-step');
    });

    // highlight step
    if (activeGlobalStep !== null) {
      const startStep = pattern.startBeat * STEPS_PER_BEAT;
      const totalSteps = pattern.lengthBeats * STEPS_PER_BEAT;
      if (activeGlobalStep >= startStep && activeGlobalStep < startStep + totalSteps) {
        const localStep = (activeGlobalStep - startStep) % totalSteps;
        document.querySelectorAll(`.step-cell[data-step="${localStep}"]`)
          .forEach(c => c.classList.add('active-step'));
      }
    }
  }

  // === CHANNEL RACK UI ===
  function renderRack() {
    rackRows.innerHTML = '';
    const names = ['kick','snare','hat'];
    names.forEach((name, idx) => {
      const row = document.createElement('div');
      row.className = 'rack-row';

      const label = document.createElement('div');
      label.className = 'rack-name';
      label.textContent = name[0].toUpperCase() + name.slice(1);

      const mBtn = document.createElement('button');
      mBtn.className = 'rack-btn';
      mBtn.textContent = 'M';
      mBtn.title = 'Mute instrument';
      mBtn.classList.toggle('active', instrumentSettings[name].muted);
      mBtn.addEventListener('click', () => {
        instrumentSettings[name].muted = !instrumentSettings[name].muted;
        mBtn.classList.toggle('active', instrumentSettings[name].muted);
      });

      const sBtn = document.createElement('button');
      sBtn.className = 'rack-btn';
      sBtn.textContent = 'S';
      sBtn.title = 'Solo (instrument)';
      sBtn.addEventListener('click', () => {
        // quick local solo: mute others
        const soloOn = !sBtn.classList.contains('active');
        document.querySelectorAll('.rack-btn').forEach(b => {
          if (b !== sBtn && b.textContent === 'S') b.classList.remove('active');
        });
        Object.keys(instrumentSettings).forEach(k => instrumentSettings[k].muted = false);

        if (soloOn) {
          sBtn.classList.add('active');
          Object.keys(instrumentSettings).forEach(k => {
            instrumentSettings[k].muted = (k !== name);
          });
        } else {
          sBtn.classList.remove('active');
          Object.keys(instrumentSettings).forEach(k => instrumentSettings[k].muted = false);
        }
        renderRack(); // re-sync M buttons
      });

      const volSlider = document.createElement('input');
      volSlider.type = 'range';
      volSlider.min = 0;
      volSlider.max = 1;
      volSlider.step = 0.01;
      volSlider.value = instrumentSettings[name].gain;
      volSlider.className = 'rack-slider';
      volSlider.title = 'Volume';
      volSlider.addEventListener('input', () => {
        instrumentSettings[name].gain = parseFloat(volSlider.value);
      });

      const panSlider = document.createElement('input');
      panSlider.type = 'range';
      panSlider.min = -1;
      panSlider.max = 1;
      panSlider.step = 0.02;
      panSlider.value = instrumentSettings[name].pan;
      panSlider.className = 'rack-slider';
      panSlider.title = 'Pan';
      panSlider.addEventListener('input', () => {
        instrumentSettings[name].pan = parseFloat(panSlider.value);
      });

      const out = document.createElement('div');
      out.className = 'rack-output';
      out.textContent = 'Out ' + (idx + 1);

      row.appendChild(label);
      row.appendChild(mBtn);
      row.appendChild(sBtn);
      row.appendChild(volSlider);
      row.appendChild(panSlider);
      row.appendChild(out);
      rackRows.appendChild(row);
    });
  }

  // === RESIZE TRACKS ===
  let resizingTrackIndex = null;
  let startY = 0;
  let startHeight = 0;

  trackHeaders.addEventListener('mousedown', e => {
    const handle = e.target.closest('.track-resize-handle');
    if (!handle) return;
    resizingTrackIndex = parseInt(handle.dataset.trackIndex, 10);
    startY = e.clientY;
    startHeight = tracks[resizingTrackIndex].height;
    document.body.style.userSelect = 'none';
  });

  window.addEventListener('mousemove', e => {
    if (resizingTrackIndex == null) return;
    const dy = e.clientY - startY;
    const newHeight = Math.min(
      TRACK_HEIGHT_MAX,
      Math.max(TRACK_HEIGHT_MIN, startHeight + dy)
    );
    tracks[resizingTrackIndex].height = newHeight;
    renderTracks();
  });

  window.addEventListener('mouseup', () => {
    if (resizingTrackIndex != null) {
      resizingTrackIndex = null;
      document.body.style.userSelect = '';
    }
  });

  // === BROWSER TABS & MANUAL TREE ===
  document.querySelectorAll('.browser-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.browser-tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const tab = btn.dataset.tab;
      document.getElementById('tab-project').style.display =
        tab === 'project' ? 'block' : 'none';
      document.getElementById('tab-manual').style.display =
        tab === 'manual' ? 'block' : 'none';
    });
  });

  document.querySelectorAll('.tree-group').forEach(group => {
    const title = group.querySelector('.tree-title');
    const content = group.querySelector('.tree-content');
    title.addEventListener('click', () => {
      title.classList.toggle('collapsed');
      content.classList.toggle('collapsed');
    });
  });

  // === TRANSPORT / PLAYHEAD ===
  function bpmToPixelsPerSecond(bpm) {
    const secondsPerBeat = 60 / bpm;
    return BEAT_PIXELS / secondsPerBeat;
  }

  function setPlayheadPosition(px) { playheadEl.style.left = px + 'px'; }

  function updateTimeDisplay(elapsedSeconds) {
    const totalBeats = (elapsedSeconds / 60) * tempo;
    const bars = Math.floor(totalBeats / 4);
    const beats = Math.floor(totalBeats % 4) + 1;
    const ticks = Math.floor((totalBeats * 96) % 96);
    timeDisplay.textContent = `${bars}:${beats.toString().padStart(2,'0')}:${ticks.toString().padStart(2,'0')}`;
  }

  function animationLoop(timestamp) {
    if (!isPlaying) return;
    const elapsed = (timestamp - playStartTime) / 1000;
    const pxPerSec = bpmToPixelsPerSecond(tempo);
    const newX = playheadStartX + elapsed * pxPerSec;
    const maxX = playheadStartX + GRID_BEATS * BEAT_PIXELS;

    const totalBeats = (elapsed / 60) * tempo;
    const globalStep = Math.floor(totalBeats * STEPS_PER_BEAT);

    if (globalStep !== lastGlobalStep) {
      handleStepChange(globalStep);
      lastGlobalStep = globalStep;
    }

    if (newX >= maxX) {
      if (loopEnabled) {
        playStartTime = timestamp;
        setPlayheadPosition(playheadStartX);
        updateTimeDisplay(0);
        lastGlobalStep = -1;
      } else {
        stopPlayback();
        return;
      }
    } else {
      setPlayheadPosition(newX);
      updateTimeDisplay(elapsed);
    }

    requestAnimationFrame(animationLoop);
  }

  function trackGainForPattern(pattern) {
    const track = tracks[pattern.trackIndex];
    if (!track) return 0;
    if (track.muted) return 0;
    const soloActive = anyTrackSolo();
    if (soloActive && !track.solo) return 0;
    return track.volume;
  }

  function handleStepChange(globalStep) {
    if (!audioCtx) return;

    const beatsFromStart = globalStep / STEPS_PER_BEAT;
    const isBarStart = (globalStep % STEPS_PER_BAR === 0);
    const isBeatStart = (globalStep % STEPS_PER_BEAT === 0);

    if (isBeatStart) playMetronome(isBarStart);

    patterns.forEach(pattern => {
      const startStep = pattern.startBeat * STEPS_PER_BEAT;
      const patternSteps = pattern.lengthBeats * STEPS_PER_BEAT;
      const endStep = startStep + patternSteps;
      if (globalStep < startStep || globalStep >= endStep) return;

      const localStep = (globalStep - startStep) % patternSteps;
      const baseGain = trackGainForPattern(pattern);
      if (baseGain <= 0) return;

      // Kick
      if (pattern.steps.kick[localStep] && !instrumentSettings.kick.muted) {
        playKick(baseGain * instrumentSettings.kick.gain, instrumentSettings.kick.pan);
      }
      // Snare
      if (pattern.steps.snare[localStep] && !instrumentSettings.snare.muted) {
        playSnare(baseGain * instrumentSettings.snare.gain, instrumentSettings.snare.pan);
      }
      // Hat
      if (pattern.steps.hat[localStep] && !instrumentSettings.hat.muted) {
        playHat(baseGain * instrumentSettings.hat.gain, instrumentSettings.hat.pan);
      }
    });

    updateStepSequencerUI(globalStep);
  }

  function startPlayback() {
    if (isPlaying) return;
    ensureAudioContext();
    isPlaying = true;
    playStartTime = performance.now();
    lastGlobalStep = -1;
    playBtn.textContent = '‚è∏';
    playBtn.classList.add('active-outline');
    statusLabel.textContent = 'Playing (metronome + patterns)';
    requestAnimationFrame(animationLoop);
  }

  function stopPlayback() {
    isPlaying = false;
    playBtn.textContent = '‚ñ∂';
    playBtn.classList.remove('active-outline');
    setPlayheadPosition(playheadStartX);
    updateTimeDisplay(0);
    lastGlobalStep = -1;
    statusLabel.textContent = 'Stopped';
    updateStepSequencerUI();
  }

  playBtn.addEventListener('click', () => {
    if (isPlaying) {
      isPlaying = false;
      playBtn.textContent = '‚ñ∂';
      playBtn.classList.remove('active-outline');
      statusLabel.textContent = 'Paused';
    } else {
      startPlayback();
    }
  });

  stopBtn.addEventListener('click', stopPlayback);

  backBtn.addEventListener('click', () => {
    stopPlayback();
  });

  fwdBtn.addEventListener('click', () => {
    const maxX = playheadStartX + GRID_BEATS * BEAT_PIXELS;
    setPlayheadPosition(maxX);
    statusLabel.textContent = 'Jumped to end (visual only)';
  });

  loopBtn.addEventListener('click', () => {
    loopEnabled = !loopEnabled;
    loopBtn.classList.toggle('active-outline', loopEnabled);
    statusLabel.textContent = loopEnabled ? 'Loop enabled' : 'Loop disabled';
  });

  recordBtn.addEventListener('click', () => {
    recordBtn.classList.toggle('active-outline');
    const active = recordBtn.classList.contains('active-outline');
    statusLabel.textContent = active
      ? 'Record armed (connect recording engine)'
      : 'Record disarmed';
  });

  tempoDecBtn.addEventListener('click', () => {
    tempo = Math.max(40, tempo - 5);
    tempoDisplay.textContent = tempo.toFixed(3);
  });
  tempoIncBtn.addEventListener('click', () => {
    tempo = Math.min(300, tempo + 5);
    tempoDisplay.textContent = tempo.toFixed(3);
  });

  // Spacebar = play/pause
  window.addEventListener('keydown', e => {
    if (e.code === 'Space' && !e.repeat) {
      e.preventDefault();
      playBtn.click();
    }
  });

  // === FILE UPLOAD STUB ===
  hiddenFileInput.addEventListener('change', () => {
    if (hiddenFileInput.files.length) {
      const file = hiddenFileInput.files[0];
      statusLabel.textContent = 'Loaded file: ' + file.name + ' (connect to engine for playback)';
    }
  });

  // === GLOBAL CLICK TO CLOSE MENUS ===
  window.addEventListener('click', () => {
    document.querySelectorAll('.track-menu').forEach(m => m.classList.remove('open'));
  });

  // === DOUBLE-CLICK GRID TO ADD PATTERN ===
  playlistGrid.addEventListener('dblclick', e => {
    const row = e.target.closest('.grid-track-row');
    if (!row) return;
    const rect = playlistGrid.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const beat = Math.floor((x - playheadStartX) / BEAT_PIXELS);
    const trackIndex = parseInt(row.dataset.trackIndex, 10);
    addPatternForTrack(trackIndex, isNaN(beat) ? 0 : beat);
  });

  // === INIT ===
  renderTracks();
  setPlayheadPosition(playheadStartX);
  updateTimeDisplay(0);
  tempoDisplay.textContent = tempo.toFixed(3);
  buildStepGrid();
  renderRack();
  updatePatternSelect();
  updateStepSequencerUI();
</script>
</body>
</html>
