<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sulandra AI Studio – Video Lab</title>
  <style>
    /* --- CSS STYLES --- */
    :root { --bg: #050816; --card-bg: #0b1020; --accent: #a855f7; --text-main: #f9fafb; --text-muted: #9ca3af; --border-soft: rgba(148, 163, 184, 0.25); }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: radial-gradient(circle at top, #111827, #020617 55%), #000; color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; }
    
    /* Layout Elements */
    header { border-bottom: 1px solid var(--border-soft); background: rgba(2, 6, 23, 0.95); padding: 14px 16px; }
    .header-inner { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .logo { font-weight: 700; font-size: 18px; color: var(--accent); }
    
    main { flex: 1; max-width: 1200px; margin: 20px auto; width: 100%; padding: 0 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    
    /* Cards */
    .card { border-radius: 16px; border: 1px solid var(--border-soft); background: rgba(15, 23, 42, 0.6); padding: 20px; display: flex; flex-direction: column; gap: 15px; }
    h2 { font-size: 16px; margin-bottom: 10px; color: var(--text-main); }
    
    /* Inputs */
    .input-group { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 12px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
    
    /* Custom Radio Selectors */
    .radio-group { display: flex; gap: 10px; background: #020617; padding: 4px; border-radius: 8px; border: 1px solid var(--border-soft); width: fit-content; }
    .radio-option { cursor: pointer; padding: 6px 12px; font-size: 12px; border-radius: 6px; color: var(--text-muted); transition: all 0.2s; }
    .radio-option.active { background: var(--accent); color: white; font-weight: 600; }
    
    /* File Upload */
    .upload-box { border: 1px dashed var(--border-soft); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: 0.2s; background: rgba(2,6,23,0.5); }
    .upload-box:hover { border-color: var(--accent); background: rgba(168, 85, 247, 0.05); }
    .upload-active { border-color: #22c55e !important; background: rgba(34, 197, 94, 0.1) !important; }
    
    /* Buttons */
    .btn { border: none; border-radius: 8px; padding: 10px 20px; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
    .btn-primary { background: linear-gradient(135deg, #a855f7, #3b82f6); color: white; width: 100%; }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--border-soft); flex: 1; }
    .btn-secondary:hover { background: rgba(255,255,255,0.2); }

    /* Video Player Area */
    .video-container { background: #000; border-radius: 12px; overflow: hidden; display: flex; justify-content: center; align-items: center; border: 1px solid var(--border-soft); min-height: 300px; position: relative; }
    
    /* Dynamic Video Sizing */
    video { max-width: 100%; max-height: 500px; box-shadow: 0 0 30px rgba(0,0,0,0.5); transition: all 0.3s ease; }
    
    /* Class to force 16:9 shape */
    .aspect-16-9 { aspect-ratio: 16/9; width: 100%; }
    /* Class to force 9:16 shape */
    .aspect-9-16 { aspect-ratio: 9/16; width: auto; height: 500px; }

    .actions-row { display: none; gap: 10px; margin-top: 10px; }
    .actions-row.show { display: flex; }

    .loading-bar { height: 4px; background: var(--accent); width: 0%; transition: width 0.3s; position: absolute; bottom: 0; left: 0; }

    /* Hidden inputs */
    input[type="file"] { display: none; }
  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo">Sulandra AI Studio</div>
    <div style="font-size:12px; color:var(--text-muted);">Video Lab</div>
  </div>
</header>

<main>
  <div class="card">
    <h2>Create Settings</h2>

    <div class="input-group">
      <label>Aspect Ratio</label>
      <div class="radio-group">
        <div class="radio-option active" onclick="setAspect('16:9', this)">16:9 (Horizontal)</div>
        <div class="radio-option" onclick="setAspect('9:16', this)">9:16 (Vertical)</div>
      </div>
    </div>

    <div class="input-group">
      <label>Duration (Extension Length)</label>
      <div class="radio-group">
        <div class="radio-option active" onclick="setDuration(5, this)">5 Seconds</div>
        <div class="radio-option" onclick="setDuration(10, this)">10 Seconds</div>
      </div>
    </div>

    <div class="input-group">
      <label>Prompt (Optional)</label>
      <textarea id="prompt-text" style="width:100%; background:#020617; border:1px solid var(--border-soft); color:white; padding:10px; border-radius:8px;" placeholder="Describe the motion..."></textarea>
    </div>

    <div class="input-group">
      <label>Source Image</label>
      <input type="file" id="real-file-input" accept="image/*" onchange="fileSelected(this)">
      <div class="upload-box" onclick="document.getElementById('real-file-input').click()">
        <div style="font-size:24px; margin-bottom:5px;">+</div>
        <strong id="upload-text">Click to Upload Image</strong>
      </div>
    </div>

    <button class="btn btn-primary" onclick="runVideoGeneration()">
      Generate Video
    </button>
  </div>

  <div class="card">
    <h2>Preview & Extend</h2>
    
    <div class="video-container">
      <video id="main-video" controls loop playsinline></video>
      <div class="loading-bar" id="loading-bar"></div>
    </div>

    <div class="actions-row" id="actions-row">
      <button class="btn btn-secondary" onclick="downloadVideo()">Download</button>
      <button class="btn btn-secondary" onclick="postToMedia()">Post to Media</button>
      <button class="btn btn-secondary" style="border-color: var(--accent); color: var(--accent);" onclick="extendVideo()">
        ✨ Extend Video
      </button>
    </div>
    <div id="status-text" style="font-size:11px; color:var(--text-muted); margin-top:5px; text-align:center;">Ready.</div>
  </div>
</main>

<script>
  // --- CONFIGURATION ---
  const API_URL = "https://j61fbk8b92147l-8000.proxy.runpod.net"; // REPLACE WITH YOUR RUNPOD URL
  
  // State
  let selectedAspectRatio = "16:9";
  let selectedDuration = 5;
  let currentFile = null;

  // --- UI FUNCTIONS ---

  function setAspect(ratio, element) {
    selectedAspectRatio = ratio;
    // Update UI buttons
    document.querySelectorAll('.input-group:nth-child(2) .radio-option').forEach(el => el.classList.remove('active'));
    element.classList.add('active');
    
    // Update Player Shape Immediately for preview
    const videoPlayer = document.getElementById('main-video');
    videoPlayer.className = (ratio === '16:9') ? 'aspect-16-9' : 'aspect-9-16';
  }

  function setDuration(seconds, element) {
    selectedDuration = seconds;
    document.querySelectorAll('.input-group:nth-child(3) .radio-option').forEach(el => el.classList.remove('active'));
    element.classList.add('active');
  }

  function fileSelected(input) {
    if (input.files && input.files[0]) {
      currentFile = input.files[0];
      document.querySelector('.upload-box').classList.add('upload-active');
      document.getElementById('upload-text').textContent = currentFile.name;
    }
  }

  // --- GENERATION LOGIC ---

  async function runVideoGeneration() {
    if (!currentFile) { alert("Please select an image first!"); return; }

    // UI Updates
    const btn = document.querySelector('.btn-primary');
    btn.disabled = true;
    btn.textContent = "Generating... (Wait ~60s)";
    document.getElementById('loading-bar').style.width = "50%"; // Fake progress
    document.getElementById('status-text').textContent = "Sending to GPU...";
    document.getElementById('actions-row').classList.remove('show'); // Hide actions while generating

    try {
      const formData = new FormData();
      formData.append("file", currentFile);
      formData.append("aspect_ratio", selectedAspectRatio);
      formData.append("duration_sec", selectedDuration);

      const response = await fetch(`${API_URL}/generate-video`, {
        method: 'POST',
        body: formData
      });

      if (!response.ok) throw new Error("Server error");

      const videoBlob = await response.blob();
      const videoUrl = URL.createObjectURL(videoBlob);

      // Setup Video Player
      const video = document.getElementById('main-video');
      video.src = videoUrl;
      // Apply shape class again to be sure
      video.className = (selectedAspectRatio === '16:9') ? 'aspect-16-9' : 'aspect-9-16';
      video.play();

      document.getElementById('status-text').textContent = "Generation Complete!";
      document.getElementById('loading-bar').style.width = "100%";
      
      // Show Action Buttons
      document.getElementById('actions-row').classList.add('show');

    } catch (error) {
      alert("Error: " + error.message);
      document.getElementById('status-text').textContent = "Error.";
    } finally {
      btn.disabled = false;
      btn.textContent = "Generate Video";
      setTimeout(() => { document.getElementById('loading-bar').style.width = "0%"; }, 1000);
    }
  }

  // --- ACTION BUTTONS ---

  function downloadVideo() {
    const video = document.getElementById('main-video');
    if (!video.src) return;
    const a = document.createElement('a');
    a.href = video.src;
    a.download = `sulandra_ai_${Date.now()}.mp4`;
    a.click();
  }

  function postToMedia() {
    alert("Posted to Sulandra Community Feed! (Simulation)");
  }

  // --- THE MAGIC EXTEND FUNCTION ---
  async function extendVideo() {
    const video = document.getElementById('main-video');
    if (!video.src) return;

    const confirmExtend = confirm(`Extend this clip by another ${selectedDuration} seconds?`);
    if (!confirmExtend) return;

    document.getElementById('status-text').textContent = "Capturing last frame for extension...";

    // 1. Capture Last Frame
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    
    // Move video to the very end to capture the last moment
    video.currentTime = video.duration; 
    
    // Wait a tiny bit for the seek to finish
    await new Promise(r => setTimeout(r, 200));
    
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // 2. Convert Canvas to File Blob
    canvas.toBlob((blob) => {
      // 3. Set this new image as the 'currentFile'
      const newFile = new File([blob], "extension_frame.png", { type: "image/png" });
      currentFile = newFile;

      // 4. Update UI to show we are extending
      document.getElementById('upload-text').textContent = "Last Frame Captured (Ready to Extend)";
      document.querySelector('.upload-box').classList.add('upload-active');

      // 5. Run Generation Automatically
      runVideoGeneration();
    }, 'image/png');
  }
</script>

</body>
</html>
