<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sulandra Creative Studio - Video Lab</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* --- COLOR PALETTE --- */
      --bg-root: #050505;
      --bg-panel: #0a0a0a;
      --bg-card: #121212;
      
      /* VIBRANT GRADIENTS */
      --brand-gradient: linear-gradient(135deg, #7c3aed 0%, #2dd4bf 100%); /* Violet to Cyan */
      --accent: #8b5cf6; 
      --accent-glow: rgba(139, 92, 246, 0.5);
      --highlight: #2dd4bf; /* Teal/Cyan pop */
      
      --text-main: #ffffff;
      --text-muted: #a1a1aa;
      --border: #27272a;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; scrollbar-width: thin; scrollbar-color: #3f3f46 transparent; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background-color: #3f3f46; border-radius: 20px; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-root);
      color: var(--text-main);
      height: 100vh;
      display: grid;
      grid-template-rows: 60px 1fr; /* Header | Content */
      overflow: hidden;
    }

    /* --- HEADER --- */
    header {
      border-bottom: 1px solid var(--border);
      background: rgba(5, 5, 5, 0.9);
      backdrop-filter: blur(10px);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 24px;
      z-index: 50;
    }
    
    .brand-area { display: flex; align-items: center; gap: 15px; }
    
    .company-name { 
      font-weight: 700; font-size: 18px; letter-spacing: -0.5px; color: white;
    }
    
    .app-badge {
      background: var(--brand-gradient);
      -webkit-background-clip: text;
      color: transparent;
      font-weight: 800;
      font-size: 12px;
      letter-spacing: 1px;
      text-transform: uppercase;
      border: 1px solid #3f3f46;
      padding: 4px 10px;
      border-radius: 20px;
      position: relative;
    }
    .app-badge::before { /* Glow effect */
      content: ''; position: absolute; inset: 0; padding: 1px; border-radius: 20px; 
      background: var(--brand-gradient); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none;
    }

    /* --- MAIN LAYOUT --- */
    .main-layout {
      display: grid;
      grid-template-columns: 64px 340px 1fr 320px; /* Icons | Controls | Canvas | Assets */
      height: 100%;
      overflow: hidden;
    }

    /* 1. ICON BAR */
    .sidebar-icons {
      background: var(--bg-root);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column; align-items: center;
      padding-top: 20px; gap: 24px;
    }
    .icon-btn {
      width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: var(--text-muted); transition: 0.2s; font-size: 18px;
    }
    .icon-btn:hover { background: var(--bg-card); color: white; }
    .icon-btn.active { color: white; background: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }

    /* 2. CONTROL PANEL (Fixed Scroll Issue) */
    .control-panel {
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      overflow-y: auto; /* Crucial for scrolling */
      padding: 20px;
      gap: 24px;
    }

    .panel-section { display: flex; flex-direction: column; gap: 12px; }
    label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); font-weight: 600; display: flex; justify-content: space-between; }
    
    /* Fancy Toggles */
    .toggles { display: flex; background: #000; padding: 4px; border-radius: 8px; border: 1px solid var(--border); }
    .toggle-btn {
      flex: 1; text-align: center; padding: 8px; font-size: 12px; cursor: pointer; border-radius: 6px; transition: 0.2s; color: var(--text-muted); font-weight: 500;
    }
    .toggle-btn:hover { color: white; }
    .toggle-btn.active { background: var(--bg-card); color: var(--highlight); border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

    /* Upload Area */
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      height: 140px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      cursor: pointer; transition: 0.2s; background: rgba(255,255,255,0.01);
      position: relative; overflow: hidden;
    }
    .upload-zone:hover { border-color: var(--accent); background: rgba(139, 92, 246, 0.05); }
    .upload-zone.has-image { border-style: solid; border-color: var(--highlight); }
    
    .preview-thumb { position: absolute; width: 100%; height: 100%; object-fit: cover; opacity: 0.6; display: none; }

    /* Prompt Box */
    textarea {
      width: 100%; background: #000; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; font-family: inherit; font-size: 13px; resize: none; outline: none; transition: 0.2s;
    }
    textarea:focus { border-color: var(--accent); }

    /* Generate Button */
    .btn-gen {
      background: var(--brand-gradient);
      color: white; border: none; padding: 16px; border-radius: 10px; font-weight: 600; font-size: 14px;
      cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 0.5px;
      box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4); margin-top: 10px;
    }
    .btn-gen:hover { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(45, 212, 191, 0.4); }
    .btn-gen:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* 3. CANVAS AREA */
    .canvas-area {
      background: radial-gradient(circle at center, #1a1a20 0%, #050505 100%);
      display: flex; align-items: center; justify-content: center;
      position: relative;
      padding: 40px;
    }
    
    .video-wrapper {
      border-radius: 16px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.7); border: 1px solid var(--border);
      max-width: 100%; max-height: 100%; display: flex;
    }
    video { max-height: 70vh; max-width: 100%; display: block; }

    /* 4. ASSETS PANEL */
    .assets-panel {
      background: var(--bg-panel);
      border-left: 1px solid var(--border);
      display: flex; flex-direction: column;
    }
    .assets-header {
      height: 50px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; font-size: 12px; font-weight: 600; color: var(--text-muted);
    }
    .assets-list { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 16px; }

    /* Video Card Style */
    .video-card {
      background: var(--bg-card); border-radius: 10px; overflow: hidden; border: 1px solid var(--border); transition: 0.2s;
    }
    .video-card:hover { border-color: var(--text-muted); }
    .mini-video { width: 100%; aspect-ratio: 16/9; display: block; background: black; object-fit: cover; }
    .card-controls { padding: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    
    .mini-btn {
      background: rgba(255,255,255,0.05); border: none; color: var(--text-muted); padding: 6px; border-radius: 4px; font-size: 10px; cursor: pointer; transition: 0.2s;
    }
    .mini-btn:hover { background: white; color: black; }
    .btn-extend { color: var(--highlight); background: rgba(45, 212, 191, 0.1); }
    .btn-extend:hover { background: var(--highlight); color: black; }

    /* --- MODALS & OVERLAYS --- */
    .loader-overlay {
      position: absolute; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
      display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 20;
    }
    .spinner {
      width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--highlight); border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); z-index: 100;
      display: none; align-items: center; justify-content: center;
    }
    .modal {
      background: #18181b; border: 1px solid var(--border); width: 400px; padding: 24px; border-radius: 16px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
    }
    .modal-input {
      width: 100%; background: #000; border: 1px solid var(--border); padding: 12px; color: white; border-radius: 8px; margin: 15px 0; outline: none;
    }
    .modal-input:focus { border-color: var(--highlight); }
  </style>
</head>
<body>

<div class="loader-overlay" id="global-loader">
  <div class="spinner"></div>
  <div style="margin-top:15px; font-size:13px; font-weight:500; color:var(--text-main);" id="loader-text">Initializing...</div>
</div>

<header>
  <div class="brand-area">
    <div class="company-name">Sulandra Creative Studio</div>
    <div class="app-badge">Video Lab</div>
  </div>
  <div style="font-size:12px; color:var(--text-muted);">
    <span style="color:#22c55e;">‚óè</span> Server Connected
  </div>
</header>

<div class="main-layout">
  <div class="sidebar-icons">
    <div class="icon-btn">üè†</div>
    <div class="icon-btn active">‚ú®</div>
    <div class="icon-btn">üìÇ</div>
    <div class="icon-btn">‚öôÔ∏è</div>
  </div>

  <div class="control-panel">
    <div class="panel-section">
      <label>Input Image</label>
      <input type="file" id="file-input" accept="image/*" hidden onchange="handleFile(this)">
      <div class="upload-zone" id="upload-box" onclick="document.getElementById('file-input').click()">
        <img id="preview-thumb" class="preview-thumb">
        <div id="upload-ui" style="text-align:center;">
          <div style="font-size:24px; margin-bottom:8px; opacity:0.7;">üìÇ</div>
          <div style="font-size:12px; font-weight:600;">Click to Upload</div>
          <div style="font-size:10px; color:var(--text-muted); margin-top:4px;">JPG or PNG</div>
        </div>
      </div>
    </div>

    <div class="panel-section">
      <label>Prompt / Action</label>
      <textarea id="prompt-text" rows="3" placeholder="Describe the motion (e.g. The girl smiles and turns her head)..."></textarea>
    </div>

    <div class="panel-section">
      <label>Aspect Ratio</label>
      <div class="toggles">
        <div class="toggle-btn active" onclick="setAspect('16:9', this)">16:9</div>
        <div class="toggle-btn" onclick="setAspect('9:16', this)">9:16</div>
      </div>
    </div>

    <div class="panel-section">
      <label>Duration</label>
      <div class="toggles">
        <div class="toggle-btn active" onclick="setDuration(5, this)">5s</div>
        <div class="toggle-btn" onclick="setDuration(10, this)">10s</div>
      </div>
    </div>

    <button class="btn-gen" id="gen-btn" onclick="generateVideo()">‚ú® Generate Video</button>
  </div>

  <div class="canvas-area">
    <div class="video-wrapper">
      <video id="main-player" controls loop playsinline style="display:none;"></video>
      <div id="empty-state" style="color:var(--text-muted); font-size:13px;">
        Select an image and click Generate to begin.
      </div>
    </div>
  </div>

  <div class="assets-panel">
    <div class="assets-header">
      <span>MY GALLERY</span>
      <span id="asset-count">0 items</span>
    </div>
    <div class="assets-list" id="gallery-list">
      </div>
  </div>
</div>

<div class="modal-overlay" id="extend-modal">
  <div class="modal">
    <h3 style="margin-bottom:8px;">Extend & Merge</h3>
    <p style="font-size:12px; color:var(--text-muted);">Describe what happens next. The system will generate a new clip and seamlessly merge it with the original.</p>
    
    <input type="text" class="modal-input" id="extend-prompt-input" placeholder="e.g. Camera pans left...">
    
    <div style="display:flex; gap:10px;">
      <button class="mini-btn" style="flex:1; padding:12px;" onclick="closeModal()">Cancel</button>
      <button class="btn-gen" style="flex:1; margin:0; font-size:12px; padding:12px;" onclick="confirmExtend()">Confirm</button>
    </div>
  </div>
</div>

<script>
  // === API CONFIG ===
  const API_URL = "https://j61fbk8b92147l-8000.proxy.runpod.net"; // RUNPOD URL

  // === STATE ===
  let state = { aspect: '16:9', duration: 5, file: null };
  let extendTarget = null; // { id, filename, url }

  // === DB INIT ===
  let db;
  const request = indexedDB.open("SulandraDB", 1);
  request.onupgradeneeded = e => e.target.result.createObjectStore("videos", { keyPath: "id" });
  request.onsuccess = e => { db = e.target.result; loadGallery(); };

  // === UI FUNCTIONS ===
  function handleFile(input) {
    if (input.files[0]) {
      state.file = input.files[0];
      const url = URL.createObjectURL(state.file);
      document.getElementById('preview-thumb').src = url;
      document.getElementById('preview-thumb').style.display = 'block';
      document.getElementById('upload-ui').style.display = 'none';
      document.getElementById('upload-box').classList.add('has-image');
    }
  }

  function setAspect(val, btn) {
    state.aspect = val;
    document.querySelectorAll('.panel-section:nth-child(3) .toggle-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }

  function setDuration(val, btn) {
    state.duration = val;
    document.querySelectorAll('.panel-section:nth-child(4) .toggle-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }

  function setLoading(active, msg) {
    const loader = document.getElementById('global-loader');
    loader.style.display = active ? 'flex' : 'none';
    if (msg) document.getElementById('loader-text').textContent = msg;
  }

  function playVideo(url) {
    const v = document.getElementById('main-player');
    v.src = url;
    v.style.display = 'block';
    document.getElementById('empty-state').style.display = 'none';
    v.play();
  }

  // === GENERATION ===
  async function generateVideo() {
    if (!state.file) return alert("Please upload an image first.");
    
    setLoading(true, "Initializing AI Engine...");
    const prompt = document.getElementById('prompt-text').value;

    try {
      const formData = new FormData();
      formData.append("file", state.file);
      formData.append("aspect_ratio", state.aspect);
      formData.append("duration_sec", state.duration);
      formData.append("prompt", prompt);

      const res = await fetch(`${API_URL}/generate-video`, { method: 'POST', body: formData });
      if (!res.ok) throw new Error("Server Error");

      const blob = await res.blob();
      const filename = res.headers.get("X-Filename") || `gen_${Date.now()}.mp4`;

      // Save & Display
      const record = {
        id: Date.now(), blob, filename, timestamp: Date.now()
      };
      saveToDB(record);
      playVideo(URL.createObjectURL(blob));

    } catch (e) {
      alert("Error: " + e.message);
    } finally {
      setLoading(false);
    }
  }

  // === EXTENSION LOGIC ===
  function triggerExtend(id, filename) {
    // Find video in DB to get blob URL
    const tx = db.transaction("videos", "readonly");
    tx.objectStore("videos").get(id).onsuccess = (e) => {
      const vid = e.target.result;
      if (vid) {
        extendTarget = { id: vid.id, filename: vid.filename, url: URL.createObjectURL(vid.blob) };
        document.getElementById('extend-modal').style.display = 'flex';
      }
    };
  }

  function closeModal() {
    document.getElementById('extend-modal').style.display = 'none';
  }

  async function confirmExtend() {
    closeModal();
    const prompt = document.getElementById('extend-prompt-input').value;
    setLoading(true, "Capturing Last Frame...");

    try {
      // 1. Capture Frame
      const video = document.createElement('video');
      video.src = extendTarget.url;
      video.crossOrigin = "anonymous";
      await new Promise(r => video.onloadeddata = r);
      video.currentTime = video.duration; // Seek end
      await new Promise(r => video.onseeked = r);

      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      
      const frameBlob = await new Promise(r => canvas.toBlob(r, 'image/jpeg'));

      // 2. Generate Next Clip
      setLoading(true, "Generating Extension...");
      const formData = new FormData();
      formData.append("file", frameBlob);
      formData.append("aspect_ratio", state.aspect);
      formData.append("duration_sec", state.duration);
      formData.append("prompt", prompt);

      const genRes = await fetch(`${API_URL}/generate-video`, { method: 'POST', body: formData });
      if (!genRes.ok) throw new Error("Extension Failed");
      
      const extBlob = await genRes.blob();
      const extFilename = genRes.headers.get("X-Filename");

      // 3. Merge
      setLoading(true, "Merging Clips (FFmpeg)...");
      const mergeRes = await fetch(`${API_URL}/merge-videos`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify([ extendTarget.filename, extFilename ])
      });

      if (!mergeRes.ok) throw new Error("Merge Failed");
      
      const mergedBlob = await mergeRes.blob();
      const mergedFilename = mergeRes.headers.get("X-Filename");

      // 4. Save Result
      const record = {
        id: Date.now(), blob: mergedBlob, filename: mergedFilename, timestamp: Date.now()
      };
      saveToDB(record);
      playVideo(URL.createObjectURL(mergedBlob));

    } catch (e) {
      alert(e.message);
    } finally {
      setLoading(false);
    }
  }

  // === DB HELPERS ===
  function saveToDB(item) {
    const tx = db.transaction("videos", "readwrite");
    tx.objectStore("videos").add(item);
    tx.oncomplete = loadGallery;
  }

  function loadGallery() {
    const tx = db.transaction("videos", "readonly");
    const store = tx.objectStore("videos");
    store.getAll().onsuccess = (e) => {
      const videos = e.target.result.sort((a, b) => b.id - a.id);
      document.getElementById('asset-count').textContent = `${videos.length} items`;
      
      const list = document.getElementById('gallery-list');
      list.innerHTML = '';
      
      videos.forEach(vid => {
        const url = URL.createObjectURL(vid.blob);
        const div = document.createElement('div');
        div.className = 'video-card';
        div.innerHTML = `
          <video src="${url}" class="mini-video" onmouseover="this.play()" onmouseout="this.pause();this.currentTime=0;"></video>
          <div class="card-controls">
            <button class="mini-btn" onclick="playVideo('${url}')">‚ñ∂ Play</button>
            <button class="mini-btn btn-extend" onclick="triggerExtend(${vid.id}, '${vid.filename}')">‚ú® Extend</button>
          </div>
        `;
        list.appendChild(div);
      });
    };
  }
</script>
</body>
</html>
