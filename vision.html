<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sulandra Creative Lab · Vision Lab</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet"
    />
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap"
        rel="stylesheet"
    />

    <style>
    /* ====================================================================== */
    /*  SULANDRA VISION LAB – SECTION 1: GLOBAL THEME & BASE LAYOUT          */
    /*  (Chunk 1 / 8 – paste at very top of the file)                        */
    /* ====================================================================== */

    :root {
        /* Core background layers */
        --bg-root: #020617;
        --bg-app: #020617;
        --bg-panel: #020617;
        --bg-card: #020617;
        --bg-card-soft: #020617;
        --bg-elevated: #020617;

        /* Structural borders */
        --border-subtle: #111827;
        --border-strong: #1f2937;
        --border-focus: #4b5563;

        /* Accent + status */
        --accent-primary: #22c55e;
        --accent-primary-soft: rgba(34, 197, 94, 0.12);
        --accent-primary-strong: #4ade80;
        --accent-secondary: #60a5fa;
        --accent-secondary-soft: rgba(96, 165, 250, 0.2);
        --accent-danger: #ef4444;
        --accent-warning: #f97316;

        /* Text */
        --text-primary: #f9fafb;
        --text-secondary: #9ca3af;
        --text-muted: #6b7280;
        --text-soft: #4b5563;
        --text-dark: #020617;

        /* Shadows & radii */
        --radius-xs: 8px;
        --radius-sm: 10px;
        --radius-md: 14px;
        --radius-lg: 20px;
        --radius-xl: 24px;
        --radius-pill: 999px;

        --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.9);
        --shadow-card: 0 24px 60px rgba(0, 0, 0, 0.95);
        --shadow-strong: 0 32px 80px rgba(0, 0, 0, 0.98);
        --shadow-glow-accent: 0 0 0 1px rgba(34, 197, 94, 0.8),
                               0 0 40px rgba(34, 197, 94, 0.9);

        /* Layout metrics */
        --nav-width: 80px;
        --header-height: 70px;
        --footer-height: 0px;
        --history-rail-width: 100px;
        --config-panel-min: 360px;
        --config-panel-max: 460px;

        /* Timing */
        --fast: 120ms;
        --normal: 160ms;
        --slow: 220ms;
    }

    /* ---------------------------------------------------------------------- */
    /*  RESET & BASICS                                                       */
    /* ---------------------------------------------------------------------- */

    *, *::before, *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    html,
    body {
        width: 100%;
        height: 100%;
    }

    body {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
            "Segoe UI", sans-serif;
        font-size: 14px;
        line-height: 1.55;
        color: var(--text-primary);
        background:
            radial-gradient(circle at -10% -30%, rgba(59, 130, 246, 0.22), transparent 60%),
            radial-gradient(circle at 120% 0%, rgba(34, 197, 94, 0.24), transparent 58%),
            radial-gradient(circle at 50% 140%, rgba(0, 0, 0, 0.88), #020617 70%);
        display: flex;
        overflow: hidden;
    }

    img,
    video {
        max-width: 100%;
        display: block;
    }

    button {
        font: inherit;
        border: none;
        background: none;
        cursor: pointer;
    }

    input,
    textarea,
    select {
        font: inherit;
        color: inherit;
        background: transparent;
        border-radius: 0;
        border: none;
        outline: none;
    }

    a {
        color: inherit;
        text-decoration: none;
    }

    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    ::-webkit-scrollbar-track {
        background: transparent;
    }

    ::-webkit-scrollbar-thumb {
        background: #111827;
        border-radius: 999px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #1f2937;
    }

    /* Utility classes ------------------------------------------------------- */

    .hidden {
        display: none !important;
    }

    .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    .text-soft {
        color: var(--text-secondary);
    }

    .text-muted {
        color: var(--text-muted);
    }

    .badge-pill {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        border: 1px solid rgba(31, 41, 55, 0.95);
        background: radial-gradient(circle at 0 0, #020617, #020617 60%, #000 100%);
        color: var(--text-secondary);
    }

    .badge-pill--accent {
        background: linear-gradient(135deg, #22c55e, #4ade80);
        border-color: transparent;
        color: #022c22;
        box-shadow: 0 16px 40px rgba(34, 197, 94, 0.85);
        font-weight: 700;
    }

    .tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 9px;
        border-radius: 999px;
        font-size: 11px;
        border: 1px solid rgba(31, 41, 55, 0.9);
        background: radial-gradient(circle at 0 0, #020617, #020617 60%, #000 100%);
        color: var(--text-secondary);
    }

    .tag-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow:
            0 0 0 3px rgba(34, 197, 94, 0.35),
            0 0 22px rgba(34, 197, 94, 0.85);
    }

    .pill-switch {
        display: inline-flex;
        padding: 4px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 0, #020617, #020617 60%, #000 100%);
        border: 1px solid rgba(15, 23, 42, 0.95);
        box-shadow:
            0 0 0 1px rgba(15, 23, 42, 0.9),
            0 18px 42px rgba(0, 0, 0, 0.9);
        gap: 2px;
    }

    .pill-switch__btn {
        padding: 7px 16px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        transition:
            background var(--fast) ease-out,
            color var(--fast) ease-out,
            box-shadow var(--fast) ease-out,
            transform var(--fast) ease-out;
        white-space: nowrap;
    }

    .pill-switch__btn--active {
        background: linear-gradient(135deg, #22c55e, #4ade80);
        color: #020617;
        box-shadow: var(--shadow-glow-accent);
        transform: translateY(-1px);
    }

    .pill-switch__btn:not(.pill-switch__btn--active):hover {
        background: rgba(15, 23, 42, 0.95);
        color: #e5e7eb;
    }

    /* ---------------------------------------------------------------------- */
    /*  ROOT LAYOUT: SIDEBAR + APP SHELL                                     */
    /* ---------------------------------------------------------------------- */

    .vision-root {
        display: flex;
        width: 100%;
        height: 100%;
        min-height: 0;
        min-width: 0;
        color: var(--text-primary);
    }

    /* Left navigation column ------------------------------------------------ */

    .vision-sidebar {
        width: var(--nav-width);
        flex-shrink: 0;
        background:
            radial-gradient(circle at 0 0, #020617, #020617 40%, #000 100%);
        border-right: 1px solid rgba(15, 23, 42, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 18px 0 16px;
        box-shadow: 22px 0 55px rgba(0, 0, 0, 0.96);
        z-index: 20;
    }

    .vision-sidebar__logo {
        width: 52px;
        height: 52px;
        border-radius: 999px;
        background: radial-gradient(circle at 20% 0, #22c55e, #0f172a 60%, #020617);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 24px;
        box-shadow:
            0 0 0 1px rgba(148, 163, 184, 0.4),
            0 24px 58px rgba(34, 197, 94, 0.9);
    }

    .vision-sidebar__logo-inner {
        width: 38px;
        height: 38px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 0, #020617, #000 70%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #bbf7d0;
        font-family: "Cinzel", serif;
        font-size: 22px;
        font-weight: 700;
        letter-spacing: 0.12em;
    }

    .vision-nav {
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100%;
        align-items: center;
        margin-bottom: 18px;
    }

    .vision-nav__item {
        width: 48px;
        height: 48px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        cursor: pointer;
        border: 1px solid transparent;
        background: radial-gradient(circle at 50% 0, rgba(15, 23, 42, 0.9), #020617 70%);
        transition:
            background var(--fast) ease-out,
            color var(--fast) ease-out,
            box-shadow var(--fast) ease-out,
            border-color var(--fast) ease-out,
            transform var(--fast) ease-out;
        position: relative;
    }

    .vision-nav__item svg {
        width: 24px;
        height: 24px;
        stroke-width: 1.6;
    }

    .vision-nav__item:hover {
        color: #e5e7eb;
        border-color: rgba(148, 163, 184, 0.75);
        box-shadow: 0 14px 32px rgba(15, 23, 42, 0.9);
        transform: translateY(-1px);
    }

    .vision-nav__item--active {
        color: #ecfeff;
        background: radial-gradient(circle at 20% 0, #22c55e, #0f172a 55%, #020617);
        border-color: rgba(34, 197, 94, 0.9);
        box-shadow:
            0 0 0 1px rgba(34, 197, 94, 0.8),
            0 20px 46px rgba(34, 197, 94, 0.95);
        transform: translateY(-1px);
    }

    .vision-nav__item--active::before {
        content: "";
        position: absolute;
        left: -12px;
        top: 10px;
        bottom: 10px;
        width: 3px;
        border-radius: 0 12px 12px 0;
        background: linear-gradient(180deg, #22c55e, #a7f3d0);
    }

    .vision-sidebar__footer {
        margin-top: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        width: 100%;
    }

    .vision-sidebar__credits {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 11px;
        color: var(--text-secondary);
    }

    .vision-sidebar__credits-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow:
            0 0 0 3px rgba(34, 197, 94, 0.4),
            0 0 24px rgba(34, 197, 94, 0.9);
        margin-bottom: 4px;
    }

    .vision-sidebar__sale {
        padding: 6px 9px;
        border-radius: 12px;
        background: linear-gradient(135deg, #22c55e, #a3e635);
        color: #052e16;
        font-size: 11px;
        font-weight: 800;
        text-align: center;
        line-height: 1.2;
        box-shadow: 0 16px 40px rgba(34, 197, 94, 0.8);
    }

    .vision-sidebar__user {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        border: 1px solid rgba(31, 41, 55, 0.95);
        background: radial-gradient(circle at 20% 0, #020617, #020617 60%, #000 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        margin-top: 6px;
    }

    /* ---------------------------------------------------------------------- */
    /*  APP SHELL: TOP HEADER + MAIN SPLIT                                   */
    /* ---------------------------------------------------------------------- */

    .vision-app {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        min-height: 0;
    }

    .vision-header {
        height: var(--header-height);
        flex-shrink: 0;
        padding: 0 22px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid rgba(15, 23, 42, 0.96);
        background:
            linear-gradient(
                135deg,
                rgba(15, 23, 42, 0.97),
                rgba(15, 23, 42, 0.94),
                rgba(15, 23, 42, 0.99)
            ),
            radial-gradient(circle at 0 0, rgba(59, 130, 246, 0.25), transparent 60%);
        backdrop-filter: blur(20px);
        box-shadow: 0 20px 55px rgba(0, 0, 0, 0.96);
        z-index: 10;
    }

    .vision-header__left {
        display: flex;
        align-items: center;
        gap: 18px;
        min-width: 0;
    }

    .vision-header__title-block {
        display: flex;
        flex-direction: column;
        gap: 3px;
    }

    .vision-header__title {
        font-size: 19px;
        font-weight: 700;
        letter-spacing: 0.06em;
        text-transform: uppercase;
    }

    .vision-header__subtitle {
        font-size: 11px;
        color: var(--text-secondary);
    }

    .vision-header__model-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 7px 16px;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(15, 23, 42, 0.95);
        background: radial-gradient(circle at 20% 0, #020617, #020617 60%, #000 100%);
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        box-shadow:
            0 0 0 1px rgba(15, 23, 42, 0.92),
            0 18px 42px rgba(0, 0, 0, 0.9);
    }

    .vision-header__model-pill-status {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow:
            0 0 0 3px rgba(34, 197, 94, 0.45),
            0 0 26px rgba(34, 197, 94, 0.95);
    }

    .vision-header__model-pill-chevron {
        width: 10px;
        height: 6px;
        stroke-width: 1.6;
    }

    .vision-header__tabs {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: 24px;
        border-radius: var(--radius-pill);
        padding: 4px;
        border: 1px solid rgba(15, 23, 42, 0.96);
        background: radial-gradient(circle at 30% 0, #020617, #020617 60%, #000 100%);
        box-shadow:
            0 0 0 1px rgba(15, 23, 42, 0.9),
            0 18px 42px rgba(0, 0, 0, 0.9);
    }

    .vision-header__tab {
        padding: 7px 18px;
        border-radius: 999px;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        cursor: pointer;
        white-space: nowrap;
        transition:
            background var(--fast) ease-out,
            color var(--fast) ease-out,
            box-shadow var(--fast) ease-out,
            transform var(--fast) ease-out;
    }

    .vision-header__tab--active {
        background: linear-gradient(135deg, #22c55e, #4ade80);
        color: #020617;
        box-shadow: var(--shadow-glow-accent);
        transform: translateY(-1px);
    }

    .vision-header__tab:not(.vision-header__tab--active):hover {
        background: rgba(15, 23, 42, 0.96);
        color: #e5e7eb;
    }

    .vision-header__right {
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .vision-header__view-pills {
        display: inline-flex;
        align-items: center;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(15, 23, 42, 0.96);
        background: radial-gradient(circle at 30% 0, #020617, #020617 60%, #000 100%);
        padding: 4px;
        box-shadow:
            0 0 0 1px rgba(15, 23, 42, 0.9),
            0 18px 40px rgba(0, 0, 0, 0.9);
        gap: 2px;
    }

    .vision-header__view-btn {
        padding: 7px 16px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        cursor: pointer;
        white-space: nowrap;
        transition:
            background var(--fast) ease-out,
            color var(--fast) ease-out,
            box-shadow var(--fast) ease-out,
            transform var(--fast) ease-out;
    }

    .vision-header__view-btn--active {
        background: linear-gradient(135deg, #22c55e, #4ade80);
        color: #020617;
        box-shadow: var(--shadow-glow-accent);
        transform: translateY(-1px);
    }

    .vision-header__view-btn:not(.vision-header__view-btn--active):hover {
        background: rgba(15, 23, 42, 0.96);
        color: #e5e7eb;
    }

    .vision-header__favorites-toggle {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--text-secondary);
        margin-left: 8px;
        white-space: nowrap;
    }

    .vision-header__favorites-toggle input {
        accent-color: #9ca3af;
    }

    .vision-header__assets-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 18px;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(148, 163, 184, 0.5);
        background: radial-gradient(circle at 30% 0, #020617, #020617 60%, #000 100%);
        font-size: 13px;
        font-weight: 600;
        color: #e5e7eb;
        box-shadow:
            0 0 0 1px rgba(15, 23, 42, 0.95),
            0 18px 40px rgba(0, 0, 0, 0.9);
        white-space: nowrap;
    }

    .vision-header__assets-btn svg {
        width: 18px;
        height: 18px;
        stroke-width: 1.5;
    }

    .vision-header__assets-btn:hover {
        border-color: rgba(209, 213, 219, 0.95);
    }

    /* ---------------------------------------------------------------------- */
    /*  MAIN AREA: CONFIG PANEL + STAGE                                      */
    /* ---------------------------------------------------------------------- */

    .vision-main {
        flex: 1;
        min-height: 0;
        min-width: 0;
        display: grid;
        grid-template-columns: minmax(var(--config-panel-min), var(--config-panel-max)) minmax(
                0,
                1fr
            );
        border-top: 1px solid rgba(15, 23, 42, 0.95);
    }

    .vision-config-panel {
        background: radial-gradient(circle at 0 0, #020617, #020617 60%, #000 100%);
        border-right: 1px solid rgba(15, 23, 42, 0.95);
        display: flex;
        flex-direction: column;
        min-height: 0;
        min-width: 0;
    }

    .vision-config-panel__body {
        flex: 1;
        min-height: 0;
        padding: 20px 22px 18px;
        overflow-y: auto;
    }

    .vision-config-panel__footer {
        flex-shrink: 0;
        padding: 12px 22px 18px;
        border-top: 1px solid rgba(15, 23, 42, 0.96);
        background: radial-gradient(circle at 0 0, #020617, #020617 60%, #000 100%);
        position: sticky;
        bottom: 0;
        z-index: 5;
    }

    .vision-stage {
        background: radial-gradient(circle at 100% 0, #020617, #020617 60%, #000 100%);
        display: flex;
        flex-direction: column;
        min-width: 0;
        min-height: 0;
    }

    .vision-stage__inner {
        flex: 1;
        min-height: 0;
        padding: 22px 22px 18px 22px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        overflow: hidden;
    }

    .vision-stage__toolbar {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        font-size: 12px;
        color: var(--text-secondary);
    }

    .vision-stage__toolbar-left {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .vision-stage__toolbar-right {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: auto;
    }

    .vision-stage__toolbar-icon-btn {
        width: 34px;
        height: 34px;
        border-radius: 999px;
        border: 1px solid rgba(15, 23, 42, 0.96);
        background: radial-gradient(circle at 50% 0, #020617, #020617 60%, #000 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        transition:
            background var(--fast) ease-out,
            color var(--fast) ease-out,
            border-color var(--fast) ease-out,
            box-shadow var(--fast) ease-out;
    }

    .vision-stage__toolbar-icon-btn svg {
        width: 16px;
        height: 16px;
        stroke-width: 1.5;
    }

    .vision-stage__toolbar-icon-btn:hover {
        border-color: rgba(148, 163, 184, 0.95);
        color: #e5e7eb;
        box-shadow: 0 16px 36px rgba(0, 0, 0, 0.9);
    }

    .vision-stage__actions {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 14px;
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }

    .vision-stage__action-link {
        display: inline-flex;
        align-items: center;
        gap: 7px;
        cursor: pointer;
    }

    .vision-stage__action-link--primary {
        color: #f9fafb;
        font-weight: 600;
    }

    .vision-stage__action-link:hover {
        color: #e5e7eb;
    }

    .vision-stage__divider-vertical {
        width: 1px;
        height: 16px;
        background: rgba(31, 41, 55, 0.95);
    }

    .vision-stage__feed-header {
        font-size: 15px;
        font-weight: 700;
        margin-top: 2px;
    }

    .vision-stage__feed-wrapper {
        flex: 1;
        min-height: 0;
        display: flex;
        gap: 16px;
        overflow: hidden;
    }

    .vision-stage__feed-scroll {
        flex: 1;
        min-height: 0;
        max-height: 100%;
        overflow-y: auto;
        padding-right: 4px;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .vision-stage__history-rail {
        width: var(--history-rail-width);
        flex-shrink: 0;
        border-left: 1px solid rgba(15, 23, 42, 0.95);
        padding-left: 10px;
        margin-left: 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 100%;
        overflow-y: auto;
    }

    .vision-stage__history-thumb {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid transparent;
        cursor: pointer;
        opacity: 0.8;
        transition:
            border-color var(--fast) ease-out,
            box-shadow var(--fast) ease-out,
            opacity var(--fast) ease-out,
            transform var(--fast) ease-out;
        background: #020617;
    }

    .vision-stage__history-thumb img,
    .vision-stage__history-thumb video {
        width: 100%;
        aspect-ratio: 9 / 16;
        object-fit: cover;
        display: block;
    }

    .vision-stage__history-thumb-badge {
        position: absolute;
        bottom: 4px;
        right: 4px;
        padding: 2px 5px;
        border-radius: 999px;
        font-size: 9px;
        background: rgba(15, 23, 42, 0.96);
        color: #e5e7eb;
    }

    .vision-stage__history-thumb--active {
        opacity: 1;
        border-color: #22c55e;
        box-shadow:
            0 0 0 1px rgba(34, 197, 94, 0.8),
            0 0 22px rgba(34, 197, 94, 0.9);
        transform: translateY(-1px);
    }

    /* Card (preview item) base --------------------------------------------- */

    .vision-card {
        border-radius: 22px;
        border: 1px solid rgba(15, 23, 42, 0.95);
        background: radial-gradient(circle at 10% 0, #0b1120, #020617 70%);
        box-shadow:
            0 0 0 1px rgba(15, 23, 42, 0.95),
            0 26px 60px rgba(0, 0, 0, 0.96);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .vision-card__media {
        width: 100%;
        aspect-ratio: 16 / 9;
        background: #020617;
        overflow: hidden;
        position: relative;
    }

    .vision-card__media img,
    .vision-card__media video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .vision-card__media-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        padding: 10px 12px;
        background: linear-gradient(
            to top,
            rgba(15, 23, 42, 0.85),
            rgba(15, 23, 42, 0.6),
            transparent
        );
        pointer-events: none;
        color: #e5e7eb;
        font-size: 12px;
    }

    .vision-card__media-overlay-left {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .vision-card__media-overlay-right {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .vision-card__media-chip {
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.92);
        border: 1px solid rgba(31, 41, 55, 0.95);
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .vision-card__bottom {
        padding: 10px 12px 11px;
        border-top: 1px solid rgba(15, 23, 42, 0.95);
        background: radial-gradient(circle at 0 0, #020617, #020617 60%, #000 100%);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        font-size: 12px;
        color: var(--text-secondary);
    }

    .vision-card__title-block {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .vision-card__title {
        font-size: 13px;
        font-weight: 600;
        color: #e5e7eb;
    }

    .vision-card__meta {
        font-size: 11px;
        color: var(--text-muted);
    }

    .vision-card__actions {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .vision-card__icon-btn {
        width: 28px;
        height: 28px;
        border-radius: 999px;
        border: 1px solid rgba(31, 41, 55, 0.95);
        background: radial-gradient(circle at 50% 0, #020617, #020617 60%, #000 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        transition:
            background var(--fast) ease-out,
            color var(--fast) ease-out,
            border-color var(--fast) ease-out,
            box-shadow var(--fast) ease-out;
    }

    .vision-card__icon-btn svg {
        width: 16px;
        height: 16px;
        stroke-width: 1.5;
    }

    .vision-card__icon-btn:hover {
        border-color: rgba(148, 163, 184, 0.95);
        color: #e5e7eb;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.9);
    }

    .vision-card--active {
        border-color: #22c55e;
        box-shadow:
            0 0 0 1px rgba(34, 197, 94, 0.8),
            0 26px 62px rgba(34, 197, 94, 0.9);
    }
    /* ====================================================================== */
/* SURGICAL ADDITIONS - Reference Previews & Ask SIA                     */
/* ====================================================================== */

/* Kling-style prominent reference image preview container */
.reference-preview-large {
    width: 100%;
    /* Default aspect, can be overridden via JS if needed */
    aspect-ratio: 16 / 9;
    background: #020617;
    border-radius: 14px;
    border: 1px solid rgba(31, 41, 55, 0.95);
    overflow: hidden;
    display: none; /* Hidden until image added */
    margin-bottom: 12px;
    position: relative;
}

/* Class added via JS when an image is loaded */
.reference-preview-large.has-image {
    display: block;
}

.reference-preview-large img {
    width: 100%;
    height: 100%;
    object-fit: contain; /* Ensure whole image is visible like Kling */
}

/* Small "Ask SIA" magic button next to prompt labels */
.ask-sia-prompt-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    border-radius: 6px;
    border: 1px solid rgba(34, 197, 94, 0.3);
    background: rgba(34, 197, 94, 0.1);
    color: #4ade80;
    cursor: pointer;
    transition: all 0.2s ease;
}

.ask-sia-prompt-btn:hover {
    background: rgba(34, 197, 94, 0.2);
    border-color: rgba(34, 197, 94, 0.6);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
}

.ask-sia-prompt-btn svg {
    width: 14px;
    height: 14px;
}

/* Label container to hold the label text and the new button */
.prompt-label-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}
/* ====================================================================== */
/* SULANDRA UPLOAD BOX STYLE                                             */
/* ====================================================================== */

.sulandra-upload-box {
    width: 100%;
    aspect-ratio: 16 / 9; /* Cinematic shape */
    background: #0f172a;  /* Darker background */
    border-radius: 16px;
    border: 1px dashed rgba(51, 65, 85, 0.8);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.2s ease;
    margin-bottom: 16px;
    text-align: center;
}

.sulandra-upload-box:hover {
    border-color: #22c55e; /* Green accent on hover */
    background: #1e293b;
}

/* The Placeholder content (Icon + Text) */
.sulandra-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    color: #9ca3af;
    pointer-events: none; /* Clicks pass through to the label */
    padding: 20px;
}

.sulandra-placeholder svg {
    width: 32px;
    height: 32px;
    color: #4ade80; /* Accent color icon */
    opacity: 0.8;
}

.sulandra-placeholder-title {
    font-size: 13px;
    font-weight: 600;
    color: #e5e7eb;
}

.sulandra-placeholder-sub {
    font-size: 11px;
    color: #64748b;
}

/* The Image Preview (Hidden by default) */
.sulandra-preview-img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: contain; /* Show full image */
    background: #000;
    z-index: 10;
    display: none;
}

/* State: When file is selected */
.sulandra-upload-box.has-file .sulandra-preview-img {
    display: block;
}

.sulandra-upload-box.has-file .sulandra-placeholder {
    display: none;
}

/* Remove button (appears on hover when file exists) */
.sulandra-remove-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    background: rgba(0,0,0,0.6);
    border-radius: 50%;
    color: white;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 20;
    border: 1px solid rgba(255,255,255,0.2);
}

.sulandra-upload-box.has-file:hover .sulandra-remove-btn {
    display: flex;
}
/* Compact version for dual frames and list items */
.sulandra-upload-box.compact {
    aspect-ratio: 16 / 9;
    min-height: 80px;
    margin-bottom: 8px;
}

.sulandra-upload-box.compact .sulandra-placeholder {
    padding: 10px;
    gap: 4px;
}

.sulandra-upload-box.compact .sulandra-placeholder svg {
    width: 20px;
    height: 20px;
}

.sulandra-upload-box.compact .sulandra-placeholder-title {
    font-size: 11px;
}

.sulandra-upload-box.compact .sulandra-placeholder-sub {
    display: none; /* Hide subtitle to save space */
}
/* ====================================================================== */
/* ASK SIA - SIDE PANEL & STYLES                                        */
/* ====================================================================== */

.ask-sia-panel-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none; /* Hidden by default */
    justify-content: flex-end;
    z-index: 99999; /* Above everything */
    backdrop-filter: blur(2px);
}

.ask-sia-panel {
    width: 380px;
    max-width: 90%;
    height: 100%;
    background: radial-gradient(circle at 0% 0%, rgba(69,241,255,0.1), transparent 60%),
                radial-gradient(circle at 100% 100%, rgba(34, 197, 94, 0.1), transparent 60%),
                #020617;
    border-left: 1px solid rgba(255,255,255,0.1);
    box-shadow: -8px 0 40px rgba(0,0,0,0.8);
    display: flex;
    flex-direction: column;
    padding: 16px;
    animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes slideInRight {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

.ask-sia-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.ask-sia-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    font-weight: 700;
    color: #e5e7eb;
}

.ask-sia-icon-large {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: conic-gradient(from 210deg, #ff5af1, #45f1ff, #ffd15a, #ff5af1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 800;
    color: #000;
    box-shadow: 0 0 15px rgba(69,241,255,0.5);
}

.ask-sia-close {
    cursor: pointer;
    color: #9ca3af;
    padding: 4px;
}
.ask-sia-close:hover { color: #fff; }

.ask-sia-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 16px;
    overflow-y: auto;
}

.ask-sia-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #6b7280;
    margin-bottom: 6px;
}

.ask-sia-context-box {
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 10px;
    font-size: 11px;
    color: #9ca3af;
    font-family: 'JetBrains Mono', monospace;
}

.ask-sia-textarea {
    width: 100%;
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 10px;
    padding: 10px;
    color: #fff;
    font-size: 12px;
    resize: vertical;
    min-height: 80px;
}
.ask-sia-textarea:focus { border-color: #4ade80; }

.ask-sia-answer-box {
    flex: 1;
    background: rgba(34, 197, 94, 0.03);
    border: 1px solid rgba(34, 197, 94, 0.15);
    border-radius: 10px;
    padding: 12px;
    font-size: 12px;
    color: #e5e7eb;
    line-height: 1.6;
}

.ask-sia-main-btn {
    width: 100%;
    padding: 10px;
    border-radius: 99px;
    background: linear-gradient(135deg, #22c55e, #4ade80);
    color: #022c22;
    font-weight: 600;
    font-size: 12px;
    margin-top: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.ask-sia-main-btn:hover { opacity: 0.9; transform: translateY(-1px); }
/* ====================================================================== */
/* ASK SIA - SIDE PANEL STYLES                                            */
/* ====================================================================== */

.ask-sia-panel-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none; /* Hidden by default */
    justify-content: flex-end;
    z-index: 99999;
    backdrop-filter: blur(2px);
}

.ask-sia-panel {
    width: 380px;
    max-width: 90%;
    height: 100%;
    background: radial-gradient(circle at 0% 0%, rgba(69,241,255,0.1), transparent 60%),
                radial-gradient(circle at 100% 100%, rgba(34, 197, 94, 0.1), transparent 60%),
                #020617;
    border-left: 1px solid rgba(255,255,255,0.1);
    box-shadow: -8px 0 40px rgba(0,0,0,0.8);
    display: flex;
    flex-direction: column;
    padding: 16px;
    animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes slideInRight {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

.ask-sia-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.ask-sia-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    font-weight: 700;
    color: #e5e7eb;
}

.ask-sia-icon-large {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: conic-gradient(from 210deg, #ff5af1, #45f1ff, #ffd15a, #ff5af1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 800;
    color: #000;
    box-shadow: 0 0 15px rgba(69,241,255,0.5);
}

.ask-sia-close {
    cursor: pointer;
    color: #9ca3af;
    padding: 4px;
}
.ask-sia-close:hover { color: #fff; }

.ask-sia-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 16px;
    overflow-y: auto;
}

.ask-sia-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #6b7280;
    margin-bottom: 6px;
}

.ask-sia-context-box {
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 10px;
    font-size: 11px;
    color: #9ca3af;
    font-family: 'JetBrains Mono', monospace;
    max-height: 100px;
    overflow-y: auto;
}

.ask-sia-textarea {
    width: 100%;
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 10px;
    padding: 10px;
    color: #fff;
    font-size: 12px;
    resize: vertical;
    min-height: 80px;
}
.ask-sia-textarea:focus { border-color: #4ade80; }

.ask-sia-answer-box {
    flex: 1;
    background: rgba(34, 197, 94, 0.03);
    border: 1px solid rgba(34, 197, 94, 0.15);
    border-radius: 10px;
    padding: 12px;
    font-size: 12px;
    color: #e5e7eb;
    line-height: 1.6;
    overflow-y: auto;
}

.ask-sia-main-btn {
    width: 100%;
    padding: 10px;
    border-radius: 99px;
    background: linear-gradient(135deg, #22c55e, #4ade80);
    color: #022c22;
    font-weight: 600;
    font-size: 12px;
    margin-top: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
}
/* ====================================================================== */
/* SULANDRA NEON TRIGGER (Sparkling Text)                                */
/* ====================================================================== */

.sulandra-neon-trigger {
    font-family: 'Cinzel', serif;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.08em;
    color: #e2e8f0;
    cursor: pointer;
    text-transform: uppercase;
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-left: auto; /* Push to right */
    
    /* The Neon Glow */
    text-shadow: 
        0 0 2px rgba(255,255,255,0.8),
        0 0 8px rgba(34, 197, 94, 0.8),
        0 0 15px rgba(34, 197, 94, 0.6);
    
    transition: all 0.3s ease;
    animation: sulandra-pulse 3s infinite alternate;
}

/* Sparkle icon pseudo-element */
.sulandra-neon-trigger::before {
    content: "✦";
    font-size: 10px;
    color: #86efac;
    text-shadow: 0 0 5px #fff;
    animation: sulandra-sparkle 1.5s infinite linear;
}

.sulandra-neon-trigger:hover {
    color: #fff;
    text-shadow: 
        0 0 4px #fff,
        0 0 10px #4ade80,
        0 0 20px #4ade80,
        0 0 30px #22c55e;
    transform: scale(1.02);
}

@keyframes sulandra-pulse {
    0% { opacity: 0.9; }
    100% { opacity: 1; text-shadow: 0 0 4px #fff, 0 0 12px #22c55e, 0 0 25px #22c55e; }
}

@keyframes sulandra-sparkle {
    0% { opacity: 0.5; transform: scale(0.8) rotate(0deg); }
    50% { opacity: 1; transform: scale(1.2) rotate(180deg); }
    100% { opacity: 0.5; transform: scale(0.8) rotate(360deg); }
}
/* ====================================================================== */
/* SULANDRA NEON TRIGGER (Sparkling Text)                                */
/* ====================================================================== */

.sulandra-neon-trigger {
    font-family: 'Cinzel', serif; /* Matches your logo font for elegance */
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.08em;
    color: #e2e8f0;
    cursor: pointer;
    text-transform: uppercase;
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    
    /* The Neon Glow */
    text-shadow: 
        0 0 2px rgba(255,255,255,0.8),
        0 0 8px rgba(34, 197, 94, 0.8),
        0 0 15px rgba(34, 197, 94, 0.6);
    
    transition: all 0.3s ease;
    animation: sulandra-pulse 3s infinite alternate;
}

/* Sparkle icon (optional pseudo-element) */
.sulandra-neon-trigger::before {
    content: "✦";
    font-size: 10px;
    color: #86efac; /* Lighter green */
    text-shadow: 0 0 5px #fff;
    animation: sulandra-sparkle 1.5s infinite linear;
}

.sulandra-neon-trigger:hover {
    color: #fff;
    text-shadow: 
        0 0 4px #fff,
        0 0 10px #4ade80,
        0 0 20px #4ade80,
        0 0 30px #22c55e;
    transform: scale(1.02);
}

@keyframes sulandra-pulse {
    0% { opacity: 0.9; }
    100% { opacity: 1; text-shadow: 0 0 4px #fff, 0 0 12px #22c55e, 0 0 25px #22c55e; }
}

@keyframes sulandra-sparkle {
    0% { opacity: 0.5; transform: scale(0.8) rotate(0deg); }
    50% { opacity: 1; transform: scale(1.2) rotate(180deg); }
    100% { opacity: 0.5; transform: scale(0.8) rotate(360deg); }
}
</style>
</head>
<body>
<div class="vision-root">

    <!-- =============================================================== -->
    <!--  LEFT SIDEBAR – Sulandra Nav                                   -->
    <!-- =============================================================== -->
    <aside class="vision-sidebar">
        <div class="vision-sidebar__logo">
            <div class="vision-sidebar__logo-inner">
                S
            </div>
        </div>

        <nav class="vision-nav" aria-label="Main navigation">
            <!-- Home / Feed -->
            <button class="vision-nav__item" data-nav="home" title="Home">
                <svg viewBox="0 0 24 24" fill="none">
                    <path d="M4 11L12 4L20 11" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M6 10.5V19H10.5V14.5H13.5V19H18V10.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>

            <!-- Vision Lab (current) -->
<button class="vision-nav__item vision-nav__item--active" data-lab-nav="image" title="Image Lab">
    <svg viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="1.5"/><circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/><path d="M21 15L16 10L5 21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
</button>

<button class="vision-nav__item" data-lab-nav="video" title="Video Lab">
    <svg viewBox="0 0 24 24" fill="none"><path d="M15 10L20 7V17L15 14V10Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><rect x="4" y="6" width="11" height="12" rx="2" stroke="currentColor" stroke-width="1.5"/></svg>
</button>

<button class="vision-nav__item" data-lab-nav="shortfilm" title="Short Film Lab">
    <svg viewBox="0 0 24 24" fill="none"><path d="M19.82 2H4.18C2.97602 2 2 2.97602 2 4.18V19.82C2 21.024 2.97602 22 4.18 22H19.82C21.024 22 22 21.024 22 19.82V4.18C22 2.97602 21.024 2 19.82 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 2V22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M17 2V22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 12H22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 7H7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 17H7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M17 17H22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M17 7H22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
</button>

            <!-- Sound Lab placeholder -->
            <button class="vision-nav__item" data-nav="sound" title="Sound Lab">
                <svg viewBox="0 0 24 24" fill="none">
                    <path d="M5 9V15" stroke="currentColor" stroke-linecap="round"/>
                    <path d="M9 7V17" stroke="currentColor" stroke-linecap="round"/>
                    <path d="M13 5V19" stroke="currentColor" stroke-linecap="round"/>
                    <path d="M17 8V16" stroke="currentColor" stroke-linecap="round"/>
                </svg>
            </button>

            <!-- Studio placeholder -->
            <button class="vision-nav__item" data-nav="studio" title="Sulandra Studio">
                <svg viewBox="0 0 24 24" fill="none">
                    <rect x="3.5" y="4.5" width="17" height="15" rx="2" stroke="currentColor"/>
                    <path d="M3.5 9.5H20.5" stroke="currentColor"/>
                    <path d="M10 14H14" stroke="currentColor" stroke-linecap="round"/>
                </svg>
            </button>

            <!-- Explore / School placeholder -->
            <button class="vision-nav__item" data-nav="school" title="Sulandra School of Arts">
                <svg viewBox="0 0 24 24" fill="none">
                    <path d="M4 9L12 4L20 9L12 14L4 9Z" stroke="currentColor" stroke-linejoin="round"/>
                    <path d="M6 10.5V15.5C8 18 10 19 12 19C14 19 16 18 18 15.5V10.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </nav>

        <div class="vision-sidebar__footer">
            <div class="vision-sidebar__credits">
                <div class="vision-sidebar__credits-dot"></div>
                <div>Sulandra Creative Network</div>
                <div class="text-muted" style="font-size:10px;">Vision · RunPod · SIA Brain</div>
            </div>
            <div class="vision-sidebar__sale">
                SAVE<br>50% OFF
            </div>
            <div class="vision-sidebar__user" title="Account">
                <svg viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="9" r="3" stroke="currentColor"/>
                    <path d="M6 19C7.5 16.5 9.5 15.25 12 15.25C14.5 15.25 16.5 16.5 18 19" stroke="currentColor" stroke-linecap="round"/>
                </svg>
            </div>
        </div>
    </aside>

    <!-- =============================================================== -->
    <!--  APP SHELL – HEADER & MAIN SPLIT                               -->
    <!-- =============================================================== -->
    <div class="vision-app">

        <!-- =========================================================== -->
        <!--  TOP HEADER                                                 -->
        <!-- =========================================================== -->
        <header class="vision-header">
            <div class="vision-header__left">
                <div class="vision-header__title-block">
                    <div class="vision-header__title">Sulandra Vision Lab</div>
                    <div class="vision-header__subtitle">
                        Unified AI Image · Video · Short Film generator – powered by Sulandra on RunPod
                    </div>
                </div>

                <!-- Model pill -->
                <button class="vision-header__model-pill" type="button" id="model-pill">
                    <span class="vision-header__model-pill-status"></span>
                    <span>Sulandra Vision Flux&nbsp;2.0</span>
                    <svg class="vision-header__model-pill-chevron" viewBox="0 0 12 8" fill="none">
                        <path d="M2 2L6 6L10 2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>

                <!-- Main lab tabs -->
               
            </div>

            <div class="vision-header__right">
                <!-- Create / View toggle -->
                <div class="vision-header__view-pills" id="mode-toggle">
                    <button
                        class="vision-header__view-btn vision-header__view-btn--active"
                        data-mode="create"
                        type="button"
                    >
                        Create
                    </button>
                    <button
                        class="vision-header__view-btn"
                        data-mode="view"
                        type="button"
                    >
                        My Files
                    </button>
                </div>

                <!-- Favorites toggle -->
                <label class="vision-header__favorites-toggle">
                    <input type="checkbox" id="favorites-toggle-checkbox" />
                    <span>Show favorites only</span>
                </label>

                <!-- Assets button (opens assets panel / right drawer later) -->
                <button class="vision-header__assets-btn" type="button" id="open-assets-btn">
                    <svg viewBox="0 0 24 24" fill="none">
                        <rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor"/>
                        <path d="M3 9H21" stroke="currentColor"/>
                        <path d="M9 14H15" stroke="currentColor" stroke-linecap="round"/>
                    </svg>
                    <span>Assets</span>
                </button>
            </div>
        </header>

        <!-- =========================================================== -->
        <!--  MAIN AREA – CONFIG PANEL + STAGE                          -->
        <!-- =========================================================== -->
        <main class="vision-main">

            <!-- ======================================================= -->
            <!--  LEFT: CONFIG PANEL (per-lab controls)                 -->
            <!-- ======================================================= -->
            <section class="vision-config-panel" aria-label="Generation controls">
                <div class="vision-config-panel__body">

                    <!-- =================================================== -->
                    <!--  IMAGE LAB CONFIG                                   -->
                    <!-- =================================================== -->
<div class="lab-config" id="lab-config-image" data-lab="image">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <div>
            <div style="font-size:15px;font-weight:600;">Image Generator</div>
            <div class="text-muted" style="font-size:12px;margin-top:2px;">
                Text-to-Image · Image-to-Image · Styles · Aspect ratios
            </div>
        </div>
        <div class="pill-switch" id="image-mode-switch">
            <button
                type="button"
                class="pill-switch__btn pill-switch__btn--active"
                data-image-mode="text"
            >
                Text → Image
            </button>
            <button
                type="button"
                class="pill-switch__btn"
                data-image-mode="image"
            >
                Image → Image
            </button>
        </div>
    </div>

    <div id="image-reference-block" style="margin-bottom:16px; display:none;">
    <div class="text-soft" style="font-size:12px;margin-bottom:6px;">Reference image</div>
    
    <label class="sulandra-upload-box" id="image-upload-box" for="image-reference-input">
        <div class="sulandra-placeholder">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M12 5V19M5 12H19" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div>
                <div class="sulandra-placeholder-title">Add a start image</div>
                <div class="sulandra-placeholder-sub">Click to upload (JPG/PNG)</div>
            </div>
        </div>
        
        <img id="image-preview-img" class="sulandra-preview-img" alt="Reference Preview" />
        <button type="button" class="sulandra-remove-btn" onclick="clearReference('image'); event.preventDefault();">×</button>
        
        <input id="image-reference-input" type="file" accept="image/*" class="visually-hidden" />
    </label>
</div>

    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:16px;">
        <div>
            <div class="prompt-label-row">
                <label for="image-main-prompt" class="text-soft" style="font-size:12px;">Prompt</label>
                <button type="button" class="ask-sia-prompt-btn" data-target-prompt="image-main-prompt" title="Ask SIA to enhance prompt">
                    <svg viewBox="0 0 24 24" fill="none"><path d="M12 4V20M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M15 9L9 15M9 9L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                </button>
            </div>
            <div style="margin-top:6px;">
                <textarea
                    id="image-main-prompt"
                    rows="4"
                    placeholder="Describe the image you want Sulandra to create..."
                    style="width:100%;border-radius:16px;border:1px solid rgba(31,41,55,0.95);padding:10px 12px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-primary);resize:vertical;min-height:90px;"
                ></textarea>
            </div>
        </div>

        <div>
            <div class="prompt-label-row">
                <label for="image-negative-prompt" class="text-soft" style="font-size:12px;">Negative prompt</label>
                <button type="button" class="ask-sia-prompt-btn" data-target-prompt="image-negative-prompt" title="Ask SIA for negative ideas">
                    <svg viewBox="0 0 24 24" fill="none"><path d="M12 4V20M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M15 9L9 15M9 9L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                </button>
            </div>
            <div style="margin-top:6px;">
                <textarea
                    id="image-negative-prompt"
                    rows="2"
                    placeholder="Things to avoid (blur, watermark, distortion, etc.)"
                    style="width:100%;border-radius:14px;border:1px solid rgba(31,41,55,0.95);padding:8px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-primary);resize:vertical;min-height:60px;"
                ></textarea>
            </div>
        </div>
    </div>

    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:14px;">
        <div style="display:flex;gap:10px;">
            <div style="flex:1;">
                <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Aspect ratio</div>
                <div class="pill-switch" id="image-aspect-switch">
                    <button type="button" class="pill-switch__btn pill-switch__btn--active" data-image-aspect="1:1">1:1</button>
                    <button type="button" class="pill-switch__btn" data-image-aspect="16:9">16:9</button>
                    <button type="button" class="pill-switch__btn" data-image-aspect="9:16">9:16</button>
                </div>
            </div>
        </div>

        <div style="display:flex;gap:10px;">
            <div style="flex:1;">
                <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Style preset</div>
                <select id="image-style-select" style="width:100%;border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:7px 12px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:12px;">
                    <option value="natural">Natural photo</option>
                    <option value="cinematic">Cinematic</option>
                    <option value="anime">Anime / Stylized</option>
                    <option value="digital-art">Digital art</option>
                    <option value="3d">3D render</option>
                    <option value="illustration">Illustration</option>
                </select>
            </div>
            <div style="width:120px;">
                <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Guidance</div>
                <input type="range" id="image-guidance-slider" min="1" max="20" value="7" style="width:100%;" />
                <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-muted);margin-top:2px;">
                    <span>Loose</span><span id="image-guidance-value">7</span><span>Strict</span>
                </div>
            </div>
        </div>
    </div>

    <div style="display:flex;gap:10px;margin-bottom:10px;">
        <div style="flex:1;">
            <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Steps</div>
            <input type="number" id="image-steps-input" value="30" min="10" max="80" style="width:100%;border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:7px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:12px;" />
        </div>
        <div style="flex:1;">
            <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Seed</div>
            <input type="number" id="image-seed-input" placeholder="Random" style="width:100%;border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:7px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:12px;" />
        </div>
    </div>

    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;font-size:11px;color:var(--text-muted);">
        <div><span id="image-estimate-res">1024 × 1024</span><span>&nbsp;•</span><span id="image-estimate-cost">~1 credit</span></div>
        <button type="button" id="image-toggle-advanced" style="border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:4px 8px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:11px;">Advanced settings</button>
    </div>

    <div id="image-advanced-panel" class="hidden" style="margin-top:8px;font-size:11px;color:var(--text-secondary);border-radius:14px;border:1px solid rgba(31,41,55,0.95);padding:8px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);">
        <div style="display:flex;flex-direction:column;gap:6px;">
            <label><input type="checkbox" id="image-enable-upscale" /><span>&nbsp;Upscale after generation</span></label>
            <label><input type="checkbox" id="image-enable-face-fix" /><span>&nbsp;Face enhancement</span></label>
            <label><input type="checkbox" id="image-enable-tiling" /><span>&nbsp;Seamless tiling</span></label>
        </div>
    </div>
</div>

                    <!-- =================================================== -->
                    <!--  VIDEO LAB CONFIG                                   -->
                    <!-- =================================================== -->
                    <div class="lab-config hidden" id="lab-config-video" data-lab="video">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <div>
            <div style="font-size:15px;font-weight:600;">Video Generator</div>
            <div class="text-muted" style="font-size:12px;margin-top:2px;">
                Text-to-Video · Image-to-Video · Native audio · Durations
            </div>
        </div>
        <div class="pill-switch" id="video-mode-switch">
            <button
                type="button"
                class="pill-switch__btn pill-switch__btn--active"
                data-video-mode="text"
            >
                Text → Video
            </button>
            <button
                type="button"
                class="pill-switch__btn"
                data-video-mode="image"
            >
                Image → Video
            </button>
        </div>
    </div>

<div id="video-reference-block" style="margin-bottom:16px; display:none;">
    <div style="display:flex; gap:10px;">
        <div style="flex:1;">
            <div class="text-soft" style="font-size:12px;margin-bottom:6px;">Start Frame</div>
            <label class="sulandra-upload-box compact" id="video-start-box" for="video-start-input">
                <div class="sulandra-placeholder">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5 12h14M5 12l6-6m-6 6l6 6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <div class="sulandra-placeholder-title">Start Image</div>
                </div>
                <img id="video-start-img" class="sulandra-preview-img" alt="Start Preview" />
                <button type="button" class="sulandra-remove-btn" onclick="clearReference('video-start'); event.preventDefault();">×</button>
                <input id="video-start-input" type="file" accept="image/*" class="visually-hidden" />
            </label>
        </div>

        <div style="flex:1;">
            <div class="text-soft" style="font-size:12px;margin-bottom:6px;">End Frame (Opt)</div>
            <label class="sulandra-upload-box compact" id="video-end-box" for="video-end-input">
                <div class="sulandra-placeholder">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 12H5m14 0l-6-6m6 6l-6 6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <div class="sulandra-placeholder-title">End Image</div>
                </div>
                <img id="video-end-img" class="sulandra-preview-img" alt="End Preview" />
                <button type="button" class="sulandra-remove-btn" onclick="clearReference('video-end'); event.preventDefault();">×</button>
                <input id="video-end-input" type="file" accept="image/*" class="visually-hidden" />
            </label>
        </div>
    </div>
</div>

    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:16px;">
        <div>
    <div class="prompt-label-row">
        <label for="video-main-prompt" class="text-soft" style="font-size:12px;">Prompt</label>
        <span class="sulandra-neon-trigger" data-target-prompt="video-main-prompt">Ask SIA</span>
    </div>
    <div style="margin-top:6px;">
        <textarea id="video-main-prompt" ... (keep your existing textarea attributes) ...></textarea>
    </div>
</div>

<div>
    <div class="prompt-label-row">
        <label for="video-negative-prompt" class="text-soft" style="font-size:12px;">Negative prompt</label>
        <span class="sulandra-neon-trigger" data-target-prompt="video-negative-prompt">Ask SIA</span>
    </div>
    <div style="margin-top:6px;">
        <textarea id="video-negative-prompt" ... (keep your existing textarea attributes) ...></textarea>
    </div>
</div>

        <div>
            <div class="prompt-label-row">
                <label for="video-negative-prompt" class="text-soft" style="font-size:12px;">Negative prompt</label>
                <button type="button" class="ask-sia-prompt-btn" data-target-prompt="video-negative-prompt" title="Ask SIA for negative ideas">
                    <svg viewBox="0 0 24 24" fill="none"><path d="M12 4V20M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M15 9L9 15M9 9L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                </button>
            </div>
            <div style="margin-top:6px;">
                <textarea
                    id="video-negative-prompt"
                    rows="2"
                    placeholder="Things to avoid (camera shake, artifacts, jitter, etc.)"
                    style="width:100%;border-radius:14px;border:1px solid rgba(31,41,55,0.95);padding:8px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-primary);resize:vertical;min-height:60px;"
                ></textarea>
            </div>
        </div>
    </div>

    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:14px;">
        <div style="display:flex;gap:10px;">
            <div style="flex:1;">
                <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Duration</div>
                <select id="video-duration-select" style="width:100%;border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:7px 12px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:12px;">
                    <option value="5">5 seconds</option>
                    <option value="10" selected>10 seconds</option>
                    <option value="15">15 seconds</option>
                    <option value="20">20 seconds</option>
                </select>
            </div>
            <div style="flex:1;">
                <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Aspect ratio</div>
                <div class="pill-switch" id="video-aspect-switch">
                    <button type="button" class="pill-switch__btn pill-switch__btn--active" data-video-aspect="16:9">16:9</button>
                    <button type="button" class="pill-switch__btn" data-video-aspect="9:16">9:16</button>
                    <button type="button" class="pill-switch__btn" data-video-aspect="1:1">1:1</button>
                </div>
            </div>
        </div>

        <div style="display:flex;gap:10px;align-items:flex-end;">
            <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-secondary);">
                <input type="checkbox" id="video-native-audio-checkbox" />
                <span>Generate native audio</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-secondary);">
                <input type="checkbox" id="video-loop-checkbox" />
                <span>Loop-friendly motion</span>
            </label>
        </div>
    </div>

    <div style="display:flex;gap:10px;margin-bottom:10px;">
        <div style="flex:1;">
            <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Steps / quality</div>
            <input type="number" id="video-steps-input" value="30" min="12" max="80" style="width:100%;border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:7px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:12px;" />
        </div>
        <div style="flex:1;">
            <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Seed</div>
            <input type="number" id="video-seed-input" placeholder="Random" style="width:100%;border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:7px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:12px;" />
        </div>
    </div>

    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;font-size:11px;color:var(--text-muted);">
        <div><span id="video-estimate-res">720p</span><span>&nbsp;•</span><span id="video-estimate-cost">~3 credits</span></div>
        <button type="button" id="video-toggle-advanced" style="border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:4px 8px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:11px;">Advanced motion</button>
    </div>

    <div id="video-advanced-panel" class="hidden" style="margin-top:8px;font-size:11px;color:var(--text-secondary);border-radius:14px;border:1px solid rgba(31,41,55,0.95);padding:8px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);">
        <div style="display:flex;flex-direction:column;gap:6px;">
            <label><input type="checkbox" id="video-cam-move-checkbox" /><span>&nbsp;Enable cinematic camera moves</span></label>
            <label><input type="checkbox" id="video-stabilize-checkbox" /><span>&nbsp;Extra stabilization</span></label>
            <label><input type="checkbox" id="video-high-fps-checkbox" /><span>&nbsp;Higher FPS (slightly slower)</span></label>
        </div>
    </div>
</div>

                    <!-- =================================================== -->
                    <!--  SHORT FILM LAB CONFIG                             -->
                    <!-- =================================================== -->
                    <div class="lab-config hidden" id="lab-config-shortfilm" data-lab="shortfilm">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <div>
            <div style="font-size:15px;font-weight:600;">Short Film Builder</div>
            <div class="text-muted" style="font-size:12px;margin-top:2px;">
                Multi-segment storytelling · Scenes · Transitions · Narrative prompts
            </div>
        </div>
        <div class="badge-pill">
            <span class="tag-dot"></span>
            <span>Storyboard mode</span>
        </div>
    </div>
<div style="margin-bottom:16px;">
    <div class="text-soft" style="font-size:12px;margin-bottom:6px;">Style Reference (Optional)</div>
    
    <label class="sulandra-upload-box" id="shortfilm-upload-box" for="shortfilm-reference-input">
        <div class="sulandra-placeholder">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div>
                <div class="sulandra-placeholder-title">Set film style</div>
                <div class="sulandra-placeholder-sub">Upload an image to guide the look</div>
            </div>
        </div>
        
        <img id="shortfilm-preview-img" class="sulandra-preview-img" alt="Reference Preview" />
        <button type="button" class="sulandra-remove-btn" onclick="clearReference('shortfilm'); event.preventDefault();">×</button>
        
        <input id="shortfilm-reference-input" type="file" accept="image/*" class="visually-hidden" />
    </label>
</div>
   <div class="prompt-label-row">
    <div class="text-soft" style="font-size:12px;">Film title &amp; global prompt</div>
    <span class="sulandra-neon-trigger" data-target-prompt="shortfilm-global-prompt">Ask SIA</span>
</div>

    <input
        id="shortfilm-title-input"
        type="text"
        placeholder="Title of your short film"
        style="width:100%;border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:7px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-primary);font-size:12px;margin-bottom:8px;"
    />
    <textarea
        id="shortfilm-global-prompt"
        rows="3"
        placeholder="Describe the overall story, tone, characters, and style..."
        style="width:100%;border-radius:14px;border:1px solid rgba(31,41,55,0.95);padding:8px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-primary);resize:vertical;min-height:70px;margin-bottom:12px;"
    ></textarea>

    <div class="text-soft" style="font-size:12px;margin-bottom:4px;">
        Segments
    </div>
    <div
        id="shortfilm-segments-container"
        style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px;"
    >
        </div>

    <button
        type="button"
        id="shortfilm-add-segment-btn"
        style="width:100%;border-radius:12px;border:1px dashed rgba(55,65,81,0.9);padding:7px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:12px;display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:12px;"
    >
        <svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;">
            <path d="M12 5V19" stroke="currentColor" stroke-linecap="round"/>
            <path d="M5 12H19" stroke="currentColor" stroke-linecap="round"/>
        </svg>
        <span>Add segment</span>
    </button>

    <div style="display:flex;gap:10px;margin-bottom:10px;font-size:11px;color:var(--text-secondary);">
        <div style="flex:1;">
            <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Aspect ratio</div>
            <div class="pill-switch" id="shortfilm-aspect-switch">
                <button
                    type="button"
                    class="pill-switch__btn pill-switch__btn--active"
                    data-shortfilm-aspect="16:9"
                >
                    16:9
                </button>
                <button
                    type="button"
                    class="pill-switch__btn"
                    data-shortfilm-aspect="9:16"
                >
                    9:16
                </button>
            </div>
        </div>
        <div style="flex:1;">
            <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Total length</div>
            <div id="shortfilm-total-length">~ 20 sec</div>
            <div class="text-muted" style="font-size:10px;">Based on segment durations</div>
        </div>
    </div>
</div>
                    <!-- =================================================== -->
                    <!--  MY FILES / ASSETS CONFIG                          -->
                    <!-- =================================================== -->
                    <div class="lab-config hidden" id="lab-config-assets" data-lab="assets">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
                            <div>
                                <div style="font-size:15px;font-weight:600;">My Files</div>
                                <div class="text-muted" style="font-size:12px;margin-top:2px;">
                                    Browse images, videos, and short films created in Sulandra Vision Lab
                                </div>
                            </div>
                            <div class="pill-switch" id="assets-type-switch">
                                <button
                                    type="button"
                                    class="pill-switch__btn pill-switch__btn--active"
                                    data-assets-type="images"
                                >
                                    Images
                                </button>
                                <button
                                    type="button"
                                    class="pill-switch__btn"
                                    data-assets-type="videos"
                                >
                                    Videos
                                </button>
                                <button
                                    type="button"
                                    class="pill-switch__btn"
                                    data-assets-type="films"
                                >
                                    Films
                                </button>
                            </div>
                        </div>

                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;font-size:11px;color:var(--text-secondary);">
                            <div style="display:flex;align-items:center;gap:8px;">
                                <div class="tag">
                                    <span class="tag-dot"></span>
                                    <span id="assets-count-label">0 items</span>
                                </div>
                                <label style="display:flex;align-items:center;gap:4px;">
                                    <input type="checkbox" id="assets-favorites-only" />
                                    <span>Favorites only</span>
                                </label>
                            </div>
                            <div class="pill-switch" id="assets-layout-switch">
                                <button
                                    type="button"
                                    class="pill-switch__btn pill-switch__btn--active"
                                    data-assets-layout="grid"
                                >
                                    Grid
                                </button>
                                <button
                                    type="button"
                                    class="pill-switch__btn"
                                    data-assets-layout="list"
                                >
                                    List
                                </button>
                            </div>
                        </div>

                        <div style="margin-bottom:10px;">
                            <input
                                id="assets-search-input"
                                type="text"
                                placeholder="Search by prompt, tag, or date..."
                                style="width:100%;border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:7px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-primary);font-size:12px;"
                            />
                        </div>

                        <div
                            id="assets-list-container"
                            style="border-radius:16px;border:1px solid rgba(31,41,55,0.95);padding:6px 2px 6px 0;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);max-height:340px;overflow-y:auto;"
                        >
                            <!-- Assets list items will be populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- ======================================================= -->
                <!--  CONFIG PANEL FOOTER – Generate buttons                -->
                <!-- ======================================================= -->
                <div class="vision-config-panel__footer">
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px;">
                        <div style="display:flex;flex-direction:column;gap:3px;font-size:11px;color:var(--text-secondary);">
                            <div>
                                <span>Credits: </span>
                                <span class="badge-pill badge-pill--accent" id="credits-pill">
                                    <span>SAFE</span>&nbsp;·&nbsp;<span id="credits-count">671</span>
                                </span>
                            </div>
                            <div class="text-muted" style="font-size:10px;">
                                Powered by Sulandra on RunPod · SIA Brain connected
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <button
                                type="button"
                                id="btn-random-prompt"
                                class="vision-card__icon-btn"
                                title="Random idea"
                            >
                                <svg viewBox="0 0 24 24" fill="none">
                                    <path d="M6 7H9L11 10L13 14L15 17H18" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M13 10L15 7H18" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M18 4V7H21" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M6 17H9L11 14" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M6 20V17H3" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>

                            <button
                                type="button"
                                id="btn-generate"
                                style="padding:9px 24px;border-radius:999px;border:none;background:linear-gradient(135deg,#22c55e,#4ade80);color:#022c22;font-size:13px;font-weight:700;box-shadow:0 20px 52px rgba(34,197,94,0.95);display:inline-flex;align-items:center;gap:8px;"
                            >
                                <span id="btn-generate-label">Generate</span>
                                <span style="font-size:11px;opacity:0.9;" id="btn-generate-mode-label">(Image)</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ======================================================= -->
            <!--  RIGHT: STAGE / PREVIEW                                -->
            <!-- ======================================================= -->
            <section class="vision-stage" aria-label="Preview & history">
                <div class="vision-stage__inner">

                    <!-- Stage toolbar row -->
                    <div class="vision-stage__toolbar">
                        <div class="vision-stage__toolbar-left">
                            <!-- Gallery filter tabs -->
                            <div class="pill-switch" id="gallery-filter-switch">
                                <button
                                    type="button"
                                    class="pill-switch__btn pill-switch__btn--active"
                                    data-gallery-filter="all"
                                >
                                    All
                                </button>
                                <button
                                    type="button"
                                    class="pill-switch__btn"
                                    data-gallery-filter="images"
                                >
                                    Images
                                </button>
                                <button
                                    type="button"
                                    class="pill-switch__btn"
                                    data-gallery-filter="videos"
                                >
                                    Videos
                                </button>
                                <button
                                    type="button"
                                    class="pill-switch__btn"
                                    data-gallery-filter="films"
                                >
                                    Films
                                </button>
                            </div>

                            <!-- View type (grid vs vertical) -->
                            <div class="pill-switch" id="gallery-layout-switch">
                                <button
                                    type="button"
                                    class="pill-switch__btn pill-switch__btn--active"
                                    data-gallery-layout="grid"
                                >
                                    Grid
                                </button>
                                <button
                                    type="button"
                                    class="pill-switch__btn"
                                    data-gallery-layout="vertical"
                                >
                                    Vertical
                                </button>
                            </div>

                            <!-- Divider & Ask SIA button -->
                            <div class="vision-stage__divider-vertical"></div>
                            <button
                                type="button"
                                class="vision-card__icon-btn"
                                id="btn-open-ask-sia"
                                title="Ask SIA about this output"
                            >
                                <svg viewBox="0 0 24 24" fill="none">
                                    <path d="M5 11C5 7.686 7.686 5 11 5H13C16.314 5 19 7.686 19 11C19 14.314 16.314 17 13 17H12.5" stroke="currentColor" stroke-linecap="round"/>
                                    <path d="M11.5 17L9 20.5L6.5 17" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                    <circle cx="10" cy="11" r="1" fill="currentColor"/>
                                    <circle cx="14" cy="11" r="1" fill="currentColor"/>
                                </svg>
                            </button>
                        </div>

                        <div class="vision-stage__toolbar-right">
                            <div class="badge-pill">
                                <span class="tag-dot"></span>
                                <span id="gallery-count-label">No items yet</span>
                            </div>

                            <button
                                class="vision-stage__toolbar-icon-btn"
                                type="button"
                                id="btn-gallery-refresh"
                                title="Reload history"
                            >
                                <svg viewBox="0 0 24 24" fill="none">
                                    <path d="M4 4V10H10" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M20 20V14H14" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M6.5 17.5C7.66974 18.6638 9.25798 19.3142 10.9165 19.3142C12.575 19.3142 14.1633 18.6638 15.333 17.5C16.5027 16.3362 17.155 14.7533 17.155 13.095C17.155 11.4367 16.5027 9.85382 15.333 8.69C14.1633 7.52618 12.575 6.87579 10.9165 6.87579C9.25798 6.87579 7.66974 7.52618 6.5 8.69L4 11" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Stage actions description -->
                    <div class="vision-stage__actions">
                        <span>Latest creations</span>
                        <span class="vision-stage__divider-vertical"></span>
                        <button class="vision-stage__action-link vision-stage__action-link--primary" type="button" id="btn-open-gallery-settings">
                            <svg viewBox="0 0 24 24" fill="none" style="width:14px;height:14px;">
                                <path d="M12 8V12L14.5 14.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="12" cy="12" r="8" stroke="currentColor"/>
                            </svg>
                            <span>Gallery settings</span>
                        </button>
                        <span class="vision-stage__divider-vertical"></span>
                        <span class="text-muted">Scroll to browse · click thumbnail to jump</span>
                    </div>

                    <!-- Stage feed + history rail -->
                    <div class="vision-stage__feed-wrapper">
                        <!-- Main scrolling feed -->
                        <div class="vision-stage__feed-scroll" id="gallery-scroll">
                            <div id="gallery-empty-state" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;border-radius:22px;border:1px dashed rgba(31,41,55,0.95);padding:32px 20px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);">
                                <svg viewBox="0 0 24 24" fill="none" style="width:46px;height:46px;margin-bottom:10px;color:var(--text-secondary);">
                                    <rect x="3.5" y="4.5" width="17" height="13" rx="2" stroke="currentColor"/>
                                    <path d="M10 10.5L7.5 14.5H16.5L13.5 10L11.5 12.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                    <circle cx="9" cy="9" r="1" fill="currentColor"/>
                                </svg>
                                <div style="font-size:15px;font-weight:600;margin-bottom:4px;">
                                    Nothing here yet
                                </div>
                                <div class="text-muted" style="font-size:12px;max-width:320px;margin-bottom:10px;">
                                    Generate an image, video, or short film. Your creations will appear here with a continuous scroll and synced history rail.
                                </div>
                                <div class="badge-pill">
                                    <span class="tag-dot"></span>
                                    <span>Ready when you are</span>
                                </div>
                            </div>

                            <!-- Gallery items container – cards are injected via JS -->
                            <div id="gallery-items-container" style="display:flex;flex-direction:column;gap:16px;"></div>
                        </div>

                        <!-- Right-side history rail -->
                        <div class="vision-stage__history-rail" id="history-rail">
                            <!-- History thumbnails are injected via JS -->
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
</div>
</body>
<div class="ask-sia-panel-backdrop" id="askSiaBackdrop">
    <div class="ask-sia-panel">
        <div class="ask-sia-header">
            <div class="ask-sia-title">
                <div class="ask-sia-icon-large">S</div>
                <div>
                    <div>Ask SIA</div>
                    <div style="font-size: 10px; font-weight:400; color:#9ca3af; margin-top:2px;">
                        Sulandra Intelligent Assistant
                    </div>
                </div>
            </div>
            <div class="ask-sia-close" onclick="closeAskSia()">
                <svg viewBox="0 0 24 24" fill="none" style="width:20px;height:20px;">
                    <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
        </div>

        <div class="ask-sia-body">
            <div>
                <div class="ask-sia-label">Current Context</div>
                <div class="ask-sia-context-box" id="askSiaContext">
                    No active context.
                </div>
            </div>

            <div>
                <div class="ask-sia-label">Your Request</div>
                <textarea
                    id="askSiaQuestion"
                    class="ask-sia-textarea"
                    placeholder="E.g. 'Make this prompt more cinematic', 'Fix the lighting description', 'Suggest a camera angle'..."
                ></textarea>
            </div>

            <div style="flex:1; display:flex; flex-direction:column;">
                <div class="ask-sia-label">SIA Response</div>
                <div class="ask-sia-answer-box" id="askSiaAnswer">
                    <span style="color:#6b7280; font-style:italic;">Waiting for input...</span>
                </div>
            </div>

            <button type="button" class="ask-sia-main-btn" onclick="sendAskSia()">
                <span>Generate Suggestion</span>
                <svg viewBox="0 0 24 24" fill="none" style="width:14px;height:14px;"><path d="M5 12h14m-6-6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
        </div>
    </div>
</div>
<script>
/* ====================================================================== */
/*  SULANDRA VISION LAB – SECTION 3                                       */
/*  GLOBAL CONFIG, STATE & CORE UTILITIES                                 */
/*  (Chunk 3 / 8 – paste right after </body>)                             */
/* ====================================================================== */

/* ----------------------------- API CONFIG ------------------------------ */

/**
 * Base URL for your Sulandra Vision backend on RunPod.
 * Replace this with your own endpoint. All generate calls will use it.
 *
 * Example:
 *   const SULANDRA_API_BASE = "https://xxxxxxxx-xxxx-xxxx.runpod.endpoint";
 */
const SULANDRA_API_BASE = "https://YOUR-RUNPOD-ENDPOINT-HERE";

/**
 * Optional: SIA Brain endpoint (Ask SIA).
 * Replace with your FastAPI / Node endpoint that accepts a JSON payload.
 */
const SIA_BRAIN_ENDPOINT = "https://YOUR-SIA-BRAIN-ENDPOINT-HERE";

/* --------------------------- STORAGE KEYS ------------------------------ */

const STORAGE_KEYS = {
    history:   "sulandra_vision_history_v1",
    settings:  "sulandra_vision_settings_v1",
    favorites: "sulandra_vision_favorites_v1",
    assets:    "sulandra_vision_assets_v1"
};

/* --------------------------- GLOBAL STATE ------------------------------ */

let currentLab            = "image";     // 'image' | 'video' | 'shortfilm' | 'assets'
let currentMode           = "create";    // 'create' | 'view'
let currentGalleryFilter  = "all";       // 'all' | 'images' | 'videos' | 'films'
let currentGalleryLayout  = "grid";      // 'grid' | 'vertical'
let currentImageMode      = "text";      // 'text' | 'image'
let currentVideoMode      = "text";      // 'text' | 'image'
let currentAssetsType     = "images";    // 'images' | 'videos' | 'films'
let currentAssetsLayout   = "grid";      // 'grid' | 'list'
let favoritesOnlyGallery  = false;
let favoritesOnlyAssets   = false;
let lightboxCurrentId     = null;        // ID of the item opened in lightbox
let historyInMemory       = [];          // In-memory cache of history items

/* --------------------------- SAFE JSON HELPERS ------------------------- */

/**
 * Safely parse JSON, returning a fallback value if parsing fails.
 */
function safeParseJSON(str, fallback) {
    try {
        if (typeof str !== "string") return fallback;
        const value = JSON.parse(str);
        return value == null ? fallback : value;
    } catch (err) {
        console.warn("[Sulandra] Failed to parse JSON from storage:", err);
        return fallback;
    }
}

/**
 * Load data from localStorage with a fallback.
 */
function loadFromStorage(key, fallback) {
    try {
        const raw = window.localStorage.getItem(key);
        if (raw == null) return fallback;
        return safeParseJSON(raw, fallback);
    } catch (err) {
        console.warn("[Sulandra] Failed to load from storage:", key, err);
        return fallback;
    }
}

/**
 * Save data to localStorage, swallowing errors in case of quota or privacy mode.
 */
function saveToStorage(key, value) {
    try {
        window.localStorage.setItem(key, JSON.stringify(value));
    } catch (err) {
        console.warn("[Sulandra] Failed to save to storage:", key, err);
    }
}

/* ------------------------------- ID HELPER ----------------------------- */

/**
 * Lightweight UUID v4 style ID generator for history items.
 */
function uuidv4() {
    // Not cryptographically secure, but fine for client IDs.
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
        const r = (Math.random() * 16) | 0;
        const v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
}

/* ----------------------------- DOM HELPERS ----------------------------- */

/**
 * Get an element by ID. Logs a warning once if not found (for debugging).
 */
function $(id) {
    return document.getElementById(id);
}

/**
 * Safe set text content of an element by ID.
 */
function setTextContent(id, text) {
    const el = $(id);
    if (el) {
        el.textContent = text;
    }
}

/**
 * Toggle active classes inside a pill-switch style container.
 *
 * @param {HTMLElement} container - parent element
 * @param {string} attrName - data attribute name to match (e.g. 'image-mode')
 * @param {string} value - value to set active
 * @param {string} [btnClass] - button class selector to filter, default 'pill-switch__btn'
 */
function setToggleButtons(container, attrName, value, btnClass) {
    if (!container) return;
    const selector = btnClass || ".pill-switch__btn";
    const buttons = container.querySelectorAll(selector);
    buttons.forEach(function (btn) {
        const v = btn.dataset[attrName];
        const isActive = v === value;
        btn.classList.toggle("pill-switch__btn--active", isActive);
    });
}

/**
 * Smoothly scroll an element into view within its scroll container.
 */
function smoothScrollIntoView(el, block) {
    if (!el) return;
    try {
        el.scrollIntoView({
            behavior: "smooth",
            block: block || "center",
            inline: "nearest"
        });
    } catch (err) {
        // Older browsers: just call without options
        el.scrollIntoView();
    }
}

/* -------------------------- HISTORY NORMALIZATION ---------------------- */

/**
 * Normalizes any generation result (image/video/film) into a standard object
 * that can be used across the gallery, history rail, and My Files.
 *
 * Expected shape:
 *   {
 *     id: string,
 *     kind: 'image' | 'video' | 'shortfilm',
 *     url: string,         // main media URL
 *     thumb: string,       // thumbnail URL (if different from url)
 *     title: string,
 *     prompt: string,
 *     negativePrompt: string,
 *     createdAt: number,   // timestamp
 *     duration: number|null,
 *     aspect: string,      // "1:1" | "16:9" | "9:16"
 *     meta: object,
 *     isFavorite: boolean
 *   }
 */
function normalizeHistoryItem(raw) {
    if (!raw) raw = {};
    const now = Date.now();
    const id = raw.id || uuidv4();

    // Kind / lab
    let kind = raw.kind || raw.type || "image";
    if (kind === "film" || kind === "short") {
        kind = "shortfilm";
    }

    // URLs
    const url = raw.url || raw.mediaUrl || "";
    const thumb = raw.thumb || raw.thumbnail || url;

    // Text
    const prompt = raw.prompt || raw.text || "";
    const negativePrompt = raw.negativePrompt || raw.negative || "";
    const title =
        raw.title ||
        (kind === "image"
            ? "Image"
            : kind === "video"
            ? "Video"
            : "Short Film");

    // Aspect
    let aspect = raw.aspect || "1:1";
    if (!aspect || typeof aspect !== "string") {
        aspect = "1:1";
    }

    // Duration (for video & film)
    let duration = null;
    if (kind === "video" || kind === "shortfilm") {
        if (typeof raw.duration === "number") {
            duration = raw.duration;
        } else if (raw.meta && typeof raw.meta.duration === "number") {
            duration = raw.meta.duration;
        }
    }

    const createdAt = typeof raw.createdAt === "number" ? raw.createdAt : now;
    const isFavorite = !!raw.isFavorite;

    const meta = Object.assign(
        {},
        raw.meta || {},
        {
            seed: raw.seed,
            steps: raw.steps,
            guidance: raw.guidance,
            style: raw.style,
            model: raw.model || "Sulandra Vision Flux 2.0",
            creditsUsed: raw.creditsUsed
        }
    );

    return {
        id: id,
        kind: kind,
        url: url,
        thumb: thumb,
        title: title,
        prompt: prompt,
        negativePrompt: negativePrompt,
        createdAt: createdAt,
        duration: duration,
        aspect: aspect,
        meta: meta,
        isFavorite: isFavorite
    };
}

/* ====================================================================== */
/*  SULANDRA VISION LAB – SECTION 4                                       */
/*  HISTORY SYSTEM & GALLERY RENDERING                                    */
/* ====================================================================== */

/* --------------------------- HISTORY LOAD ------------------------------ */

/**
 * Load history from localStorage into memory.
 */
function loadHistoryFromStorage() {
    const raw = loadFromStorage(STORAGE_KEYS.history, []);
    if (!Array.isArray(raw)) return [];
    historyInMemory = raw.map(normalizeHistoryItem);
    return historyInMemory;
}

/**
 * Save full history array to localStorage.
 */
function saveHistoryToStorage() {
    saveToStorage(STORAGE_KEYS.history, historyInMemory);
}

/**
 * Add a new item to history.
 */
function addHistoryItem(item) {
    const normalized = normalizeHistoryItem(item);
    historyInMemory.unshift(normalized); // newest first
    saveHistoryToStorage();
    return normalized;
}

/**
 * Mark or unmark favorite.
 */
function toggleFavorite(historyId, value) {
    const item = historyInMemory.find(x => x.id === historyId);
    if (!item) return;

    if (typeof value === "boolean") {
        item.isFavorite = value;
    } else {
        item.isFavorite = !item.isFavorite;
    }

    saveHistoryToStorage();
}

/**
 * Delete an item from history.
 */
function deleteHistoryItem(historyId) {
    historyInMemory = historyInMemory.filter(x => x.id !== historyId);
    saveHistoryToStorage();
}

/**
 * Returns filtered history according to current lab, gallery filter,
 * and favorites toggle.
 */
function getFilteredHistory() {
    let items = [...historyInMemory];

    // 1. By current gallery tab (All / Images / Videos / Films)
    if (currentGalleryFilter === "images") {
        items = items.filter(x => x.kind === "image");
    } else if (currentGalleryFilter === "videos") {
        items = items.filter(x => x.kind === "video");
    } else if (currentGalleryFilter === "films") {
        items = items.filter(x => x.kind === "shortfilm");
    }

    // 2. Favorites only?
    if (favoritesOnlyGallery) {
        items = items.filter(x => x.isFavorite);
    }

    return items;
}

/**
 * Filter history specifically for the current lab (image/video/shortfilm).
 * Used mainly when user switches labs.
 */
function filterHistoryForLab(lab) {
    if (lab === "image") return historyInMemory.filter(x => x.kind === "image");
    if (lab === "video") return historyInMemory.filter(x => x.kind === "video");
    if (lab === "shortfilm") return historyInMemory.filter(x => x.kind === "shortfilm");
    return [];
}

/* --------------------------- GALLERY RENDERING -------------------------- */

/**
 * Clear the gallery.
 */
function clearGallery() {
    const container = $("gallery-items-container");
    if (container) container.innerHTML = "";
}

/**
 * Render a single gallery card (Image / Video / Film)
 */
function createGalleryCard(item) {
    const card = document.createElement("div");
    card.className = currentGalleryLayout === "grid"
        ? "gallery-card gallery-card--grid"
        : "gallery-card gallery-card--vertical";

    card.dataset.historyId = item.id;

    /* ---------- media element ---------- */
    let mediaHTML = "";
    if (item.kind === "image") {
        mediaHTML = `<img src="${item.url}" class="gallery-card__media">`;
    } else if (item.kind === "video") {
        mediaHTML = `<video src="${item.url}" class="gallery-card__media" muted playsinline></video>`;
    } else {
        mediaHTML = `<video src="${item.url}" class="gallery-card__media" muted playsinline></video>`;
    }

    /* ---------- build card ---------- */
    card.innerHTML = `
        <div class="gallery-card__media-wrapper">
            ${mediaHTML}
        </div>

        <div class="gallery-card__info">
            <div class="gallery-card__title">${item.title}</div>
            <div class="gallery-card__prompt">${item.prompt || "No prompt"}</div>
            <div class="gallery-card__meta">
                <span>${new Date(item.createdAt).toLocaleString()}</span>
                ${item.isFavorite
                    ? `<span class="gallery-card__fav gallery-card__fav--active" data-fav="${item.id}">★</span>`
                    : `<span class="gallery-card__fav" data-fav="${item.id}">☆</span>`
                }
            </div>
        </div>
    `;

    /* ---------- favorite toggle ---------- */
    const favBtn = card.querySelector("[data-fav]");
    favBtn.addEventListener("click", e => {
        e.stopPropagation();
        toggleFavorite(item.id);
        renderGallery();
        renderHistoryRail();
    });

    /* ---------- click to open lightbox ---------- */
    card.addEventListener("click", () => {
        openLightbox(item.id);
    });

    return card;
}

/**
 * Render the full gallery based on filters.
 */
function renderGallery() {
    const items = getFilteredHistory();
    const container = $("gallery-items-container");
    const emptyState = $("gallery-empty-state");

    if (!container) return;

    // Clear old
    container.innerHTML = "";

    if (!items.length) {
        if (emptyState) emptyState.style.display = "flex";
        setTextContent("gallery-count-label", "No items yet");
        return;
    }

    if (emptyState) emptyState.style.display = "none";

    // Build cards
    items.forEach(x => {
        const card = createGalleryCard(x);
        container.appendChild(card);
    });

    // Count
    setTextContent("gallery-count-label", `${items.length} item${items.length === 1 ? "" : "s"}`);
}

/* --------------------------- HISTORY RAIL ------------------------------- */

/**
 * Create a history thumbnail button.
 */
function createHistoryThumb(item) {
    const thumb = document.createElement("button");
    thumb.className = "history-thumb";
    thumb.dataset.historyId = item.id;

    let html = "";
    if (item.kind === "image") {
        html = `<img src="${item.thumb}" class="history-thumb__media">`;
    } else {
        html = `<video src="${item.thumb}" class="history-thumb__media" muted playsinline></video>`;
    }

    thumb.innerHTML = html;

    // click → scroll to gallery card
    thumb.addEventListener("click", () => {
        scrollToHistoryItem(item.id);
    });

    return thumb;
}

/**
 * Rebuild the entire history rail.
 */
function renderHistoryRail() {
    const rail = $("history-rail");
    if (!rail) return;

    rail.innerHTML = "";

    const items = getFilteredHistory();
    items.forEach(x => {
        const thumb = createHistoryThumb(x);
        rail.appendChild(thumb);
    });
}

/**
 * Scroll the gallery to a specific history item.
 */
function scrollToHistoryItem(historyId) {
    const container = $("gallery-items-container");
    if (!container) return;

    const card = container.querySelector(`[data-history-id="${historyId}"]`);
    if (!card) return;

    smoothScrollIntoView(card, "center");
}

/* --------------------------- GALLERY LAYOUT ----------------------------- */

function applyGalleryLayout() {
    const container = $("gallery-items-container");
    if (!container) return;

    container.classList.remove("gallery-layout--grid", "gallery-layout--vertical");

    if (currentGalleryLayout === "grid") {
        container.classList.add("gallery-layout--grid");
    } else {
        container.classList.add("gallery-layout--vertical");
    }
}

/* -------------------------- HISTORY SYNC MASTER ------------------------- */

/**
 * Main function to refresh:
 * 1. gallery  
 * 2. history rail  
 * 3. empty-state  
 * 4. counts
 */
function refreshAllHistoryDisplays() {
    renderGallery();
    renderHistoryRail();
    applyGalleryLayout();
}

/* --------------------------- INITIAL LOAD ------------------------------- */

loadHistoryFromStorage();
refreshAllHistoryDisplays();
/* ====================================================================== */
/*  SULANDRA VISION LAB – SECTION 5                                       */
/*  DYNAMIC CSS, LIGHTBOX VIEWER & ITEM ACTIONS                           */
/* ====================================================================== */

/* -------------------------- DYNAMIC CSS INJECTION ---------------------- */

/**
 * Injects additional CSS for:
 * - gallery-card (16:9 preview layout)
 * - history-thumb
 * - lightbox viewer
 */
function injectDynamicStyles() {
    const css = `
    /* =============================================================== */
    /*  GALLERY CARDS & HISTORY THUMBS                                */
    /* =============================================================== */

    .gallery-layout--grid {
        display: grid !important;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        grid-auto-rows: auto;
        gap: 16px;
    }

    .gallery-layout--vertical {
        display: flex !important;
        flex-direction: column;
        gap: 16px;
    }

    .gallery-card {
        border-radius: 22px;
        border: 1px solid rgba(15, 23, 42, 0.95);
        background: radial-gradient(circle at 10% 0, #0b1120, #020617 70%);
        box-shadow:
            0 0 0 1px rgba(15, 23, 42, 0.95),
            0 26px 60px rgba(0, 0, 0, 0.96);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        cursor: pointer;
        transition:
            transform 140ms ease-out,
            box-shadow 140ms ease-out,
            border-color 140ms ease-out;
    }

    .gallery-card:hover {
        transform: translateY(-2px);
        border-color: rgba(34, 197, 94, 0.85);
        box-shadow:
            0 0 0 1px rgba(34, 197, 94, 0.75),
            0 32px 72px rgba(0, 0, 0, 0.98);
    }

    .gallery-card__media-wrapper {
        width: 100%;
        aspect-ratio: 16 / 9;
        background: #020617;
        overflow: hidden;
        position: relative;
    }

    .gallery-card__media {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .gallery-card__info {
        padding: 10px 12px 12px;
        border-top: 1px solid rgba(15, 23, 42, 0.95);
        background: radial-gradient(circle at 0 0, #020617, #020617 60%, #000 100%);
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-height: 72px;
    }

    .gallery-card__title {
        font-size: 13px;
        font-weight: 600;
        color: #e5e7eb;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    .gallery-card__prompt {
        font-size: 11px;
        color: #9ca3af;
        max-height: 3.2em;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .gallery-card__meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 10px;
        color: #6b7280;
        margin-top: 2px;
    }

    .gallery-card__fav {
        cursor: pointer;
        font-size: 13px;
        padding: 1px 4px;
        border-radius: 999px;
        border: 1px solid transparent;
    }

    .gallery-card__fav--active {
        color: #fbbf24;
        border-color: rgba(251, 191, 36, 0.4);
        background: rgba(24, 24, 27, 0.9);
    }

    .history-thumb {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid transparent;
        cursor: pointer;
        opacity: 0.82;
        transition:
            border-color 140ms ease-out,
            box-shadow 140ms ease-out,
            opacity 140ms ease-out,
            transform 140ms ease-out;
        background: #020617;
    }

    .history-thumb__media {
        width: 100%;
        aspect-ratio: 9 / 16;
        object-fit: cover;
        display: block;
    }

    .history-thumb:hover {
        opacity: 1;
        border-color: rgba(148, 163, 184, 0.9);
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.96);
        transform: translateY(-1px);
    }

    /* =============================================================== */
    /*  LIGHTBOX VIEWER                                               */
    /* =============================================================== */

    .vision-lightbox-backdrop {
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at 0 0, rgba(15, 23, 42, 0.9), rgba(0, 0, 0, 0.98));
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .vision-lightbox-backdrop--visible {
        display: flex;
    }

    .vision-lightbox {
        width: min(1120px, 95vw);
        max-height: 90vh;
        border-radius: 26px;
        border: 1px solid rgba(31, 41, 55, 0.95);
        background: radial-gradient(circle at 0 0, #020617, #020617 60%, #000 100%);
        box-shadow:
            0 0 0 1px rgba(15, 23, 42, 0.95),
            0 38px 90px rgba(0, 0, 0, 0.98);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .vision-lightbox__header {
        padding: 10px 16px 8px;
        border-bottom: 1px solid rgba(31, 41, 55, 0.95);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .vision-lightbox__title-block {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .vision-lightbox__title {
        font-size: 14px;
        font-weight: 600;
        color: #e5e7eb;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .vision-lightbox__subtitle {
        font-size: 11px;
        color: #9ca3af;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .vision-lightbox__badge {
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid rgba(55, 65, 81, 1);
        font-size: 10px;
        color: #9ca3af;
    }

    .vision-lightbox__close-btn {
        width: 30px;
        height: 30px;
        border-radius: 999px;
        border: 1px solid rgba(31, 41, 55, 0.95);
        background: radial-gradient(circle at 50% 0, #020617, #020617 60%, #000 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
        cursor: pointer;
    }

    .vision-lightbox__close-btn:hover {
        border-color: rgba(148, 163, 184, 0.95);
        color: #e5e7eb;
    }

    .vision-lightbox__body {
        display: grid;
        grid-template-columns: minmax(0, 3fr) minmax(260px, 1.5fr);
        gap: 0;
        min-height: 0;
        flex: 1;
    }

    .vision-lightbox__media-panel {
        padding: 10px 10px 12px 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-height: 0;
    }

    .vision-lightbox__media-frame {
        width: 100%;
        aspect-ratio: 16 / 9;
        border-radius: 18px;
        border: 1px solid rgba(31, 41, 55, 0.95);
        background: #020617;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .vision-lightbox__media-frame img,
    .vision-lightbox__media-frame video {
        width: 100%;
        height: 100%;
        object-fit: contain;
        background: #020617;
    }

    .vision-lightbox__media-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        font-size: 11px;
        color: #9ca3af;
    }

    .vision-lightbox__btn-row {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
    }

    .vision-lightbox__icon-btn {
        width: 30px;
        height: 30px;
        border-radius: 999px;
        border: 1px solid rgba(31, 41, 55, 0.95);
        background: radial-gradient(circle at 50% 0, #020617, #020617 60%, #000 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #9ca3af;
    }

    .vision-lightbox__icon-btn:hover {
        border-color: rgba(148, 163, 184, 0.95);
        color: #e5e7eb;
        box-shadow: 0 14px 36px rgba(0, 0, 0, 0.9);
    }

    .vision-lightbox__ask-btn {
        padding: 7px 12px;
        border-radius: 999px;
        border: 1px solid rgba(34, 197, 94, 0.85);
        background: linear-gradient(135deg, #22c55e, #4ade80);
        color: #052e16;
        font-size: 11px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        box-shadow: 0 18px 48px rgba(34, 197, 94, 0.95);
    }

    .vision-lightbox__meta-panel {
        border-left: 1px solid rgba(31, 41, 55, 0.95);
        padding: 10px 14px 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-height: 0;
    }

    .vision-lightbox__meta-section-title {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #9ca3af;
        margin-bottom: 2px;
    }

    .vision-lightbox__meta-block {
        border-radius: 10px;
        border: 1px solid rgba(31, 41, 55, 0.95);
        padding: 6px 8px;
        background: radial-gradient(circle at 0 0, #020617, #020617 60%, #000 100%);
        font-size: 11px;
        color: #e5e7eb;
        max-height: 90px;
        overflow-y: auto;
    }

    .vision-lightbox__meta-row {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: #9ca3af;
    }

    .vision-lightbox__meta-row span:first-child {
        color: #6b7280;
    }
    `;

    const style = document.createElement("style");
    style.textContent = css;
    document.head.appendChild(style);
}

/* ----------------------------- LIGHTBOX DOM ----------------------------- */

let lightboxBackdrop = null;
let lightboxRoot = null;
let lightboxMediaFrame = null;
let lightboxTitleEl = null;
let lightboxSubtitleEl = null;
let lightboxMetaPrompt = null;
let lightboxMetaNegative = null;
let lightboxMetaStats = null;
let lightboxFavBtn = null;
let lightboxCurrentItem = null;

/**
 * Create the lightbox DOM and attach to document.body (once).
 */
function ensureLightboxDOM() {
    if (lightboxBackdrop) return;

    lightboxBackdrop = document.createElement("div");
    lightboxBackdrop.className = "vision-lightbox-backdrop";
    lightboxBackdrop.setAttribute("role", "dialog");
    lightboxBackdrop.setAttribute("aria-modal", "true");

    lightboxRoot = document.createElement("div");
    lightboxRoot.className = "vision-lightbox";

    /* ---------- HEADER ---------- */
    const header = document.createElement("div");
    header.className = "vision-lightbox__header";

    const titleBlock = document.createElement("div");
    titleBlock.className = "vision-lightbox__title-block";

    lightboxTitleEl = document.createElement("div");
    lightboxTitleEl.className = "vision-lightbox__title";

    lightboxSubtitleEl = document.createElement("div");
    lightboxSubtitleEl.className = "vision-lightbox__subtitle";

    titleBlock.appendChild(lightboxTitleEl);
    titleBlock.appendChild(lightboxSubtitleEl);

    const badge = document.createElement("div");
    badge.className = "vision-lightbox__badge";
    badge.id = "lightbox-kind-badge";

    const closeBtn = document.createElement("button");
    closeBtn.className = "vision-lightbox__close-btn";
    closeBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;">
            <path d="M7 7L17 17" stroke="currentColor" stroke-linecap="round"/>
            <path d="M17 7L7 17" stroke="currentColor" stroke-linecap="round"/>
        </svg>
    `;

    closeBtn.addEventListener("click", closeLightbox);

    header.appendChild(titleBlock);
    header.appendChild(badge);
    header.appendChild(closeBtn);

    /* ---------- BODY ---------- */
    const body = document.createElement("div");
    body.className = "vision-lightbox__body";

    // Left: media
    const mediaPanel = document.createElement("div");
    mediaPanel.className = "vision-lightbox__media-panel";

    lightboxMediaFrame = document.createElement("div");
    lightboxMediaFrame.className = "vision-lightbox__media-frame";

    const mediaToolbar = document.createElement("div");
    mediaToolbar.className = "vision-lightbox__media-toolbar";

    const leftBtns = document.createElement("div");
    leftBtns.className = "vision-lightbox__btn-row";

    const btnFullscreen = document.createElement("button");
    btnFullscreen.className = "vision-lightbox__icon-btn";
    btnFullscreen.title = "Open in new tab";
    btnFullscreen.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;">
            <path d="M14 5H19V10" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 19H5V14" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M19 5L13 11" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M5 19L11 13" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    `;
    btnFullscreen.addEventListener("click", () => {
        if (!lightboxCurrentItem) return;
        if (lightboxCurrentItem.url) {
            window.open(lightboxCurrentItem.url, "_blank");
        }
    });

    const btnDownload = document.createElement("button");
    btnDownload.className = "vision-lightbox__icon-btn";
    btnDownload.title = "Download";
    btnDownload.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;">
            <path d="M12 4V14" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 10L12 14L16 10" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M5 18H19" stroke="currentColor" stroke-linecap="round"/>
        </svg>
    `;
    btnDownload.addEventListener("click", () => {
        if (!lightboxCurrentItem || !lightboxCurrentItem.url) return;
        const a = document.createElement("a");
        a.href = lightboxCurrentItem.url;
        const ext = lightboxCurrentItem.kind === "image" ? ".png" : ".mp4";
        a.download = (lightboxCurrentItem.title || "sulandra-output") + ext;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    });

    lightboxFavBtn = document.createElement("button");
    lightboxFavBtn.className = "vision-lightbox__icon-btn";
    lightboxFavBtn.title = "Toggle favorite";
    lightboxFavBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;">
            <path d="M12 17.5L7.5 20L8.25 14.75L4.5 11.25L9.75 10.5L12 5.5L14.25 10.5L19.5 11.25L15.75 14.75L16.5 20L12 17.5Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    `;
    lightboxFavBtn.addEventListener("click", () => {
        if (!lightboxCurrentItem) return;
        toggleFavorite(lightboxCurrentItem.id);
        // update local state
        const updated = historyInMemory.find(x => x.id === lightboxCurrentItem.id);
        if (updated) lightboxCurrentItem = updated;
        refreshAllHistoryDisplays();
        updateLightboxFavoriteState();
    });

    const btnRename = document.createElement("button");
    btnRename.className = "vision-lightbox__icon-btn";
    btnRename.title = "Rename item";
    btnRename.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;">
            <path d="M4 20H9L19 10L14 5L4 15V20Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    `;
    btnRename.addEventListener("click", () => {
        if (!lightboxCurrentItem) return;
        const newName = window.prompt("New title:", lightboxCurrentItem.title || "");
        if (newName && newName.trim()) {
            const item = historyInMemory.find(x => x.id === lightboxCurrentItem.id);
            if (item) {
                item.title = newName.trim();
                saveHistoryToStorage();
                lightboxCurrentItem = item;
                renderGallery();
                renderHistoryRail();
                updateLightboxContent();
            }
        }
    });

    const btnDelete = document.createElement("button");
    btnDelete.className = "vision-lightbox__icon-btn";
    btnDelete.title = "Delete from history";
    btnDelete.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;">
            <path d="M6 7H18" stroke="currentColor" stroke-linecap="round"/>
            <path d="M9 7V5H15V7" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 11V16" stroke="currentColor" stroke-linecap="round"/>
            <path d="M14 11V16" stroke="currentColor" stroke-linecap="round"/>
            <path d="M7 7H17V18C17 18.5523 16.5523 19 16 19H8C7.44772 19 7 18.5523 7 18V7Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    `;
    btnDelete.addEventListener("click", () => {
        if (!lightboxCurrentItem) return;
        const ok = window.confirm("Remove this item from Sulandra history?");
        if (!ok) return;
        const id = lightboxCurrentItem.id;
        deleteHistoryItem(id);
        closeLightbox();
        refreshAllHistoryDisplays();
    });

    leftBtns.appendChild(btnFullscreen);
    leftBtns.appendChild(btnDownload);
    leftBtns.appendChild(lightboxFavBtn);
    leftBtns.appendChild(btnRename);
    leftBtns.appendChild(btnDelete);

    const rightArea = document.createElement("div");
    rightArea.className = "vision-lightbox__btn-row";

    const askBtn = document.createElement("button");
    askBtn.className = "vision-lightbox__ask-btn";
    askBtn.id = "lightbox-ask-sia-btn";
    askBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" style="width:14px;height:14px;">
            <path d="M5 11C5 7.686 7.686 5 11 5H13C16.314 5 19 7.686 19 11C19 14.314 16.314 17 13 17H12.5" stroke="currentColor" stroke-linecap="round"/>
            <path d="M11.5 17L9 20.5L6.5 17" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>Ask SIA about this</span>
    `;

    askBtn.addEventListener("click", () => {
        if (!lightboxCurrentItem) return;
        askSIAAboutItem(lightboxCurrentItem);
    });

    rightArea.appendChild(askBtn);

    mediaToolbar.appendChild(leftBtns);
    mediaToolbar.appendChild(rightArea);

    mediaPanel.appendChild(lightboxMediaFrame);
    mediaPanel.appendChild(mediaToolbar);

    // Right: meta
    const metaPanel = document.createElement("div");
    metaPanel.className = "vision-lightbox__meta-panel";

    const promptTitle = document.createElement("div");
    promptTitle.className = "vision-lightbox__meta-section-title";
    promptTitle.textContent = "Prompt";

    lightboxMetaPrompt = document.createElement("div");
    lightboxMetaPrompt.className = "vision-lightbox__meta-block";

    const negTitle = document.createElement("div");
    negTitle.className = "vision-lightbox__meta-section-title";
    negTitle.textContent = "Negative prompt";

    lightboxMetaNegative = document.createElement("div");
    lightboxMetaNegative.className = "vision-lightbox__meta-block";

    const statsTitle = document.createElement("div");
    statsTitle.className = "vision-lightbox__meta-section-title";
    statsTitle.textContent = "Generation details";

    lightboxMetaStats = document.createElement("div");
    lightboxMetaStats.className = "vision-lightbox__meta-block";

    metaPanel.appendChild(promptTitle);
    metaPanel.appendChild(lightboxMetaPrompt);
    metaPanel.appendChild(negTitle);
    metaPanel.appendChild(lightboxMetaNegative);
    metaPanel.appendChild(statsTitle);
    metaPanel.appendChild(lightboxMetaStats);

    body.appendChild(mediaPanel);
    body.appendChild(metaPanel);

    lightboxRoot.appendChild(header);
    lightboxRoot.appendChild(body);
    lightboxBackdrop.appendChild(lightboxRoot);
    document.body.appendChild(lightboxBackdrop);

    // Click backdrop to close
    lightboxBackdrop.addEventListener("click", (e) => {
        if (e.target === lightboxBackdrop) {
            closeLightbox();
        }
    });

    // ESC key
    window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
            closeLightbox();
        }
    });
}

/* --------------------------- LIGHTBOX CONTENT --------------------------- */

function updateLightboxFavoriteState() {
    if (!lightboxFavBtn || !lightboxCurrentItem) return;
    if (lightboxCurrentItem.isFavorite) {
        lightboxFavBtn.style.color = "#facc15";
        lightboxFavBtn.style.borderColor = "rgba(250, 204, 21, 0.7)";
    } else {
        lightboxFavBtn.style.color = "";
        lightboxFavBtn.style.borderColor = "rgba(31, 41, 55, 0.95)";
    }
}

function updateLightboxContent() {
    if (!lightboxCurrentItem) return;

    const item = lightboxCurrentItem;

    // Title + subtitle
    if (lightboxTitleEl) {
        lightboxTitleEl.textContent = item.title || (item.kind === "image"
            ? "Generated image"
            : item.kind === "video"
            ? "Generated video"
            : "Generated short film");
    }

    const dateStr = new Date(item.createdAt).toLocaleString();
    const kindLabel = item.kind === "image" ? "Image" : item.kind === "video" ? "Video" : "Short Film";

    if (lightboxSubtitleEl) {
        lightboxSubtitleEl.textContent = `${kindLabel} · ${dateStr}`;
    }

    const badgeEl = document.getElementById("lightbox-kind-badge");
    if (badgeEl) {
        badgeEl.textContent = kindLabel;
    }

    // Media
    if (lightboxMediaFrame) {
        lightboxMediaFrame.innerHTML = "";
        if (item.kind === "image") {
            const img = document.createElement("img");
            img.src = item.url;
            img.alt = item.title || "Generated image";
            lightboxMediaFrame.appendChild(img);
        } else {
            const video = document.createElement("video");
            video.src = item.url;
            video.controls = true;
            video.autoplay = false;
            video.muted = false;
            video.playsInline = true;
            lightboxMediaFrame.appendChild(video);
        }
    }

    // Prompts
    if (lightboxMetaPrompt) {
        lightboxMetaPrompt.textContent = item.prompt || "No prompt recorded.";
    }
    if (lightboxMetaNegative) {
        lightboxMetaNegative.textContent = item.negativePrompt || "No negative prompt.";
    }

    // Stats
    if (lightboxMetaStats) {
        const m = item.meta || {};
        const rows = [
            ["Model", m.model || "Sulandra Vision Flux 2.0"],
            ["Aspect", item.aspect || "1:1"],
            ["Duration", item.duration ? `${item.duration}s` : (item.kind === "image" ? "—" : "Unknown")],
            ["Guidance", m.guidance != null ? m.guidance : "Default"],
            ["Steps", m.steps != null ? m.steps : "Default"],
            ["Seed", m.seed != null ? m.seed : "Random"],
            ["Credits used", m.creditsUsed != null ? m.creditsUsed : "Estimated"]
        ];

        lightboxMetaStats.innerHTML = rows.map(row => `
            <div class="vision-lightbox__meta-row">
                <span>${row[0]}</span>
                <span>${row[1]}</span>
            </div>
        `).join("");
    }

    // Favorite state
    updateLightboxFavoriteState();
}

/* --------------------------- LIGHTBOX PUBLIC API ------------------------ */

function openLightbox(historyId) {
    const item = historyInMemory.find(x => x.id === historyId);
    if (!item) return;

    ensureLightboxDOM();

    lightboxCurrentItem = item;
    updateLightboxContent();

    if (lightboxBackdrop) {
        lightboxBackdrop.classList.add("vision-lightbox-backdrop--visible");
    }
}

function closeLightbox() {
    lightboxCurrentItem = null;
    if (lightboxBackdrop) {
        lightboxBackdrop.classList.remove("vision-lightbox-backdrop--visible");
    }
}

/* --------------------------- ASK SIA INTEGRATION ------------------------ */

/**
 * Sends the selected item context to SIA Brain.
 * This is a basic POST; you just replace SIA_BRAIN_ENDPOINT with your real URL.
 */
async function askSIAAboutItem(item) {
    if (!SIA_BRAIN_ENDPOINT || SIA_BRAIN_ENDPOINT.includes("YOUR-SIA-BRAIN-ENDPOINT")) {
        window.alert("Configure SIA_BRAIN_ENDPOINT in the code to enable Ask SIA.");
        return;
    }

    try {
        const payload = {
            id: item.id,
            kind: item.kind,
            url: item.url,
            thumb: item.thumb,
            title: item.title,
            prompt: item.prompt,
            negative_prompt: item.negativePrompt,
            meta: item.meta || {}
        };

        const res = await fetch(SIA_BRAIN_ENDPOINT, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            throw new Error("SIA Brain request failed with status " + res.status);
        }

        const data = await res.json();
        // For now, show a simple alert; you can later connect this to a side panel.
        window.alert("SIA Brain response:\n\n" + (data.answer || JSON.stringify(data, null, 2)));
    } catch (err) {
        console.error("[Sulandra] Ask SIA failed:", err);
        window.alert("Ask SIA failed. Check console for details.");
    }
}

/* ====================================================================== */
/*  SULANDRA VISION LAB – SECTION 6                                       */
/*  LAB SWITCHING, CONTROLS WIRING & GENERATE FLOWS                       */
/* ====================================================================== */

/* ------------------------------ LAB SWITCHING --------------------------- */

function setActiveLab(lab) {
    currentLab = lab;

    // UPDATE: Sidebar Navigation active states
    const navItems = document.querySelectorAll("[data-lab-nav]");
    navItems.forEach(item => {
        const navLab = item.dataset.labNav;
        item.classList.toggle("vision-nav__item--active", navLab === lab);
    });

    // Config panels (visibility)
    const configs = document.querySelectorAll(".lab-config");
    configs.forEach(cfg => {
        const labName = cfg.dataset.lab;
        // Hide all, unless it matches current lab OR it's assets view mode
        let isVisible = labName === lab;
        if (lab === 'assets' && labName === 'assets') isVisible = true;
        cfg.classList.toggle("hidden", !isVisible);
    });

    // If switching to assets via some other means, ensure mode is view
    if (lab === "assets") {
        currentMode = "view";
    } else {
        // If switching to a creation lab, ensure mode is create
        currentMode = "create";
    }
    updateModeToggleButtons();

    // Update generate button label
    const modeLabel = $("btn-generate-mode-label");
    if (modeLabel) {
        if (lab === "image") modeLabel.textContent = "(Image)";
        else if (lab === "video") modeLabel.textContent = "(Video)";
        else if (lab === "shortfilm") modeLabel.textContent = "(Short film)";
        else modeLabel.textContent = "(—)";
    }

    // Default gallery filters
    if (lab === "image") currentGalleryFilter = "images";
    else if (lab === "video") currentGalleryFilter = "videos";
    else if (lab === "shortfilm") currentGalleryFilter = "films";
    else if (lab === "assets") currentGalleryFilter = "all";

    updateGalleryFilterButtons();
    refreshAllHistoryDisplays();
}

/* ----------------------------- MODE TOGGLE ------------------------------ */

function updateModeToggleButtons() {
    const buttons = document.querySelectorAll("#mode-toggle .vision-header__view-btn");
    buttons.forEach(btn => {
        const mode = btn.dataset.mode;
        const active = mode === currentMode;
        btn.classList.toggle("vision-header__view-btn--active", active);
    });

    // If mode is "view", show My Files config; if "create", show lab config.
    const imageCfg = $("lab-config-image");
    const videoCfg = $("lab-config-video");
    const filmCfg  = $("lab-config-shortfilm");
    const assetsCfg = $("lab-config-assets");

    if (currentMode === "view") {
        if (assetsCfg) assetsCfg.classList.remove("hidden");
        if (imageCfg) imageCfg.classList.add("hidden");
        if (videoCfg) videoCfg.classList.add("hidden");
        if (filmCfg)  filmCfg.classList.add("hidden");

        // Map lab → initial assets type
        if (currentLab === "image") currentAssetsType = "images";
        else if (currentLab === "video") currentAssetsType = "videos";
        else if (currentLab === "shortfilm") currentAssetsType = "films";

        updateAssetsTypeButtons();
        renderAssetsList();
    } else {
        // create mode
        if (assetsCfg) assetsCfg.classList.add("hidden");

        if (currentLab === "image" && imageCfg) {
            imageCfg.classList.remove("hidden");
        } else if (currentLab === "video" && videoCfg) {
            videoCfg.classList.remove("hidden");
        } else if (currentLab === "shortfilm" && filmCfg) {
            filmCfg.classList.remove("hidden");
        }
    }
}

/* ------------------------- GALLERY FILTER SWITCH ------------------------ */

function updateGalleryFilterButtons() {
    const container = $("gallery-filter-switch");
    if (!container) return;
    const buttons = container.querySelectorAll(".pill-switch__btn");
    buttons.forEach(btn => {
        const val = btn.dataset.galleryFilter;
        btn.classList.toggle("pill-switch__btn--active", val === currentGalleryFilter);
    });
}

/* ------------------------ GALLERY LAYOUT SWITCH ------------------------- */

function updateGalleryLayoutButtons() {
    const container = $("gallery-layout-switch");
    if (!container) return;
    const buttons = container.querySelectorAll(".pill-switch__btn");
    buttons.forEach(btn => {
        const val = btn.dataset.galleryLayout;
        btn.classList.toggle("pill-switch__btn--active", val === currentGalleryLayout);
    });
}
/* ========================================= */
/* PREVIEW LOGIC (SULANDRA STYLE)           */
/* ========================================= */

function wireReferenceImagePreviews() {
    // Generic setup function
    const setupBox = (inputId, boxId, imgId) => {
        const input = document.getElementById(inputId);
        const box = document.getElementById(boxId);
        const img = document.getElementById(imgId);

        if (!input || !box || !img) return;

        input.addEventListener("change", () => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                    box.classList.add("has-file");
                };
                reader.readAsDataURL(input.files[0]);
            }
        });
    };

    // 1. Image Lab
    setupBox("image-reference-input", "image-upload-box", "image-preview-img");

    // 2. Video Lab (Start & End)
    setupBox("video-start-input", "video-start-box", "video-start-img");
    setupBox("video-end-input", "video-end-box", "video-end-img");
    
    // 3. Short Film (Global Style)
    setupBox("shortfilm-reference-input", "shortfilm-upload-box", "shortfilm-preview-img");
}

// Global Helper to clear images via the X button
function clearReference(idKey) {
    // Handle short film segments (idKey format: "seg-1")
    if (idKey.startsWith("seg-")) {
        const rowId = idKey.replace("seg-", "");
        const box = document.getElementById(`shortfilm-seg-box-${rowId}`);
        const img = document.getElementById(`shortfilm-seg-img-${rowId}`);
        const input = document.getElementById(`shortfilm-seg-input-${rowId}`);
        if(input) input.value = "";
        if(img) img.src = "";
        if(box) box.classList.remove("has-file");
        return;
    }

    // Handle standard boxes
    let input = document.getElementById(`${idKey}-input`) || document.getElementById(`${idKey}-reference-input`);
    let box = document.getElementById(`${idKey}-box`) || document.getElementById(`${idKey}-upload-box`);
    let img = document.getElementById(`${idKey}-img`) || document.getElementById(`${idKey}-preview-img`);

    if (input) input.value = "";
    if (img) img.src = "";
    if (box) box.classList.remove("has-file");
}
/* ----------------------- IMAGE / VIDEO / FILM CONTROLS ------------------ */

function wireImageControls() {
    const modeSwitch = $("image-mode-switch");
    if (modeSwitch) {
        modeSwitch.querySelectorAll(".pill-switch__btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const mode = btn.dataset.imageMode;
                if (!mode) return;
                currentImageMode = mode;
                setToggleButtons(modeSwitch, "imageMode", mode);
                // Show/hide reference block
                const refBlock = $("image-reference-block");
                if (refBlock) {
                    refBlock.style.display = mode === "image" ? "block" : "none";
                }
            });
        });
    }

    const aspectSwitch = $("image-aspect-switch");
    if (aspectSwitch) {
        aspectSwitch.querySelectorAll(".pill-switch__btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const a = btn.dataset.imageAspect;
                if (!a) return;
                setToggleButtons(aspectSwitch, "imageAspect", a);
                updateImageResolutionLabel(a);
            });
        });
    }

    const guidanceSlider = $("image-guidance-slider");
    if (guidanceSlider) {
        guidanceSlider.addEventListener("input", () => {
            setTextContent("image-guidance-value", guidanceSlider.value);
        });
    }

    const advToggle = $("image-toggle-advanced");
    if (advToggle) {
        advToggle.addEventListener("click", () => {
            const panel = $("image-advanced-panel");
            if (!panel) return;
            const hidden = panel.classList.contains("hidden");
            panel.classList.toggle("hidden", !hidden);
        });
    }
}

function updateImageResolutionLabel(aspect) {
    let text = "1024 × 1024";
    if (aspect === "16:9") text = "1344 × 768";
    else if (aspect === "9:16") text = "768 × 1344";
    setTextContent("image-estimate-res", text);
}

function wireVideoControls() {
    const modeSwitch = $("video-mode-switch");
    if (modeSwitch) {
        modeSwitch.querySelectorAll(".pill-switch__btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const mode = btn.dataset.videoMode;
                if (!mode) return;
                currentVideoMode = mode;
                setToggleButtons(modeSwitch, "videoMode", mode);
                const refBlock = $("video-reference-block");
                if (refBlock) {
                    refBlock.style.display = mode === "image" ? "block" : "none";
                }
            });
        });
    }

    const aspectSwitch = $("video-aspect-switch");
    if (aspectSwitch) {
        aspectSwitch.querySelectorAll(".pill-switch__btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const a = btn.dataset.videoAspect;
                if (!a) return;
                setToggleButtons(aspectSwitch, "videoAspect", a);
                updateVideoResolutionLabel(a);
            });
        });
    }

    const advToggle = $("video-toggle-advanced");
    if (advToggle) {
        advToggle.addEventListener("click", () => {
            const panel = $("video-advanced-panel");
            if (!panel) return;
            const hidden = panel.classList.contains("hidden");
            panel.classList.toggle("hidden", !hidden);
        });
    }
}

function updateVideoResolutionLabel(aspect) {
    let text = "720p";
    if (aspect === "9:16") text = "720 × 1280 (vertical)";
    else if (aspect === "1:1") text = "960 × 960";
    else text = "1280 × 720";
    setTextContent("video-estimate-res", text);
}

function wireShortFilmControls() {
    const aspectSwitch = $("shortfilm-aspect-switch");
    if (aspectSwitch) {
        aspectSwitch.querySelectorAll(".pill-switch__btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const a = btn.dataset.shortfilmAspect;
                if (!a) return;
                setToggleButtons(aspectSwitch, "shortfilmAspect", a);
            });
        });
    }

    const addBtn = $("shortfilm-add-segment-btn");
    if (addBtn) {
        addBtn.addEventListener("click", addShortFilmSegmentRow);
    }

    // Start with 3 segments by default
    for (let i = 0; i < 3; i++) {
        addShortFilmSegmentRow();
    }
}

let shortFilmSegmentCounter = 0;

/* 2. REPLACE THIS FUNCTION */
function addShortFilmSegmentRow() {
    const container = document.getElementById("shortfilm-segments-container");
    if (!container) return;

    shortFilmSegmentCounter++;
    const id = shortFilmSegmentCounter;
    const promptId = `shortfilm-segment-prompt-${id}`;

    const row = document.createElement("div");
    row.className = "shortfilm-segment-row";
    row.dataset.segmentId = String(id);
    row.style.borderBottom = "1px solid rgba(31,41,55,0.5)";
    row.style.paddingBottom = "12px";
    
    // Updated HTML with Upload Box
    row.innerHTML = `
        <div style="display:flex; gap:10px;">
            <div style="width: 100px; flex-shrink: 0;">
                <div class="text-soft" style="font-size:10px;margin-bottom:4px;">Ref Image</div>
                <label class="sulandra-upload-box compact" id="shortfilm-seg-box-${id}" for="shortfilm-seg-input-${id}" style="aspect-ratio:1/1; height:auto;">
                    <div class="sulandra-placeholder">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 5v14M5 12h14" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <img id="shortfilm-seg-img-${id}" class="sulandra-preview-img" alt="Scene Ref" />
                    <button type="button" class="sulandra-remove-btn" onclick="clearReference('seg-${id}'); event.preventDefault();">×</button>
                    <input id="shortfilm-seg-input-${id}" type="file" accept="image/*" class="visually-hidden" />
                </label>
            </div>

            <div style="flex:1; display:flex; flex-direction:column; gap:4px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <input type="text" class="shortfilm-segment-title" placeholder="Scene ${id} Title" 
                        style="flex:1; background:transparent; border:none; color:#e5e7eb; font-weight:600; font-size:12px; outline:none;" />
                    <button type="button" class="shortfilm-segment-remove" style="color:#ef4444; font-size:10px;">Remove</button>
                </div>
                
                <div style="position:relative;">
                    <textarea id="${promptId}" class="shortfilm-segment-prompt" rows="2" placeholder="Describe scene action..." 
                        style="width:100%; border-radius:10px; border:1px solid rgba(31,41,55,0.95); padding:6px 8px 6px 36px; background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%); color:#e5e7eb; font-size:11px; resize:vertical; min-height:60px;"></textarea>
                    
                    <button type="button" class="ask-sia-prompt-btn dynamic-ask-btn" data-target-prompt="${promptId}" 
                        style="position:absolute; left:6px; top:6px; border:none; background:rgba(34, 197, 94, 0.1);">
                        <svg viewBox="0 0 24 24" fill="none"><path d="M12 4V20M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M15 9L9 15M9 9L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                    </button>
                </div>

                <div style="display:flex; align-items:center; gap:6px; margin-top:2px;">
                    <span class="text-soft" style="font-size:10px;">Duration:</span>
                    <input type="number" class="shortfilm-segment-duration" value="4" min="1" max="10" 
                        style="width:40px; background:#0f172a; border:1px solid #1f2937; border-radius:4px; color:#fff; font-size:10px; padding-left:4px;" />
                    <span class="text-soft" style="font-size:10px;">sec</span>
                </div>
            </div>
        </div>
    `;

    container.appendChild(row);

    // --- Wire up Logic ---

    // 1. Image Preview Wiring for this specific row
    const input = document.getElementById(`shortfilm-seg-input-${id}`);
    const box = document.getElementById(`shortfilm-seg-box-${id}`);
    const img = document.getElementById(`shortfilm-seg-img-${id}`);

    if (input) {
        input.addEventListener("change", () => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                    box.classList.add("has-file");
                };
                reader.readAsDataURL(input.files[0]);
            }
        });
    }

    // 2. Ask SIA Listener (Updated for Side Panel)
    const askBtn = row.querySelector(".dynamic-ask-btn");
    if (askBtn) {
        askBtn.addEventListener("click", () => {
            const txt = document.getElementById(promptId);
            const content = txt ? txt.value : "";
            // Open the panel with the segment text
            openAskSia('shortfilm-segment', content || `Segment ${id} (Empty)`);
        });
    }

    // 3. Remove & Duration Listeners
    const removeBtn = row.querySelector(".shortfilm-segment-remove");
    const durInput = row.querySelector(".shortfilm-segment-duration");
    
    if (removeBtn) removeBtn.addEventListener("click", () => { row.remove(); updateShortFilmTotalLength(); });
    if (durInput) durInput.addEventListener("input", updateShortFilmTotalLength);

    updateShortFilmTotalLength();
}

function updateShortFilmTotalLength() {
    const container = $("shortfilm-segments-container");
    if (!container) return;

    const durations = container.querySelectorAll(".shortfilm-segment-duration");
    let total = 0;
    durations.forEach(input => {
        const v = Number(input.value) || 0;
        total += v;
    });

    setTextContent("shortfilm-total-length", `~ ${total || 0} sec`);
}

/* ------------------------- ASSETS PANEL (LEFT CONFIG) ------------------ */

let assetsCache = {
    images: [],
    videos: [],
    films: []
};

function updateAssetsTypeButtons() {
    const container = $("assets-type-switch");
    if (!container) return;
    const buttons = container.querySelectorAll(".pill-switch__btn");
    buttons.forEach(btn => {
        const t = btn.dataset.assetsType;
        btn.classList.toggle("pill-switch__btn--active", t === currentAssetsType);
    });
}

function updateAssetsLayoutButtons() {
    const container = $("assets-layout-switch");
    if (!container) return;
    const buttons = container.querySelectorAll(".pill-switch__btn");
    buttons.forEach(btn => {
        const t = btn.dataset.assetsLayout;
        btn.classList.toggle("pill-switch__btn--active", t === currentAssetsLayout);
    });
}

/**
 * Build list from historyInMemory into assetsCache (grouped by type).
 */
function rebuildAssetsCacheFromHistory() {
    assetsCache = {
        images: historyInMemory.filter(x => x.kind === "image"),
        videos: historyInMemory.filter(x => x.kind === "video"),
        films:  historyInMemory.filter(x => x.kind === "shortfilm")
    };
}

/**
 * Render My Files list in the left panel.
 */
function renderAssetsList() {
    rebuildAssetsCacheFromHistory();

    const container = $("assets-list-container");
    if (!container) return;

    const favoritesOnly = !!$("assets-favorites-only")?.checked;
    const query = ($("assets-search-input")?.value || "").toLowerCase().trim();

    let list = [];
    if (currentAssetsType === "images") list = assetsCache.images;
    else if (currentAssetsType === "videos") list = assetsCache.videos;
    else list = assetsCache.films;

    if (favoritesOnly) {
        list = list.filter(x => x.isFavorite);
    }

    if (query) {
        list = list.filter(x =>
            (x.prompt || "").toLowerCase().includes(query) ||
            (x.title || "").toLowerCase().includes(query)
        );
    }

    container.innerHTML = "";

    if (!list.length) {
        container.innerHTML = `
            <div style="padding:10px 12px;font-size:11px;color:#9ca3af;">
                No items found for this filter.
            </div>
        `;
        setTextContent("assets-count-label", "0 items");
        return;
    }

    setTextContent("assets-count-label", `${list.length} item${list.length === 1 ? "" : "s"}`);

    list.forEach(item => {
        const row = document.createElement("div");
        row.className = "assets-row";
        row.style.cssText = `
            display:flex;
            align-items:center;
            gap:8px;
            padding:6px 8px;
            border-radius:10px;
            margin:0 4px 4px;
            cursor:pointer;
            border:1px solid transparent;
        `;

        row.addEventListener("mouseenter", () => {
            row.style.borderColor = "rgba(31,41,55,0.95)";
            row.style.background = "radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%)";
        });
        row.addEventListener("mouseleave", () => {
            row.style.borderColor = "transparent";
            row.style.background = "transparent";
        });

        row.addEventListener("click", () => {
            // Scroll main gallery to this item and open lightbox
            scrollToHistoryItem(item.id);
            openLightbox(item.id);
        });

        const thumb = document.createElement("div");
        thumb.style.cssText = `
            width:40px;
            height:26px;
            border-radius:6px;
            overflow:hidden;
            flex-shrink:0;
            background:#020617;
        `;
        thumb.innerHTML = item.kind === "image"
            ? `<img src="${item.thumb}" style="width:100%;height:100%;object-fit:cover;">`
            : `<video src="${item.thumb}" style="width:100%;height:100%;object-fit:cover;" muted></video>`;

        const info = document.createElement("div");
        info.style.cssText = `
            flex:1;
            min-width:0;
            display:flex;
            flex-direction:column;
            gap:2px;
        `;
        info.innerHTML = `
            <div style="font-size:11px;color:#e5e7eb;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                ${item.title || "Untitled"}
            </div>
            <div style="font-size:10px;color:#9ca3af;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                ${(item.prompt || "No prompt").replace(/\s+/g, " ").slice(0, 64)}
            </div>
        `;

        const meta = document.createElement("div");
        meta.style.cssText = `
            display:flex;
            flex-direction:column;
            align-items:flex-end;
            gap:2px;
            font-size:9px;
            color:#6b7280;
        `;
        const dateStr = new Date(item.createdAt).toLocaleDateString();
        const favChar = item.isFavorite ? "★" : "☆";
        meta.innerHTML = `
            <div>${dateStr}</div>
            <div>${favChar}</div>
        `;

        row.appendChild(thumb);
        row.appendChild(info);
        row.appendChild(meta);

        container.appendChild(row);
    });
}

/* ----------------------------- GENERATE BUTTON -------------------------- */

let isGenerating = false;

function setGeneratingState(active, labelText) {
    isGenerating = active;
    const btn = $("btn-generate");
    const lbl = $("btn-generate-label");

    if (!btn || !lbl) return;

    if (active) {
        btn.disabled = true;
        btn.style.opacity = "0.9";
        btn.style.cursor = "wait";
        lbl.textContent = labelText || "Generating…";
    } else {
        btn.disabled = false;
        btn.style.opacity = "";
        btn.style.cursor = "pointer";
        lbl.textContent = "Generate";
    }
}

/* --------------------------- RUNPOD API STUB --------------------------- */

async function callSulandraAPI(path, payload) {
    if (!SULANDRA_API_BASE || SULANDRA_API_BASE.includes("YOUR-RUNPOD-ENDPOINT")) {
        // Stub: simulate success with placeholder image/video so UI is still testable
        console.warn("[Sulandra] SULANDRA_API_BASE is not configured. Returning stub object.");
        await new Promise(res => setTimeout(res, 800));
        const kind = payload.kind || "image";
        const url = kind === "image"
            ? "https://dummyimage.com/1280x720/0f172a/ffffff.png&text=Sulandra+Image"
            : "https://sample-videos.com/video321/mp4/720/big_buck_bunny_720p_1mb.mp4";
        return {
            ok: true,
            kind: kind,
            url: url,
            thumb: url,
            meta: {
                model: "Sulandra Vision Flux 2.0 (stub)",
                guidance: payload.guidance,
                steps: payload.steps,
                seed: payload.seed || null,
                creditsUsed: 1
            }
        };
    }

    const url = SULANDRA_API_BASE.replace(/\/+$/, "") + path;
    const res = await fetch(url, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
    });

    if (!res.ok) {
        const txt = await res.text();
        throw new Error("Sulandra API error: " + res.status + " – " + txt);
    }

    return res.json();
}

/* ---------------------- BUILD PAYLOADS FROM UI -------------------------- */

function getSelectedImageAspect() {
    const btn = document.querySelector("#image-aspect-switch .pill-switch__btn--active");
    return btn ? btn.dataset.imageAspect || "1:1" : "1:1";
}

function getSelectedVideoAspect() {
    const btn = document.querySelector("#video-aspect-switch .pill-switch__btn--active");
    return btn ? btn.dataset.videoAspect || "16:9" : "16:9";
}

function getSelectedShortFilmAspect() {
    const btn = document.querySelector("#shortfilm-aspect-switch .pill-switch__btn--active");
    return btn ? btn.dataset.shortfilmAspect || "16:9" : "16:9";
}

function buildImagePayloadFromUI() {
    const prompt = $("image-main-prompt")?.value || "";
    const negativePrompt = $("image-negative-prompt")?.value || "";
    const aspect = getSelectedImageAspect();
    const style = $("image-style-select")?.value || "natural";
    const guidance = Number($("image-guidance-slider")?.value || 7);
    const steps = Number($("image-steps-input")?.value || 30);
    const seedVal = $("image-seed-input")?.value;
    const seed = seedVal === "" ? null : Number(seedVal);

    return {
        kind: "image",
        prompt: prompt,
        negative_prompt: negativePrompt,
        aspect: aspect,
        style: style,
        guidance: guidance,
        steps: steps,
        seed: seed,
        mode: currentImageMode
        // reference image will be added later if needed
    };
}

function buildVideoPayloadFromUI() {
    const prompt = $("video-main-prompt")?.value || "";
    const negativePrompt = $("video-negative-prompt")?.value || "";
    const aspect = getSelectedVideoAspect();
    const duration = Number($("video-duration-select")?.value || 10);
    const steps = Number($("video-steps-input")?.value || 30);
    const seedVal = $("video-seed-input")?.value;
    const seed = seedVal === "" ? null : Number(seedVal);
    const nativeAudio = !!$("video-native-audio-checkbox")?.checked;
    const loop = !!$("video-loop-checkbox")?.checked;
    const camMove = !!$("video-cam-move-checkbox")?.checked;
    const stabilize = !!$("video-stabilize-checkbox")?.checked;
    const highFps = !!$("video-high-fps-checkbox")?.checked;

    return {
        kind: "video",
        prompt: prompt,
        negative_prompt: negativePrompt,
        aspect: aspect,
        duration: duration,
        steps: steps,
        seed: seed,
        mode: currentVideoMode,
        native_audio: nativeAudio,
        loop: loop,
        camera_motion: camMove,
        stabilize: stabilize,
        high_fps: highFps
        // reference image will be attached if image→video mode
    };
}

function buildShortFilmPayloadFromUI() {
    const title = $("shortfilm-title-input")?.value || "Untitled short film";
    const globalPrompt = $("shortfilm-global-prompt")?.value || "";
    const aspect = getSelectedShortFilmAspect();
    const container = $("shortfilm-segments-container");
    const segments = [];

    if (container) {
        container.querySelectorAll(".shortfilm-segment-row").forEach(row => {
            const t = row.querySelector(".shortfilm-segment-title")?.value || "";
            const p = row.querySelector(".shortfilm-segment-prompt")?.value || "";
            const d = Number(row.querySelector(".shortfilm-segment-duration")?.value || 4);
            segments.push({
                title: t,
                prompt: p,
                duration: d
            });
        });
    }

    return {
        kind: "shortfilm",
        film_title: title,
        global_prompt: globalPrompt,
        aspect: aspect,
        segments: segments
    };
}

/* ----------------------- FILE INPUT HELPERS (REFS) ---------------------- */

async function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            const res = reader.result;
            const base64 = typeof res === "string"
                ? res.split(",")[1]
                : "";
            resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

/* --------------------------- GENERATE FLOWS ----------------------------- */

async function generateImageFromUI() {
    if (isGenerating) return;
    const payload = buildImagePayloadFromUI();

    // Reference image if in image→image mode
    if (currentImageMode === "image") {
        const fileInput = $("image-reference-input");
        if (fileInput && fileInput.files && fileInput.files[0]) {
            payload.reference_image = await readFileAsBase64(fileInput.files[0]);
        }
    }

    setGeneratingState(true, "Generating image…");
    try {
        const result = await callSulandraAPI("/generate/image", payload);

        const item = addHistoryItem({
            kind: "image",
            url: result.url,
            thumb: result.thumb || result.url,
            title: "Image",
            prompt: payload.prompt,
            negativePrompt: payload.negative_prompt,
            aspect: payload.aspect,
            meta: result.meta
        });

        refreshAllHistoryDisplays();
        scrollToHistoryItem(item.id);
    } catch (err) {
        console.error("[Sulandra] Image generation failed:", err);
        window.alert("Image generation failed. Check console for details.");
    } finally {
        setGeneratingState(false);
    }
}

async function generateVideoFromUI() {
    if (isGenerating) return;
    const payload = buildVideoPayloadFromUI();

    if (currentVideoMode === "image") {
        const fileInput = $("video-reference-input");
        if (fileInput && fileInput.files && fileInput.files[0]) {
            payload.reference_image = await readFileAsBase64(fileInput.files[0]);
        }
    }

    setGeneratingState(true, "Generating video…");
    try {
        const result = await callSulandraAPI("/generate/video", payload);

        const item = addHistoryItem({
            kind: "video",
            url: result.url,
            thumb: result.thumb || result.url,
            title: "Video",
            prompt: payload.prompt,
            negativePrompt: payload.negative_prompt,
            aspect: payload.aspect,
            duration: payload.duration,
            meta: result.meta
        });

        refreshAllHistoryDisplays();
        scrollToHistoryItem(item.id);
    } catch (err) {
        console.error("[Sulandra] Video generation failed:", err);
        window.alert("Video generation failed. Check console for details.");
    } finally {
        setGeneratingState(false);
    }
}

async function generateShortFilmFromUI() {
    if (isGenerating) return;
    const payload = buildShortFilmPayloadFromUI();

    if (!payload.segments || !payload.segments.length) {
        window.alert("Add at least one segment to your short film.");
        return;
    }

    setGeneratingState(true, "Generating short film…");
    try {
        const result = await callSulandraAPI("/generate/shortfilm", payload);

        const item = addHistoryItem({
            kind: "shortfilm",
            url: result.url,
            thumb: result.thumb || result.url,
            title: payload.film_title,
            prompt: payload.global_prompt,
            negativePrompt: "",
            aspect: payload.aspect,
            duration: payload.segments.reduce((s, seg) => s + (seg.duration || 0), 0),
            meta: result.meta
        });

        refreshAllHistoryDisplays();
        scrollToHistoryItem(item.id);
    } catch (err) {
        console.error("[Sulandra] Short film generation failed:", err);
        window.alert("Short film generation failed. Check console for details.");
    } finally {
        setGeneratingState(false);
    }
}

/* ------------------------ RANDOM PROMPT BUTTON -------------------------- */

function wireRandomPromptButton() {
    const btn = $("btn-random-prompt");
    if (!btn) return;

    btn.addEventListener("click", () => {
        if (currentLab === "image") {
            const examples = [
                "cinematic portrait of an African futurist artist in neon-lit studio, ultra-detailed, 50mm, shallow depth of field",
                "lush Cameroon hillside at golden hour, kids flying kites, volumetric light, 8k, photography",
                "Amapiano club scene in Lagos, neon reflections, crowd dancing, motion blur, high energy"
            ];
            const t = $("image-main-prompt");
            if (t) t.value = examples[Math.floor(Math.random() * examples.length)];
        } else if (currentLab === "video") {
            const examples = [
                "slow drone fly-through over Providence City at sunrise, soft light, birds flying, gentle camera easing",
                "close-up shot circling a singer on stage, colorful lights, crowd silhouettes, smooth dolly movement",
                "city street in the rain at night, reflections on pavement, cars passing, cinematic parallax"
            ];
            const t = $("video-main-prompt");
            if (t) t.value = examples[Math.floor(Math.random() * examples.length)];
        } else if (currentLab === "shortfilm") {
            const g = $("shortfilm-global-prompt");
            if (g) {
                g.value = "Short film about a young creator building Sulandra Studio, balancing nursing shifts with late-night coding and music sessions.";
            }
        }
    });
}

/* --------------------------- MAIN BUTTON WIRING ------------------------- */

function wireMainButtonsAndToggles() {
    // UPDATE: New Sidebar Lab Navigation clicks
    document.querySelectorAll("[data-lab-nav]").forEach(btn => {
        btn.addEventListener("click", () => {
            const lab = btn.dataset.labNav;
            if (!lab) return;
            setActiveLab(lab);
        });
    });

    // Mode toggle
    document.querySelectorAll("#mode-toggle .vision-header__view-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const mode = btn.dataset.mode;
            if (!mode) return;
            currentMode = mode;
            updateModeToggleButtons();
        });
    });

    // Favorites only – header toggle (affects gallery/history)
    const favToggle = $("favorites-toggle-checkbox");
    if (favToggle) {
        favToggle.addEventListener("change", () => {
            favoritesOnlyGallery = favToggle.checked;
            refreshAllHistoryDisplays();
        });
    }

    // Gallery filter tabs
    const galleryFilter = $("gallery-filter-switch");
    if (galleryFilter) {
        galleryFilter.querySelectorAll(".pill-switch__btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const val = btn.dataset.galleryFilter || "all";
                currentGalleryFilter = val;
                updateGalleryFilterButtons();
                refreshAllHistoryDisplays();
            });
        });
    }

    // Gallery layout (grid / vertical)
    const galleryLayout = $("gallery-layout-switch");
    if (galleryLayout) {
        galleryLayout.querySelectorAll(".pill-switch__btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const val = btn.dataset.galleryLayout || "grid";
                currentGalleryLayout = val;
                updateGalleryLayoutButtons();
                applyGalleryLayout();
            });
        });
    }

    // Refresh gallery button
    const refreshBtn = $("btn-gallery-refresh");
    if (refreshBtn) {
        refreshBtn.addEventListener("click", () => {
            refreshAllHistoryDisplays();
        });
    }

    // Gallery settings button – for now, info tip
    const gallerySettingsBtn = $("btn-open-gallery-settings");
    if (gallerySettingsBtn) {
        gallerySettingsBtn.addEventListener("click", () => {
            window.alert("Gallery settings will let you choose how many items to keep, auto-clean rules, etc. (Placeholder).");
        });
    }

    // Assets button in header
    const openAssetsBtn = $("open-assets-btn");
    if (openAssetsBtn) {
        openAssetsBtn.addEventListener("click", () => {
            setActiveLab("assets");
            currentMode = "view";
            updateModeToggleButtons();
        });
    }

    // Assets type switch
    const assetsTypeSwitch = $("assets-type-switch");
    if (assetsTypeSwitch) {
        assetsTypeSwitch.querySelectorAll(".pill-switch__btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const t = btn.dataset.assetsType;
                if (!t) return;
                currentAssetsType = t;
                updateAssetsTypeButtons();
                renderAssetsList();
            });
        });
    }

    // Assets layout switch (for future layout variations)
    const assetsLayoutSwitch = $("assets-layout-switch");
    if (assetsLayoutSwitch) {
        assetsLayoutSwitch.querySelectorAll(".pill-switch__btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const t = btn.dataset.assetsLayout;
                if (!t) return;
                currentAssetsLayout = t;
                updateAssetsLayoutButtons();
                renderAssetsList();
            });
        });
    }

    // Assets favorites filter
    const assetsFavToggle = $("assets-favorites-only");
    if (assetsFavToggle) {
        assetsFavToggle.addEventListener("change", () => {
            renderAssetsList();
        });
    }

    // Assets search
    const assetsSearch = $("assets-search-input");
    if (assetsSearch) {
        assetsSearch.addEventListener("input", () => {
            renderAssetsList();
        });
    }

    // Generate button
    const generateBtn = $("btn-generate");
    if (generateBtn) {
        generateBtn.addEventListener("click", () => {
            if (currentLab === "image") {
                generateImageFromUI();
            } else if (currentLab === "video") {
                generateVideoFromUI();
            } else if (currentLab === "shortfilm") {
                generateShortFilmFromUI();
            } else {
                window.alert("Select Images, Videos, or Short Films to generate.");
            }
        });
    }

    // Ask SIA button in stage toolbar
    const askSIAStageBtn = $("btn-open-ask-sia");
    if (askSIAStageBtn) {
        askSIAStageBtn.addEventListener("click", () => {
            const first = historyInMemory[0];
            if (!first) {
                window.alert("Generate something first, then Ask SIA about it.");
                return;
            }
            askSIAAboutItem(first);
        });
    }

    // Random prompt button
    wireRandomPromptButton();
// --- ASK SIA BUTTONS WIRING ---
    document.querySelectorAll(".ask-sia-prompt-btn").forEach(btn => {
        // Remove old listeners (clone node trick) to prevent duplicates if function runs twice
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);

        newBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();

            const targetId = newBtn.dataset.targetPrompt;
            const textarea = document.getElementById(targetId);
            
            let contextText = "General Help";
            if (textarea && textarea.value.trim()) {
                contextText = textarea.value.trim();
            } else if (textarea) {
                contextText = "Empty prompt field";
            }

            // Open the panel with the text from the prompt box
            openAskSia(currentLab, contextText);
        });
    });
}
/* =============================== */
/* ASK SIA LOGIC                   */
/* =============================== */
let askSiaState = {
  mode: 'general',
  context: ''
};

function openAskSia(mode, contextText) {
  askSiaState.mode = mode || 'general';
  askSiaState.context = contextText || '';

  const backdrop = document.getElementById('askSiaBackdrop');
  const ctxBox = document.getElementById('askSiaContext');
  const answerBox = document.getElementById('askSiaAnswer');
  const questionBox = document.getElementById('askSiaQuestion');

  // Populate UI
  ctxBox.textContent = contextText || "No context selected.";
  questionBox.value = ""; // Clear previous question
  answerBox.innerHTML = '<span style="color:#6b7280; font-style:italic;">How can I help with this prompt?</span>';
  
  // Show Panel
  backdrop.style.display = 'flex';
}

function closeAskSia() {
  document.getElementById('askSiaBackdrop').style.display = 'none';
}

async function sendAskSia() {
  const question = document.getElementById('askSiaQuestion').value;
  const answerBox = document.getElementById('askSiaAnswer');
  
  if (!question.trim()) {
      answerBox.innerHTML = '<span style="color:#ef4444;">Please type a request first.</span>';
      return;
  }

  // Loading State
  answerBox.innerHTML = '<span style="color:#4ade80;">SIA is thinking...</span>';

  // 🔌 SIMULATED API CALL (Replace with your Real API)
  setTimeout(() => {
      const mockResponse = `<strong>Suggestion for ${askSiaState.mode}:</strong><br><br>Based on your input "${askSiaState.context}", try adding "volumetric lighting, 8k resolution, shot on 35mm" to enhance the cinematic feel.`;
      answerBox.innerHTML = mockResponse;
  }, 1500);
}

// Close on Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeAskSia();
});

/* -------------------------- INITIAL UI WIRING ENTRY --------------------- */

function initializeSulandraVision() {
    injectDynamicStyles();
    applyGalleryLayout();

    // reload history into cache + UI
    loadHistoryFromStorage();
    rebuildAssetsCacheFromHistory();
    refreshAllHistoryDisplays();
    renderAssetsList();

    wireImageControls();
    wireVideoControls();
    wireShortFilmControls();
    wireMainButtonsAndToggles();

    // Set default lab
    setActiveLab("image");
    currentMode = "create";
    updateModeToggleButtons();
}

document.addEventListener("DOMContentLoaded", () => {
    try {
        initializeSulandraVision();
    } catch (err) {
        console.error("[Sulandra] Initialization error:", err);
    }
    function initializeSulandraVision() {
    injectDynamicStyles();
    applyGalleryLayout();

    // ... (existing code) ...

    wireImageControls();
    wireVideoControls();
    wireShortFilmControls();
    
    wireReferenceImagePreviews(); // <--- ADD THIS LINE HERE

    wireMainButtonsAndToggles();
    // ...
}
});

/* ====================================================================== */
/*  SULANDRA VISION LAB – SECTION 7                                       */
/*  BRAND CLEANUP, UI SETTINGS PERSISTENCE & TOAST NOTIFICATIONS          */
/* ====================================================================== */

/* ------------------------------ BRAND CLEANUP --------------------------- */
/**
 * Some older copies of this UI may still contain references to "Kling" or
 * "Kling AI". This helper sweeps the DOM and replaces them with "Sulandra".
 *
 * It runs AFTER the main UI initializes, so any dynamic text also gets fixed.
 */
function renameBrandInDOM() {
    const replacements = [
        { from: /kling\s*ai/gi, to: "Sulandra" },
        { from: /kling/gi,      to: "Sulandra" }
    ];

    const walker = document.createTreeWalker(
        document.body,
        NodeFilter.SHOW_TEXT,
        null,
        false
    );

    const nodes = [];
    let n = walker.nextNode();
    while (n) {
        nodes.push(n);
        n = walker.nextNode();
    }

    nodes.forEach(node => {
        let txt = node.nodeValue;
        if (typeof txt !== "string") return;
        let changed = false;
        replacements.forEach(rule => {
            if (rule.from.test(txt)) {
                txt = txt.replace(rule.from, rule.to);
                changed = true;
            }
        });
        if (changed) node.nodeValue = txt;
    });
}

/* ------------------------------ UI SETTINGS ---------------------------- */
/**
 * UI settings we persist:
 *  - lastLab             (image / video / shortfilm / assets)
 *  - lastMode            (create / view)
 *  - galleryLayout       (grid / vertical)
 *  - galleryFilter       (all / images / videos / films)
 *  - favoritesOnlyGallery
 *  - imageMode           (text / image)
 *  - videoMode           (text / image)
 *  - assetsType          (images / videos / films)
 *  - assetsLayout        (grid / list)
 */
function loadUISettingsFromStorage() {
    const defaults = {
        lastLab: "image",
        lastMode: "create",
        galleryLayout: "grid",
        galleryFilter: "all",
        favoritesOnlyGallery: false,
        imageMode: "text",
        videoMode: "text",
        assetsType: "images",
        assetsLayout: "grid"
    };

    const saved = loadFromStorage(STORAGE_KEYS.settings, defaults);
    return Object.assign({}, defaults, saved || {});
}

function saveUISettingsFromState() {
    const payload = {
        lastLab: currentLab,
        lastMode: currentMode,
        galleryLayout: currentGalleryLayout,
        galleryFilter: currentGalleryFilter,
        favoritesOnlyGallery: !!favoritesOnlyGallery,
        imageMode: currentImageMode,
        videoMode: currentVideoMode,
        assetsType: currentAssetsType,
        assetsLayout: currentAssetsLayout
    };
    saveToStorage(STORAGE_KEYS.settings, payload);
}

/**
 * Apply saved settings to the global state and reflect in UI.
 * Called AFTER the main initializeSulandraVision has run, so it can override
 * the default "image / create" startup state.
 */
function applySavedUISettingsToUI() {
    const s = loadUISettingsFromStorage();

    // First, update globals
    currentLab = s.lastLab || "image";
    currentMode = s.lastMode || "create";
    currentGalleryLayout = s.galleryLayout || "grid";
    currentGalleryFilter = s.galleryFilter || "all";
    favoritesOnlyGallery = !!s.favoritesOnlyGallery;
    currentImageMode = s.imageMode || "text";
    currentVideoMode = s.videoMode || "text";
    currentAssetsType = s.assetsType || "images";
    currentAssetsLayout = s.assetsLayout || "grid";

    // Then update UI
    setActiveLab(currentLab);
    updateModeToggleButtons();
    updateGalleryLayoutButtons();
    updateGalleryFilterButtons();

    const favToggle = $("favorites-toggle-checkbox");
    if (favToggle) favToggle.checked = favoritesOnlyGallery;

    // Image / Video mode toggles
    const imageModeSwitch = $("image-mode-switch");
    if (imageModeSwitch) {
        setToggleButtons(imageModeSwitch, "imageMode", currentImageMode);
        const refBlock = $("image-reference-block");
        if (refBlock) {
            refBlock.style.display = currentImageMode === "image" ? "block" : "none";
        }
    }

    const videoModeSwitch = $("video-mode-switch");
    if (videoModeSwitch) {
        setToggleButtons(videoModeSwitch, "videoMode", currentVideoMode);
        const refBlock = $("video-reference-block");
        if (refBlock) {
            refBlock.style.display = currentVideoMode === "image" ? "block" : "none";
        }
    }

    // Assets (My Files) toggles
    updateAssetsTypeButtons();
    updateAssetsLayoutButtons();

    const assetsFavToggle = $("assets-favorites-only");
    if (assetsFavToggle) assetsFavToggle.checked = false;

    refreshAllHistoryDisplays();
    renderAssetsList();
}

/* Persist settings when the tab is hidden or closed */
document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") {
        saveUISettingsFromState();
    }
});
window.addEventListener("beforeunload", () => {
    saveUISettingsFromState();
});

/* ----------------------------- TOAST SYSTEM ----------------------------- */
/**
 * Simple in-app toast notifications (top-right).
 * We override window.alert to funnel all alerts through this system,
 * so everything in previous chunks automatically gets nicer UX.
 */

let toastContainer = null;
let toastIdCounter = 0;

function ensureToastContainer() {
    if (toastContainer) return;
    toastContainer = document.createElement("div");
    toastContainer.id = "sulandra-toast-container";
    toastContainer.style.position = "fixed";
    toastContainer.style.top = "16px";
    toastContainer.style.right = "16px";
    toastContainer.style.zIndex = "99999";
    toastContainer.style.display = "flex";
    toastContainer.style.flexDirection = "column";
    toastContainer.style.gap = "8px";
    document.body.appendChild(toastContainer);
}

/**
 * type = 'info' | 'success' | 'error' | 'warning'
 */
function showSulandraToast(message, type) {
    ensureToastContainer();
    toastIdCounter++;

    const toast = document.createElement("div");
    toast.dataset.toastId = String(toastIdCounter);
    toast.style.minWidth = "260px";
    toast.style.maxWidth = "360px";
    toast.style.padding = "10px 12px";
    toast.style.borderRadius = "12px";
    toast.style.border = "1px solid rgba(31,41,55,0.95)";
    toast.style.display = "flex";
    toast.style.alignItems = "flex-start";
    toast.style.gap = "10px";
    toast.style.fontSize = "11px";
    toast.style.color = "#e5e7eb";
    toast.style.boxShadow =
        "0 0 0 1px rgba(15,23,42,0.95), 0 20px 50px rgba(0,0,0,0.96)";
    toast.style.background =
        "radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%)";
    toast.style.opacity = "0";
    toast.style.transform = "translateY(-4px)";
    toast.style.transition = "opacity 140ms ease-out, transform 140ms ease-out";

    let accentColor = "#60a5fa"; // info
    if (type === "success") accentColor = "#22c55e";
    else if (type === "error") accentColor = "#f97373";
    else if (type === "warning") accentColor = "#facc15";

    const icon = document.createElement("div");
    icon.style.width = "18px";
    icon.style.height = "18px";
    icon.style.borderRadius = "999px";
    icon.style.flexShrink = "0";
    icon.style.display = "flex";
    icon.style.alignItems = "center";
    icon.style.justifyContent = "center";
    icon.style.background = "rgba(15,23,42,0.95)";
    icon.style.border = `1px solid ${accentColor}`;
    icon.style.color = accentColor;
    icon.innerHTML = `
        <svg viewBox="0 0 24 24" style="width:12px;height:12px;" fill="none">
            ${
                type === "success"
                    ? '<path d="M6 12L10 16L18 8" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>'
                    : type === "error"
                    ? '<path d="M8 8L16 16M16 8L8 16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>'
                    : type === "warning"
                    ? '<path d="M12 7V13M12 17H12.01" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>'
                    : '<path d="M12 7V13M12 17H12.01" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>'
            }
        </svg>
    `;

    const textBlock = document.createElement("div");
    textBlock.style.flex = "1";
    textBlock.style.minWidth = "0";
    textBlock.style.whiteSpace = "pre-line";
    textBlock.textContent = String(message || "");

    const closeBtn = document.createElement("button");
    closeBtn.style.border = "none";
    closeBtn.style.background = "transparent";
    closeBtn.style.color = "#6b7280";
    closeBtn.style.cursor = "pointer";
    closeBtn.style.padding = "0";
    closeBtn.style.marginLeft = "4px";
    closeBtn.innerHTML = `
        <svg viewBox="0 0 24 24" style="width:14px;height:14px;" fill="none">
            <path d="M7 7L17 17" stroke="currentColor" stroke-linecap="round"/>
            <path d="M17 7L7 17" stroke="currentColor" stroke-linecap="round"/>
        </svg>
    `;

    closeBtn.addEventListener("click", () => {
        dismissToast(toast);
    });

    toast.appendChild(icon);
    toast.appendChild(textBlock);
    toast.appendChild(closeBtn);

    toastContainer.appendChild(toast);

    // Force reflow then animate in
    requestAnimationFrame(() => {
        toast.style.opacity = "1";
        toast.style.transform = "translateY(0)";
    });

    // Auto-dismiss after a delay
    const ttl = type === "error" ? 7000 : 4500;
    setTimeout(() => {
        dismissToast(toast);
    }, ttl);
}

function dismissToast(toastEl) {
    if (!toastEl || !toastEl.parentElement) return;
    toastEl.style.opacity = "0";
    toastEl.style.transform = "translateY(-4px)";
    setTimeout(() => {
        if (toastEl.parentElement) {
            toastEl.parentElement.removeChild(toastEl);
        }
    }, 180);
}

/* Override window.alert to use Sulandra toast system */
(function overrideAlertForSulandra() {
    const originalAlert = window.alert;
    window._sulandra_original_alert = originalAlert;
    window.alert = function (msg) {
        showSulandraToast(msg, "info");
    };
})();

/* ------------------------ POST-INIT HOOKS (DOM READY) ------------------- */
/**
 * We attach an extra DOMContentLoaded listener here to:
 *  - Apply saved UI settings after the main initializeSulandraVision runs.
 *  - Clean up any remaining "Kling" branding into "Sulandra".
 *  - Show a small welcome toast the first time.
 */

document.addEventListener("DOMContentLoaded", () => {
    try {
        // Apply saved settings (lab/mode/layout/filter)
        applySavedUISettingsToUI();
    } catch (err) {
        console.warn("[Sulandra] Failed to apply saved UI settings:", err);
    }

    try {
        renameBrandInDOM();
    } catch (err) {
        console.warn("[Sulandra] Brand rename failed:", err);
    }

    // Optional: first-time welcome toast
    const flagKey = "sulandra_vision_welcome_shown_v1";
    const alreadyShown = window.localStorage.getItem(flagKey);
    if (!alreadyShown) {
        showSulandraToast(
            "Welcome to Sulandra Vision Lab.\nPlug in your RunPod + SIA Brain endpoints and start creating.",
            "success"
        );
        window.localStorage.setItem(flagKey, "1");
    }
});
/* ====================================================================== */
/*  SULANDRA VISION LAB – SECTION 8                                       */
/*  DEV HELPERS, GLOBAL EXPORT & SCRIPT CLOSURE                           */
/* ====================================================================== */

/**
 * Expose a small public API on window for debugging in the browser console.
 * Example:
 *   SulandraVision.refresh()
 *   SulandraVision.listHistory()
 */
(function exposeSulandraVisionGlobals() {
    try {
        window.SulandraVision = {
            version: "1.0.0",
            get state() {
                return {
                    currentLab,
                    currentMode,
                    currentGalleryFilter,
                    currentGalleryLayout,
                    currentImageMode,
                    currentVideoMode,
                    currentAssetsType,
                    currentAssetsLayout,
                    favoritesOnlyGallery,
                    historyCount: historyInMemory.length
                };
            },
            refresh: function () {
                try {
                    refreshAllHistoryDisplays();
                    renderAssetsList();
                    showSulandraToast("Sulandra Vision UI refreshed.", "success");
                } catch (err) {
                    console.error("[Sulandra] refresh() failed:", err);
                    showSulandraToast("Refresh failed. Check console for details.", "error");
                }
            },
            listHistory: function () {
                console.table(historyInMemory.map(h => ({
                    id: h.id,
                    kind: h.kind,
                    title: h.title,
                    createdAt: new Date(h.createdAt).toLocaleString(),
                    favorite: h.isFavorite
                })));
                showSulandraToast("History printed to console.", "info");
            },
            clearHistory: function (confirmFirst = true) {
                if (confirmFirst) {
                    const ok = window._sulandra_original_alert
                        ? window._sulandra_original_alert("This will clear your local history. Continue?")
                        : window.confirm("This will clear your local history. Continue?");
                    if (!ok) return;
                }
                historyInMemory = [];
                saveHistoryToStorage();
                refreshAllHistoryDisplays();
                renderAssetsList();
                showSulandraToast("Sulandra history cleared (local only).", "warning");
            }
        };
    } catch (err) {
        console.warn("[Sulandra] Failed to expose SulandraVision globals:", err);
    }
})();

/* Final safety log so you can see load success in dev tools */
console.log("%cSulandra Vision Lab loaded.", "color:#22c55e;font-weight:600;");

/* ====================================================================== */
/*  END OF SULANDRA VISION LAB SCRIPT                                     */
/* ====================================================================== */
</script>
</html>
