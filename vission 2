<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sulandra Creative Lab · Vision Lab</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet"
    />
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap"
        rel="stylesheet"
    />

    <style>
    /* ====================================================================== */
    /*  SULANDRA VISION LAB – SECTION 1: GLOBAL THEME & BASE LAYOUT          */
    /*  (Chunk 1 / 8 – paste at very top of the file)                        */
    /* ====================================================================== */

    :root {
        /* Core background layers */
        --bg-root: #020617;
        --bg-app: #020617;
        --bg-panel: #020617;
        --bg-card: #020617;
        --bg-card-soft: #020617;
        --bg-elevated: #020617;

        /* Structural borders */
        --border-subtle: #111827;
        --border-strong: #1f2937;
        --border-focus: #4b5563;

        /* Accent + status */
        --accent-primary: #22c55e;
        --accent-primary-soft: rgba(34, 197, 94, 0.12);
        --accent-primary-strong: #4ade80;
        --accent-secondary: #60a5fa;
        --accent-secondary-soft: rgba(96, 165, 250, 0.2);
        --accent-danger: #ef4444;
        --accent-warning: #f97316;

        /* Text */
        --text-primary: #f9fafb;
        --text-secondary: #9ca3af;
        --text-muted: #6b7280;
        --text-soft: #4b5563;
        --text-dark: #020617;

        /* Shadows & radii */
        --radius-xs: 8px;
        --radius-sm: 10px;
        --radius-md: 14px;
        --radius-lg: 20px;
        --radius-xl: 24px;
        --radius-pill: 999px;

        --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.9);
        --shadow-card: 0 24px 60px rgba(0, 0, 0, 0.95);
        --shadow-strong: 0 32px 80px rgba(0, 0, 0, 0.98);
        --shadow-glow-accent: 0 0 0 1px rgba(34, 197, 94, 0.8),
                               0 0 40px rgba(34, 197, 94, 0.9);

        /* Layout metrics */
        --nav-width: 80px;
        --header-height: 70px;
        --footer-height: 0px;
        --history-rail-width: 100px;
        --config-panel-min: 360px;
        --config-panel-max: 460px;

        /* Timing */
        --fast: 120ms;
        --normal: 160ms;
        --slow: 220ms;
    }

    /* ---------------------------------------------------------------------- */
    /*  RESET & BASICS                                                       */
    /* ---------------------------------------------------------------------- */

    *, *::before, *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    html,
    body {
        width: 100%;
        height: 100%;
    }

    body {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
            "Segoe UI", sans-serif;
        font-size: 14px;
        line-height: 1.55;
        color: var(--text-primary);
        background:
            radial-gradient(circle at -10% -30%, rgba(59, 130, 246, 0.22), transparent 60%),
            radial-gradient(circle at 120% 0%, rgba(34, 197, 94, 0.24), transparent 58%),
            radial-gradient(circle at 50% 140%, rgba(0, 0, 0, 0.88), #020617 70%);
        display: flex;
        overflow: hidden;
    }

    img,
    video {
        max-width: 100%;
        display: block;
    }

    button {
        font: inherit;
        border: none;
        background: none;
        cursor: pointer;
    }

    input,
    textarea,
    select {
        font: inherit;
        color: inherit;
        background: transparent;
        border-radius: 0;
        border: none;
        outline: none;
    }

    a {
        color: inherit;
        text-decoration: none;
    }

    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    ::-webkit-scrollbar-track {
        background: transparent;
    }

    ::-webkit-scrollbar-thumb {
        background: #111827;
        border-radius: 999px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #1f2937;
    }

    /* Utility classes ------------------------------------------------------- */

    .hidden {
        display: none !important;
    }

    .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    .text-soft {
        color: var(--text-secondary);
    }

    .text-muted {
        color: var(--text-muted);
    }

    .badge-pill {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        border: 1px solid rgba(31, 41, 55, 0.95);
        background: radial-gradient(circle at 0 0, #020617, #020617 60%, #000 100%);
        color: var(--text-secondary);
    }

    .badge-pill--accent {
        background: linear-gradient(135deg, #22c55e, #4ade80);
        border-color: transparent;
        color: #022c22;
        box-shadow: 0 16px 40px rgba(34, 197, 94, 0.85);
        font-weight: 700;
    }

    .tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 9px;
        border-radius: 999px;
        font-size: 11px;
        border: 1px solid rgba(31, 41, 55, 0.9);
        background: radial-gradient(circle at 0 0, #020617, #020617 60%, #000 100%);
        color: var(--text-secondary);
    }

    .tag-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow:
            0 0 0 3px rgba(34, 197, 94, 0.35),
            0 0 22px rgba(34, 197, 94, 0.85);
    }

    .pill-switch {
        display: inline-flex;
        padding: 4px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 0, #020617, #020617 60%, #000 100%);
        border: 1px solid rgba(15, 23, 42, 0.95);
        box-shadow:
            0 0 0 1px rgba(15, 23, 42, 0.9),
            0 18px 42px rgba(0, 0, 0, 0.9);
        gap: 2px;
    }

    .pill-switch__btn {
        padding: 7px 16px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        transition:
            background var(--fast) ease-out,
            color var(--fast) ease-out,
            box-shadow var(--fast) ease-out,
            transform var(--fast) ease-out;
        white-space: nowrap;
    }

    .pill-switch__btn--active {
        background: linear-gradient(135deg, #22c55e, #4ade80);
        color: #020617;
        box-shadow: var(--shadow-glow-accent);
        transform: translateY(-1px);
    }

    .pill-switch__btn:not(.pill-switch__btn--active):hover {
        background: rgba(15, 23, 42, 0.95);
        color: #e5e7eb;
    }

    /* ---------------------------------------------------------------------- */
    /*  ROOT LAYOUT: SIDEBAR + APP SHELL                                     */
    /* ---------------------------------------------------------------------- */

    .vision-root {
        display: flex;
        width: 100%;
        height: 100%;
        min-height: 0;
        min-width: 0;
        color: var(--text-primary);
    }

    /* Left navigation column ------------------------------------------------ */

    .vision-sidebar {
        width: var(--nav-width);
        flex-shrink: 0;
        background:
            radial-gradient(circle at 0 0, #020617, #020617 40%, #000 100%);
        border-right: 1px solid rgba(15, 23, 42, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 18px 0 16px;
        box-shadow: 22px 0 55px rgba(0, 0, 0, 0.96);
        z-index: 20;
    }

    .vision-sidebar__logo {
        width: 52px;
        height: 52px;
        border-radius: 999px;
        background: radial-gradient(circle at 20% 0, #22c55e, #0f172a 60%, #020617);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 24px;
        box-shadow:
            0 0 0 1px rgba(148, 163, 184, 0.4),
            0 24px 58px rgba(34, 197, 94, 0.9);
    }

    .vision-sidebar__logo-inner {
        width: 38px;
        height: 38px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 0, #020617, #000 70%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #bbf7d0;
        font-family: "Cinzel", serif;
        font-size: 22px;
        font-weight: 700;
        letter-spacing: 0.12em;
    }

    .vision-nav {
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100%;
        align-items: center;
        margin-bottom: 18px;
    }

    .vision-nav__item {
        width: 48px;
        height: 48px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        cursor: pointer;
        border: 1px solid transparent;
        background: radial-gradient(circle at 50% 0, rgba(15, 23, 42, 0.9), #020617 70%);
        transition:
            background var(--fast) ease-out,
            color var(--fast) ease-out,
            box-shadow var(--fast) ease-out,
            border-color var(--fast) ease-out,
            transform var(--fast) ease-out;
        position: relative;
    }

    .vision-nav__item svg {
        width: 24px;
        height: 24px;
        stroke-width: 1.6;
    }

    .vision-nav__item:hover {
        color: #e5e7eb;
        border-color: rgba(148, 163, 184, 0.75);
        box-shadow: 0 14px 32px rgba(15, 23, 42, 0.9);
        transform: translateY(-1px);
    }

    .vision-nav__item--active {
        color: #ecfeff;
        background: radial-gradient(circle at 20% 0, #22c55e, #0f172a 55%, #020617);
        border-color: rgba(34, 197, 94, 0.9);
        box-shadow:
            0 0 0 1px rgba(34, 197, 94, 0.8),
            0 20px 46px rgba(34, 197, 94, 0.95);
        transform: translateY(-1px);
    }

    .vision-nav__item--active::before {
        content: "";
        position: absolute;
        left: -12px;
        top: 10px;
        bottom: 10px;
        width: 3px;
        border-radius: 0 12px 12px 0;
        background: linear-gradient(180deg, #22c55e, #a7f3d0);
    }

    .vision-sidebar__footer {
        margin-top: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        width: 100%;
    }

    .vision-sidebar__credits {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 11px;
        color: var(--text-secondary);
    }

    .vision-sidebar__credits-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow:
            0 0 0 3px rgba(34, 197, 94, 0.4),
            0 0 24px rgba(34, 197, 94, 0.9);
        margin-bottom: 4px;
    }

    .vision-sidebar__sale {
        padding: 6px 9px;
        border-radius: 12px;
        background: linear-gradient(135deg, #22c55e, #a3e635);
        color: #052e16;
        font-size: 11px;
        font-weight: 800;
        text-align: center;
        line-height: 1.2;
        box-shadow: 0 16px 40px rgba(34, 197, 94, 0.8);
    }

    .vision-sidebar__user {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        border: 1px solid rgba(31, 41, 55, 0.95);
        background: radial-gradient(circle at 20% 0, #020617, #020617 60%, #000 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        margin-top: 6px;
    }

    /* ---------------------------------------------------------------------- */
    /*  APP SHELL: TOP HEADER + MAIN SPLIT                                   */
    /* ---------------------------------------------------------------------- */

    .vision-app {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        min-height: 0;
    }

    .vision-header {
        height: var(--header-height);
        flex-shrink: 0;
        padding: 0 22px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid rgba(15, 23, 42, 0.96);
        background:
            linear-gradient(
                135deg,
                rgba(15, 23, 42, 0.97),
                rgba(15, 23, 42, 0.94),
                rgba(15, 23, 42, 0.99)
            ),
            radial-gradient(circle at 0 0, rgba(59, 130, 246, 0.25), transparent 60%);
        backdrop-filter: blur(20px);
        box-shadow: 0 20px 55px rgba(0, 0, 0, 0.96);
        z-index: 10;
    }

    .vision-header__left {
        display: flex;
        align-items: center;
        gap: 18px;
        min-width: 0;
    }

    .vision-header__title-block {
        display: flex;
        flex-direction: column;
        gap: 3px;
    }

    .vision-header__title {
        font-size: 19px;
        font-weight: 700;
        letter-spacing: 0.06em;
        text-transform: uppercase;
    }

    .vision-header__subtitle {
        font-size: 11px;
        color: var(--text-secondary);
    }

    .vision-header__model-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 7px 16px;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(15, 23, 42, 0.95);
        background: radial-gradient(circle at 20% 0, #020617, #020617 60%, #000 100%);
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        box-shadow:
            0 0 0 1px rgba(15, 23, 42, 0.92),
            0 18px 42px rgba(0, 0, 0, 0.9);
    }

    .vision-header__model-pill-status {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow:
            0 0 0 3px rgba(34, 197, 94, 0.45),
            0 0 26px rgba(34, 197, 94, 0.95);
    }

    .vision-header__model-pill-chevron {
        width: 10px;
        height: 6px;
        stroke-width: 1.6;
    }

    .vision-header__tabs {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: 24px;
        border-radius: var(--radius-pill);
        padding: 4px;
        border: 1px solid rgba(15, 23, 42, 0.96);
        background: radial-gradient(circle at 30% 0, #020617, #020617 60%, #000 100%);
        box-shadow:
            0 0 0 1px rgba(15, 23, 42, 0.9),
            0 18px 42px rgba(0, 0, 0, 0.9);
    }

    .vision-header__tab {
        padding: 7px 18px;
        border-radius: 999px;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        cursor: pointer;
        white-space: nowrap;
        transition:
            background var(--fast) ease-out,
            color var(--fast) ease-out,
            box-shadow var(--fast) ease-out,
            transform var(--fast) ease-out;
    }

    .vision-header__tab--active {
        background: linear-gradient(135deg, #22c55e, #4ade80);
        color: #020617;
        box-shadow: var(--shadow-glow-accent);
        transform: translateY(-1px);
    }

    .vision-header__tab:not(.vision-header__tab--active):hover {
        background: rgba(15, 23, 42, 0.96);
        color: #e5e7eb;
    }

    .vision-header__right {
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .vision-header__view-pills {
        display: inline-flex;
        align-items: center;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(15, 23, 42, 0.96);
        background: radial-gradient(circle at 30% 0, #020617, #020617 60%, #000 100%);
        padding: 4px;
        box-shadow:
            0 0 0 1px rgba(15, 23, 42, 0.9),
            0 18px 40px rgba(0, 0, 0, 0.9);
        gap: 2px;
    }

    .vision-header__view-btn {
        padding: 7px 16px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        cursor: pointer;
        white-space: nowrap;
        transition:
            background var(--fast) ease-out,
            color var(--fast) ease-out,
            box-shadow var(--fast) ease-out,
            transform var(--fast) ease-out;
    }

    .vision-header__view-btn--active {
        background: linear-gradient(135deg, #22c55e, #4ade80);
        color: #020617;
        box-shadow: var(--shadow-glow-accent);
        transform: translateY(-1px);
    }

    .vision-header__view-btn:not(.vision-header__view-btn--active):hover {
        background: rgba(15, 23, 42, 0.96);
        color: #e5e7eb;
    }

    .vision-header__favorites-toggle {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--text-secondary);
        margin-left: 8px;
        white-space: nowrap;
    }

    .vision-header__favorites-toggle input {
        accent-color: #9ca3af;
    }

    .vision-header__assets-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 18px;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(148, 163, 184, 0.5);
        background: radial-gradient(circle at 30% 0, #020617, #020617 60%, #000 100%);
        font-size: 13px;
        font-weight: 600;
        color: #e5e7eb;
        box-shadow:
            0 0 0 1px rgba(15, 23, 42, 0.95),
            0 18px 40px rgba(0, 0, 0, 0.9);
        white-space: nowrap;
    }

    .vision-header__assets-btn svg {
        width: 18px;
        height: 18px;
        stroke-width: 1.5;
    }

    .vision-header__assets-btn:hover {
        border-color: rgba(209, 213, 219, 0.95);
    }

    /* ---------------------------------------------------------------------- */
    /*  MAIN AREA: CONFIG PANEL + STAGE                                      */
    /* ---------------------------------------------------------------------- */

    .vision-main {
        flex: 1;
        min-height: 0;
        min-width: 0;
        display: grid;
        grid-template-columns: minmax(var(--config-panel-min), var(--config-panel-max)) minmax(
                0,
                1fr
            );
        border-top: 1px solid rgba(15, 23, 42, 0.95);
    }

    .vision-config-panel {
        background: radial-gradient(circle at 0 0, #020617, #020617 60%, #000 100%);
        border-right: 1px solid rgba(15, 23, 42, 0.95);
        display: flex;
        flex-direction: column;
        min-height: 0;
        min-width: 0;
    }

    .vision-config-panel__body {
        flex: 1;
        min-height: 0;
        padding: 20px 22px 18px;
        overflow-y: auto;
    }

    .vision-config-panel__footer {
        flex-shrink: 0;
        padding: 12px 22px 18px;
        border-top: 1px solid rgba(15, 23, 42, 0.96);
        background: radial-gradient(circle at 0 0, #020617, #020617 60%, #000 100%);
        position: sticky;
        bottom: 0;
        z-index: 5;
    }

    .vision-stage {
        background: radial-gradient(circle at 100% 0, #020617, #020617 60%, #000 100%);
        display: flex;
        flex-direction: column;
        min-width: 0;
        min-height: 0;
    }

    .vision-stage__inner {
        flex: 1;
        min-height: 0;
        padding: 22px 22px 18px 22px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        overflow: hidden;
    }

    .vision-stage__toolbar {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        font-size: 12px;
        color: var(--text-secondary);
    }

    .vision-stage__toolbar-left {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .vision-stage__toolbar-right {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: auto;
    }

    .vision-stage__toolbar-icon-btn {
        width: 34px;
        height: 34px;
        border-radius: 999px;
        border: 1px solid rgba(15, 23, 42, 0.96);
        background: radial-gradient(circle at 50% 0, #020617, #020617 60%, #000 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        transition:
            background var(--fast) ease-out,
            color var(--fast) ease-out,
            border-color var(--fast) ease-out,
            box-shadow var(--fast) ease-out;
    }

    .vision-stage__toolbar-icon-btn svg {
        width: 16px;
        height: 16px;
        stroke-width: 1.5;
    }

    .vision-stage__toolbar-icon-btn:hover {
        border-color: rgba(148, 163, 184, 0.95);
        color: #e5e7eb;
        box-shadow: 0 16px 36px rgba(0, 0, 0, 0.9);
    }

    .vision-stage__actions {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 14px;
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }

    .vision-stage__action-link {
        display: inline-flex;
        align-items: center;
        gap: 7px;
        cursor: pointer;
    }

    .vision-stage__action-link--primary {
        color: #f9fafb;
        font-weight: 600;
    }

    .vision-stage__action-link:hover {
        color: #e5e7eb;
    }

    .vision-stage__divider-vertical {
        width: 1px;
        height: 16px;
        background: rgba(31, 41, 55, 0.95);
    }

    .vision-stage__feed-header {
        font-size: 15px;
        font-weight: 700;
        margin-top: 2px;
    }

    .vision-stage__feed-wrapper {
        flex: 1;
        min-height: 0;
        display: flex;
        gap: 16px;
        overflow: hidden;
    }

    .vision-stage__feed-scroll {
        flex: 1;
        min-height: 0;
        max-height: 100%;
        overflow-y: auto;
        padding-right: 4px;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .vision-stage__history-rail {
        width: var(--history-rail-width);
        flex-shrink: 0;
        border-left: 1px solid rgba(15, 23, 42, 0.95);
        padding-left: 10px;
        margin-left: 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 100%;
        overflow-y: auto;
    }

    .vision-stage__history-thumb {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid transparent;
        cursor: pointer;
        opacity: 0.8;
        transition:
            border-color var(--fast) ease-out,
            box-shadow var(--fast) ease-out,
            opacity var(--fast) ease-out,
            transform var(--fast) ease-out;
        background: #020617;
    }

    .vision-stage__history-thumb img,
    .vision-stage__history-thumb video {
        width: 100%;
        aspect-ratio: 9 / 16;
        object-fit: cover;
        display: block;
    }

    .vision-stage__history-thumb-badge {
        position: absolute;
        bottom: 4px;
        right: 4px;
        padding: 2px 5px;
        border-radius: 999px;
        font-size: 9px;
        background: rgba(15, 23, 42, 0.96);
        color: #e5e7eb;
    }

    .vision-stage__history-thumb--active {
        opacity: 1;
        border-color: #22c55e;
        box-shadow:
            0 0 0 1px rgba(34, 197, 94, 0.8),
            0 0 22px rgba(34, 197, 94, 0.9);
        transform: translateY(-1px);
    }

    /* Card (preview item) base --------------------------------------------- */

    .vision-card {
        border-radius: 22px;
        border: 1px solid rgba(15, 23, 42, 0.95);
        background: radial-gradient(circle at 10% 0, #0b1120, #020617 70%);
        box-shadow:
            0 0 0 1px rgba(15, 23, 42, 0.95),
            0 26px 60px rgba(0, 0, 0, 0.96);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .vision-card__media {
        width: 100%;
        aspect-ratio: 16 / 9;
        background: #020617;
        overflow: hidden;
        position: relative;
    }

    .vision-card__media img,
    .vision-card__media video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .vision-card__media-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        padding: 10px 12px;
        background: linear-gradient(
            to top,
            rgba(15, 23, 42, 0.85),
            rgba(15, 23, 42, 0.6),
            transparent
        );
        pointer-events: none;
        color: #e5e7eb;
        font-size: 12px;
    }

    .vision-card__media-overlay-left {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .vision-card__media-overlay-right {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .vision-card__media-chip {
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.92);
        border: 1px solid rgba(31, 41, 55, 0.95);
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .vision-card__bottom {
        padding: 10px 12px 11px;
        border-top: 1px solid rgba(15, 23, 42, 0.95);
        background: radial-gradient(circle at 0 0, #020617, #020617 60%, #000 100%);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        font-size: 12px;
        color: var(--text-secondary);
    }

    .vision-card__title-block {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .vision-card__title {
        font-size: 13px;
        font-weight: 600;
        color: #e5e7eb;
    }

    .vision-card__meta {
        font-size: 11px;
        color: var(--text-muted);
    }

    .vision-card__actions {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .vision-card__icon-btn {
        width: 28px;
        height: 28px;
        border-radius: 999px;
        border: 1px solid rgba(31, 41, 55, 0.95);
        background: radial-gradient(circle at 50% 0, #020617, #020617 60%, #000 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        transition:
            background var(--fast) ease-out,
            color var(--fast) ease-out,
            border-color var(--fast) ease-out,
            box-shadow var(--fast) ease-out;
    }

    .vision-card__icon-btn svg {
        width: 16px;
        height: 16px;
        stroke-width: 1.5;
    }

    .vision-card__icon-btn:hover {
        border-color: rgba(148, 163, 184, 0.95);
        color: #e5e7eb;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.9);
    }

    .vision-card--active {
        border-color: #22c55e;
        box-shadow:
            0 0 0 1px rgba(34, 197, 94, 0.8),
            0 26px 62px rgba(34, 197, 94, 0.9);
    }
    /* ====================================================================== */
/* SURGICAL ADDITIONS - Reference Previews & Ask SIA                     */
/* ====================================================================== */

/* Kling-style prominent reference image preview container */
.reference-preview-large {
    width: 100%;
    /* Default aspect, can be overridden via JS if needed */
    aspect-ratio: 16 / 9;
    background: #020617;
    border-radius: 14px;
    border: 1px solid rgba(31, 41, 55, 0.95);
    overflow: hidden;
    display: none; /* Hidden until image added */
    margin-bottom: 12px;
    position: relative;
}

/* Class added via JS when an image is loaded */
.reference-preview-large.has-image {
    display: block;
}

.reference-preview-large img {
    width: 100%;
    height: 100%;
    object-fit: contain; /* Ensure whole image is visible like Kling */
}

/* Small "Ask SIA" magic button next to prompt labels */
.ask-sia-prompt-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    border-radius: 6px;
    border: 1px solid rgba(34, 197, 94, 0.3);
    background: rgba(34, 197, 94, 0.1);
    color: #4ade80;
    cursor: pointer;
    transition: all 0.2s ease;
}

.ask-sia-prompt-btn:hover {
    background: rgba(34, 197, 94, 0.2);
    border-color: rgba(34, 197, 94, 0.6);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
}

.ask-sia-prompt-btn svg {
    width: 14px;
    height: 14px;
}

/* Label container to hold the label text and the new button */
.prompt-label-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}
/* ====================================================================== */
/* SULANDRA UPLOAD BOX STYLE                                             */
/* ====================================================================== */

.sulandra-upload-box {
    width: 100%;
    aspect-ratio: 16 / 9; /* Cinematic shape */
    background: #0f172a;  /* Darker background */
    border-radius: 16px;
    border: 1px dashed rgba(51, 65, 85, 0.8);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.2s ease;
    margin-bottom: 16px;
    text-align: center;
}

.sulandra-upload-box:hover {
    border-color: #22c55e; /* Green accent on hover */
    background: #1e293b;
}

/* The Placeholder content (Icon + Text) */
.sulandra-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    color: #9ca3af;
    pointer-events: none; /* Clicks pass through to the label */
    padding: 20px;
}

.sulandra-placeholder svg {
    width: 32px;
    height: 32px;
    color: #4ade80; /* Accent color icon */
    opacity: 0.8;
}

.sulandra-placeholder-title {
    font-size: 13px;
    font-weight: 600;
    color: #e5e7eb;
}

.sulandra-placeholder-sub {
    font-size: 11px;
    color: #64748b;
}

/* The Image Preview (Hidden by default) */
.sulandra-preview-img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: contain; /* Show full image */
    background: #000;
    z-index: 10;
    display: none;
}

/* State: When file is selected */
.sulandra-upload-box.has-file .sulandra-preview-img {
    display: block;
}

.sulandra-upload-box.has-file .sulandra-placeholder {
    display: none;
}

/* Remove button (appears on hover when file exists) */
.sulandra-remove-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    background: rgba(0,0,0,0.6);
    border-radius: 50%;
    color: white;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 20;
    border: 1px solid rgba(255,255,255,0.2);
}

.sulandra-upload-box.has-file:hover .sulandra-remove-btn {
    display: flex;
}
/* Compact version for dual frames and list items */
.sulandra-upload-box.compact {
    aspect-ratio: 16 / 9;
    min-height: 80px;
    margin-bottom: 8px;
}

.sulandra-upload-box.compact .sulandra-placeholder {
    padding: 10px;
    gap: 4px;
}

.sulandra-upload-box.compact .sulandra-placeholder svg {
    width: 20px;
    height: 20px;
}

.sulandra-upload-box.compact .sulandra-placeholder-title {
    font-size: 11px;
}

.sulandra-upload-box.compact .sulandra-placeholder-sub {
    display: none; /* Hide subtitle to save space */
}
/* ====================================================================== */
/* ASK SIA - MODERN CHAT UI (Left Sidebar & Green Branding)              */
/* ====================================================================== */

.ask-sia-panel-backdrop {
    position: fixed;
    top: 0;
    bottom: 0;
    left: 80px; /* Locked next to nav bar */
    right: 0;
    background: rgba(0,0,0,0.4);
    display: none; 
    justify-content: flex-start; /* Aligns panel to the LEFT */
    z-index: 99999;
    backdrop-filter: blur(4px);
}

.ask-sia-panel {
    width: 400px;
    max-width: 90%;
    height: 100%;
    background: #020617; /* Matches app theme */
    border-right: 1px solid rgba(255,255,255,0.1);
    box-shadow: 10px 0 50px rgba(0,0,0,0.8);
    display: flex;
    flex-direction: column;
    animation: slideInLeft 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes slideInLeft {
    from { transform: translateX(-100%); }
    to { transform: translateX(0); }
}

/* Header & Logo */
.ask-sia-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    background: rgba(15, 23, 42, 0.5);
}

.ask-sia-title {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* FIXED LOGO: Sulandra Green Gradient */
/* ====================================================================== */
/* FIXED: SPARKLE ICON & NEON TEXT (Matches Lab Buttons)                 */
/* ====================================================================== */

.ask-sia-icon-large {
    width: 32px;
    height: 32px;
    background: transparent; /* Removes the green box */
    border: none;
    box-shadow: none;
    
    /* Center the sparkle */
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* Hide the letter 'S' */
    color: transparent;
    font-size: 0;
    
    position: relative;
}

/* The Neon Sparkle */
.ask-sia-icon-large::after {
    content: "✦";
    font-size: 22px;        /* Large visible sparkle */
    color: #86efac;         /* Neon Green */
    text-shadow: 
        0 0 5px #fff,
        0 0 12px #22c55e,
        0 0 20px #22c55e;
    
    /* Use the same animation defined in your neon triggers */
    animation: sulandra-sparkle 2s infinite ease-in-out;
}

/* Force the "Ask SIA" title text to match the Neon look */
.ask-sia-title > div:last-child > div:first-child {
    font-family: 'Cinzel', serif !important;
    font-size: 16px !important;
    font-weight: 700 !important;
    letter-spacing: 0.08em !important;
    text-transform: uppercase;
    color: #fff !important;
    
    /* The Neon Glow Effect */
    text-shadow: 
        0 0 4px rgba(255,255,255,0.6),
        0 0 10px rgba(34, 197, 94, 0.8),
        0 0 20px rgba(34, 197, 94, 0.4);
}

.ask-sia-close {
    cursor: pointer;
    color: #64748b;
    transition: color 0.2s;
}
.ask-sia-close:hover { color: #fff; }

/* Scrollable Chat Area */
.ask-sia-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

/* Context Bubble */
.ask-sia-context-box {
    background: rgba(30, 41, 59, 0.4);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 10px;
    padding: 10px;
    font-size: 11px;
    color: #94a3b8;
    font-family: 'JetBrains Mono', monospace;
    margin-bottom: 10px;
}

/* AI Response Text */
.ask-sia-answer-box {
    font-size: 13px;
    color: #e2e8f0;
    line-height: 1.6;
}

/* Footer (Input Area) */
.ask-sia-footer {
    padding: 16px 20px;
    border-top: 1px solid rgba(255,255,255,0.1);
    background: #020617;
}

.ask-sia-input-wrapper {
    position: relative;
    width: 100%;
}

.ask-sia-textarea {
    width: 100%;
    background: #1e293b;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px;
    padding: 12px 45px 12px 16px;
    color: #fff;
    font-size: 13px;
    resize: none;
    height: 48px;
    transition: all 0.2s;
}

.ask-sia-textarea:focus {
    background: #0f172a;
    border-color: #22c55e;
    box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
}

.ask-sia-send-btn {
    position: absolute;
    right: 6px;
    bottom: 6px;
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, #22c55e, #4ade80);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #022c22;
    cursor: pointer;
    transition: transform 0.2s;
}
.ask-sia-send-btn:hover { transform: scale(1.05); }

/* "Use Prompt" Button Style */
.ask-sia-suggestion {
    background: rgba(34, 197, 94, 0.08);
    border: 1px solid rgba(34, 197, 94, 0.2);
    border-radius: 12px;
    padding: 12px;
    margin-top: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.ask-sia-suggestion-text {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: #86efac;
    background: rgba(0,0,0,0.3);
    padding: 8px;
    border-radius: 6px;
}
.ask-sia-use-btn {
    align-self: flex-start;
    background: #22c55e;
    color: #022c22;
    font-size: 11px;
    font-weight: 700;
    padding: 6px 12px;
    border-radius: 99px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}
.ask-sia-use-btn:hover { background: #4ade80; }
/* ====================================================================== */
/* ASK SIA - SIDE PANEL STYLES                                            */
/* ====================================================================== */

.ask-sia-panel-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none; /* Hidden by default */
    justify-content: flex-end;
    z-index: 99999;
    backdrop-filter: blur(2px);
}

.ask-sia-panel {
    width: 380px;
    max-width: 90%;
    height: 100%;
    background: radial-gradient(circle at 0% 0%, rgba(69,241,255,0.1), transparent 60%),
                radial-gradient(circle at 100% 100%, rgba(34, 197, 94, 0.1), transparent 60%),
                #020617;
    border-left: 1px solid rgba(255,255,255,0.1);
    box-shadow: -8px 0 40px rgba(0,0,0,0.8);
    display: flex;
    flex-direction: column;
    padding: 16px;
    animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes slideInRight {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

.ask-sia-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.ask-sia-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    font-weight: 700;
    color: #e5e7eb;
}

.ask-sia-close {
    cursor: pointer;
    color: #9ca3af;
    padding: 4px;
}
.ask-sia-close:hover { color: #fff; }

.ask-sia-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 16px;
    overflow-y: auto;
}

.ask-sia-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #6b7280;
    margin-bottom: 6px;
}

.ask-sia-context-box {
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 10px;
    font-size: 11px;
    color: #9ca3af;
    font-family: 'JetBrains Mono', monospace;
    max-height: 100px;
    overflow-y: auto;
}

.ask-sia-textarea {
    width: 100%;
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 10px;
    padding: 10px;
    color: #fff;
    font-size: 12px;
    resize: vertical;
    min-height: 80px;
}
.ask-sia-textarea:focus { border-color: #4ade80; }

.ask-sia-answer-box {
    flex: 1;
    overflow-y: auto; /* ENABLE SCROLLING */
    display: flex;
    flex-direction: column; /* Stack bubbles vertically */
    gap: 10px;
    padding: 10px;
    margin-bottom: 10px;
    /* Optional: custom scrollbar looks nicer */
    scrollbar-width: thin; 
    scrollbar-color: #334155 transparent;
}

.ask-sia-main-btn {
    width: 100%;
    padding: 10px;
    border-radius: 99px;
    background: linear-gradient(135deg, #22c55e, #4ade80);
    color: #022c22;
    font-weight: 600;
    font-size: 12px;
    margin-top: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
}
/* ====================================================================== */
/* SULANDRA NEON TRIGGER (Sparkling Text)                                */
/* ====================================================================== */

.sulandra-neon-trigger {
    font-family: 'Cinzel', serif;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.08em;
    color: #e2e8f0;
    cursor: pointer;
    text-transform: uppercase;
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-left: auto; /* Push to right */
    
    /* The Neon Glow */
    text-shadow: 
        0 0 2px rgba(255,255,255,0.8),
        0 0 8px rgba(34, 197, 94, 0.8),
        0 0 15px rgba(34, 197, 94, 0.6);
    
    transition: all 0.3s ease;
    animation: sulandra-pulse 3s infinite alternate;
}

/* Sparkle icon pseudo-element */
.sulandra-neon-trigger::before {
    content: "✦";
    font-size: 10px;
    color: #86efac;
    text-shadow: 0 0 5px #fff;
    animation: sulandra-sparkle 1.5s infinite linear;
}

.sulandra-neon-trigger:hover {
    color: #fff;
    text-shadow: 
        0 0 4px #fff,
        0 0 10px #4ade80,
        0 0 20px #4ade80,
        0 0 30px #22c55e;
    transform: scale(1.02);
}

@keyframes sulandra-pulse {
    0% { opacity: 0.9; }
    100% { opacity: 1; text-shadow: 0 0 4px #fff, 0 0 12px #22c55e, 0 0 25px #22c55e; }
}

@keyframes sulandra-sparkle {
    0% { opacity: 0.5; transform: scale(0.8) rotate(0deg); }
    50% { opacity: 1; transform: scale(1.2) rotate(180deg); }
    100% { opacity: 0.5; transform: scale(0.8) rotate(360deg); }
}
/* ====================================================================== */
/* SULANDRA NEON TRIGGER (Sparkling Text)                                */
/* ====================================================================== */

.sulandra-neon-trigger {
    font-family: 'Cinzel', serif; /* Matches your logo font for elegance */
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.08em;
    color: #e2e8f0;
    cursor: pointer;
    text-transform: uppercase;
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    
    /* The Neon Glow */
    text-shadow: 
        0 0 2px rgba(255,255,255,0.8),
        0 0 8px rgba(34, 197, 94, 0.8),
        0 0 15px rgba(34, 197, 94, 0.6);
    
    transition: all 0.3s ease;
    animation: sulandra-pulse 3s infinite alternate;
}

/* Sparkle icon (optional pseudo-element) */
.sulandra-neon-trigger::before {
    content: "✦";
    font-size: 10px;
    color: #86efac; /* Lighter green */
    text-shadow: 0 0 5px #fff;
    animation: sulandra-sparkle 1.5s infinite linear;
}

.sulandra-neon-trigger:hover {
    color: #fff;
    text-shadow: 
        0 0 4px #fff,
        0 0 10px #4ade80,
        0 0 20px #4ade80,
        0 0 30px #22c55e;
    transform: scale(1.02);
}

@keyframes sulandra-pulse {
    0% { opacity: 0.9; }
    100% { opacity: 1; text-shadow: 0 0 4px #fff, 0 0 12px #22c55e, 0 0 25px #22c55e; }
}

@keyframes sulandra-sparkle {
    0% { opacity: 0.5; transform: scale(0.8) rotate(0deg); }
    50% { opacity: 1; transform: scale(1.2) rotate(180deg); }
    100% { opacity: 0.5; transform: scale(0.8) rotate(360deg); }
}
/* ====================================================================== */
/* PLACEHOLDER & LOADING STATES                                         */
/* ====================================================================== */

.gallery-card--loading .gallery-card__media-wrapper {
    background: #020617;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

/* Futuristic Shimmer Animation */
.gallery-card--loading .gallery-card__media-wrapper::after {
    content: "";
    position: absolute;
    top: 0;
    left: -150%;
    width: 300%;
    height: 100%;
    background: linear-gradient(
        115deg,
        transparent 20%,
        rgba(34, 197, 94, 0.1) 40%,
        rgba(96, 165, 250, 0.2) 50%,
        rgba(34, 197, 94, 0.1) 60%,
        transparent 80%
    );
    animation: futuristic-shimmer 2.5s infinite linear;
    z-index: 1;
}

@keyframes futuristic-shimmer {
    0% { transform: translateX(0) skewX(-20deg); }
    100% { transform: translateX(50%) skewX(-20deg); }
}

/* Loading Spinner/Text container */
.gallery-card-loader-content {
    z-index: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    color: var(--accent-primary);
}

/* Neon Spinner */
.neon-spinner {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid transparent;
    border-top-color: var(--accent-primary);
    border-right-color: var(--accent-secondary);
    box-shadow: 0 0 15px var(--accent-primary-soft), inset 0 0 15px var(--accent-secondary-soft);
    animation: neon-spin 1.2s linear infinite;
}

@keyframes neon-spin {
    to { transform: rotate(360deg); }
}

.gallery-card--loading .gallery-card__title {
    color: var(--text-muted);
    font-style: italic;
}
        /* ====================================================================== */
/* FORCE LEFT SIDEBAR (Overrides any previous Right-side settings)      */
/* ====================================================================== */

.ask-sia-panel-backdrop {
    /* Force alignment to the START (Left) instead of End (Right) */
    justify-content: flex-start !important; 
    
    /* Position it exactly 80px from the left (next to your nav bar) */
    left: 80px !important; 
    right: 0;
}

.ask-sia-panel {
    /* Flip the borders so the line is on the right side of the panel */
    border-right: 1px solid rgba(255,255,255,0.1) !important;
    border-left: none !important;
    
    /* Force the Left-side animation */
    animation: forceSlideInLeft 0.3s cubic-bezier(0.16, 1, 0.3, 1) !important;
}

/* Define the left-side slide animation */
@keyframes forceSlideInLeft {
    from { transform: translateX(-100%); }
    to { transform: translateX(0); }
}
</style>
<script type="module">
    import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client";
    window.GradioClient = Client;

    /* ====================================================================== */
    /* FIXED: GLOBAL SIA & DOWNLOAD FUNCTIONS                                */
    /* ====================================================================== */

    // 1. Initialize State (FIXED: Attached to window so Send Button can see it)
    window.askSiaState = { context: "" };

    // 2. Open SIA (Attached to Window so HTML can see it)
    window.openAskSia = function(contextType, contextText) {
        const backdrop = document.getElementById("askSiaBackdrop");
        const contextBox = document.getElementById("askSiaContext");
        const answerBox = document.getElementById("askSiaAnswer");
        const questionBox = document.getElementById("askSiaQuestion");

        if (backdrop) {
            backdrop.style.display = "flex"; // Shows panel (CSS handles position)
            if (questionBox) {
                questionBox.value = "";
                questionBox.focus();
            }
        }

        if (contextBox) {
            const cleanText = (contextText || "General Query").substring(0, 150);
            contextBox.textContent = `[${contextType.toUpperCase()}] ${cleanText}${contextText.length > 150 ? "..." : ""}`;
            // FIX: Update the global state
            window.askSiaState.context = contextText;
        }

        if (answerBox) {
            answerBox.innerHTML = '<span style="color:#6b7280; font-style:italic;">I am listening. How can I help with this?</span>';
        }
    };

    // 3. Close SIA
    window.closeAskSia = function() {
        const backdrop = document.getElementById("askSiaBackdrop");
        if (backdrop) backdrop.style.display = "none";
    };

    // 4. Strict Download (Attached to Window)
    window.downloadHistoryItem = async function(item) {
        if (!item || !item.url) {
            showSulandraToast("Error: No file URL found.", "error");
            return;
        }

        showSulandraToast("Downloading...", "info");

        try {
            const response = await fetch(item.url);
            if (!response.ok) throw new Error("File fetch failed");
            
            const blob = await response.blob();
            const objectUrl = URL.createObjectURL(blob);
            
            const a = document.createElement("a");
            let ext = item.kind === "video" || item.kind === "shortfilm" ? ".mp4" : ".png";
            
            // Clean title for filename
            const safeTitle = (item.title || "sulandra_creation").replace(/[^a-z0-9]/gi, '_').toLowerCase();
            
            a.href = objectUrl;
            a.download = `${safeTitle}${ext}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            setTimeout(() => URL.revokeObjectURL(objectUrl), 1000);
            
            showSulandraToast("Download complete.", "success");

        } catch (err) {
            console.error("Download error:", err);
            // Strict mode: Toast error only, NO new window opening.
            showSulandraToast("Download failed. The server blocked the request.", "error");
        }
    };
</script>
</head>
<body>
<div class="vision-root">

    <!-- =============================================================== -->
    <!--  LEFT SIDEBAR – Sulandra Nav                                   -->
    <!-- =============================================================== -->
    <aside class="vision-sidebar">
        <div class="vision-sidebar__logo">
            <div class="vision-sidebar__logo-inner">
                S
            </div>
        </div>

        <nav class="vision-nav" aria-label="Main navigation">
            <!-- Home / Feed -->
            <button class="vision-nav__item" data-nav="home" title="Home">
                <svg viewBox="0 0 24 24" fill="none">
                    <path d="M4 11L12 4L20 11" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M6 10.5V19H10.5V14.5H13.5V19H18V10.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>

            <!-- Vision Lab (current) -->
<button class="vision-nav__item vision-nav__item--active" data-lab-nav="image" title="Image Lab">
    <svg viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="1.5"/><circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/><path d="M21 15L16 10L5 21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
</button>

<button class="vision-nav__item" data-lab-nav="video" title="Video Lab">
    <svg viewBox="0 0 24 24" fill="none"><path d="M15 10L20 7V17L15 14V10Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><rect x="4" y="6" width="11" height="12" rx="2" stroke="currentColor" stroke-width="1.5"/></svg>
</button>

<button class="vision-nav__item" data-lab-nav="shortfilm" title="Short Film Lab">
    <svg viewBox="0 0 24 24" fill="none"><path d="M19.82 2H4.18C2.97602 2 2 2.97602 2 4.18V19.82C2 21.024 2.97602 22 4.18 22H19.82C21.024 22 22 21.024 22 19.82V4.18C22 2.97602 21.024 2 19.82 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 2V22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M17 2V22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 12H22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 7H7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 17H7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M17 17H22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M17 7H22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
</button>

            <!-- Sound Lab placeholder -->
            <button class="vision-nav__item" data-nav="sound" title="Sound Lab">
                <svg viewBox="0 0 24 24" fill="none">
                    <path d="M5 9V15" stroke="currentColor" stroke-linecap="round"/>
                    <path d="M9 7V17" stroke="currentColor" stroke-linecap="round"/>
                    <path d="M13 5V19" stroke="currentColor" stroke-linecap="round"/>
                    <path d="M17 8V16" stroke="currentColor" stroke-linecap="round"/>
                </svg>
            </button>

            <!-- Studio placeholder -->
            <button class="vision-nav__item" data-nav="studio" title="Sulandra Studio">
                <svg viewBox="0 0 24 24" fill="none">
                    <rect x="3.5" y="4.5" width="17" height="15" rx="2" stroke="currentColor"/>
                    <path d="M3.5 9.5H20.5" stroke="currentColor"/>
                    <path d="M10 14H14" stroke="currentColor" stroke-linecap="round"/>
                </svg>
            </button>

            <!-- Explore / School placeholder -->
            <button class="vision-nav__item" data-nav="school" title="Sulandra School of Arts">
                <svg viewBox="0 0 24 24" fill="none">
                    <path d="M4 9L12 4L20 9L12 14L4 9Z" stroke="currentColor" stroke-linejoin="round"/>
                    <path d="M6 10.5V15.5C8 18 10 19 12 19C14 19 16 18 18 15.5V10.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </nav>

        <div class="vision-sidebar__footer">
            <div class="vision-sidebar__credits">
                <div class="vision-sidebar__credits-dot"></div>
                <div>Sulandra Creative Network</div>
                <div class="text-muted" style="font-size:10px;">Vision · RunPod · SIA Brain</div>
            </div>
            <div class="vision-sidebar__sale">
                SAVE<br>50% OFF
            </div>
            <div class="vision-sidebar__user" title="Account">
                <svg viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="9" r="3" stroke="currentColor"/>
                    <path d="M6 19C7.5 16.5 9.5 15.25 12 15.25C14.5 15.25 16.5 16.5 18 19" stroke="currentColor" stroke-linecap="round"/>
                </svg>
            </div>
        </div>
    </aside>

    <!-- =============================================================== -->
    <!--  APP SHELL – HEADER & MAIN SPLIT                               -->
    <!-- =============================================================== -->
    <div class="vision-app">

        <!-- =========================================================== -->
        <!--  TOP HEADER                                                 -->
        <!-- =========================================================== -->
        <header class="vision-header">
            <div class="vision-header__left">
                <div class="vision-header__title-block">
                    <div class="vision-header__title">Sulandra Vision Lab</div>
                    <div class="vision-header__subtitle">
                        Unified AI Image · Video · Short Film generator – powered by Sulandra on RunPod
                    </div>
                </div>

                <!-- Model pill -->
                <button class="vision-header__model-pill" type="button" id="model-pill">
                    <span class="vision-header__model-pill-status"></span>
                    <span>Sulandra Vision Flux&nbsp;2.0</span>
                    <svg class="vision-header__model-pill-chevron" viewBox="0 0 12 8" fill="none">
                        <path d="M2 2L6 6L10 2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>

                <!-- Main lab tabs -->
               
            </div>

            <div class="vision-header__right">
                <!-- Create / View toggle -->
                <div class="vision-header__view-pills" id="mode-toggle">
                    <button
                        class="vision-header__view-btn vision-header__view-btn--active"
                        data-mode="create"
                        type="button"
                    >
                        Create
                    </button>
                    <button
                        class="vision-header__view-btn"
                        data-mode="view"
                        type="button"
                    >
                        My Files
                    </button>
                </div>

                <!-- Favorites toggle -->
                <label class="vision-header__favorites-toggle">
                    <input type="checkbox" id="favorites-toggle-checkbox" />
                    <span>Show favorites only</span>
                </label>

                <!-- Assets button (opens assets panel / right drawer later) -->
                <button class="vision-header__assets-btn" type="button" id="open-assets-btn">
                    <svg viewBox="0 0 24 24" fill="none">
                        <rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor"/>
                        <path d="M3 9H21" stroke="currentColor"/>
                        <path d="M9 14H15" stroke="currentColor" stroke-linecap="round"/>
                    </svg>
                    <span>Assets</span>
                </button>
            </div>
        </header>

        <!-- =========================================================== -->
        <!--  MAIN AREA – CONFIG PANEL + STAGE                          -->
        <!-- =========================================================== -->
        <main class="vision-main">

            <!-- ======================================================= -->
            <!--  LEFT: CONFIG PANEL (per-lab controls)                 -->
            <!-- ======================================================= -->
            <section class="vision-config-panel" aria-label="Generation controls">
                <div class="vision-config-panel__body">

                    <!-- =================================================== -->
                    <!--  IMAGE LAB CONFIG                                   -->
                    <!-- =================================================== -->
<div class="lab-config" id="lab-config-image" data-lab="image">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <div>
            <div style="font-size:15px;font-weight:600;">Image Generator</div>
            <div class="text-muted" style="font-size:12px;margin-top:2px;">
                Text-to-Image · Image-to-Image · Styles · Aspect ratios
            </div>
        </div>
        <div class="pill-switch" id="image-mode-switch">
            <button type="button" class="pill-switch__btn pill-switch__btn--active" data-image-mode="text">Text → Image</button>
            <button type="button" class="pill-switch__btn" data-image-mode="image">Image → Image</button>
        </div>
    </div>

    <div id="image-reference-block" style="margin-bottom:16px; display:none;">
        <div class="text-soft" style="font-size:12px;margin-bottom:6px;">Reference image</div>
        <label class="sulandra-upload-box" id="image-upload-box" for="image-reference-input">
            <div class="sulandra-placeholder">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 5V19M5 12H19" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <div>
                    <div class="sulandra-placeholder-title">Add a start image</div>
                    <div class="sulandra-placeholder-sub">Click to upload (JPG/PNG)</div>
                </div>
            </div>
            <img id="image-preview-img" class="sulandra-preview-img" alt="Reference Preview" />
            <button type="button" class="sulandra-remove-btn" onclick="clearReference('image'); event.preventDefault();">×</button>
            <input id="image-reference-input" type="file" accept="image/*" class="visually-hidden" />
        </label>
    </div>

    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:16px;">
        <div>
            <div class="prompt-label-row">
                <label for="image-main-prompt" class="text-soft" style="font-size:12px;">Prompt</label>
                <span class="sulandra-neon-trigger" data-target-prompt="image-main-prompt">Ask SIA</span>
            </div>
            <div style="margin-top:6px;">
                <textarea id="image-main-prompt" rows="4" placeholder="Describe the image you want Sulandra to create..." style="width:100%;border-radius:16px;border:1px solid rgba(31,41,55,0.95);padding:10px 12px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-primary);resize:vertical;min-height:90px;"></textarea>
            </div>
        </div>

        <div>
            <div class="prompt-label-row">
                <label for="image-negative-prompt" class="text-soft" style="font-size:12px;">Negative prompt</label>
                <span class="sulandra-neon-trigger" data-target-prompt="image-negative-prompt">Ask SIA</span>
            </div>
            <div style="margin-top:6px;">
                <textarea id="image-negative-prompt" rows="2" placeholder="Things to avoid (blur, watermark, distortion, etc.)" style="width:100%;border-radius:14px;border:1px solid rgba(31,41,55,0.95);padding:8px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-primary);resize:vertical;min-height:60px;"></textarea>
            </div>
        </div>
    </div>

    <div style="display:flex;gap:10px;margin-bottom:14px;">
        <div style="flex:2;">
             <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Aspect ratio</div>
             <div class="pill-switch" id="image-aspect-switch" style="width:100%; display:flex;">
                 <button type="button" class="pill-switch__btn pill-switch__btn--active" style="flex:1; justify-content:center;" data-image-aspect="1:1">1:1</button>
                 <button type="button" class="pill-switch__btn" style="flex:1; justify-content:center;" data-image-aspect="16:9">16:9</button>
                 <button type="button" class="pill-switch__btn" style="flex:1; justify-content:center;" data-image-aspect="9:16">9:16</button>
             </div>
         </div>
         <div style="flex:1;">
             <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Variations</div>
             <select id="image-variations-select" style="width:100%;border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:7px 12px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:12px; text-align:center;">
                 <option value="1" selected>1</option>
                 <option value="2">2</option>
                 <option value="3">3</option>
                 <option value="4">4</option>
             </select>
         </div>
     
     <div style="display:flex;gap:10px;">
            <div style="flex:1;">
                <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Style preset</div>
                <select id="image-style-select" style="width:100%;border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:7px 12px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:12px;">
                    <option value="natural">Natural photo</option>
                    <option value="cinematic">Cinematic</option>
                    <option value="anime">Anime / Stylized</option>
                    <option value="digital-art">Digital art</option>
                    <option value="3d">3D render</option>
                    <option value="illustration">Illustration</option>
                </select>
            </div>
            <div style="width:120px;">
                <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Guidance</div>
                <input type="range" id="image-guidance-slider" min="1" max="20" value="7" style="width:100%;" />
                <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-muted);margin-top:2px;">
                    <span>Loose</span><span id="image-guidance-value">7</span><span>Strict</span>
                </div>
            </div>
        </div>
    </div>

    <div style="display:flex;gap:10px;margin-bottom:10px;">
        <div style="flex:1;">
            <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Steps</div>
            <input type="number" id="image-steps-input" value="30" min="10" max="80" style="width:100%;border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:7px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:12px;" />
        </div>
        <div style="flex:1;">
            <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Seed</div>
            <input type="number" id="image-seed-input" placeholder="Random" style="width:100%;border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:7px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:12px;" />
        </div>
    </div>

    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;font-size:11px;color:var(--text-muted);">
        <div><span id="image-estimate-res">1024 × 1024</span><span>&nbsp;•</span><span id="image-estimate-cost">~1 credit</span></div>
        <button type="button" id="image-toggle-advanced" style="border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:4px 8px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:11px;">Advanced settings</button>
    </div>

    <div id="image-advanced-panel" class="hidden" style="margin-top:8px;font-size:11px;color:var(--text-secondary);border-radius:14px;border:1px solid rgba(31,41,55,0.95);padding:8px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);">
        <div style="display:flex;flex-direction:column;gap:6px;">
            <label><input type="checkbox" id="image-enable-upscale" /><span>&nbsp;Upscale after generation</span></label>
            <label><input type="checkbox" id="image-enable-face-fix" /><span>&nbsp;Face enhancement</span></label>
            <label><input type="checkbox" id="image-enable-tiling" /><span>&nbsp;Seamless tiling</span></label>
        </div>
    </div>
</div>

                    <!-- =================================================== -->
                    <!--  VIDEO LAB CONFIG                                   -->
                    <!-- =================================================== -->
                   <div class="lab-config hidden" id="lab-config-video" data-lab="video">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <div>
            <div style="font-size:15px;font-weight:600;">Video Generator</div>
            <div class="text-muted" style="font-size:12px;margin-top:2px;">
                Text-to-Video · Image-to-Video · Native audio · Durations
            </div>
        </div>
        <div class="pill-switch" id="video-mode-switch">
            <button type="button" class="pill-switch__btn pill-switch__btn--active" data-video-mode="text">Text → Video</button>
            <button type="button" class="pill-switch__btn" data-video-mode="image">Image → Video</button>
        </div>
    </div>

    <div id="video-reference-block" style="margin-bottom:16px; display:none;">
        <div style="display:flex; gap:10px;">
            <div style="flex:1;">
                <div class="text-soft" style="font-size:12px;margin-bottom:6px;">Start Frame</div>
                <label class="sulandra-upload-box compact" id="video-start-box" for="video-start-input">
                    <div class="sulandra-placeholder">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5 12h14M5 12l6-6m-6 6l6 6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        <div class="sulandra-placeholder-title">Start Image</div>
                    </div>
                    <img id="video-start-img" class="sulandra-preview-img" alt="Start Preview" />
                    <button type="button" class="sulandra-remove-btn" onclick="clearReference('video-start'); event.preventDefault();">×</button>
                    <input id="video-start-input" type="file" accept="image/*" class="visually-hidden" />
                </label>
            </div>
            <div style="flex:1;">
                <div class="text-soft" style="font-size:12px;margin-bottom:6px;">End Frame (Opt)</div>
                <label class="sulandra-upload-box compact" id="video-end-box" for="video-end-input">
                    <div class="sulandra-placeholder">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 12H5m14 0l-6-6m6 6l-6 6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        <div class="sulandra-placeholder-title">End Image</div>
                    </div>
                    <img id="video-end-img" class="sulandra-preview-img" alt="End Preview" />
                    <button type="button" class="sulandra-remove-btn" onclick="clearReference('video-end'); event.preventDefault();">×</button>
                    <input id="video-end-input" type="file" accept="image/*" class="visually-hidden" />
                </label>
            </div>
        </div>
    </div>

    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:16px;">
        <div>
            <div class="prompt-label-row">
                <label for="video-main-prompt" class="text-soft" style="font-size:12px;">Prompt</label>
                <span class="sulandra-neon-trigger" data-target-prompt="video-main-prompt">Ask SIA</span>
            </div>
            <div style="margin-top:6px;">
                <textarea id="video-main-prompt" rows="4" placeholder="Describe the motion, camera moves, and scene for the video..." style="width:100%;border-radius:16px;border:1px solid rgba(31,41,55,0.95);padding:10px 12px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-primary);resize:vertical;min-height:90px;"></textarea>
            </div>
        </div>
        <div>
            <div class="prompt-label-row">
                <label for="video-negative-prompt" class="text-soft" style="font-size:12px;">Negative prompt</label>
                <span class="sulandra-neon-trigger" data-target-prompt="video-negative-prompt">Ask SIA</span>
            </div>
            <div style="margin-top:6px;">
                <textarea id="video-negative-prompt" rows="2" placeholder="Things to avoid (camera shake, artifacts, jitter, etc.)" style="width:100%;border-radius:14px;border:1px solid rgba(31,41,55,0.95);padding:8px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-primary);resize:vertical;min-height:60px;"></textarea>
            </div>
        </div>
    </div>

    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:14px;">
        <div style="display:flex;gap:10px;">
            <div style="flex:1;">
                <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Duration</div>
                <select id="video-duration-select" style="width:100%;border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:7px 12px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:12px;">
                    <option value="5">5 seconds</option>
                    <option value="10" selected>10 seconds</option>
                    <option value="15">15 seconds</option>
                    <option value="20">20 seconds</option>
                </select>
            </div>
            <div style="flex:1;">
                <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Aspect ratio</div>
                <div class="pill-switch" id="video-aspect-switch">
                    <button type="button" class="pill-switch__btn pill-switch__btn--active" data-video-aspect="16:9">16:9</button>
                    <button type="button" class="pill-switch__btn" data-video-aspect="9:16">9:16</button>
                    <button type="button" class="pill-switch__btn" data-video-aspect="1:1">1:1</button>
                </div>
            </div>
        </div>
        <div style="display:flex;gap:10px;align-items:flex-end;">
            <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-secondary);">
                <input type="checkbox" id="video-native-audio-checkbox" />
                <span>Generate native audio</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-secondary);">
                <input type="checkbox" id="video-loop-checkbox" />
                <span>Loop-friendly motion</span>
            </label>
        </div>
    </div>
    <div style="display:flex;gap:10px;margin-bottom:10px;">
        <div style="flex:1;">
            <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Steps / quality</div>
            <input type="number" id="video-steps-input" value="30" min="12" max="80" style="width:100%;border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:7px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:12px;" />
        </div>
        <div style="flex:1;">
            <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Seed</div>
            <input type="number" id="video-seed-input" placeholder="Random" style="width:100%;border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:7px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:12px;" />
        </div>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;font-size:11px;color:var(--text-muted);">
        <div><span id="video-estimate-res">720p</span><span>&nbsp;•</span><span id="video-estimate-cost">~3 credits</span></div>
        <button type="button" id="video-toggle-advanced" style="border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:4px 8px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:11px;">Advanced motion</button>
    </div>
    <div id="video-advanced-panel" class="hidden" style="margin-top:8px;font-size:11px;color:var(--text-secondary);border-radius:14px;border:1px solid rgba(31,41,55,0.95);padding:8px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);">
        <div style="display:flex;flex-direction:column;gap:6px;">
            <label><input type="checkbox" id="video-cam-move-checkbox" /><span>&nbsp;Enable cinematic camera moves</span></label>
            <label><input type="checkbox" id="video-stabilize-checkbox" /><span>&nbsp;Extra stabilization</span></label>
            <label><input type="checkbox" id="video-high-fps-checkbox" /><span>&nbsp;Higher FPS (slightly slower)</span></label>
        </div>
    </div>
</div>

                    <!-- =================================================== -->
                    <!--  SHORT FILM LAB CONFIG                             -->
                    <!-- =================================================== -->
 <div class="lab-config hidden" id="lab-config-shortfilm" data-lab="shortfilm">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <div>
            <div style="font-size:15px;font-weight:600;">Short Film Builder</div>
            <div class="text-muted" style="font-size:12px;margin-top:2px;">
                Multi-segment storytelling · Scenes · Transitions · Narrative prompts
            </div>
        </div>
        <div class="badge-pill">
            <span class="tag-dot"></span>
            <span>Storyboard mode</span>
        </div>
    </div>

    <div style="margin-bottom:16px;">
        <div class="text-soft" style="font-size:12px;margin-bottom:6px;">Style Reference (Optional)</div>
        <label class="sulandra-upload-box" id="shortfilm-upload-box" for="shortfilm-reference-input">
            <div class="sulandra-placeholder">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <div>
                    <div class="sulandra-placeholder-title">Set film style</div>
                    <div class="sulandra-placeholder-sub">Upload an image to guide the look</div>
                </div>
            </div>
            <img id="shortfilm-preview-img" class="sulandra-preview-img" alt="Reference Preview" />
            <button type="button" class="sulandra-remove-btn" onclick="clearReference('shortfilm'); event.preventDefault();">×</button>
            <input id="shortfilm-reference-input" type="file" accept="image/*" class="visually-hidden" />
        </label>
    </div>

    <div class="prompt-label-row">
        <div class="text-soft" style="font-size:12px;">Film title &amp; global prompt</div>
        <span class="sulandra-neon-trigger" data-target-prompt="shortfilm-global-prompt">Ask SIA</span>
    </div>
    <input id="shortfilm-title-input" type="text" placeholder="Title of your short film" style="width:100%;border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:7px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-primary);font-size:12px;margin-bottom:8px;" />
    <textarea id="shortfilm-global-prompt" rows="3" placeholder="Describe the overall story, tone, characters, and style..." style="width:100%;border-radius:14px;border:1px solid rgba(31,41,55,0.95);padding:8px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-primary);resize:vertical;min-height:70px;margin-bottom:12px;"></textarea>

    <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Segments</div>
    <div id="shortfilm-segments-container" style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px;"></div>

    <button type="button" id="shortfilm-add-segment-btn" style="width:100%;border-radius:12px;border:1px dashed rgba(55,65,81,0.9);padding:7px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-secondary);font-size:12px;display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:12px;">
        <svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;"><path d="M12 5V19" stroke="currentColor" stroke-linecap="round"/><path d="M5 12H19" stroke="currentColor" stroke-linecap="round"/></svg>
        <span>Add segment</span>
    </button>

    <div style="display:flex;gap:10px;margin-bottom:10px;font-size:11px;color:var(--text-secondary);">
        <div style="flex:1;">
            <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Aspect ratio</div>
            <div class="pill-switch" id="shortfilm-aspect-switch">
                <button type="button" class="pill-switch__btn pill-switch__btn--active" data-shortfilm-aspect="16:9">16:9</button>
                <button type="button" class="pill-switch__btn" data-shortfilm-aspect="9:16">9:16</button>
            </div>
        </div>
        <div style="flex:1;">
            <div class="text-soft" style="font-size:12px;margin-bottom:4px;">Total length</div>
            <div id="shortfilm-total-length">~ 20 sec</div>
            <div class="text-muted" style="font-size:10px;">Based on segment durations</div>
        </div>
    </div>
</div>
                    <!-- =================================================== -->
                    <!--  MY FILES / ASSETS CONFIG                          -->
                    <!-- =================================================== -->
                    <div class="lab-config hidden" id="lab-config-assets" data-lab="assets">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
                            <div>
                                <div style="font-size:15px;font-weight:600;">My Files</div>
                                <div class="text-muted" style="font-size:12px;margin-top:2px;">
                                    Browse images, videos, and short films created in Sulandra Vision Lab
                                </div>
                            </div>
                            <div class="pill-switch" id="assets-type-switch">
                                <button
                                    type="button"
                                    class="pill-switch__btn pill-switch__btn--active"
                                    data-assets-type="images"
                                >
                                    Images
                                </button>
                                <button
                                    type="button"
                                    class="pill-switch__btn"
                                    data-assets-type="videos"
                                >
                                    Videos
                                </button>
                                <button
                                    type="button"
                                    class="pill-switch__btn"
                                    data-assets-type="films"
                                >
                                    Films
                                </button>
                            </div>
                        </div>

                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;font-size:11px;color:var(--text-secondary);">
                            <div style="display:flex;align-items:center;gap:8px;">
                                <div class="tag">
                                    <span class="tag-dot"></span>
                                    <span id="assets-count-label">0 items</span>
                                </div>
                                <label style="display:flex;align-items:center;gap:4px;">
                                    <input type="checkbox" id="assets-favorites-only" />
                                    <span>Favorites only</span>
                                </label>
                            </div>
                            <div class="pill-switch" id="assets-layout-switch">
                                <button
                                    type="button"
                                    class="pill-switch__btn pill-switch__btn--active"
                                    data-assets-layout="grid"
                                >
                                    Grid
                                </button>
                                <button
                                    type="button"
                                    class="pill-switch__btn"
                                    data-assets-layout="list"
                                >
                                    List
                                </button>
                            </div>
                        </div>

                        <div style="margin-bottom:10px;">
                            <input
                                id="assets-search-input"
                                type="text"
                                placeholder="Search by prompt, tag, or date..."
                                style="width:100%;border-radius:999px;border:1px solid rgba(31,41,55,0.95);padding:7px 10px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);color:var(--text-primary);font-size:12px;"
                            />
                        </div>

                        <div
                            id="assets-list-container"
                            style="border-radius:16px;border:1px solid rgba(31,41,55,0.95);padding:6px 2px 6px 0;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);max-height:340px;overflow-y:auto;"
                        >
                            <!-- Assets list items will be populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- ======================================================= -->
                <!--  CONFIG PANEL FOOTER – Generate buttons                -->
                <!-- ======================================================= -->
                <div class="vision-config-panel__footer">
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px;">
                        <div style="display:flex;flex-direction:column;gap:3px;font-size:11px;color:var(--text-secondary);">
                            <div>
                                <span>Credits: </span>
                                <span class="badge-pill badge-pill--accent" id="credits-pill">
                                    <span>SAFE</span>&nbsp;·&nbsp;<span id="credits-count">671</span>
                                </span>
                            </div>
                            <div class="text-muted" style="font-size:10px;">
                                Powered by Sulandra on RunPod · SIA Brain connected
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <button
                                type="button"
                                id="btn-random-prompt"
                                class="vision-card__icon-btn"
                                title="Random idea"
                            >
                                <svg viewBox="0 0 24 24" fill="none">
                                    <path d="M6 7H9L11 10L13 14L15 17H18" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M13 10L15 7H18" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M18 4V7H21" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M6 17H9L11 14" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M6 20V17H3" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>

                            <button
                                type="button"
                                id="btn-generate"
                                style="padding:9px 24px;border-radius:999px;border:none;background:linear-gradient(135deg,#22c55e,#4ade80);color:#022c22;font-size:13px;font-weight:700;box-shadow:0 20px 52px rgba(34,197,94,0.95);display:inline-flex;align-items:center;gap:8px;"
                            >
                                <span id="btn-generate-label">Generate</span>
                                <span style="font-size:11px;opacity:0.9;" id="btn-generate-mode-label">(Image)</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ======================================================= -->
            <!--  RIGHT: STAGE / PREVIEW                                -->
            <!-- ======================================================= -->
            <section class="vision-stage" aria-label="Preview & history">
                <div class="vision-stage__inner">

                    <!-- Stage toolbar row -->
                    <div class="vision-stage__toolbar">
                        <div class="vision-stage__toolbar-left">
                            <!-- Gallery filter tabs -->
                            <div class="pill-switch" id="gallery-filter-switch">
                                <button
                                    type="button"
                                    class="pill-switch__btn pill-switch__btn--active"
                                    data-gallery-filter="all"
                                >
                                    All
                                </button>
                                <button
                                    type="button"
                                    class="pill-switch__btn"
                                    data-gallery-filter="images"
                                >
                                    Images
                                </button>
                                <button
                                    type="button"
                                    class="pill-switch__btn"
                                    data-gallery-filter="videos"
                                >
                                    Videos
                                </button>
                                <button
                                    type="button"
                                    class="pill-switch__btn"
                                    data-gallery-filter="films"
                                >
                                    Films
                                </button>
                            </div>

                            <!-- View type (grid vs vertical) -->
                            <div class="pill-switch" id="gallery-layout-switch">
                                <button
                                    type="button"
                                    class="pill-switch__btn pill-switch__btn--active"
                                    data-gallery-layout="grid"
                                >
                                    Grid
                                </button>
                                <button
                                    type="button"
                                    class="pill-switch__btn"
                                    data-gallery-layout="vertical"
                                >
                                    Vertical
                                </button>
                            </div>

                            <!-- Divider & Ask SIA button -->
                            <div class="vision-stage__divider-vertical"></div>
                            <button
                                type="button"
                                class="vision-card__icon-btn"
                                id="btn-open-ask-sia"
                                title="Ask SIA about this output"
                            >
                                <svg viewBox="0 0 24 24" fill="none">
                                    <path d="M5 11C5 7.686 7.686 5 11 5H13C16.314 5 19 7.686 19 11C19 14.314 16.314 17 13 17H12.5" stroke="currentColor" stroke-linecap="round"/>
                                    <path d="M11.5 17L9 20.5L6.5 17" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                    <circle cx="10" cy="11" r="1" fill="currentColor"/>
                                    <circle cx="14" cy="11" r="1" fill="currentColor"/>
                                </svg>
                            </button>
                        </div>

                        <div class="vision-stage__toolbar-right">
                            <div class="badge-pill">
                                <span class="tag-dot"></span>
                                <span id="gallery-count-label">No items yet</span>
                            </div>

                            <button
                                class="vision-stage__toolbar-icon-btn"
                                type="button"
                                id="btn-gallery-refresh"
                                title="Reload history"
                            >
                                <svg viewBox="0 0 24 24" fill="none">
                                    <path d="M4 4V10H10" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M20 20V14H14" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M6.5 17.5C7.66974 18.6638 9.25798 19.3142 10.9165 19.3142C12.575 19.3142 14.1633 18.6638 15.333 17.5C16.5027 16.3362 17.155 14.7533 17.155 13.095C17.155 11.4367 16.5027 9.85382 15.333 8.69C14.1633 7.52618 12.575 6.87579 10.9165 6.87579C9.25798 6.87579 7.66974 7.52618 6.5 8.69L4 11" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Stage actions description -->
                    <div class="vision-stage__actions">
                        <span>Latest creations</span>
                        <span class="vision-stage__divider-vertical"></span>
                        <button class="vision-stage__action-link vision-stage__action-link--primary" type="button" id="btn-open-gallery-settings">
                            <svg viewBox="0 0 24 24" fill="none" style="width:14px;height:14px;">
                                <path d="M12 8V12L14.5 14.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="12" cy="12" r="8" stroke="currentColor"/>
                            </svg>
                            <span>Gallery settings</span>
                        </button>
                        <span class="vision-stage__divider-vertical"></span>
                        <span class="text-muted">Scroll to browse · click thumbnail to jump</span>
                    </div>

                    <!-- Stage feed + history rail -->
                    <div class="vision-stage__feed-wrapper">
                        <!-- Main scrolling feed -->
                        <div class="vision-stage__feed-scroll" id="gallery-scroll">
                            <div id="gallery-empty-state" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;border-radius:22px;border:1px dashed rgba(31,41,55,0.95);padding:32px 20px;background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%);">
                                <svg viewBox="0 0 24 24" fill="none" style="width:46px;height:46px;margin-bottom:10px;color:var(--text-secondary);">
                                    <rect x="3.5" y="4.5" width="17" height="13" rx="2" stroke="currentColor"/>
                                    <path d="M10 10.5L7.5 14.5H16.5L13.5 10L11.5 12.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                    <circle cx="9" cy="9" r="1" fill="currentColor"/>
                                </svg>
                                <div style="font-size:15px;font-weight:600;margin-bottom:4px;">
                                    Nothing here yet
                                </div>
                                <div class="text-muted" style="font-size:12px;max-width:320px;margin-bottom:10px;">
                                    Generate an image, video, or short film. Your creations will appear here with a continuous scroll and synced history rail.
                                </div>
                                <div class="badge-pill">
                                    <span class="tag-dot"></span>
                                    <span>Ready when you are</span>
                                </div>
                            </div>

                            <!-- Gallery items container – cards are injected via JS -->
                            <div id="gallery-items-container" style="display:flex;flex-direction:column;gap:16px;"></div>
                        </div>

                        <!-- Right-side history rail -->
                        <div class="vision-stage__history-rail" id="history-rail">
                            <!-- History thumbnails are injected via JS -->
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
</div>
</body>
<div class="ask-sia-panel-backdrop" id="askSiaBackdrop">
    <div class="ask-sia-panel">
        <div class="ask-sia-header">
            <div class="ask-sia-title">
                <div class="ask-sia-icon-large">S</div>
                <div>
                    <div style="font-weight:700; color:#fff;">Ask SIA</div>
                    <div style="font-size: 10px; color:#94a3b8;">Sulandra Intelligent Assistant</div>
                </div>
            </div>
            <div class="ask-sia-close" onclick="closeAskSia()">
                <svg viewBox="0 0 24 24" fill="none" style="width:20px;height:20px;">
                    <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
        </div>

        <div class="ask-sia-body">
            <div>
                <div style="font-size:10px; text-transform:uppercase; color:#64748b; margin-bottom:6px; letter-spacing:0.05em;">Context</div>
                <div class="ask-sia-context-box" id="askSiaContext">
                    No active context.
                </div>
            </div>

            <div id="askSiaAnswer" class="ask-sia-answer-box">
                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; opacity:0.3; margin-top:40px;">
                    <svg viewBox="0 0 24 24" fill="none" style="width:40px;height:40px;margin-bottom:10px;color:#64748b;"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <span>How can I help you create?</span>
                </div>
            </div>
        </div>

        <div class="ask-sia-footer">
            <div class="ask-sia-input-wrapper">
                <textarea
                    id="askSiaQuestion"
                    class="ask-sia-textarea"
                    placeholder="Ask SIA to refine your prompt..."
                    onkeydown="if(event.key === 'Enter' && !event.shiftKey){ event.preventDefault(); sendAskSia(); }"
                ></textarea>
                <button type="button" class="ask-sia-send-btn" onclick="sendAskSia()">
                    <svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;">
                        <path d="M5 12h14m-6-6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>
<script>
/* ====================================================================== */
/*  SULANDRA VISION LAB – SECTION 3                                       */
/*  GLOBAL CONFIG, STATE & CORE UTILITIES                                 */
/*  (Chunk 3 / 8 – paste right after </body>)                             */
/* ====================================================================== */

/* ----------------------------- API CONFIG ------------------------------ */

/**
 * CONNECTED: Your active RunPod FastAPI backend.
 */
const SULANDRA_API_BASE = "https://tz9i9ot0o6003r-8188.proxy.runpod.net";
const HUNYUAN_API_BASE  = "https://d2r0ul0h7pe8gt-300.proxy.runpod.net";

/**
 * CONNECTED: SIA Brain uses the same backend via the /ask_sia endpoint.
 */
const SIA_BRAIN_ENDPOINT = `${SULANDRA_API_BASE}/ask_sia`;

/* --------------------------- STORAGE KEYS ------------------------------ */

const STORAGE_KEYS = {
    history:   "sulandra_vision_history_v1",
    settings:  "sulandra_vision_settings_v1",
    favorites: "sulandra_vision_favorites_v1",
    assets:    "sulandra_vision_assets_v1"
};

/* --------------------------- GLOBAL STATE ------------------------------ */

let currentLab            = "image";     // 'image' | 'video' | 'shortfilm' | 'assets'
let currentMode           = "create";    // 'create' | 'view'
let currentGalleryFilter  = "all";       // 'all' | 'images' | 'videos' | 'films'
let currentGalleryLayout  = "grid";      // 'grid' | 'vertical'
let currentImageMode      = "text";      // 'text' | 'image'
let currentVideoMode      = "text";      // 'text' | 'image'
let currentAssetsType     = "images";    // 'images' | 'videos' | 'films'
let currentAssetsLayout   = "grid";      // 'grid' | 'list'
let favoritesOnlyGallery  = false;
let favoritesOnlyAssets   = false;
let lightboxCurrentId     = null;        // ID of the item opened in lightbox
let historyInMemory       = [];          // In-memory cache of history items

/* --------------------------- SAFE JSON HELPERS ------------------------- */

/**
 * Safely parse JSON, returning a fallback value if parsing fails.
 */
function safeParseJSON(str, fallback) {
    try {
        if (typeof str !== "string") return fallback;
        const value = JSON.parse(str);
        return value == null ? fallback : value;
    } catch (err) {
        console.warn("[Sulandra] Failed to parse JSON from storage:", err);
        return fallback;
    }
}

/**
 * Load data from localStorage with a fallback.
 */
function loadFromStorage(key, fallback) {
    try {
        const raw = window.localStorage.getItem(key);
        if (raw == null) return fallback;
        return safeParseJSON(raw, fallback);
    } catch (err) {
        console.warn("[Sulandra] Failed to load from storage:", key, err);
        return fallback;
    }
}

/**
 * Save data to localStorage, swallowing errors in case of quota or privacy mode.
 */
function saveToStorage(key, value) {
    try {
        window.localStorage.setItem(key, JSON.stringify(value));
    } catch (err) {
        console.warn("[Sulandra] Failed to save to storage:", key, err);
    }
}

/* ------------------------------- ID HELPER ----------------------------- */

/**
 * Lightweight UUID v4 style ID generator for history items.
 */
function uuidv4() {
    // Not cryptographically secure, but fine for client IDs.
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
        const r = (Math.random() * 16) | 0;
        const v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
}

/* ----------------------------- DOM HELPERS ----------------------------- */

/**
 * Get an element by ID. Logs a warning once if not found (for debugging).
 */
function $(id) {
    return document.getElementById(id);
}

/**
 * Safe set text content of an element by ID.
 */
function setTextContent(id, text) {
    const el = $(id);
    if (el) {
        el.textContent = text;
    }
}

/**
 * Toggle active classes inside a pill-switch style container.
 *
 * @param {HTMLElement} container - parent element
 * @param {string} attrName - data attribute name to match (e.g. 'image-mode')
 * @param {string} value - value to set active
 * @param {string} [btnClass] - button class selector to filter, default 'pill-switch__btn'
 */
function setToggleButtons(container, attrName, value, btnClass) {
    if (!container) return;
    const selector = btnClass || ".pill-switch__btn";
    const buttons = container.querySelectorAll(selector);
    buttons.forEach(function (btn) {
        const v = btn.dataset[attrName];
        const isActive = v === value;
        btn.classList.toggle("pill-switch__btn--active", isActive);
    });
}

/**
 * Smoothly scroll an element into view within its scroll container.
 */
function smoothScrollIntoView(el, block) {
    if (!el) return;
    try {
        el.scrollIntoView({
            behavior: "smooth",
            block: block || "center",
            inline: "nearest"
        });
    } catch (err) {
        // Older browsers: just call without options
        el.scrollIntoView();
    }
}

/* -------------------------- HISTORY NORMALIZATION ---------------------- */

/**
 * Normalizes any generation result (image/video/film) into a standard object
 * that can be used across the gallery, history rail, and My Files.
 *
 * Expected shape:
 *   {
 *     id: string,
 *     kind: 'image' | 'video' | 'shortfilm',
 *     url: string,         // main media URL
 *     thumb: string,       // thumbnail URL (if different from url)
 *     title: string,
 *     prompt: string,
 *     negativePrompt: string,
 *     createdAt: number,   // timestamp
 *     duration: number|null,
 *     aspect: string,      // "1:1" | "16:9" | "9:16"
 *     meta: object,
 *     isFavorite: boolean
 *   }
 */
function normalizeHistoryItem(raw) {
    if (!raw) raw = {};
    const now = Date.now();
    const id = raw.id || uuidv4();

    // Kind / lab
    let kind = raw.kind || raw.type || "image";
    if (kind === "film" || kind === "short") {
        kind = "shortfilm";
    }

    // URLs
    const url = raw.url || raw.mediaUrl || "";
    const thumb = raw.thumb || raw.thumbnail || url;

    // Text
    const prompt = raw.prompt || raw.text || "";
    const negativePrompt = raw.negativePrompt || raw.negative || "";
    const title =
        raw.title ||
        (kind === "image"
            ? "Image"
            : kind === "video"
            ? "Video"
            : "Short Film");

    // Aspect
    let aspect = raw.aspect || "1:1";
    if (!aspect || typeof aspect !== "string") {
        aspect = "1:1";
    }

    // Duration (for video & film)
    let duration = null;
    if (kind === "video" || kind === "shortfilm") {
        if (typeof raw.duration === "number") {
            duration = raw.duration;
        } else if (raw.meta && typeof raw.meta.duration === "number") {
            duration = raw.meta.duration;
        }
    }

    const createdAt = typeof raw.createdAt === "number" ? raw.createdAt : now;
    const isFavorite = !!raw.isFavorite;

    const meta = Object.assign(
        {},
        raw.meta || {},
        {
            seed: raw.seed,
            steps: raw.steps,
            guidance: raw.guidance,
            style: raw.style,
            model: raw.model || "Sulandra Vision Flux 2.0",
            creditsUsed: raw.creditsUsed
        }
    );

    return {
        id: id,
        kind: kind,
        url: url,
        thumb: thumb,
        title: title,
        prompt: prompt,
        negativePrompt: negativePrompt,
        createdAt: createdAt,
        duration: duration,
        aspect: aspect,
        meta: meta,
        isFavorite: isFavorite
    };
}

/* ====================================================================== */
/*  SULANDRA VISION LAB – SECTION 4                                       */
/*  HISTORY SYSTEM & GALLERY RENDERING                                    */
/* ====================================================================== */

/* --------------------------- HISTORY LOAD ------------------------------ */

/**
 * Load history from localStorage into memory.
 */
function loadHistoryFromStorage() {
    const raw = loadFromStorage(STORAGE_KEYS.history, []);
    if (!Array.isArray(raw)) return [];
    historyInMemory = raw.map(normalizeHistoryItem);
    return historyInMemory;
}

/**
 * Save full history array to localStorage.
 */
function saveHistoryToStorage() {
    saveToStorage(STORAGE_KEYS.history, historyInMemory);
}

/**
 * Add a new item to history.
 */
function addHistoryItem(item) {
    const normalized = normalizeHistoryItem(item);
    historyInMemory.unshift(normalized); // newest first
    saveHistoryToStorage();
    return normalized;
}

/**
 * Mark or unmark favorite.
 */
function toggleFavorite(historyId, value) {
    const item = historyInMemory.find(x => x.id === historyId);
    if (!item) return;

    if (typeof value === "boolean") {
        item.isFavorite = value;
    } else {
        item.isFavorite = !item.isFavorite;
    }

    saveHistoryToStorage();
}

/**
 * Delete an item from history.
 */
function deleteHistoryItem(historyId) {
    historyInMemory = historyInMemory.filter(x => x.id !== historyId);
    saveHistoryToStorage();
}
/**
 * Apply a history item's prompt back into the appropriate lab inputs.
 */
function applyHistoryPrompt(item) {
    if (!item) return;

    // Switch to the matching lab
    if (item.kind === "image") {
        setActiveLab("image");
        const main = $("image-main-prompt");
        const neg = $("image-negative-prompt");
        if (main) main.value = item.prompt || "";
        if (neg && item.negativePrompt) neg.value = item.negativePrompt;
    } else if (item.kind === "video") {
        setActiveLab("video");
        const main = $("video-main-prompt");
        const neg = $("video-negative-prompt");
        if (main) main.value = item.prompt || "";
        if (neg && item.negativePrompt) neg.value = item.negativePrompt;
    } else if (item.kind === "shortfilm") {
        setActiveLab("shortfilm");
        const main = $("shortfilm-global-prompt");
        if (main) main.value = item.prompt || "";
    }
}
/**
 * Force a browser download of a history item's media (image or video).
 */
async function downloadHistoryItem(item) {
    if (!item || !item.url) return;

    try {
        // Fetch media as a blob so we can force a "real" download
        const response = await fetch(item.url);
        if (!response.ok) throw new Error("Download failed");

        const blob = await response.blob();
        const objectUrl = URL.createObjectURL(blob);

        const a = document.createElement("a");

        // Decide extension based on type
        let ext = "";
        if (item.kind === "image") ext = ".png";
        else if (item.kind === "video" || item.kind === "shortfilm") ext = ".mp4";

        const safeTitle = (item.title || "sulandra-output").replace(/[^\w\-]+/g, "_");

        a.href = objectUrl;
        a.download = safeTitle + ext;

        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        URL.revokeObjectURL(objectUrl);
        } catch (err) {
        console.error("Download error:", err);

        // Do NOT open a new tab anymore.
        // Show a toast / alert instead so the user can manually save.
        alert(
            "Download failed inside the browser.\n" +
            "Please right-click the image or video and choose 'Save As…' to download."
        );
    }
}

/**
 * Returns filtered history according to current lab, gallery filter,
 * and favorites toggle.
 */
function getFilteredHistory() {
    let items = [...historyInMemory];

    // 1. By current gallery tab (All / Images / Videos / Films)
    if (currentGalleryFilter === "images") {
        items = items.filter(x => x.kind === "image");
    } else if (currentGalleryFilter === "videos") {
        items = items.filter(x => x.kind === "video");
    } else if (currentGalleryFilter === "films") {
        items = items.filter(x => x.kind === "shortfilm");
    }

    // 2. Favorites only?
    if (favoritesOnlyGallery) {
        items = items.filter(x => x.isFavorite);
    }

    return items;
}

/**
 * Filter history specifically for the current lab (image/video/shortfilm).
 * Used mainly when user switches labs.
 */
function filterHistoryForLab(lab) {
    if (lab === "image") return historyInMemory.filter(x => x.kind === "image");
    if (lab === "video") return historyInMemory.filter(x => x.kind === "video");
    if (lab === "shortfilm") return historyInMemory.filter(x => x.kind === "shortfilm");
    return [];
}

/* --------------------------- GALLERY RENDERING -------------------------- */

/**
 * Clear the gallery.
 */
function clearGallery() {
    const container = $("gallery-items-container");
    if (container) container.innerHTML = "";
}

/**
 * Render a single gallery card (Image / Video / Film / Placeholder)
 */
function createGalleryCard(item) {
    const card = document.createElement("div");
    // Add loading class if it's a placeholder
    const baseClass = currentGalleryLayout === "grid" ? "gallery-card gallery-card--grid" : "gallery-card gallery-card--vertical";
    card.className = item.isPlaceholder ? `${baseClass} gallery-card--loading` : baseClass;

    card.dataset.historyId = item.id;

    /* ---------- media element OR loading placeholder ---------- */
    let mediaHTML = "";
    if (item.isPlaceholder) {
        // Futuristic loading animation
        mediaHTML = `
            <div class="gallery-card-loader-content">
                <div class="neon-spinner"></div>
                <div style="font-size:10px; letter-spacing:0.1em; text-transform:uppercase;">Generating</div>
            </div>
        `;
    } else if (item.kind === "image") {
        mediaHTML = `<img src="${item.url}" class="gallery-card__media" loading="lazy">`;
    } else {
        // Video or Shortfilm
        mediaHTML = `<video src="${item.url}" class="gallery-card__media" muted playsinline onmouseover="this.play()" onmouseout="this.pause();this.currentTime=0;"></video>`;
    }

    /* ---------- build card wrapper ---------- */
    // Placeholders use their target aspect ratio immediately
    const aspect = item.aspect || "1:1";
    
    card.innerHTML = `
    <div class="gallery-card__media-wrapper" data-aspect="${aspect}">
        ${mediaHTML}
    </div>

    <div class="gallery-card__info">
        <div class="gallery-card__title">${item.isPlaceholder ? "Creating..." : item.title}</div>

        <div class="gallery-card__actions-row" style="${item.isPlaceholder ? 'opacity:0.5; pointer-events:none;' : ''}">
            <div class="gallery-card__actions-left">
                <button type="button" class="gallery-card__icon-btn" data-action="fullscreen" title="Fullscreen">⤢</button>
                <button type="button" class="gallery-card__icon-btn" data-action="use-prompt" title="Use this prompt">↻</button>
                <button type="button" class="gallery-card__icon-btn" data-action="download" title="Download">⤓</button>
                <button type="button" class="gallery-card__icon-btn gallery-card__icon-btn--danger" data-action="delete" title="Delete">🗑</button>
            </div>
            ${!item.isPlaceholder ? (item.isFavorite ? `<span class="gallery-card__fav gallery-card__fav--active" data-fav="${item.id}">♥</span>` : `<span class="gallery-card__fav" data-fav="${item.id}">♡</span>`) : ''}
        </div>
    </div>
`;

    // Don't attach listeners if it's a placeholder
    if (item.isPlaceholder) return card;

    /* ---------- Attach Listeners (same as before) ---------- */
    const favBtn = card.querySelector("[data-fav]");
    if (favBtn) favBtn.addEventListener("click", e => { e.stopPropagation(); toggleFavorite(item.id); refreshAllHistoryDisplays(); });

    const fullscreenBtn = card.querySelector('[data-action="fullscreen"]');
    if (fullscreenBtn) fullscreenBtn.addEventListener("click", e => { e.stopPropagation(); openLightbox(item.id); });

    const deleteBtn = card.querySelector('[data-action="delete"]');
    if (deleteBtn) deleteBtn.addEventListener("click", e => { e.stopPropagation(); if(window.confirm("Delete?")) { deleteHistoryItem(item.id); refreshAllHistoryDisplays(); } });

    const usePromptBtn = card.querySelector('[data-action="use-prompt"]');
    if (usePromptBtn) usePromptBtn.addEventListener("click", e => { e.stopPropagation(); applyHistoryPrompt(item); });

    // Changed download to a button listener instead of an <a> tag for better control
    const downloadBtn = card.querySelector('[data-action="download"]');
    if (downloadBtn) downloadBtn.addEventListener("click", e => { e.stopPropagation(); downloadHistoryItem(item); });

    card.addEventListener("click", () => { openLightbox(item.id); });

    return card;
}

/**
 * Render the full gallery based on filters.
 */
function renderGallery() {
    const items = getFilteredHistory();
    const container = $("gallery-items-container");
    const emptyState = $("gallery-empty-state");

    if (!container) return;

    // Clear old
    container.innerHTML = "";

    if (!items.length) {
        if (emptyState) emptyState.style.display = "flex";
        setTextContent("gallery-count-label", "No items yet");
        return;
    }

    if (emptyState) emptyState.style.display = "none";

    // Build cards
    items.forEach(x => {
        const card = createGalleryCard(x);
        container.appendChild(card);
    });

    // Count
    setTextContent("gallery-count-label", `${items.length} item${items.length === 1 ? "" : "s"}`);
}

/* --------------------------- HISTORY RAIL ------------------------------- */

/**
 * Create a history thumbnail button.
 */
function createHistoryThumb(item) {
    const thumb = document.createElement("button");
    thumb.className = "history-thumb";
    thumb.dataset.historyId = item.id;

    let html = "";
    if (item.kind === "image") {
        html = `<img src="${item.thumb}" class="history-thumb__media">`;
    } else {
        html = `<video src="${item.thumb}" class="history-thumb__media" muted playsinline></video>`;
    }

    thumb.innerHTML = html;

    // click → scroll to gallery card
    thumb.addEventListener("click", () => {
        scrollToHistoryItem(item.id);
    });

    return thumb;
}

/**
 * Rebuild the entire history rail.
 */
function renderHistoryRail() {
    const rail = $("history-rail");
    if (!rail) return;

    rail.innerHTML = "";

    const items = getFilteredHistory();
    items.forEach(x => {
        const thumb = createHistoryThumb(x);
        rail.appendChild(thumb);
    });
}

/**
 * Safely scroll the gallery container to a specific item
 * without moving the rest of the page.
 */
function scrollToHistoryItem(historyId) {
    const container = document.getElementById("gallery-scroll");
    if (!container) return;

    const card = container.querySelector(`[data-history-id="${historyId}"]`);
    if (!card) return;

    // 1. Get the position of the card relative to the viewport
    const cardRect = card.getBoundingClientRect();
    const containerRect = container.getBoundingClientRect();

    // 2. Calculate offset inside the container
    const relativeTop = cardRect.top - containerRect.top;
    const currentScroll = container.scrollTop;

    // 3. Scroll ONLY the container (with 20px breathing room at top)
    container.scrollTo({
        top: currentScroll + relativeTop - 20,
        behavior: "smooth"
    });
}

/* --------------------------- GALLERY LAYOUT ----------------------------- */

function applyGalleryLayout() {
    const container = $("gallery-items-container");
    if (!container) return;

    container.classList.remove("gallery-layout--grid", "gallery-layout--vertical");

    if (currentGalleryLayout === "grid") {
        container.classList.add("gallery-layout--grid");
    } else {
        container.classList.add("gallery-layout--vertical");
    }
}

/* -------------------------- HISTORY SYNC MASTER ------------------------- */

/**
 * Main function to refresh:
 * 1. gallery  
 * 2. history rail  
 * 3. empty-state  
 * 4. counts
 */
function refreshAllHistoryDisplays() {
    renderGallery();
    renderHistoryRail();
    applyGalleryLayout();
}

/* --------------------------- INITIAL LOAD ------------------------------- */

loadHistoryFromStorage();
refreshAllHistoryDisplays();
/* ====================================================================== */
/*  SULANDRA VISION LAB – SECTION 5                                       */
/*  DYNAMIC CSS, LIGHTBOX VIEWER & ITEM ACTIONS                           */
/* ====================================================================== */

/* -------------------------- DYNAMIC CSS INJECTION ---------------------- */

/**
 * Injects additional CSS for:
 * - gallery-card (16:9 preview layout)
 * - history-thumb
 * - lightbox viewer
 */
function injectDynamicStyles() {
    const css = `
    /* =============================================================== */
    /* LAYOUT SAFETY FIXES (Restores Header & Removes Empty Space)     */
    /* =============================================================== */
    html, body {
        height: 100% !important;
        overflow: hidden !important;
        margin: 0 !important;
    }
    .vision-root, .vision-app, .vision-main {
        height: 100% !important;
        min-height: 0 !important;
        overflow: hidden !important;
    }
    /* Ensure the feed wrapper handles the scrolling, not the page */
    .vision-stage__feed-wrapper {
        height: 100%;
        overflow: hidden;
    }
    .vision-stage__feed-scroll {
        height: 100%;
        overflow-y: auto;
    }

    /* =============================================================== */
    /* GALLERY CARDS (Main Preview)                                    */
    /* =============================================================== */
    .gallery-layout--grid {
        display: grid !important;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        grid-auto-rows: auto;
        gap: 16px;
        padding-bottom: 40px; /* Space for scrolling */
    }

    .gallery-layout--vertical {
        display: flex !important;
        flex-direction: column;
        gap: 20px;
        padding-bottom: 40px;
    }

    .gallery-card {
        border-radius: 20px;
        border: 1px solid rgba(15, 23, 42, 0.95);
        background: radial-gradient(circle at 10% 0, #0b1120, #020617 70%);
        box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: transform 0.2s ease, border-color 0.2s ease;
    }
    .gallery-card:hover {
        transform: translateY(-2px);
        border-color: rgba(34, 197, 94, 0.5);
    }

    /* FORCE 16:9 Aspect Ratio for the Card Container */
    .gallery-card__media-wrapper {
        width: 100%;
        aspect-ratio: 16 / 9 !important;
        background: #000; /* Black bars */
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    /* FORCE Image to fit inside without cropping (Contain) */
    .gallery-card__media {
        width: 100%;
        height: 100%;
        object-fit: contain !important; 
        background: #000;
    }

    .gallery-card__info {
        padding: 10px 12px;
        background: #020617;
        border-top: 1px solid rgba(255,255,255,0.05);
    }
    .gallery-card__title {
        font-size: 13px;
        color: #e2e8f0;
        margin-bottom: 6px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .gallery-card__actions-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .gallery-card__actions-left {
        display: flex; gap: 6px;
    }
    .gallery-card__icon-btn {
        width: 28px; height: 28px;
        border-radius: 50%;
        background: rgba(255,255,255,0.05);
        display: flex; align-items: center; justify-content: center;
        color: #94a3b8;
        transition: all 0.2s;
    }
    .gallery-card__icon-btn:hover { background: rgba(255,255,255,0.15); color: #fff; }
    .gallery-card__fav { cursor: pointer; padding: 4px; font-size: 16px; color:#64748b; }
    .gallery-card__fav--active { color: #eab308; }

    /* =============================================================== */
    /* HISTORY RAIL (Right Side) - NO SQUEEZING FIX                    */
    /* =============================================================== */
    
    /* Ensure the rail itself scrolls and has height */
    .vision-stage__history-rail {
        height: 100% !important;
        overflow-y: auto !important;
        padding-right: 4px;
        padding-bottom: 20px;
        display: flex !important;
        flex-direction: column !important;
        gap: 12px !important;
    }

    /* The individual history card */
    .history-thumb {
        width: 100%;
        /* Let height adapt to image, but don't get huge */
        height: auto;
        min-height: 60px; 
        
        /* CRITICAL: Prevents flexbox from squashing items to 0px */
        flex-shrink: 0 !important; 
        
        border-radius: 10px;
        overflow: hidden;
        border: 2px solid transparent;
        background: #000;
        cursor: pointer;
        opacity: 0.7;
        transition: all 0.2s ease;
        position: relative;
    }

    .history-thumb:hover {
        opacity: 1;
        border-color: rgba(34, 197, 94, 0.6);
        transform: scale(1.02);
    }

    /* The image inside history */
    .history-thumb__media {
        width: 100%;
        height: auto;
        display: block;
        /* Show full original aspect ratio */
        object-fit: contain; 
    }

    /* =============================================================== */
    /* LIGHTBOX VIEWER                                               */
    /* =============================================================== */
    .vision-lightbox-backdrop {
        position: fixed; inset: 0;
        background: rgba(0,0,0,0.9);
        display: none; align-items: center; justify-content: center;
        z-index: 10000; /* High Z-index to sit on top */
        backdrop-filter: blur(5px);
    }
    .vision-lightbox-backdrop--visible { display: flex; }

    .vision-lightbox {
        width: 95vw; height: 90vh;
        background: #0f172a;
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.1);
        display: flex; flex-direction: column;
        overflow: hidden;
        box-shadow: 0 50px 100px rgba(0,0,0,0.8);
    }

    .vision-lightbox__header {
        padding: 12px 20px;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        display: flex; justify-content: space-between; align-items: center;
        background: #020617;
    }
    .vision-lightbox__title { color: #f1f5f9; font-weight: 600; font-size: 14px; }
    
    .vision-lightbox__body {
        flex: 1;
        display: grid; 
        grid-template-columns: 1fr 300px;
        overflow: hidden;
    }
    
    .vision-lightbox__media-panel {
        background: #000;
        display: flex; align-items: center; justify-content: center;
        padding: 20px;
        position: relative;
    }
    
    .vision-lightbox__media-frame {
        width: 100%; height: 100%;
        display: flex; align-items: center; justify-content: center;
    }
    .vision-lightbox__media-frame img, .vision-lightbox__media-frame video {
        max-width: 100%; max-height: 100%;
        object-fit: contain;
    }

    /* Toolbar overlay inside lightbox */
    .vision-lightbox__media-toolbar {
        position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
        background: rgba(15,23,42,0.8); border: 1px solid rgba(255,255,255,0.1);
        padding: 8px 16px; border-radius: 99px;
        display: flex; gap: 12px; backdrop-filter: blur(10px);
    }

    .vision-lightbox__meta-panel {
        background: #020617;
        border-left: 1px solid rgba(255,255,255,0.08);
        padding: 20px;
        display: flex; flex-direction: column; gap: 16px;
        overflow-y: auto;
    }
    
    .vision-lightbox__meta-block {
        background: rgba(255,255,255,0.03);
        padding: 10px; border-radius: 8px;
        font-size: 12px; color: #cbd5e1;
        border: 1px solid rgba(255,255,255,0.05);
    }
    .vision-lightbox__meta-section-title {
        font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em;
        color: #64748b; margin-bottom: 4px;
    }
    
    .vision-lightbox__close-btn { color: #94a3b8; cursor: pointer; }
    .vision-lightbox__close-btn:hover { color: #fff; }
    
    .vision-lightbox__icon-btn { color: #cbd5e1; cursor: pointer; transition: color 0.2s; }
    .vision-lightbox__icon-btn:hover { color: #4ade80; }
    `;

    const style = document.createElement("style");
    style.textContent = css;
    document.head.appendChild(style);
}

/* ----------------------------- LIGHTBOX DOM ----------------------------- */

let lightboxBackdrop = null;
let lightboxRoot = null;
let lightboxMediaFrame = null;
let lightboxTitleEl = null;
let lightboxSubtitleEl = null;
let lightboxMetaPrompt = null;
let lightboxMetaNegative = null;
let lightboxMetaStats = null;
let lightboxFavBtn = null;
let lightboxCurrentItem = null;

/**
 * Create the lightbox DOM and attach to document.body (once).
 */
function ensureLightboxDOM() {
    if (lightboxBackdrop) return;

    lightboxBackdrop = document.createElement("div");
    lightboxBackdrop.className = "vision-lightbox-backdrop";
    lightboxBackdrop.setAttribute("role", "dialog");
    lightboxBackdrop.setAttribute("aria-modal", "true");

    lightboxRoot = document.createElement("div");
    lightboxRoot.className = "vision-lightbox";

    /* ---------- HEADER ---------- */
    const header = document.createElement("div");
    header.className = "vision-lightbox__header";

    const titleBlock = document.createElement("div");
    titleBlock.className = "vision-lightbox__title-block";

    lightboxTitleEl = document.createElement("div");
    lightboxTitleEl.className = "vision-lightbox__title";

    lightboxSubtitleEl = document.createElement("div");
    lightboxSubtitleEl.className = "vision-lightbox__subtitle";

    titleBlock.appendChild(lightboxTitleEl);
    titleBlock.appendChild(lightboxSubtitleEl);

    const badge = document.createElement("div");
    badge.className = "vision-lightbox__badge";
    badge.id = "lightbox-kind-badge";

    const closeBtn = document.createElement("button");
    closeBtn.className = "vision-lightbox__close-btn";
    closeBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;">
            <path d="M7 7L17 17" stroke="currentColor" stroke-linecap="round"/>
            <path d="M17 7L7 17" stroke="currentColor" stroke-linecap="round"/>
        </svg>
    `;

    closeBtn.addEventListener("click", closeLightbox);

    header.appendChild(titleBlock);
    header.appendChild(badge);
    header.appendChild(closeBtn);

    /* ---------- BODY ---------- */
    const body = document.createElement("div");
    body.className = "vision-lightbox__body";

    // Left: media
    const mediaPanel = document.createElement("div");
    mediaPanel.className = "vision-lightbox__media-panel";

    lightboxMediaFrame = document.createElement("div");
    lightboxMediaFrame.className = "vision-lightbox__media-frame";

    const mediaToolbar = document.createElement("div");
    mediaToolbar.className = "vision-lightbox__media-toolbar";

    const leftBtns = document.createElement("div");
    leftBtns.className = "vision-lightbox__btn-row";

    const btnFullscreen = document.createElement("button");
    btnFullscreen.className = "vision-lightbox__icon-btn";
    btnFullscreen.title = "Open in new tab";
    btnFullscreen.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;">
            <path d="M14 5H19V10" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 19H5V14" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M19 5L13 11" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M5 19L11 13" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    `;
    btnFullscreen.addEventListener("click", () => {
        if (!lightboxCurrentItem) return;
        if (lightboxCurrentItem.url) {
            window.open(lightboxCurrentItem.url, "_blank");
        }
    });

    const btnDownload = document.createElement("button");
btnDownload.className = "vision-lightbox__icon-btn";
btnDownload.title = "Download";
btnDownload.innerHTML = `
    <svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;">
        <path d="M12 4V14" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M8 10L12 14L16 10" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M5 18H19" stroke="currentColor" stroke-linecap="round"/>
    </svg>
`;

btnDownload.addEventListener("click", () => {
    if (!lightboxCurrentItem) return;
    downloadHistoryItem(lightboxCurrentItem);
});

    lightboxFavBtn = document.createElement("button");
    lightboxFavBtn.className = "vision-lightbox__icon-btn";
    lightboxFavBtn.title = "Toggle favorite";
    lightboxFavBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;">
            <path d="M12 17.5L7.5 20L8.25 14.75L4.5 11.25L9.75 10.5L12 5.5L14.25 10.5L19.5 11.25L15.75 14.75L16.5 20L12 17.5Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    `;
    lightboxFavBtn.addEventListener("click", () => {
        if (!lightboxCurrentItem) return;
        toggleFavorite(lightboxCurrentItem.id);
        // update local state
        const updated = historyInMemory.find(x => x.id === lightboxCurrentItem.id);
        if (updated) lightboxCurrentItem = updated;
        refreshAllHistoryDisplays();
        updateLightboxFavoriteState();
    });

    const btnRename = document.createElement("button");
    btnRename.className = "vision-lightbox__icon-btn";
    btnRename.title = "Rename item";
    btnRename.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;">
            <path d="M4 20H9L19 10L14 5L4 15V20Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    `;
    btnRename.addEventListener("click", () => {
        if (!lightboxCurrentItem) return;
        const newName = window.prompt("New title:", lightboxCurrentItem.title || "");
        if (newName && newName.trim()) {
            const item = historyInMemory.find(x => x.id === lightboxCurrentItem.id);
            if (item) {
                item.title = newName.trim();
                saveHistoryToStorage();
                lightboxCurrentItem = item;
                renderGallery();
                renderHistoryRail();
                updateLightboxContent();
            }
        }
    });

    const btnDelete = document.createElement("button");
    btnDelete.className = "vision-lightbox__icon-btn";
    btnDelete.title = "Delete from history";
    btnDelete.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;">
            <path d="M6 7H18" stroke="currentColor" stroke-linecap="round"/>
            <path d="M9 7V5H15V7" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 11V16" stroke="currentColor" stroke-linecap="round"/>
            <path d="M14 11V16" stroke="currentColor" stroke-linecap="round"/>
            <path d="M7 7H17V18C17 18.5523 16.5523 19 16 19H8C7.44772 19 7 18.5523 7 18V7Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    `;
    btnDelete.addEventListener("click", () => {
        if (!lightboxCurrentItem) return;
        const ok = window.confirm("Remove this item from Sulandra history?");
        if (!ok) return;
        const id = lightboxCurrentItem.id;
        deleteHistoryItem(id);
        closeLightbox();
        refreshAllHistoryDisplays();
    });

    leftBtns.appendChild(btnFullscreen);
    leftBtns.appendChild(btnDownload);
    leftBtns.appendChild(lightboxFavBtn);
    leftBtns.appendChild(btnRename);
    leftBtns.appendChild(btnDelete);

    const rightArea = document.createElement("div");
    rightArea.className = "vision-lightbox__btn-row";

    const askBtn = document.createElement("button");
    askBtn.className = "vision-lightbox__ask-btn";
    askBtn.id = "lightbox-ask-sia-btn";
    askBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" style="width:14px;height:14px;">
            <path d="M5 11C5 7.686 7.686 5 11 5H13C16.314 5 19 7.686 19 11C19 14.314 16.314 17 13 17H12.5" stroke="currentColor" stroke-linecap="round"/>
            <path d="M11.5 17L9 20.5L6.5 17" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>Ask SIA about this</span>
    `;

    askBtn.addEventListener("click", () => {
        if (!lightboxCurrentItem) return;
        askSIAAboutItem(lightboxCurrentItem);
    });

    rightArea.appendChild(askBtn);

    mediaToolbar.appendChild(leftBtns);
    mediaToolbar.appendChild(rightArea);

    mediaPanel.appendChild(lightboxMediaFrame);
    mediaPanel.appendChild(mediaToolbar);

    // Right: meta
    const metaPanel = document.createElement("div");
    metaPanel.className = "vision-lightbox__meta-panel";

    const promptTitle = document.createElement("div");
    promptTitle.className = "vision-lightbox__meta-section-title";
    promptTitle.textContent = "Prompt";

    lightboxMetaPrompt = document.createElement("div");
    lightboxMetaPrompt.className = "vision-lightbox__meta-block";

    const negTitle = document.createElement("div");
    negTitle.className = "vision-lightbox__meta-section-title";
    negTitle.textContent = "Negative prompt";

    lightboxMetaNegative = document.createElement("div");
    lightboxMetaNegative.className = "vision-lightbox__meta-block";

    const statsTitle = document.createElement("div");
    statsTitle.className = "vision-lightbox__meta-section-title";
    statsTitle.textContent = "Generation details";

    lightboxMetaStats = document.createElement("div");
    lightboxMetaStats.className = "vision-lightbox__meta-block";

    metaPanel.appendChild(promptTitle);
    metaPanel.appendChild(lightboxMetaPrompt);
    metaPanel.appendChild(negTitle);
    metaPanel.appendChild(lightboxMetaNegative);
    metaPanel.appendChild(statsTitle);
    metaPanel.appendChild(lightboxMetaStats);

    body.appendChild(mediaPanel);
    body.appendChild(metaPanel);

    lightboxRoot.appendChild(header);
    lightboxRoot.appendChild(body);
    lightboxBackdrop.appendChild(lightboxRoot);
    document.body.appendChild(lightboxBackdrop);

    // Click backdrop to close
    lightboxBackdrop.addEventListener("click", (e) => {
        if (e.target === lightboxBackdrop) {
            closeLightbox();
        }
    });

    // ESC key
    window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
            closeLightbox();
        }
    });
}

/* --------------------------- LIGHTBOX CONTENT --------------------------- */

function updateLightboxFavoriteState() {
    if (!lightboxFavBtn || !lightboxCurrentItem) return;
    if (lightboxCurrentItem.isFavorite) {
        lightboxFavBtn.style.color = "#facc15";
        lightboxFavBtn.style.borderColor = "rgba(250, 204, 21, 0.7)";
    } else {
        lightboxFavBtn.style.color = "";
        lightboxFavBtn.style.borderColor = "rgba(31, 41, 55, 0.95)";
    }
}

function updateLightboxContent() {
    if (!lightboxCurrentItem) return;

    const item = lightboxCurrentItem;

    // Title + subtitle
    if (lightboxTitleEl) {
        lightboxTitleEl.textContent = item.title || (item.kind === "image"
            ? "Generated image"
            : item.kind === "video"
            ? "Generated video"
            : "Generated short film");
    }

    const dateStr = new Date(item.createdAt).toLocaleString();
    const kindLabel = item.kind === "image" ? "Image" : item.kind === "video" ? "Video" : "Short Film";

    if (lightboxSubtitleEl) {
        lightboxSubtitleEl.textContent = `${kindLabel} · ${dateStr}`;
    }

    const badgeEl = document.getElementById("lightbox-kind-badge");
    if (badgeEl) {
        badgeEl.textContent = kindLabel;
    }

    // Media
    if (lightboxMediaFrame) {
        lightboxMediaFrame.innerHTML = "";
        if (item.kind === "image") {
            const img = document.createElement("img");
            img.src = item.url;
            img.alt = item.title || "Generated image";
            lightboxMediaFrame.appendChild(img);
        } else {
            const video = document.createElement("video");
            video.src = item.url;
            video.controls = true;
            video.autoplay = false;
            video.muted = false;
            video.playsInline = true;
            lightboxMediaFrame.appendChild(video);
        }
    }

    // Prompts
    if (lightboxMetaPrompt) {
        lightboxMetaPrompt.textContent = item.prompt || "No prompt recorded.";
    }
    if (lightboxMetaNegative) {
        lightboxMetaNegative.textContent = item.negativePrompt || "No negative prompt.";
    }

    // Stats
    if (lightboxMetaStats) {
        const m = item.meta || {};
        const rows = [
            ["Model", m.model || "Sulandra Vision Flux 2.0"],
            ["Aspect", item.aspect || "1:1"],
            ["Duration", item.duration ? `${item.duration}s` : (item.kind === "image" ? "—" : "Unknown")],
            ["Guidance", m.guidance != null ? m.guidance : "Default"],
            ["Steps", m.steps != null ? m.steps : "Default"],
            ["Seed", m.seed != null ? m.seed : "Random"],
            ["Credits used", m.creditsUsed != null ? m.creditsUsed : "Estimated"]
        ];

        lightboxMetaStats.innerHTML = rows.map(row => `
            <div class="vision-lightbox__meta-row">
                <span>${row[0]}</span>
                <span>${row[1]}</span>
            </div>
        `).join("");
    }

    // Favorite state
    updateLightboxFavoriteState();
}

/* --------------------------- LIGHTBOX PUBLIC API ------------------------ */

function openLightbox(historyId) {
    const item = historyInMemory.find(x => x.id === historyId);
    if (!item) return;

    ensureLightboxDOM();

    lightboxCurrentItem = item;
    updateLightboxContent();

    if (lightboxBackdrop) {
        lightboxBackdrop.classList.add("vision-lightbox-backdrop--visible");
    }
}

function closeLightbox() {
    lightboxCurrentItem = null;
    if (lightboxBackdrop) {
        lightboxBackdrop.classList.remove("vision-lightbox-backdrop--visible");
    }
}

/* --------------------------- ASK SIA INTEGRATION ------------------------ */

/**
 * Sends the selected item context to SIA Brain.
 * This is a basic POST; you just replace SIA_BRAIN_ENDPOINT with your real URL.
 */
async function askSIAAboutItem(item) {
    if (!SIA_BRAIN_ENDPOINT || SIA_BRAIN_ENDPOINT.includes("YOUR-SIA-BRAIN-ENDPOINT")) {
        window.alert("Configure SIA_BRAIN_ENDPOINT in the code to enable Ask SIA.");
        return;
    }

    try {
        const payload = {
            id: item.id,
            kind: item.kind,
            url: item.url,
            thumb: item.thumb,
            title: item.title,
            prompt: item.prompt,
            negative_prompt: item.negativePrompt,
            meta: item.meta || {}
        };

        const res = await fetch(SIA_BRAIN_ENDPOINT, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            throw new Error("SIA Brain request failed with status " + res.status);
        }

        const data = await res.json();
        // For now, show a simple alert; you can later connect this to a side panel.
        window.alert("SIA Brain response:\n\n" + (data.answer || JSON.stringify(data, null, 2)));
    } catch (err) {
        console.error("[Sulandra] Ask SIA failed:", err);
        window.alert("Ask SIA failed. Check console for details.");
    }
}

/* ====================================================================== */
/*  SULANDRA VISION LAB – SECTION 6                                       */
/*  LAB SWITCHING, CONTROLS WIRING & GENERATE FLOWS                       */
/* ====================================================================== */

/* ------------------------------ LAB SWITCHING --------------------------- */

function setActiveLab(lab) {
    currentLab = lab;

    // UPDATE: Sidebar Navigation active states
    const navItems = document.querySelectorAll("[data-lab-nav]");
    navItems.forEach(item => {
        const navLab = item.dataset.labNav;
        item.classList.toggle("vision-nav__item--active", navLab === lab);
    });

    // Config panels (visibility)
    const configs = document.querySelectorAll(".lab-config");
    configs.forEach(cfg => {
        const labName = cfg.dataset.lab;
        // Hide all, unless it matches current lab OR it's assets view mode
        let isVisible = labName === lab;
        if (lab === 'assets' && labName === 'assets') isVisible = true;
        cfg.classList.toggle("hidden", !isVisible);
    });

    // If switching to assets via some other means, ensure mode is view
    if (lab === "assets") {
        currentMode = "view";
    } else {
        // If switching to a creation lab, ensure mode is create
        currentMode = "create";
    }
    updateModeToggleButtons();

    // Update generate button label
    const modeLabel = $("btn-generate-mode-label");
    if (modeLabel) {
        if (lab === "image") modeLabel.textContent = "(Image)";
        else if (lab === "video") modeLabel.textContent = "(Video)";
        else if (lab === "shortfilm") modeLabel.textContent = "(Short film)";
        else modeLabel.textContent = "(—)";
    }

    // Default gallery filters
    if (lab === "image") currentGalleryFilter = "images";
    else if (lab === "video") currentGalleryFilter = "videos";
    else if (lab === "shortfilm") currentGalleryFilter = "films";
    else if (lab === "assets") currentGalleryFilter = "all";

    updateGalleryFilterButtons();
    refreshAllHistoryDisplays();
}

/* ----------------------------- MODE TOGGLE ------------------------------ */

function updateModeToggleButtons() {
    const buttons = document.querySelectorAll("#mode-toggle .vision-header__view-btn");
    buttons.forEach(btn => {
        const mode = btn.dataset.mode;
        const active = mode === currentMode;
        btn.classList.toggle("vision-header__view-btn--active", active);
    });

    // If mode is "view", show My Files config; if "create", show lab config.
    const imageCfg = $("lab-config-image");
    const videoCfg = $("lab-config-video");
    const filmCfg  = $("lab-config-shortfilm");
    const assetsCfg = $("lab-config-assets");

    if (currentMode === "view") {
        if (assetsCfg) assetsCfg.classList.remove("hidden");
        if (imageCfg) imageCfg.classList.add("hidden");
        if (videoCfg) videoCfg.classList.add("hidden");
        if (filmCfg)  filmCfg.classList.add("hidden");

        // Map lab → initial assets type
        if (currentLab === "image") currentAssetsType = "images";
        else if (currentLab === "video") currentAssetsType = "videos";
        else if (currentLab === "shortfilm") currentAssetsType = "films";

        updateAssetsTypeButtons();
        renderAssetsList();
    } else {
        // create mode
        if (assetsCfg) assetsCfg.classList.add("hidden");

        if (currentLab === "image" && imageCfg) {
            imageCfg.classList.remove("hidden");
        } else if (currentLab === "video" && videoCfg) {
            videoCfg.classList.remove("hidden");
        } else if (currentLab === "shortfilm" && filmCfg) {
            filmCfg.classList.remove("hidden");
        }
    }
}

/* ------------------------- GALLERY FILTER SWITCH ------------------------ */

function updateGalleryFilterButtons() {
    const container = $("gallery-filter-switch");
    if (!container) return;
    const buttons = container.querySelectorAll(".pill-switch__btn");
    buttons.forEach(btn => {
        const val = btn.dataset.galleryFilter;
        btn.classList.toggle("pill-switch__btn--active", val === currentGalleryFilter);
    });
}

/* ------------------------ GALLERY LAYOUT SWITCH ------------------------- */

function updateGalleryLayoutButtons() {
    const container = $("gallery-layout-switch");
    if (!container) return;
    const buttons = container.querySelectorAll(".pill-switch__btn");
    buttons.forEach(btn => {
        const val = btn.dataset.galleryLayout;
        btn.classList.toggle("pill-switch__btn--active", val === currentGalleryLayout);
    });
}
/* ========================================= */
/* PREVIEW LOGIC (SULANDRA STYLE)           */
/* ========================================= */

function wireReferenceImagePreviews() {
    // Generic setup function
    const setupBox = (inputId, boxId, imgId) => {
        const input = document.getElementById(inputId);
        const box = document.getElementById(boxId);
        const img = document.getElementById(imgId);

        if (!input || !box || !img) return;

        input.addEventListener("change", () => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                    box.classList.add("has-file");
                };
                reader.readAsDataURL(input.files[0]);
            }
        });
    };

    // 1. Image Lab
    setupBox("image-reference-input", "image-upload-box", "image-preview-img");

    // 2. Video Lab (Start & End)
    setupBox("video-start-input", "video-start-box", "video-start-img");
    setupBox("video-end-input", "video-end-box", "video-end-img");
    
    // 3. Short Film (Global Style)
    setupBox("shortfilm-reference-input", "shortfilm-upload-box", "shortfilm-preview-img");
}

// Global Helper to clear images via the X button
function clearReference(idKey) {
    // Handle short film segments (idKey format: "seg-1")
    if (idKey.startsWith("seg-")) {
        const rowId = idKey.replace("seg-", "");
        const box = document.getElementById(`shortfilm-seg-box-${rowId}`);
        const img = document.getElementById(`shortfilm-seg-img-${rowId}`);
        const input = document.getElementById(`shortfilm-seg-input-${rowId}`);
        if(input) input.value = "";
        if(img) img.src = "";
        if(box) box.classList.remove("has-file");
        return;
    }

    // Handle standard boxes
    let input = document.getElementById(`${idKey}-input`) || document.getElementById(`${idKey}-reference-input`);
    let box = document.getElementById(`${idKey}-box`) || document.getElementById(`${idKey}-upload-box`);
    let img = document.getElementById(`${idKey}-img`) || document.getElementById(`${idKey}-preview-img`);

    if (input) input.value = "";
    if (img) img.src = "";
    if (box) box.classList.remove("has-file");
}
/* ----------------------- IMAGE / VIDEO / FILM CONTROLS ------------------ */

function wireImageControls() {
    const modeSwitch = $("image-mode-switch");
    if (modeSwitch) {
        modeSwitch.querySelectorAll(".pill-switch__btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const mode = btn.dataset.imageMode;
                if (!mode) return;
                currentImageMode = mode;
                setToggleButtons(modeSwitch, "imageMode", mode);
                // Show/hide reference block
                const refBlock = $("image-reference-block");
                if (refBlock) {
                    refBlock.style.display = mode === "image" ? "block" : "none";
                }
            });
        });
    }

    const aspectSwitch = $("image-aspect-switch");
    if (aspectSwitch) {
        aspectSwitch.querySelectorAll(".pill-switch__btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const a = btn.dataset.imageAspect;
                if (!a) return;
                setToggleButtons(aspectSwitch, "imageAspect", a);
                updateImageResolutionLabel(a);
            });
        });
    }

    const guidanceSlider = $("image-guidance-slider");
    if (guidanceSlider) {
        guidanceSlider.addEventListener("input", () => {
            setTextContent("image-guidance-value", guidanceSlider.value);
        });
    }

    const advToggle = $("image-toggle-advanced");
    if (advToggle) {
        advToggle.addEventListener("click", () => {
            const panel = $("image-advanced-panel");
            if (!panel) return;
            const hidden = panel.classList.contains("hidden");
            panel.classList.toggle("hidden", !hidden);
        });
    }
}

function updateImageResolutionLabel(aspect) {
    let text = "1024 × 1024";
    if (aspect === "16:9") text = "1344 × 768";
    else if (aspect === "9:16") text = "768 × 1344";
    setTextContent("image-estimate-res", text);
}

function wireVideoControls() {
    const modeSwitch = $("video-mode-switch");
    if (modeSwitch) {
        modeSwitch.querySelectorAll(".pill-switch__btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const mode = btn.dataset.videoMode;
                if (!mode) return;
                currentVideoMode = mode;
                setToggleButtons(modeSwitch, "videoMode", mode);
                const refBlock = $("video-reference-block");
                if (refBlock) {
                    refBlock.style.display = mode === "image" ? "block" : "none";
                }
            });
        });
    }

    const aspectSwitch = $("video-aspect-switch");
    if (aspectSwitch) {
        aspectSwitch.querySelectorAll(".pill-switch__btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const a = btn.dataset.videoAspect;
                if (!a) return;
                setToggleButtons(aspectSwitch, "videoAspect", a);
                updateVideoResolutionLabel(a);
            });
        });
    }

    const advToggle = $("video-toggle-advanced");
    if (advToggle) {
        advToggle.addEventListener("click", () => {
            const panel = $("video-advanced-panel");
            if (!panel) return;
            const hidden = panel.classList.contains("hidden");
            panel.classList.toggle("hidden", !hidden);
        });
    }
}

function updateVideoResolutionLabel(aspect) {
    let text = "720p";
    if (aspect === "9:16") text = "720 × 1280 (vertical)";
    else if (aspect === "1:1") text = "960 × 960";
    else text = "1280 × 720";
    setTextContent("video-estimate-res", text);
}

function wireShortFilmControls() {
    const aspectSwitch = $("shortfilm-aspect-switch");
    if (aspectSwitch) {
        aspectSwitch.querySelectorAll(".pill-switch__btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const a = btn.dataset.shortfilmAspect;
                if (!a) return;
                setToggleButtons(aspectSwitch, "shortfilmAspect", a);
            });
        });
    }

    const addBtn = $("shortfilm-add-segment-btn");
    if (addBtn) {
        addBtn.addEventListener("click", addShortFilmSegmentRow);
    }

    // Start with 3 segments by default
    for (let i = 0; i < 3; i++) {
        addShortFilmSegmentRow();
    }
}

let shortFilmSegmentCounter = 0;

/* 2. REPLACE THIS FUNCTION */
function addShortFilmSegmentRow() {
    const container = document.getElementById("shortfilm-segments-container");
    if (!container) return;

    shortFilmSegmentCounter++;
    const id = shortFilmSegmentCounter;
    const promptId = `shortfilm-segment-prompt-${id}`;

    const row = document.createElement("div");
    row.className = "shortfilm-segment-row";
    row.dataset.segmentId = String(id);
    row.style.borderBottom = "1px solid rgba(31,41,55,0.5)";
    row.style.paddingBottom = "12px";
    
    // Updated HTML: Neon Text placed in the Header row
    row.innerHTML = `
        <div style="display:flex; gap:10px;">
            <div style="width: 100px; flex-shrink: 0;">
                <div class="text-soft" style="font-size:10px;margin-bottom:4px;">Ref Image</div>
                <label class="sulandra-upload-box compact" id="shortfilm-seg-box-${id}" for="shortfilm-seg-input-${id}" style="aspect-ratio:1/1; height:auto;">
                    <div class="sulandra-placeholder">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 5v14M5 12h14" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <img id="shortfilm-seg-img-${id}" class="sulandra-preview-img" alt="Scene Ref" />
                    <button type="button" class="sulandra-remove-btn" onclick="clearReference('seg-${id}'); event.preventDefault();">×</button>
                    <input id="shortfilm-seg-input-${id}" type="file" accept="image/*" class="visually-hidden" />
                </label>
            </div>

            <div style="flex:1; display:flex; flex-direction:column; gap:4px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <input type="text" class="shortfilm-segment-title" placeholder="Scene ${id} Title" 
                        style="flex:1; background:transparent; border:none; color:#e5e7eb; font-weight:600; font-size:12px; outline:none;" />
                    
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span class="sulandra-neon-trigger dynamic-ask-trigger" data-target-prompt="${promptId}" style="font-size:9px;">Ask SIA</span>
                        <button type="button" class="shortfilm-segment-remove" style="color:#ef4444; font-size:10px;">Remove</button>
                    </div>
                </div>
                
                <div>
                    <textarea id="${promptId}" class="shortfilm-segment-prompt" rows="2" placeholder="Describe scene action..." 
                        style="width:100%; border-radius:10px; border:1px solid rgba(31,41,55,0.95); padding:6px 8px; background:radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%); color:#e5e7eb; font-size:11px; resize:vertical; min-height:60px;"></textarea>
                </div>

                <div style="display:flex; align-items:center; gap:6px; margin-top:2px;">
                    <span class="text-soft" style="font-size:10px;">Duration:</span>
                    <input type="number" class="shortfilm-segment-duration" value="4" min="1" max="10" 
                        style="width:40px; background:#0f172a; border:1px solid #1f2937; border-radius:4px; color:#fff; font-size:10px; padding-left:4px;" />
                    <span class="text-soft" style="font-size:10px;">sec</span>
                </div>
            </div>
        </div>
    `;

    container.appendChild(row);

    // --- Wire up Logic ---
    const input = document.getElementById(`shortfilm-seg-input-${id}`);
    const box = document.getElementById(`shortfilm-seg-box-${id}`);
    const img = document.getElementById(`shortfilm-seg-img-${id}`);

    if (input) {
        input.addEventListener("change", () => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                    box.classList.add("has-file");
                };
                reader.readAsDataURL(input.files[0]);
            }
        });
    }

    // Wiring the new Neon Text trigger
    const askTrigger = row.querySelector(".dynamic-ask-trigger");
    if (askTrigger) {
        askTrigger.addEventListener("click", () => {
            const txt = document.getElementById(promptId);
            const content = txt ? txt.value : "";
            openAskSia('shortfilm-segment', content || `Segment ${id} (Empty)`);
        });
    }

    const removeBtn = row.querySelector(".shortfilm-segment-remove");
    const durInput = row.querySelector(".shortfilm-segment-duration");
    
    if (removeBtn) removeBtn.addEventListener("click", () => { row.remove(); updateShortFilmTotalLength(); });
    if (durInput) durInput.addEventListener("input", updateShortFilmTotalLength);

    updateShortFilmTotalLength();
}

function updateShortFilmTotalLength() {
    const container = $("shortfilm-segments-container");
    if (!container) return;

    const durations = container.querySelectorAll(".shortfilm-segment-duration");
    let total = 0;
    durations.forEach(input => {
        const v = Number(input.value) || 0;
        total += v;
    });

    setTextContent("shortfilm-total-length", `~ ${total || 0} sec`);
}

/* ------------------------- ASSETS PANEL (LEFT CONFIG) ------------------ */

let assetsCache = {
    images: [],
    videos: [],
    films: []
};

function updateAssetsTypeButtons() {
    const container = $("assets-type-switch");
    if (!container) return;
    const buttons = container.querySelectorAll(".pill-switch__btn");
    buttons.forEach(btn => {
        const t = btn.dataset.assetsType;
        btn.classList.toggle("pill-switch__btn--active", t === currentAssetsType);
    });
}

function updateAssetsLayoutButtons() {
    const container = $("assets-layout-switch");
    if (!container) return;
    const buttons = container.querySelectorAll(".pill-switch__btn");
    buttons.forEach(btn => {
        const t = btn.dataset.assetsLayout;
        btn.classList.toggle("pill-switch__btn--active", t === currentAssetsLayout);
    });
}

/**
 * Build list from historyInMemory into assetsCache (grouped by type).
 */
function rebuildAssetsCacheFromHistory() {
    assetsCache = {
        images: historyInMemory.filter(x => x.kind === "image"),
        videos: historyInMemory.filter(x => x.kind === "video"),
        films:  historyInMemory.filter(x => x.kind === "shortfilm")
    };
}

/**
 * Render My Files list in the left panel.
 */
function renderAssetsList() {
    rebuildAssetsCacheFromHistory();

    const container = $("assets-list-container");
    if (!container) return;

    const favoritesOnly = !!$("assets-favorites-only")?.checked;
    const query = ($("assets-search-input")?.value || "").toLowerCase().trim();

    let list = [];
    if (currentAssetsType === "images") list = assetsCache.images;
    else if (currentAssetsType === "videos") list = assetsCache.videos;
    else list = assetsCache.films;

    if (favoritesOnly) {
        list = list.filter(x => x.isFavorite);
    }

    if (query) {
        list = list.filter(x =>
            (x.prompt || "").toLowerCase().includes(query) ||
            (x.title || "").toLowerCase().includes(query)
        );
    }

    container.innerHTML = "";

    if (!list.length) {
        container.innerHTML = `
            <div style="padding:10px 12px;font-size:11px;color:#9ca3af;">
                No items found for this filter.
            </div>
        `;
        setTextContent("assets-count-label", "0 items");
        return;
    }

    setTextContent("assets-count-label", `${list.length} item${list.length === 1 ? "" : "s"}`);

    list.forEach(item => {
        const row = document.createElement("div");
        row.className = "assets-row";
        row.style.cssText = `
            display:flex;
            align-items:center;
            gap:8px;
            padding:6px 8px;
            border-radius:10px;
            margin:0 4px 4px;
            cursor:pointer;
            border:1px solid transparent;
        `;

        row.addEventListener("mouseenter", () => {
            row.style.borderColor = "rgba(31,41,55,0.95)";
            row.style.background = "radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%)";
        });
        row.addEventListener("mouseleave", () => {
            row.style.borderColor = "transparent";
            row.style.background = "transparent";
        });

        row.addEventListener("click", () => {
            // Scroll main gallery to this item and open lightbox
            scrollToHistoryItem(item.id);
            openLightbox(item.id);
        });

        const thumb = document.createElement("div");
        thumb.style.cssText = `
            width:40px;
            height:26px;
            border-radius:6px;
            overflow:hidden;
            flex-shrink:0;
            background:#020617;
        `;
        thumb.innerHTML = item.kind === "image"
            ? `<img src="${item.thumb}" style="width:100%;height:100%;object-fit:cover;">`
            : `<video src="${item.thumb}" style="width:100%;height:100%;object-fit:cover;" muted></video>`;

        const info = document.createElement("div");
        info.style.cssText = `
            flex:1;
            min-width:0;
            display:flex;
            flex-direction:column;
            gap:2px;
        `;
        info.innerHTML = `
            <div style="font-size:11px;color:#e5e7eb;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                ${item.title || "Untitled"}
            </div>
            <div style="font-size:10px;color:#9ca3af;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                ${(item.prompt || "No prompt").replace(/\s+/g, " ").slice(0, 64)}
            </div>
        `;

        const meta = document.createElement("div");
        meta.style.cssText = `
            display:flex;
            flex-direction:column;
            align-items:flex-end;
            gap:2px;
            font-size:9px;
            color:#6b7280;
        `;
        const dateStr = new Date(item.createdAt).toLocaleDateString();
        const favChar = item.isFavorite ? "★" : "☆";
        meta.innerHTML = `
            <div>${dateStr}</div>
            <div>${favChar}</div>
        `;

        row.appendChild(thumb);
        row.appendChild(info);
        row.appendChild(meta);

        container.appendChild(row);
    });
}

/* ----------------------------- GENERATE BUTTON -------------------------- */

let isGenerating = false;

function setGeneratingState(active, labelText) {
    isGenerating = active;
    const btn = $("btn-generate");
    const lbl = $("btn-generate-label");

    if (!btn || !lbl) return;

    if (active) {
        btn.disabled = true;
        btn.style.opacity = "0.9";
        btn.style.cursor = "wait";
        lbl.textContent = labelText || "Generating…";
    } else {
        btn.disabled = false;
        btn.style.opacity = "";
        btn.style.cursor = "pointer";
        lbl.textContent = "Generate";
    }
}

/* --------------------------- REAL API INTEGRATION --------------------------- */

/**
 * Real API Call Handler
 * Routes requests to SIA Brain (Images) or Hunyuan (Videos & Films)
 */
async function callSulandraAPI(uiPath, payload) {
    try {
        // --- FIX FOR 422 ERROR: SANITIZE SEED ---
        // Ensure seed is ALWAYS an integer. If empty/null, generate one here.
        const safeSeed = (payload.seed === null || payload.seed === undefined || payload.seed === "") 
            ? Math.floor(Math.random() * 4294967295) 
            : Number(payload.seed);

        // ============================================================
        //  VIDEO & SHORT FILM GENERATION (HUNYUAN PORT 300)
        // ============================================================
        if (payload.kind === "video" || payload.kind === "shortfilm") {
            if (!window.GradioClient) throw new Error("Gradio Client loading... try again later.");

            let finalPrompt = "", steps = 50, resolution = "1280x720", duration = 129;
            
            if (payload.kind === "shortfilm") {
                let segmentText = payload.segments ? payload.segments.map((seg, i) => `Scene ${i+1}: ${seg.prompt}`).join(". ") : "";
                finalPrompt = `Cinematic short film titled "${payload.film_title}". ${payload.global_prompt}. ${segmentText}`;
                if (payload.aspect === "9:16") resolution = "720x1280";
                if (payload.aspect === "1:1")  resolution = "960x960";
            } else {
                finalPrompt = payload.prompt;
                steps = Number(payload.steps) || 50;
                const resMap = { "16:9": "1280x720", "9:16": "720x1280", "1:1": "960x960" };
                if (resMap[payload.aspect]) resolution = resMap[payload.aspect];
                if (payload.duration == 5 || payload.duration == 9) duration = 129;
            }

            console.log(`[Sulandra] Calling Hunyuan...`);
            const client = await window.GradioClient.connect(HUNYUAN_API_BASE);
            const result = await client.predict("/lambda_1", [ 
                finalPrompt, resolution, duration, safeSeed, steps, 1, 7, 6 
            ]);

            return {
                ok: true, kind: payload.kind, url: result.data[0].url, thumb: result.data[0].url,
                meta: { model: "HunyuanVideo", steps: steps, seed: safeSeed }
            };
        }

        // ============================================================
        //  IMAGE GENERATION (SIA BRAIN FLUX PORT 8188)
        // ============================================================
        let endpoint = "/api/image/txt2img";
        
        // Construct a clean body (NO batch_size) to prevent 422 errors
        let body = {
            prompt: payload.prompt,
            steps: Number(payload.steps) || 30,
            width: 1024, height: 1024,
            guidance_scale: Number(payload.guidance) || 3.5,
            seed: safeSeed 
        };

        if (payload.aspect === "16:9") { body.width = 1344; body.height = 768; }
        if (payload.aspect === "9:16") { body.width = 768; body.height = 1344; }

        if (payload.mode === "image" && payload.reference_image) {
            endpoint = "/api/image/img2img";
            body.init_image_base64 = payload.reference_image;
            body.strength = 0.75;
        }

        const response = await fetch(`${SULANDRA_API_BASE}${endpoint}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        if (!response.ok) {
            const errText = await response.text();
            console.error("Backend Error:", errText); // Logs exact reason for 422
            throw new Error(`Backend Error ${response.status}`);
        }

        const data = await response.json();
        const fullUrl = `${SULANDRA_API_BASE}${data.image_url}`;

        return {
            ok: true, kind: "image", url: fullUrl, thumb: fullUrl,
            meta: { model: "Flux.1 Dev", seed: safeSeed }
        };

    } catch (err) {
        console.error("API Call Failed:", err);
        throw err; 
    }
}

/* ---------------------- BUILD PAYLOADS FROM UI -------------------------- */

function getSelectedImageAspect() {
    const btn = document.querySelector("#image-aspect-switch .pill-switch__btn--active");
    return btn ? btn.dataset.imageAspect || "1:1" : "1:1";
}

function getSelectedVideoAspect() {
    const btn = document.querySelector("#video-aspect-switch .pill-switch__btn--active");
    return btn ? btn.dataset.videoAspect || "16:9" : "16:9";
}

function getSelectedShortFilmAspect() {
    const btn = document.querySelector("#shortfilm-aspect-switch .pill-switch__btn--active");
    return btn ? btn.dataset.shortfilmAspect || "16:9" : "16:9";
}

function buildImagePayloadFromUI() {
    // ... existing code ...
    const steps = Number($("image-steps-input")?.value || 30);
    const seedVal = $("image-seed-input")?.value;
    const seed = seedVal === "" ? null : Number(seedVal);
    // NEW: Get batch size
    const batchSize = Number($("image-variations-select")?.value || 1);

    return {
        kind: "image",
        prompt: prompt,
        // ... existing props ...
        seed: seed,
        mode: currentImageMode,
        batch_size: batchSize // Add to payload
    };
}

function buildVideoPayloadFromUI() {
    const prompt = $("video-main-prompt")?.value || "";
    const negativePrompt = $("video-negative-prompt")?.value || "";
    const aspect = getSelectedVideoAspect();
    const duration = Number($("video-duration-select")?.value || 10);
    const steps = Number($("video-steps-input")?.value || 30);
    const seedVal = $("video-seed-input")?.value;
    const seed = seedVal === "" ? null : Number(seedVal);
    const nativeAudio = !!$("video-native-audio-checkbox")?.checked;
    const loop = !!$("video-loop-checkbox")?.checked;
    const camMove = !!$("video-cam-move-checkbox")?.checked;
    const stabilize = !!$("video-stabilize-checkbox")?.checked;
    const highFps = !!$("video-high-fps-checkbox")?.checked;

    return {
        kind: "video",
        prompt: prompt,
        negative_prompt: negativePrompt,
        aspect: aspect,
        duration: duration,
        steps: steps,
        seed: seed,
        mode: currentVideoMode,
        native_audio: nativeAudio,
        loop: loop,
        camera_motion: camMove,
        stabilize: stabilize,
        high_fps: highFps
        // reference image will be attached if image→video mode
    };
}

function buildShortFilmPayloadFromUI() {
    const title = $("shortfilm-title-input")?.value || "Untitled short film";
    const globalPrompt = $("shortfilm-global-prompt")?.value || "";
    const aspect = getSelectedShortFilmAspect();
    const container = $("shortfilm-segments-container");
    const segments = [];

    if (container) {
        container.querySelectorAll(".shortfilm-segment-row").forEach(row => {
            const t = row.querySelector(".shortfilm-segment-title")?.value || "";
            const p = row.querySelector(".shortfilm-segment-prompt")?.value || "";
            const d = Number(row.querySelector(".shortfilm-segment-duration")?.value || 4);
            segments.push({
                title: t,
                prompt: p,
                duration: d
            });
        });
    }

    return {
        kind: "shortfilm",
        film_title: title,
        global_prompt: globalPrompt,
        aspect: aspect,
        segments: segments
    };
}

/* ----------------------- FILE INPUT HELPERS (REFS) ---------------------- */

async function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            const res = reader.result;
            const base64 = typeof res === "string"
                ? res.split(",")[1]
                : "";
            resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

/* --------------------------- GENERATE FLOWS ----------------------------- */

// Helper: Create instant loading cards
function createPlaceholders(count, kind, prompt, aspect, negativePrompt) {
    const placeholders = [];
    for (let i = 0; i < count; i++) {
        const id = uuidv4();
        const item = {
            id: id, kind: kind, title: "Generating...", prompt: prompt,
            negativePrompt: negativePrompt || "", aspect: aspect || "1:1",
            createdAt: Date.now(), isPlaceholder: true, isFavorite: false, meta: {}
        };
        historyInMemory.unshift(item);
        placeholders.push(id);
    }
    refreshAllHistoryDisplays();
    return placeholders;
}

// Helper: Update card when done
function fulfillPlaceholder(placeholderId, realData) {
    const itemIdx = historyInMemory.findIndex(x => x.id === placeholderId);
    if (itemIdx === -1) return;
    historyInMemory[itemIdx] = {
        ...historyInMemory[itemIdx], ...realData, isPlaceholder: false,
        title: realData.title || (historyInMemory[itemIdx].kind === 'image' ? 'Image' : 'Video'),
        createdAt: Date.now()
    };
    saveHistoryToStorage();
    refreshAllHistoryDisplays();
}

// Read batch size from dropdown
function buildImagePayloadFromUI() {
    const prompt = $("image-main-prompt")?.value || "";
    const neg = $("image-negative-prompt")?.value || "";
    const aspect = getSelectedImageAspect();
    const batchSize = Number($("image-variations-select")?.value || 1); // Get 1-4
    const steps = Number($("image-steps-input")?.value || 30);
    const seedVal = $("image-seed-input")?.value;
    
    return {
        kind: "image", prompt: prompt, negative_prompt: neg, aspect: aspect,
        steps: steps, seed: seedVal === "" ? null : Number(seedVal),
        mode: currentImageMode, batch_size: batchSize
    };
}

async function generateImageFromUI() {
    const payload = buildImagePayloadFromUI();
    const batchCount = Number(payload.batch_size) || 1;

    // 1. Handle Reference Image (needs await)
    if (currentImageMode === "image") {
        const fileInput = $("image-reference-input");
        if (fileInput && fileInput.files && fileInput.files[0]) {
            setGeneratingState(true, "Preparing upload...");
            try {
                payload.reference_image = await readFileAsBase64(fileInput.files[0]);
            } catch(e) {
                 setGeneratingState(false);
                 showSulandraToast("Failed to read reference image.", "error");
                 return;
            }
            setGeneratingState(false);
        }
    }

    // 2. Create Placeholders immediately (1 to 4 cards)
    const placeholderIds = createPlaceholders(batchCount, "image", payload.prompt, payload.aspect, payload.negative_prompt);

    // 3. Loop and Fire API calls SEQUENTIALLY (One by One)
    // We use a 'for...of' loop with await to prevent crashing the backend with parallel requests
    for (let i = 0; i < placeholderIds.length; i++) {
        const pid = placeholderIds[i];
        const singlePayload = { ...payload };
        
        // Increment seed for variety if user set one, else random is handled in API call
        if (singlePayload.seed !== null) singlePayload.seed += i;

        try {
            // Wait for this request to finish before starting the next one
            const result = await callSulandraAPI("/generate/image", singlePayload);
            
            fulfillPlaceholder(pid, {
                url: result.url,
                thumb: result.thumb || result.url,
                meta: result.meta
            });
        } catch (err) {
            console.error(`Gen failed for ${pid}`, err);
            deleteHistoryItem(pid); // Remove failed placeholder
            refreshAllHistoryDisplays();
            if (i === 0) showSulandraToast("Generation failed", "error");
        }
    }
}

async function generateVideoFromUI() {
    const payload = buildVideoPayloadFromUI();
    if (currentVideoMode === "image") {
        const fileInput = $("video-start-input");
        if (fileInput?.files?.[0]) payload.reference_image = await readFileAsBase64(fileInput.files[0]);
    }
    // Create 1 placeholder for video
    const [placeholderId] = createPlaceholders(1, "video", payload.prompt, payload.aspect, payload.negative_prompt);
    
    callSulandraAPI("/generate/video", payload).then(result => {
        fulfillPlaceholder(placeholderId, { url: result.url, thumb: result.url, meta: result.meta });
    }).catch(err => {
        deleteHistoryItem(placeholderId);
        refreshAllHistoryDisplays();
        showSulandraToast("Video failed", "error");
    });
}

async function generateShortFilmFromUI() {
    const payload = buildShortFilmPayloadFromUI();
    if (!payload.segments?.length) return showSulandraToast("Add segments", "warning");
    
    const [placeholderId] = createPlaceholders(1, "shortfilm", payload.film_title, payload.aspect, "");
    callSulandraAPI("/generate/shortfilm", payload).then(result => {
        fulfillPlaceholder(placeholderId, { url: result.url, thumb: result.url, meta: result.meta });
    }).catch(err => {
        deleteHistoryItem(placeholderId);
        refreshAllHistoryDisplays();
    });
}

/* ------------------------ RANDOM PROMPT BUTTON -------------------------- */

function wireRandomPromptButton() {
    const btn = $("btn-random-prompt");
    if (!btn) return;

    btn.addEventListener("click", () => {
        if (currentLab === "image") {
            const examples = [
                "cinematic portrait of an African futurist artist in neon-lit studio, ultra-detailed, 50mm, shallow depth of field",
                "lush Cameroon hillside at golden hour, kids flying kites, volumetric light, 8k, photography",
                "Amapiano club scene in Lagos, neon reflections, crowd dancing, motion blur, high energy"
            ];
            const t = $("image-main-prompt");
            if (t) t.value = examples[Math.floor(Math.random() * examples.length)];
        } else if (currentLab === "video") {
            const examples = [
                "slow drone fly-through over Providence City at sunrise, soft light, birds flying, gentle camera easing",
                "close-up shot circling a singer on stage, colorful lights, crowd silhouettes, smooth dolly movement",
                "city street in the rain at night, reflections on pavement, cars passing, cinematic parallax"
            ];
            const t = $("video-main-prompt");
            if (t) t.value = examples[Math.floor(Math.random() * examples.length)];
        } else if (currentLab === "shortfilm") {
            const g = $("shortfilm-global-prompt");
            if (g) {
                g.value = "Short film about a young creator building Sulandra Studio, balancing nursing shifts with late-night coding and music sessions.";
            }
        }
    });
}

/* --------------------------- MAIN BUTTON WIRING ------------------------- */

function wireMainButtonsAndToggles() {
    // UPDATE: New Sidebar Lab Navigation clicks
    document.querySelectorAll("[data-lab-nav]").forEach(btn => {
        btn.addEventListener("click", () => {
            const lab = btn.dataset.labNav;
            if (!lab) return;
            setActiveLab(lab);
        });
    });

    // Mode toggle
    document.querySelectorAll("#mode-toggle .vision-header__view-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const mode = btn.dataset.mode;
            if (!mode) return;
            currentMode = mode;
            updateModeToggleButtons();
        });
    });

    // Favorites only – header toggle (affects gallery/history)
    const favToggle = $("favorites-toggle-checkbox");
    if (favToggle) {
        favToggle.addEventListener("change", () => {
            favoritesOnlyGallery = favToggle.checked;
            refreshAllHistoryDisplays();
        });
    }

    // Gallery filter tabs
    const galleryFilter = $("gallery-filter-switch");
    if (galleryFilter) {
        galleryFilter.querySelectorAll(".pill-switch__btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const val = btn.dataset.galleryFilter || "all";
                currentGalleryFilter = val;
                updateGalleryFilterButtons();
                refreshAllHistoryDisplays();
            });
        });
    }

    // Gallery layout (grid / vertical)
    const galleryLayout = $("gallery-layout-switch");
    if (galleryLayout) {
        galleryLayout.querySelectorAll(".pill-switch__btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const val = btn.dataset.galleryLayout || "grid";
                currentGalleryLayout = val;
                updateGalleryLayoutButtons();
                applyGalleryLayout();
            });
        });
    }

    // Refresh gallery button
    const refreshBtn = $("btn-gallery-refresh");
    if (refreshBtn) {
        refreshBtn.addEventListener("click", () => {
            refreshAllHistoryDisplays();
        });
    }

    // Gallery settings button – for now, info tip
    const gallerySettingsBtn = $("btn-open-gallery-settings");
    if (gallerySettingsBtn) {
        gallerySettingsBtn.addEventListener("click", () => {
            window.alert("Gallery settings will let you choose how many items to keep, auto-clean rules, etc. (Placeholder).");
        });
    }

    // Assets button in header
    const openAssetsBtn = $("open-assets-btn");
    if (openAssetsBtn) {
        openAssetsBtn.addEventListener("click", () => {
            setActiveLab("assets");
            currentMode = "view";
            updateModeToggleButtons();
        });
    }

    // Assets type switch
    const assetsTypeSwitch = $("assets-type-switch");
    if (assetsTypeSwitch) {
        assetsTypeSwitch.querySelectorAll(".pill-switch__btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const t = btn.dataset.assetsType;
                if (!t) return;
                currentAssetsType = t;
                updateAssetsTypeButtons();
                renderAssetsList();
            });
        });
    }

    // Assets layout switch (for future layout variations)
    const assetsLayoutSwitch = $("assets-layout-switch");
    if (assetsLayoutSwitch) {
        assetsLayoutSwitch.querySelectorAll(".pill-switch__btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const t = btn.dataset.assetsLayout;
                if (!t) return;
                currentAssetsLayout = t;
                updateAssetsLayoutButtons();
                renderAssetsList();
            });
        });
    }

    // Assets favorites filter
    const assetsFavToggle = $("assets-favorites-only");
    if (assetsFavToggle) {
        assetsFavToggle.addEventListener("change", () => {
            renderAssetsList();
        });
    }

    // Assets search
    const assetsSearch = $("assets-search-input");
    if (assetsSearch) {
        assetsSearch.addEventListener("input", () => {
            renderAssetsList();
        });
    }

    // Generate button
    const generateBtn = $("btn-generate");
    if (generateBtn) {
        generateBtn.addEventListener("click", () => {
            if (currentLab === "image") {
                generateImageFromUI();
            } else if (currentLab === "video") {
                generateVideoFromUI();
            } else if (currentLab === "shortfilm") {
                generateShortFilmFromUI();
            } else {
                window.alert("Select Images, Videos, or Short Films to generate.");
            }
        });
    }

    // Ask SIA button in stage toolbar
    const askSIAStageBtn = $("btn-open-ask-sia");
    if (askSIAStageBtn) {
        askSIAStageBtn.addEventListener("click", () => {
            const first = historyInMemory[0];
            if (!first) {
                window.alert("Generate something first, then Ask SIA about it.");
                return;
            }
            askSIAAboutItem(first);
        });
    }

    // Random prompt button
    wireRandomPromptButton();
// --- ASK SIA WIRING (Updated for Neon Text) ---
document.querySelectorAll(".sulandra-neon-trigger").forEach(el => {
    // Clone to remove old listeners
    const newEl = el.cloneNode(true);
    el.parentNode.replaceChild(newEl, el);

    newEl.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        const targetId = newEl.dataset.targetPrompt;
        const textarea = document.getElementById(targetId);
        
        let contextText = "General Help";
        if (textarea && textarea.value.trim()) {
            contextText = textarea.value.trim();
        } else if (textarea) {
            contextText = "Empty prompt field";
        }

        openAskSia(currentLab, contextText);
    });
});
}
    
/* ====================================================================== */
/* UPDATED: SIA CHAT LOGIC WITH "USE PROMPT" BUTTON                      */
/* ====================================================================== */
// Global history array
let askSiaHistory = [];

async function sendAskSia() {
    const questionBox = document.getElementById('askSiaQuestion');
    const answerBox = document.getElementById('askSiaAnswer');
    const question = questionBox.value;
  
    if (!question.trim()) return;

    // 1. ADD USER MESSAGE TO UI IMMEDIATELY
    const userBubble = document.createElement('div');
    userBubble.style.cssText = "align-self: flex-end; background: #334155; color: white; padding: 8px 12px; border-radius: 12px; margin-bottom: 8px; max-width: 80%; font-size: 13px;";
    userBubble.textContent = question;
    answerBox.appendChild(userBubble);
    
    // Scroll to bottom
    answerBox.scrollTop = answerBox.scrollHeight;

    // Clear input
    questionBox.value = "";

    // 2. SHOW LOADING BUBBLE
    const loadingBubble = document.createElement('div');
    loadingBubble.id = "sia-loading-bubble";
    loadingBubble.innerHTML = `<div class="neon-spinner" style="width:16px; height:16px; border-width:2px;"></div>`;
    answerBox.appendChild(loadingBubble);

    const payload = {
        user_input: question,
        context: window.askSiaState.context || "General Query",
        history: askSiaHistory // Send past history
    };

    try {
        const res = await fetch(SIA_BRAIN_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("SIA Offline");

        const data = await res.json();
        
        // Remove loading bubble
        const loader = document.getElementById("sia-loading-bubble");
        if(loader) loader.remove();

        // 3. ADD SIA RESPONSE TO UI
        const siaBubble = document.createElement('div');
        siaBubble.style.cssText = "align-self: flex-start; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: #e2e8f0; padding: 10px; border-radius: 12px; margin-bottom: 12px; max-width: 90%; font-size: 13px;";
        
        let html = `<div>${data.reply}</div>`;

        // Add "Use Prompt" button if there is a payload
        if (data.payload && data.payload.length > 5) {
             const safePayload = data.payload.replace(/"/g, '&quot;').replace(/\n/g, ' ');
             html += `
                <div style="margin-top:8px; padding:8px; background:rgba(0,0,0,0.3); border-radius:6px; font-family:monospace; color:#86efac; font-size:11px;">
                    ${data.payload}
                </div>
                <button class="ask-sia-use-btn" onclick="useSiaPrompt('${safePayload}')" style="margin-top:6px;">
                    <span>Use this Prompt</span>
                </button>
            `;
        }
        
        siaBubble.innerHTML = html;
        answerBox.appendChild(siaBubble);

        // 4. SAVE HISTORY (Update memory)
        askSiaHistory.push({ "role": "user", "content": question });
        askSiaHistory.push({ "role": "assistant", "content": data.reply });

        // Scroll to bottom
        answerBox.scrollTop = answerBox.scrollHeight;

    } catch (err) {
        console.error(err);
        const loader = document.getElementById("sia-loading-bubble");
        if(loader) loader.innerHTML = "<span style='color:red'>Error</span>";
    }
}

// 3. New Helper: Insert text into the correct active box
window.useSiaPrompt = function(text) {
    let targetId = "";

    // Decide which box to target based on current Lab
    if (currentLab === "image") {
        targetId = "image-main-prompt";
    } else if (currentLab === "video") {
        targetId = "video-main-prompt";
    } else if (currentLab === "shortfilm") {
        targetId = "shortfilm-global-prompt";
    }

    const input = document.getElementById(targetId);
    if (input) {
        input.value = text;
        showSulandraToast("Prompt updated!", "success");
        
        // Highlight the box briefly
        input.scrollIntoView({ behavior: "smooth", block: "center" });
        input.style.borderColor = "#4ade80";
        setTimeout(() => input.style.borderColor = "", 1000);
        
        // Optional: Close the panel after using
        // closeAskSia(); 
    } else {
        showSulandraToast("Could not find active prompt box.", "error");
    }
};

// Close on Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeAskSia();
});

/* -------------------------- INITIAL UI WIRING ENTRY --------------------- */

function initializeSulandraVision() {
    injectDynamicStyles();
    applyGalleryLayout();

    // reload history into cache + UI
    loadHistoryFromStorage();
    rebuildAssetsCacheFromHistory();
    refreshAllHistoryDisplays();
    renderAssetsList();

    wireImageControls();
    wireVideoControls();
    wireShortFilmControls();
    wireMainButtonsAndToggles();

    // Set default lab
    setActiveLab("image");
    currentMode = "create";
    updateModeToggleButtons();
}

document.addEventListener("DOMContentLoaded", () => {
    try {
        initializeSulandraVision();
    } catch (err) {
        console.error("[Sulandra] Initialization error:", err);
    }
    function initializeSulandraVision() {
    injectDynamicStyles();
    applyGalleryLayout();

    // ... (existing code) ...

    wireImageControls();
    wireVideoControls();
    wireShortFilmControls();
    
    wireReferenceImagePreviews(); // <--- ADD THIS LINE HERE

    wireMainButtonsAndToggles();
    // ...
}
});

/* ====================================================================== */
/*  SULANDRA VISION LAB – SECTION 7                                       */
/*  BRAND CLEANUP, UI SETTINGS PERSISTENCE & TOAST NOTIFICATIONS          */
/* ====================================================================== */

/* ------------------------------ BRAND CLEANUP --------------------------- */
/**
 * Some older copies of this UI may still contain references to "Kling" or
 * "Kling AI". This helper sweeps the DOM and replaces them with "Sulandra".
 *
 * It runs AFTER the main UI initializes, so any dynamic text also gets fixed.
 */
function renameBrandInDOM() {
    const replacements = [
        { from: /kling\s*ai/gi, to: "Sulandra" },
        { from: /kling/gi,      to: "Sulandra" }
    ];

    const walker = document.createTreeWalker(
        document.body,
        NodeFilter.SHOW_TEXT,
        null,
        false
    );

    const nodes = [];
    let n = walker.nextNode();
    while (n) {
        nodes.push(n);
        n = walker.nextNode();
    }

    nodes.forEach(node => {
        let txt = node.nodeValue;
        if (typeof txt !== "string") return;
        let changed = false;
        replacements.forEach(rule => {
            if (rule.from.test(txt)) {
                txt = txt.replace(rule.from, rule.to);
                changed = true;
            }
        });
        if (changed) node.nodeValue = txt;
    });
}

/* ------------------------------ UI SETTINGS ---------------------------- */
/**
 * UI settings we persist:
 *  - lastLab             (image / video / shortfilm / assets)
 *  - lastMode            (create / view)
 *  - galleryLayout       (grid / vertical)
 *  - galleryFilter       (all / images / videos / films)
 *  - favoritesOnlyGallery
 *  - imageMode           (text / image)
 *  - videoMode           (text / image)
 *  - assetsType          (images / videos / films)
 *  - assetsLayout        (grid / list)
 */
function loadUISettingsFromStorage() {
    const defaults = {
        lastLab: "image",
        lastMode: "create",
        galleryLayout: "grid",
        galleryFilter: "all",
        favoritesOnlyGallery: false,
        imageMode: "text",
        videoMode: "text",
        assetsType: "images",
        assetsLayout: "grid"
    };

    const saved = loadFromStorage(STORAGE_KEYS.settings, defaults);
    return Object.assign({}, defaults, saved || {});
}

function saveUISettingsFromState() {
    const payload = {
        lastLab: currentLab,
        lastMode: currentMode,
        galleryLayout: currentGalleryLayout,
        galleryFilter: currentGalleryFilter,
        favoritesOnlyGallery: !!favoritesOnlyGallery,
        imageMode: currentImageMode,
        videoMode: currentVideoMode,
        assetsType: currentAssetsType,
        assetsLayout: currentAssetsLayout
    };
    saveToStorage(STORAGE_KEYS.settings, payload);
}

/**
 * Apply saved settings to the global state and reflect in UI.
 * Called AFTER the main initializeSulandraVision has run, so it can override
 * the default "image / create" startup state.
 */
function applySavedUISettingsToUI() {
    const s = loadUISettingsFromStorage();

    // First, update globals
    currentLab = s.lastLab || "image";
    currentMode = s.lastMode || "create";
    currentGalleryLayout = s.galleryLayout || "grid";
    currentGalleryFilter = s.galleryFilter || "all";
    favoritesOnlyGallery = !!s.favoritesOnlyGallery;
    currentImageMode = s.imageMode || "text";
    currentVideoMode = s.videoMode || "text";
    currentAssetsType = s.assetsType || "images";
    currentAssetsLayout = s.assetsLayout || "grid";

    // Then update UI
    setActiveLab(currentLab);
    updateModeToggleButtons();
    updateGalleryLayoutButtons();
    updateGalleryFilterButtons();

    const favToggle = $("favorites-toggle-checkbox");
    if (favToggle) favToggle.checked = favoritesOnlyGallery;

    // Image / Video mode toggles
    const imageModeSwitch = $("image-mode-switch");
    if (imageModeSwitch) {
        setToggleButtons(imageModeSwitch, "imageMode", currentImageMode);
        const refBlock = $("image-reference-block");
        if (refBlock) {
            refBlock.style.display = currentImageMode === "image" ? "block" : "none";
        }
    }

    const videoModeSwitch = $("video-mode-switch");
    if (videoModeSwitch) {
        setToggleButtons(videoModeSwitch, "videoMode", currentVideoMode);
        const refBlock = $("video-reference-block");
        if (refBlock) {
            refBlock.style.display = currentVideoMode === "image" ? "block" : "none";
        }
    }

    // Assets (My Files) toggles
    updateAssetsTypeButtons();
    updateAssetsLayoutButtons();

    const assetsFavToggle = $("assets-favorites-only");
    if (assetsFavToggle) assetsFavToggle.checked = false;

    refreshAllHistoryDisplays();
    renderAssetsList();
}

/* Persist settings when the tab is hidden or closed */
document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") {
        saveUISettingsFromState();
    }
});
window.addEventListener("beforeunload", () => {
    saveUISettingsFromState();
});

/* ----------------------------- TOAST SYSTEM ----------------------------- */
/**
 * Simple in-app toast notifications (top-right).
 * We override window.alert to funnel all alerts through this system,
 * so everything in previous chunks automatically gets nicer UX.
 */

let toastContainer = null;
let toastIdCounter = 0;

function ensureToastContainer() {
    if (toastContainer) return;
    toastContainer = document.createElement("div");
    toastContainer.id = "sulandra-toast-container";
    toastContainer.style.position = "fixed";
    toastContainer.style.top = "16px";
    toastContainer.style.right = "16px";
    toastContainer.style.zIndex = "99999";
    toastContainer.style.display = "flex";
    toastContainer.style.flexDirection = "column";
    toastContainer.style.gap = "8px";
    document.body.appendChild(toastContainer);
}

/**
 * type = 'info' | 'success' | 'error' | 'warning'
 */
function showSulandraToast(message, type) {
    ensureToastContainer();
    toastIdCounter++;

    const toast = document.createElement("div");
    toast.dataset.toastId = String(toastIdCounter);
    toast.style.minWidth = "260px";
    toast.style.maxWidth = "360px";
    toast.style.padding = "10px 12px";
    toast.style.borderRadius = "12px";
    toast.style.border = "1px solid rgba(31,41,55,0.95)";
    toast.style.display = "flex";
    toast.style.alignItems = "flex-start";
    toast.style.gap = "10px";
    toast.style.fontSize = "11px";
    toast.style.color = "#e5e7eb";
    toast.style.boxShadow =
        "0 0 0 1px rgba(15,23,42,0.95), 0 20px 50px rgba(0,0,0,0.96)";
    toast.style.background =
        "radial-gradient(circle at 0 0,#020617,#020617 60%,#000 100%)";
    toast.style.opacity = "0";
    toast.style.transform = "translateY(-4px)";
    toast.style.transition = "opacity 140ms ease-out, transform 140ms ease-out";

    let accentColor = "#60a5fa"; // info
    if (type === "success") accentColor = "#22c55e";
    else if (type === "error") accentColor = "#f97373";
    else if (type === "warning") accentColor = "#facc15";

    const icon = document.createElement("div");
    icon.style.width = "18px";
    icon.style.height = "18px";
    icon.style.borderRadius = "999px";
    icon.style.flexShrink = "0";
    icon.style.display = "flex";
    icon.style.alignItems = "center";
    icon.style.justifyContent = "center";
    icon.style.background = "rgba(15,23,42,0.95)";
    icon.style.border = `1px solid ${accentColor}`;
    icon.style.color = accentColor;
    icon.innerHTML = `
        <svg viewBox="0 0 24 24" style="width:12px;height:12px;" fill="none">
            ${
                type === "success"
                    ? '<path d="M6 12L10 16L18 8" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>'
                    : type === "error"
                    ? '<path d="M8 8L16 16M16 8L8 16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>'
                    : type === "warning"
                    ? '<path d="M12 7V13M12 17H12.01" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>'
                    : '<path d="M12 7V13M12 17H12.01" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>'
            }
        </svg>
    `;

    const textBlock = document.createElement("div");
    textBlock.style.flex = "1";
    textBlock.style.minWidth = "0";
    textBlock.style.whiteSpace = "pre-line";
    textBlock.textContent = String(message || "");

    const closeBtn = document.createElement("button");
    closeBtn.style.border = "none";
    closeBtn.style.background = "transparent";
    closeBtn.style.color = "#6b7280";
    closeBtn.style.cursor = "pointer";
    closeBtn.style.padding = "0";
    closeBtn.style.marginLeft = "4px";
    closeBtn.innerHTML = `
        <svg viewBox="0 0 24 24" style="width:14px;height:14px;" fill="none">
            <path d="M7 7L17 17" stroke="currentColor" stroke-linecap="round"/>
            <path d="M17 7L7 17" stroke="currentColor" stroke-linecap="round"/>
        </svg>
    `;

    closeBtn.addEventListener("click", () => {
        dismissToast(toast);
    });

    toast.appendChild(icon);
    toast.appendChild(textBlock);
    toast.appendChild(closeBtn);

    toastContainer.appendChild(toast);

    // Force reflow then animate in
    requestAnimationFrame(() => {
        toast.style.opacity = "1";
        toast.style.transform = "translateY(0)";
    });

    // Auto-dismiss after a delay
    const ttl = type === "error" ? 7000 : 4500;
    setTimeout(() => {
        dismissToast(toast);
    }, ttl);
}

function dismissToast(toastEl) {
    if (!toastEl || !toastEl.parentElement) return;
    toastEl.style.opacity = "0";
    toastEl.style.transform = "translateY(-4px)";
    setTimeout(() => {
        if (toastEl.parentElement) {
            toastEl.parentElement.removeChild(toastEl);
        }
    }, 180);
}

/* Override window.alert to use Sulandra toast system */
(function overrideAlertForSulandra() {
    const originalAlert = window.alert;
    window._sulandra_original_alert = originalAlert;
    window.alert = function (msg) {
        showSulandraToast(msg, "info");
    };
})();

/* ------------------------ POST-INIT HOOKS (DOM READY) ------------------- */
/**
 * We attach an extra DOMContentLoaded listener here to:
 *  - Apply saved UI settings after the main initializeSulandraVision runs.
 *  - Clean up any remaining "Kling" branding into "Sulandra".
 *  - Show a small welcome toast the first time.
 */

document.addEventListener("DOMContentLoaded", () => {
    try {
        // Apply saved settings (lab/mode/layout/filter)
        applySavedUISettingsToUI();
    } catch (err) {
        console.warn("[Sulandra] Failed to apply saved UI settings:", err);
    }

    try {
        renameBrandInDOM();
    } catch (err) {
        console.warn("[Sulandra] Brand rename failed:", err);
    }

    // Optional: first-time welcome toast
    const flagKey = "sulandra_vision_welcome_shown_v1";
    const alreadyShown = window.localStorage.getItem(flagKey);
    if (!alreadyShown) {
        showSulandraToast(
            "Welcome to Sulandra Vision Lab.\nPlug in your RunPod + SIA Brain endpoints and start creating.",
            "success"
        );
        window.localStorage.setItem(flagKey, "1");
    }
});
/* ====================================================================== */
/*  SULANDRA VISION LAB – SECTION 8                                       */
/*  DEV HELPERS, GLOBAL EXPORT & SCRIPT CLOSURE                           */
/* ====================================================================== */

/**
 * Expose a small public API on window for debugging in the browser console.
 * Example:
 *   SulandraVision.refresh()
 *   SulandraVision.listHistory()
 */
(function exposeSulandraVisionGlobals() {
    try {
        window.SulandraVision = {
            version: "1.0.0",
            get state() {
                return {
                    currentLab,
                    currentMode,
                    currentGalleryFilter,
                    currentGalleryLayout,
                    currentImageMode,
                    currentVideoMode,
                    currentAssetsType,
                    currentAssetsLayout,
                    favoritesOnlyGallery,
                    historyCount: historyInMemory.length
                };
            },
            refresh: function () {
                try {
                    refreshAllHistoryDisplays();
                    renderAssetsList();
                    showSulandraToast("Sulandra Vision UI refreshed.", "success");
                } catch (err) {
                    console.error("[Sulandra] refresh() failed:", err);
                    showSulandraToast("Refresh failed. Check console for details.", "error");
                }
            },
            listHistory: function () {
                console.table(historyInMemory.map(h => ({
                    id: h.id,
                    kind: h.kind,
                    title: h.title,
                    createdAt: new Date(h.createdAt).toLocaleString(),
                    favorite: h.isFavorite
                })));
                showSulandraToast("History printed to console.", "info");
            },
            clearHistory: function (confirmFirst = true) {
                if (confirmFirst) {
                    const ok = window._sulandra_original_alert
                        ? window._sulandra_original_alert("This will clear your local history. Continue?")
                        : window.confirm("This will clear your local history. Continue?");
                    if (!ok) return;
                }
                historyInMemory = [];
                saveHistoryToStorage();
                refreshAllHistoryDisplays();
                renderAssetsList();
                showSulandraToast("Sulandra history cleared (local only).", "warning");
            }
        };
    } catch (err) {
        console.warn("[Sulandra] Failed to expose SulandraVision globals:", err);
    }
})();

/* Final safety log so you can see load success in dev tools */
console.log("%cSulandra Vision Lab loaded.", "color:#22c55e;font-weight:600;");

/* ====================================================================== */
/*  END OF SULANDRA VISION LAB SCRIPT                                     */
/* ====================================================================== */
</script>
</html>
